/**
 * IMPORTANT NOTE:
 *
 * This file is licensed only for the use of Apple developers in providing MusicKit Web Services,
 * and is subject to the Apple Media Services Terms and Conditions and the Apple Developer Program
 * License Agreement. You may not copy, modify, re-host, or create derivative works of this file or the
 * accompanying Documentation, or any part thereof, including any updates, without Apple's written consent.
 *
 * ACKNOWLEDGEMENTS:
 * https://js-cdn.music.apple.com/musickit/v1/acknowledgements.txt
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).MusicKit={})}(this,(function(e){"use strict";var t=void 0!==typeof self?self:this;function formatArtworkURL(e,t,r){return t=t||e.height||100,r=r||e.width||100,window.devicePixelRatio>=1.5&&(r*=2,t*=2),e.url.replace("{h}",""+t).replace("{w}",""+r).replace("{f}","jpeg")}var r="undefined"!=typeof FastBoot?FastBoot.require("buffer").Buffer:"undefined"!=typeof process&&null!==process.versions&&null!==process.versions.node?Buffer:window.Buffer;function memoize(e){return function(...t){let r="",n=t.length;for(e._memoized=e._memoized||{};n--;){const e=t[n];r+=e===Object(e)?JSON.stringify(e):e}return r in e._memoized?e._memoized[r]:e._memoized[r]=e(...t)}}function generateUUID(){let e=strRandomizer()+strRandomizer();for(;e.length<16;)e+=strRandomizer();return e.slice(0,16)}function strRandomizer(){return Math.random().toString(16).substring(2)}function isLibraryType(e){if(void 0===e)return!1;const t="string"==typeof e?e:e.id;return/^[a|i|l|p]{1}\.[a-zA-Z0-9]+$/.test(t)}const n=memoize(e=>/^(a\.)?[a-zA-Z0-9]+$/.test(e));function detectNodeEnvironment(){var e,t,r,n;return void 0!==(null===(r=globalThis)||void 0===r||null===(t=r.process)||void 0===t||null===(e=t.versions)||void 0===e?void 0:e.node)||void 0!==(null===(n=globalThis)||void 0===n?void 0:n.FastBoot)}function isNodeEnvironment$1(){return detectNodeEnvironment()}const i=memoize(detectNodeEnvironment()?e=>r.from(e,"base64").toString("binary"):e=>window.atob(e));memoize(detectNodeEnvironment()?e=>r.from(e).toString("base64"):e=>window.btoa(e));const debounce=(e,t=250,r={isImmediate:!1})=>{let n;return function(...i){const o=this,a=r.isImmediate&&void 0===n;void 0!==n&&clearTimeout(n),n=setTimeout((function(){n=void 0,r.isImmediate||e.apply(o,i)}),t),a&&e.apply(o,i)}},arrayEquals=(e,t)=>!!e&&!!t&&[].every.call(e,(e,r)=>e===t[r]),o=memoize(e=>{const t=i(e);return a(t)});function ensureArray(e=[]){return Array.isArray(e)?e:[e]}const a=memoize(e=>{const t=e.length,r=new ArrayBuffer(t),n=new Uint8Array(r);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);return n}),s=memoize(e=>{const t=e.length,r=new ArrayBuffer(2*t),n=new Uint16Array(r);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);return n}),c=memoize(e=>{let t,r,n,i,o,a,s,c=0;const l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let d="";for(;c<e.length;)t=e[c++],r=c<e.length?e[c++]:Number.NaN,n=c<e.length?e[c++]:Number.NaN,i=t>>2,o=(3&t)<<4|r>>4,a=(15&r)<<2|n>>6,s=63&n,isNaN(r)?a=s=64:isNaN(n)&&(s=64),d+=l.charAt(i)+l.charAt(o)+l.charAt(a)+l.charAt(s);return d}),l=/\/(?:([a-z]{2})\/)?(album|artist|episode|movie|music-video|playlist|podcast|post|season|show|song|station)\/(?:[^/]*\/)?(?:id)?(\d+|[a-z]{2}\.[a-z0-9-]+|umc.cmc.[a-zA-Z0-9]+)(?:.*(?:[?|&]i=(\d+)).*)?.*$/i;function parseMediaURL(e){const t=e.match(l)||[];let[,r,n,i,o]=t;"music-video"===n&&(n="musicVideo"),-1!==["album","playlist"].indexOf(n)&&o?(n="song",i=o):"podcast"===n&&o&&(n="episode",i=o);return{storefrontId:r,kind:n,contentId:i,itemId:o}}function formattedMediaURL(e){const t=parseMediaURL(e),{storefrontId:r,kind:n,contentId:i}=t;if([r,n,i].some(e=>void 0===e))throw new TypeError("Invalid Media URL: "+e);return{storefrontId:r,kind:n,contentId:i,isUTS:!!i&&i.startsWith("umc.")}}const d=/^http(?:s)?\:\/\/(?:itunes|(embed\.)?(music|podcasts|tv))\.apple\.com/i,u=["allow-forms","allow-popups","allow-same-origin","allow-scripts","allow-storage-access-by-user-activation","allow-top-navigation-by-user-activation"],p=["autoplay *","encrypted-media *","fullscreen *","clipboard-write"];var h,y;function hasOwn(e,t){return Object.prototype.hasOwnProperty.call(Object(e),t)}function deepClone(e){const t=Object.prototype.toString.call(e).toLowerCase().slice(8,-1);switch(t){case"set":return new Set([...e].map(e=>deepClone(e)));case"map":return new Map([...e].map(([e,t])=>[deepClone(e),deepClone(t)]));case"date":return new Date(e.getTime());case"regexp":{const t=e,r="string"==typeof t.flags?t.flags:[t.global?"g":void 0,t.ignoreCase?"i":void 0,t.multiline?"m":void 0,t.sticky?"y":void 0,t.unicode?"u":void 0].filter(e=>void 0!==e).join("");return RegExp(e.source,r)}case"arraybuffer":{const t=e;if("function"==typeof t.slice)return t.slice(0);{const r=new e.constructor(t.byteLength);return new Uint8Array(r).set(new Uint8Array(t)),r}}case"dataview":case"int8array":case"uint8array":case"uint8clampedarray":case"int16array":case"uint16array":case"int32array":case"uint32array":case"float32array":case"float64array":case"bigint64array":case"biguint64array":{const r=e;return new(0,r.constructor)(deepClone(r.buffer),r.byteOffset,"dataview"===t?r.byteLength:r.length)}case"array":case"object":{const t=Array.isArray(e)?[]:{};for(const r in e)hasOwn(e,r)&&(t[r]=deepClone(e[r]));return t}default:return e}}function transform$b(e,t,r=!1){return r&&(e=Object.keys(e).reduce((t,r)=>(t[e[r]]=r,t),{})),Object.keys(e).reduce((r,n)=>{const i=e[n],o="function"==typeof i?i():function(e,t){return t.split(".").reduce((e,t)=>{if(void 0!==e)return e[t]},e)}(t,i);return o&&function(e,t,r){t.split(".").reduce((t,n,i,o)=>{const a=i===o.length-1,s=hasOwn(t,n),c=t[n]instanceof Object,l=null===t[n];if(!a&&s&&(!c||l))throw new TypeError(`Value at ${o.slice(0,i+1).join(".")} in keypath is not an Object.`);return a?(t[n]=r,e):s?t[n]:t[n]={}},e)}(r,n,o),r},{})}function transformKeys(e,t){return Object.keys(e).reduce((r,n)=>(r[t(n)]=e[n],r),{})}e.PlaybackType=void 0,(h=e.PlaybackType||(e.PlaybackType={}))[h.none=0]="none",h[h.preview=1]="preview",h[h.unencryptedFull=2]="unencryptedFull",h[h.encryptedFull=3]="encryptedFull",function(e){e[e.none=0]="none",e[e.loading=1]="loading",e[e.ready=2]="ready",e[e.playing=3]="playing",e[e.ended=4]="ended",e[e.unavailable=5]="unavailable",e[e.restricted=6]="restricted",e[e.error=7]="error",e[e.unsupported=8]="unsupported"}(y||(y={}));class GenericStorage{get data(){return this._data}set data(e){this._data=e}get length(){return this.keys.length}get keys(){return Object.keys(this.data)}getItem(e){return this.data[e]||null}setItem(e,t){this.data[e]=t}removeItem(e){delete this.data[e]}clear(){this.keys.forEach(e=>this.removeItem(e))}key(e){return this.keys[e]||null}constructor(e={}){var t,r,n;n=void 0,(r="_data")in(t=this)?Object.defineProperty(t,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[r]=n,this.data=e}}function getCookie(e="",t=document.cookie){const r=t.match(new RegExp(`(?:^|;\\s*)${e}=([^;]*)`));if(r)return r[1]}function setCookie(e,t,r="",n=14,i,o){const a=new Date;i=null!=i?i:window;const s=(o=null!=o?o:/\./.test(i.location.hostname)?i.location.hostname:"").length>0?`domain=${o}; `:"";a.setTime(a.getTime()+24*n*60*60*1e3);let c="";"https:"===i.location.protocol&&(c="; secure"),i.document.cookie=`${e}=${t}; expires=${a.toUTCString()}; ${s}path=${r}${c}`}function removeCookie(e,t,r){setCookie(e,"","/",0,t,r)}function hasSessionStorage(){let e=!1;try{e="undefined"!=typeof sessionStorage}catch(t){}return e}function getSessionStorage(){let e;return hasSessionStorage()&&(e=sessionStorage),e}function hasLocalStorage(){let e=!1;try{e="undefined"!=typeof localStorage}catch(t){}return e}function getLocalStorage(){let e;return hasLocalStorage()&&(e=localStorage),e}function getJsonFromLocalStorage(e){const t=function(e){if(!hasLocalStorage())return;const t=getLocalStorage().getItem(e);return null!==t?t:void 0}(e);if(t)try{return JSON.parse(t)}catch(r){return}}function _define_property$20(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class Notifications{get shouldStorageDispatch(){return"undefined"!=typeof window&&hasSessionStorage()&&this.dispatchNamespace}addEventListener(e,t){Array.isArray(this._eventRegistry[e])&&this._eventRegistry[e].push(t)}dispatchEvent(e,t){Array.isArray(this._eventRegistry[e])&&this._eventRegistry[e].forEach(e=>e(t))}dispatchDistributedEvent(e,t){if(this.dispatchEvent(e,t),this.shouldStorageDispatch){var r;const n=`${this.dispatchNamespace}:${e}`;null===(r=getSessionStorage())||void 0===r||r.setItem(n,JSON.stringify(t))}}removeEventListener(e,t){if(Array.isArray(this._eventRegistry[e])){const r=this._eventRegistry[e].indexOf(t);this._eventRegistry[e].splice(r,1)}}_handleGlobalStorageEvent(e){var t;if(this.dispatchNamespace&&(null===(t=e.key)||void 0===t?void 0:t.startsWith(this.dispatchNamespace+":"))){const t=e.key.substring(this.dispatchNamespace.length+1);this.dispatchEvent(t,JSON.parse(e.newValue))}}constructor(e=[],t){_define_property$20(this,"dispatchNamespace",void 0),_define_property$20(this,"_eventRegistry",{}),e.forEach(e=>{this._eventRegistry[e]=[]}),t&&t.namespace&&(this.dispatchNamespace="com.apple."+t.namespace),this.shouldStorageDispatch&&(this._handleGlobalStorageEvent=this._handleGlobalStorageEvent.bind(this),window.addEventListener("storage",this._handleGlobalStorageEvent))}}let isMergeableObject=function(e){return function(e){return!!e&&"object"==typeof e}(e)&&!function(e){let t=Object.prototype.toString.call(e);return"[object RegExp]"===t||"[object Date]"===t||function(e){return e.$$typeof===f}(e)}(e)};let f="function"==typeof Symbol&&Symbol.for?Symbol.for("react.element"):60103;function cloneUnlessOtherwiseSpecified(e,t){return!1!==t.clone&&t.isMergeableObject(e)?deepmerge((r=e,Array.isArray(r)?[]:{}),e,t):e;var r}function defaultArrayMerge(e,t,r){return e.concat(t).map((function(e){return cloneUnlessOtherwiseSpecified(e,r)}))}function getKeys(e){return Object.keys(e).concat(function(e){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(e).filter((function(t){return e.propertyIsEnumerable(t)})):[]}(e))}function mergeObject(e,t,r){let n={};return r.isMergeableObject(e)&&getKeys(e).forEach((function(t){n[t]=cloneUnlessOtherwiseSpecified(e[t],r)})),getKeys(t).forEach((function(i){r.isMergeableObject(t[i])&&e[i]?n[i]=function(e,t){if(!t.customMerge)return deepmerge;let r=t.customMerge(e);return"function"==typeof r?r:deepmerge}(i,r)(e[i],t[i],r):n[i]=cloneUnlessOtherwiseSpecified(t[i],r)})),n}function deepmerge(e,t,r){(r=r||{}).arrayMerge=r.arrayMerge||defaultArrayMerge,r.isMergeableObject=r.isMergeableObject||isMergeableObject;let n=Array.isArray(t);return n===Array.isArray(e)?n?r.arrayMerge(e,t,r):mergeObject(e,t,r):cloneUnlessOtherwiseSpecified(t,r)}function _define_property$1$(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$T(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1$(e,t,r[t])}))}return e}function _object_spread_props$w(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _object_without_properties$2(e,t){if(null==e)return{};var r,n,i=function(e,t){if(null==e)return{};var r,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}var _;deepmerge.all=function(e,t){if(!Array.isArray(e))throw new Error("first argument should be an array");return e.reduce((function(e,r){return deepmerge(e,r,t)}),{})},function(e){e.dataRecordDidDelete="dataRecordDidDelete",e.dataRecordWillDelete="dataRecordWillDelete",e.dataRecordDidMaterialize="dataRecordDidMaterialize",e.dataRecordDidPopulate="dataRecordDidPopulate",e.dataRecordWillPopulate="dataRecordWillPopulate"}(_||(_={}));const isDataRecord=e=>!(!e||"function"!=typeof e.hasAttributes||"function"!=typeof e.hasRelationships||"function"!=typeof e.hasViews||"function"!=typeof e.serialize);class DataRecord{hasProperties(e){return!e||(e.attributes||e.relationships||e.views?!(e.attributes&&!this.hasAttributes(e.attributes))&&(!(e.relationships&&!this.hasRelationships(e.relationships))&&!(e.views&&!this.hasViews(e.views))):this.hasAttributes()||this.hasRelationships()||this.hasViews())}hasAttributes(e){return this._hasProperties(this._mjs.attributes,e)}hasRelationships(e){return this._hasProperties(this._mjs.relationships,e)}hasViews(e){return this._hasProperties(this._mjs.views,e)}meta(e){return e?this._meta[e]:this._meta}serialize(e=!0,t={},r={}){const n={id:this.id,type:this.type};return t[`${this.type}-${this.id}`]&&!r.allowFullDuplicateSerializations?n:(t[`${this.type}-${this.id}`]=!0,this.hasAttributes()&&(n.attributes=this._mjs.attributes.reduce((e,t)=>(e[t]=this[t],e),{})),this._mjs.relationships.length>0&&(n.relationships=this._serializeRelatedData(this._mjs.relationships,t,r)),this._mjs.views.length>0&&(n.views=this._serializeRelatedData(this._mjs.views,t,r)),e?{data:n}:n)}setProperty(e,t,r="attributes",n={}){function isMergeableObject(e){return!(!e||"object"!=typeof e||e instanceof DataRecord)}hasOwn(this,e)||(this._mjs[r]||(this._mjs[r]=[]),this._mjs[r].push(e));const setDescriptor=e=>({value:e,writable:!0,configurable:!0,enumerable:!0});this[e]&&t&&"object"==typeof this[e]&&"object"==typeof t?"attributes"===r?Object.defineProperty(this,e,setDescriptor(deepmerge(this[e],t,{arrayMerge:function(e,t,r){return t},isMergeableObject:isMergeableObject}))):"relationships"===r&&Array.isArray(this[e])&&n.extendRelationships?Object.defineProperty(this,e,setDescriptor(deepmerge(this[e],t,{isMergeableObject:isMergeableObject}))):Object.defineProperty(this,e,setDescriptor(t)):Object.defineProperty(this,e,setDescriptor(t))}removeRelative(e,t){this[e]&&(Array.isArray(this[e])?this[e]=this[e].filter(e=>e.id!==t):delete this[e])}setParent(e){const t=this._mjs.parents,r=t&&t.length>0;this._mjs.parents=r?t.concat(e):e}_hasProperties(e,t){return!!e&&(t?ensureArray(t).every(t=>e.includes(t)):e.length>0)}_serializeRelatedData(e,t={},r={}){return e.reduce((e,n)=>{if(r.excludeRelationships&&r.excludeRelationships.has(n))return e;if(r.includeRelationships&&!r.includeRelationships.has(n))return e;const i=this[n];return Array.isArray(i)?e[n]={data:i.map(e=>"function"==typeof e.serialize?e.serialize(!1,t,r):e)}:e[n]=i&&"function"==typeof i.serialize?i.serialize(!1,t,r):i,e},{})}constructor(e,t,r={}){_define_property$1$(this,"type",void 0),_define_property$1$(this,"id",void 0),_define_property$1$(this,"_mjs",void 0),_define_property$1$(this,"_meta",void 0),this.type=e,this.id=t,this._mjs={attributes:[],relationships:[],views:[]},this._meta={},this._mjs=_object_spread$T({},this._mjs,r)}}class DataStore extends Notifications{get mapping(){return this._mapping}set mapping(e){this._mapping=e}clear(){this._records={},this._expiryRecords=new Set}peek(e,t,r){if(this._checkForExpiredRecords(),!this._records[e])return t?null:[];if(!t)return Object.values(this._records[e]);if(Array.isArray(t))return t.map(t=>{const n=this._records[e][t];if(n&&n.hasProperties(r))return n});const n=this._records[e][t];return n&&n.hasProperties(r)?n:null}populateDataRecords(e,t={},r={}){if(!e.data)return[];if(!Array.isArray(e.data))return this.populateDataRecord(e.data,t,r);const n=[];return e.data.forEach((e,i)=>{const o=_object_spread_props$w(_object_spread$T({},r),{parents:r.parents?[_object_spread_props$w(_object_spread$T({},r.parents[0]),{position:i})]:[]});r.parents&&(r.parents[0].position=i);const a=this.populateDataRecord(e,t,o);n.push(a)}),n}populateDataRecord(e,t={},r){const n=r.filter||this.filter,i=r.mapping||this.mapping;if(n&&!n(e))return;if(i){let t="function"==typeof i?i(e):transform$b(i,e);Object.assign(e,t)}this._shouldDisableRecordReuse&&(t={});const o=this._materializeRecord(t,_object_spread$T({id:e.id,type:e.type},r));return e.meta&&(o._meta=e.meta),e.attributes&&e.attributes.cachingPolicy&&e.attributes.cachingPolicy.maxAge&&(o._mjs.expiration=Date.now()+1e3*e.attributes.cachingPolicy.maxAge,this._removeOnExpiration&&this._expiryRecords.add(o)),this._populateDataAttributes(e,o),"object"==typeof e.relationships&&Object.keys(e.relationships).forEach(n=>{let a=e.relationships[n];a&&"data"in a&&(a=this.populateDataRecords(a,t,{mapping:i,parents:[{relationshipName:n,parentType:o.type,parentId:o.id}]}),o.setProperty(n,a,"relationships",r))}),"object"==typeof e.views&&Object.keys(e.views).forEach(r=>{const n=e.views[r];if(n.attributes||n.data){const e=new DataRecord("view",r);if(this._populateDataAttributes(n,e),n.data){const r=this.populateDataRecords(n,t,i);e.setProperty("data",r,"relationships")}o.setProperty(r,e,"views")}}),o}query(e,t){this._checkForExpiredRecords();let includeRecord=e=>!1;return"string"==typeof e&&t?includeRecord=r=>(null==r?void 0:r[e])===t:"function"==typeof e?includeRecord=t=>{try{return e(t)}catch(r){return!1}}:"object"==typeof e&&(includeRecord=t=>{const r=Object.keys(e);let n=0;return r.forEach(r=>{(null==t?void 0:t[r])===e[r]&&n++}),r.length===n}),Object.values(this._records).reduce((e,t)=>(Object.values(t).forEach(t=>{includeRecord(t)&&e.push(t)}),e),[])}remove(e,t){setTimeout(this._checkForExpiredRecords.bind(this),0);if(!hasOwn(this._records,e))return;const r=this.peek(e,t);r&&(this.dispatchEvent("dataRecordWillDelete",[e,t]),r._mjs.parents&&r._mjs.parents.length>0&&r._mjs.parents.forEach(({relationshipName:e,parentType:t,parentId:n})=>{this.peek(t,n).removeRelative(e,r.id)}),delete this._records[e][t],this.dispatchEvent("dataRecordDidDelete",[e,t]))}save(e,t={}){return setTimeout(this._checkForExpiredRecords.bind(this),0),this.populateDataRecords(e,this._records,t)}_populateDataAttributes(e,t){"object"==typeof e.attributes&&(this.dispatchEvent("dataRecordWillPopulate",[t.type,t.id]),Object.keys(e.attributes).forEach(r=>{t.setProperty(r,e.attributes[r],"attributes")}),this.dispatchEvent("dataRecordDidPopulate",[t.type,t.id]))}_materializeRecord(e,t){const{type:r,id:n}=t,i=_object_without_properties$2(t,["type","id"]);return e[r]=e[r]||{},e[r][n]?e[r][n].setParent(i.parents||[]):e[r][n]=new DataRecord(r,n,i),this.dispatchEvent("dataRecordDidMaterialize",[r,n]),e[r][n]}_checkForExpiredRecords(){const e=[];this._expiryRecords.forEach(t=>{Date.now()>t._mjs.expiration&&(e.push([t.type,t.id]),this._expiryRecords.delete(t))}),e.forEach(e=>{this.remove(...e)})}constructor(e={}){super(["dataRecordDidDelete","dataRecordWillDelete","dataRecordDidMaterialize","dataRecordWillPopulate","dataRecordDidPopulate"]),_define_property$1$(this,"_records",void 0),_define_property$1$(this,"_expiryRecords",void 0),_define_property$1$(this,"_mapping",void 0),_define_property$1$(this,"_removeOnExpiration",!1),_define_property$1$(this,"_shouldDisableRecordReuse",!0),_define_property$1$(this,"filter",void 0),this._records={},this._expiryRecords=new Set,this._removeOnExpiration=!!e.removeOnExpiration,this._mapping=e.mapping,this._shouldDisableRecordReuse=!!e.shouldDisableRecordReuse,this.filter=e.filter}}function _define_property$1_(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class DeveloperToken{get isExpired(){return this.expiration<Date.now()}_decode(e){return JSON.parse(i(e))}constructor(e){if(_define_property$1_(this,"token",void 0),_define_property$1_(this,"expiration",void 0),_define_property$1_(this,"keyId",void 0),_define_property$1_(this,"teamId",void 0),this.token=e,!e||!/^[a-z0-9\-\_]{16,}\.[a-z0-9\-\_]{16,}\.[a-z0-9\-\_]{16,}/i.test(e))throw new Error("Invalid token.");const[t,r]=e.split("."),{exp:n,iss:i}=this._decode(r);if(this.expiration=1e3*n,this.isExpired)throw new Error("Initialized with an expired token.");this.teamId=i;const{kid:o}=this._decode(t);this.keyId=o}}function _define_property$1Z(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const v={INVALID_ERROR_ID:"INVALID_ERROR_ID",INVALID_ERROR_REASON:"INVALID_ERROR_REASON",ACCESS_DENIED:"ACCESS_DENIED",AGE_GATE:"AGE_GATE",AUTHORIZATION_ERROR:"AUTHORIZATION_ERROR",BUFFER_STALLED_ERROR:"BUFFER_STALLED_ERROR",CONFIGURATION_ERROR:"CONFIGURATION_ERROR",CONTENT_EQUIVALENT:"CONTENT_EQUIVALENT",CONTENT_RESTRICTED:"CONTENT_RESTRICTED",CONTENT_UNAVAILABLE:"CONTENT_UNAVAILABLE",CONTENT_UNSUPPORTED:"CONTENT_UNSUPPORTED",DEVICE_LIMIT:"DEVICE_LIMIT",GEO_BLOCK:"GEO_BLOCK",INVALID_ARGUMENTS:"INVALID_ARGUMENTS",PLAYREADY_CBC_ENCRYPTION_ERROR:"PLAYREADY_CBC_ENCRYPTION_ERROR",MEDIA_CERTIFICATE:"MEDIA_CERTIFICATE",MEDIA_DESCRIPTOR:"MEDIA_DESCRIPTOR",MEDIA_LICENSE:"MEDIA_LICENSE",MEDIA_KEY:"MEDIA_KEY",MEDIA_PLAYBACK:"MEDIA_PLAYBACK",MEDIA_SESSION:"MEDIA_SESSION",NETWORK_ERROR:"NETWORK_ERROR",NOT_FOUND:"NOT_FOUND",NOT_IMPLEMENTED:"NOT_IMPLEMENTED",PARSE_ERROR:"PARSE_ERROR",PLAY_ACTIVITY:"PLAY_ACTIVITY",REQUEST_ERROR:"REQUEST_ERROR",QUOTA_EXCEEDED:"QUOTA_EXCEEDED",SERVER_ERROR:"SERVER_ERROR",SERVICE_UNAVAILABLE:"SERVICE_UNAVAILABLE",STREAM_UPSELL:"STREAM_UPSELL",SUBSCRIPTION_ERROR:"SUBSCRIPTION_ERROR",TOKEN_EXPIRED:"TOKEN_EXPIRED",UNAUTHORIZED_ERROR:"UNAUTHORIZED_ERROR",UNKNOWN_ERROR:"UNKNOWN_ERROR",UNSUPPORTED_ERROR:"UNSUPPORTED_ERROR",USER_INTERACTION_REQUIRED:"USER_INTERACTION_REQUIRED",INTERNAL_ERROR:"INTERNAL_ERROR",OUTPUT_RESTRICTED:"OUTPUT_RESTRICTED",WIDEVINE_CDM_EXPIRED:"WIDEVINE_CDM_EXPIRED"},m={400:v.REQUEST_ERROR,401:v.UNAUTHORIZED_ERROR,403:v.ACCESS_DENIED,404:v.NOT_FOUND,405:v.NOT_FOUND,413:v.REQUEST_ERROR,414:v.REQUEST_ERROR,429:v.QUOTA_EXCEEDED,500:v.SERVER_ERROR,501:v.NOT_FOUND,503:v.SERVICE_UNAVAILABLE},g={"-1003":v.MEDIA_LICENSE,"-1004":v.DEVICE_LIMIT,"-1017":v.GEO_BLOCK,1010:v.NOT_FOUND,2002:v.AUTHORIZATION_ERROR,2034:v.TOKEN_EXPIRED,3059:v.DEVICE_LIMIT,3063:v.SUBSCRIPTION_ERROR,3076:v.CONTENT_UNAVAILABLE,3082:v.CONTENT_RESTRICTED,3084:v.STREAM_UPSELL,5002:v.SERVER_ERROR,180202:v.PLAYREADY_CBC_ENCRYPTION_ERROR,190121:v.WIDEVINE_CDM_EXPIRED},b=new Set([v.CONTENT_EQUIVALENT,v.CONTENT_UNAVAILABLE,v.CONTENT_UNSUPPORTED,v.SERVER_ERROR,v.SUBSCRIPTION_ERROR,v.UNSUPPORTED_ERROR,v.USER_INTERACTION_REQUIRED]);class MKError extends Error{static isMKError(e){return function(e){return void 0!==e&&e instanceof MKError}(e)}get errorCode(){return this.reason}static playActivityError(e){return new this(v.PLAY_ACTIVITY,e)}static parseError(e){return new this(v.PARSE_ERROR,e)}static responseError(e){const{status:t,statusText:r}=e,n=new this(m[t]||v.NETWORK_ERROR,r||""+t);return n.data=e,n}static serverError(e,t=v.UNKNOWN_ERROR){let{status:r,dialog:n,failureType:i,customerMessage:o,errorMessage:a,message:s}=e;n&&(s=n.message||n.customerMessage||n.errorMessage,n.message=s);const c=g[i]||g[r]||t,l=new this(c,s||o||a);return c===v.STREAM_UPSELL&&n&&n.okButtonAction&&n.okButtonAction.url&&(n.okButtonAction.url=n.okButtonAction.url.replace(/\&(?:challenge|key-system|uri|user-initiated)=[^\&]+/gim,"")),l.dialog=n,l}static internalError(e){return new this(v.INTERNAL_ERROR,e)}constructor(e,t){super(),_define_property$1Z(this,"isMKError",!0),_define_property$1Z(this,"reason",v.UNKNOWN_ERROR),_define_property$1Z(this,"description",void 0),_define_property$1Z(this,"dialog",void 0),_define_property$1Z(this,"data",void 0),e&&b.has(e)?(this.name=this.reason=e,this.message=this.description=t||e):t||"string"!=typeof e?(this.name=this.reason=e||v.UNKNOWN_ERROR,t&&(this.message=this.description=t)):(this.name=this.reason=v.UNKNOWN_ERROR,this.message=this.description=e),Error.captureStackTrace&&Error.captureStackTrace(this,MKError)}}function flattenAll(e){return function(e,t=1){if("function"==typeof Array.prototype.flat)return Array.prototype.flat.call(e,t);if(null==e)throw new TypeError("Cannot convert undefined or null to object");return Array.isArray(e)||(e=Array.from(e)),function flat(e,t){return t<=0?e.slice():Array.prototype.reduce.call(e,(function(e,r){return Array.isArray(r)?e.concat(flat(r,t-1)):[...e,r]}),[])}(e,t)}(e,1/0)}_define_property$1Z(MKError,"Reason",v),Object.assign(MKError,v);function invoke(e){return void 0===e||(e=>"function"!=typeof e)(e)?e:e()}function isObject$1(e){return!!e&&"object"==typeof e&&!Array.isArray(e)}function isFunction$2(e){return"function"==typeof e}function isString$1(e){return"string"==typeof e}function isEmptyString$1(e,t){if(!isString$1(e))return!1;return 0===(!0===(null==t?void 0:t.trim)?e.trim():e).length}function _define_property$1Y(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$S(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1Y(e,t,r[t])}))}return e}function _object_spread_props$v(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const S=function(e){return"boolean"==typeof e}(P=isEmptyString$1)?!P:function(...e){return!P(...e)};var P;function formatPrimitive(e,t){const r=t.path.map((e,r)=>0===r?t.encode(e):`[${t.encode(e)}]`).join("");return null===e?r:`${r}=${t.encode(e)}`}const E={comma:function(e,t){return formatPrimitive(e.join(","),t)},repeat:function(e,t){return e.map(e=>formatPrimitive(String(e),t)).filter(e=>e.length>0).join("&")},bracket:function(e,t){return e.map((function(e){return t.next(e,_object_spread_props$v(_object_spread$S({},t),{path:[...t.path,""]}))})).filter(S).join("&")},index:function(e,t){return e.map((function(e,r){return t.next(e,_object_spread_props$v(_object_spread$S({},t),{path:[...t.path,String(r)]}))})).filter(S).join("&")}},T={bracket:function(e,t){return Object.keys(e).sort(t.sort).map((function(r){return t.next(e[r],_object_spread_props$v(_object_spread$S({},t),{path:t.path.concat(r)}))})).filter(S).join("&")}},DEFAULT_ENCODER=e=>encodeURIComponent(String(e)),STRING_ENCODER=e=>String(e);function encodeQueryParameters(e,t){if(!e)return"";let r="";if(!0===(null==t?void 0:t.prefix)?r="?":isString$1(null==t?void 0:t.prefix)&&(r=t.prefix),isString$1(e))return r+e.replace(/^[?&]+/,"");var n;const i=isFunction$2(null==t?void 0:t.arrayFormat)?t.arrayFormat:E[null!==(n=null==t?void 0:t.arrayFormat)&&void 0!==n?n:"comma"];var o;const a=isFunction$2(null==t?void 0:t.objectFormat)?t.objectFormat:T[null!==(o=null==t?void 0:t.objectFormat)&&void 0!==o?o:"bracket"];var s;const c=null!==(s=null==t?void 0:t.sort)&&void 0!==s?s:(...e)=>0;let l=DEFAULT_ENCODER;isFunction$2(null==t?void 0:t.encode)?l=t.encode:!1===(null==t?void 0:t.encode)&&(l=STRING_ENCODER);const d=a(e,{path:[],next:function(e,r){return function(e,t){return void 0===e&&!1!==(null==t?void 0:t.skipUndefined)||(null===e&&!1!==(null==t?void 0:t.skipNull)||!(!isEmptyString$1(e)||!1===(null==t?void 0:t.skipEmptyString)))}(e,t)?"":isObject$1(e)?a(e,r):Array.isArray(e)?i(e,r):formatPrimitive(e,r)},encode:l,sort:c});return""===d?"":r+d}function _define_property$1X(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const DEFAULT_CACHE_KEY_FUNCTION=(e,t)=>`${t}${e}`;class NetworkCache{getItem(e){const t=this.cacheKeyForPath(e),r=this.storage.getItem(t);if(null!==r){const{x:e,d:n}=JSON.parse(r);if(e>Date.now())return n;this.storage.removeItem(t)}}setItem(e,t,r=this.ttl){const n=this.cacheKeyForPath(e);this.storage.setItem(n,JSON.stringify({x:Date.now()+r,d:t}))}removeItem(e){const t=this.cacheKeyForPath(e);this.storage.removeItem(t)}removeItemsMatching(e,t=!0){const r=this.cacheKeyForPath(e);this.removeItemsMatchingCacheKey(r,t)}clear(){this.removeItemsMatchingCacheKey(this.prefix,!1)}removeItemsMatchingCacheKey(e,t){const r=new RegExp(`^${e}${t?"$":""}`);(this.storage instanceof GenericStorage?this.storage.keys:Object.keys(this.storage)).forEach(e=>{e&&r.test(e)&&this.storage.removeItem(e)})}cacheKeyForPath(e){return this.cacheKeyFunction(e,this.prefix)}constructor(e={}){_define_property$1X(this,"storage",void 0),_define_property$1X(this,"prefix",void 0),_define_property$1X(this,"ttl",void 0),_define_property$1X(this,"cacheKeyFunction",void 0),this.storage=e.storage||new GenericStorage,this.prefix=e.prefix||"",this.ttl=e.ttl||3e5,this.cacheKeyFunction=e.cacheKeyFunction||DEFAULT_CACHE_KEY_FUNCTION}}function joinURLPath(...e){const t=flattenAll(e).map(e=>e instanceof URL?e.pathname:e).filter(e=>"string"==typeof e&&0!==e.trim().length);if(0===t.length)return"";let r=t[0];for(let n=1;n<t.length;n++)r=r.replace(/[/]+$/,"")+"/"+t[n].replace(/^[/]+/,"");return/^([a-z][a-z0-9\-_+]+)?:\/\//i.test(r)||(r="/"+r.replace(/^[/]+/,"")),r}function splitURLPath(e){e instanceof URL&&(e=e.pathname);const t=[],r=e.lastIndexOf("#");-1!==r&&(t.unshift(e.slice(r)),e=e.slice(0,r));const n=e.lastIndexOf("?");return-1!==n&&(t.unshift(e.slice(n)),e=e.slice(0,n)),[...e.split(RegExp("(?<![/:]+)\\/+")),...t].filter(e=>0!==e.trim().length)}function _define_property$1W(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$R(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1W(e,t,r[t])}))}return e}function _object_spread_props$u(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const k="undefined"!=typeof Headers,headersToDict=e=>{let t={};var r;return r=e,k&&r instanceof Headers?e.forEach((e,r)=>t[r]=e):Array.isArray(e)?e.forEach(([e,r])=>t[e]=r):t=e,t},mergeFetchHeaders=(e={},t={})=>_object_spread$R({},headersToDict(e),headersToDict(t)),mergeFetchOptions=(e,t)=>{if(e||t)return(null==e?void 0:e.headers)&&(null==t?void 0:t.headers)?_object_spread_props$u(_object_spread$R({},e,t),{headers:mergeFetchHeaders(e.headers,t.headers)}):_object_spread$R({},e,t)};function parseQueryParams(e){if(!e||e.startsWith("http")&&!e.includes("?"))return{};try{var t;return parseParams(null!==(t=e.split("?")[1])&&void 0!==t?t:e,"&",decodeURIComponent)}catch(r){return{}}}function parseParams(e,t="&",r=(e=>e)){return"string"!=typeof e?{}:e.split(t).map(e=>e.trim().split("=",2)).reduce((e,t)=>{const[n,i]=t;return""===n&&void 0===i||(e[r(n)]=r(i),void 0===i&&(e[r(n)]=void 0)),e},{})}function getMaxAgeFromHeaders(e){const t=function(e,t){if(void 0!==t)return k&&t instanceof Headers?t.get(e):t[e]}("cache-control",e);if(t){return(e=>{const t=Number(e);if(Number.isFinite(t))return t})(parseParams(t,",")["max-age"])}}function buildURL(e,t,r){isObject$1(t)&&(r=t,t="");const n=joinURLPath([e,null!=t?t:""]);let i="?";n.endsWith("&")||n.endsWith("?")?i="":n.includes("?")&&(i="&");return n+(void 0!==r?encodeQueryParameters(r,{prefix:i}):"")}function asyncGeneratorStep$1q(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _define_property$1V(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$Q(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1V(e,t,r[t])}))}return e}var w;!function(e){e.JSON="application/json",e.FORM="application/x-www-form-urlencoded"}(w||(w={}));class TokenSession extends class{clearCacheForRequest(e,t){"object"==typeof e&&(t=e,e=void 0),this.networkCache.removeItemsMatching(buildURL(this.url,null!=e?e:"",t))}request(e,t,r){var n,i=this;return(n=function*(){r||"object"!=typeof e||(r=t||{},t=e,e=void 0);let n={};"object"==typeof(r=_object_spread$Q({method:i.method,headers:i.headers,reload:!1},i._fetchOptions,r)).queryParameters?(n=r.queryParameters,delete r.queryParameters):"GET"!==r.method&&"DELETE"!==r.method||(n=t);const o=buildURL(i.url,null!=e?e:"",n),{method:a,reload:s=!1,useRawResponse:c}=r;if(r.headers=i.buildHeaders(r),delete r.reload,delete r.useRawResponse,"GET"===a&&!s){const e=i.getCacheItem(o);if(e)return Promise.resolve(e)}t&&Object.keys(t).length&&("POST"===a||"PUT"===a)&&(r.body=r.body||t,"application/x-www-form-urlencoded"===r.contentType?(r.body=encodeQueryParameters(r.body),r.headers.set("Content-Type","application/x-www-form-urlencoded")):(r.body=JSON.stringify(r.body),r.headers.set("Content-Type","application/json")));const l=yield i._fetchFunction(o,r);if(!l.ok)return Promise.reject(l);let d;try{d=yield l.json()}catch(h){d={}}if(d.errors)return Promise.reject(d.errors);const u=c?d:d.results||d.data||d;if("GET"===a){var p;const e=null!==(p=getMaxAgeFromHeaders(l.headers))&&void 0!==p?p:i.ttl;i.setCacheItem(o,u,e)}return u},function(){var e=this,t=arguments;return new Promise((function(r,i){var o=n.apply(e,t);function _next(e){asyncGeneratorStep$1q(o,r,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1q(o,r,i,_next,_throw,"throw",e)}_next(void 0)}))})()}buildHeaders({headers:e,reload:t=!1}={}){void 0===e&&(e=this.headers);const r=(e=>new e.constructor(e))(e);return t&&r.set("Cache-Control","no-cache"),r}getCacheItem(e){const t=this.networkCache.storage,r=`${this.prefix}${this.prefix}cache-mut`,n=t.getItem(r)||null,i=this.headers.get("Music-User-Token")||this.headers.get("Media-User-Token")||null;return i!==n&&(this.networkCache.clear(),null===i?t.removeItem(r):t.setItem(r,i)),this.networkCache.getItem(e)}setCacheItem(e,t,r=this.ttl){this.networkCache.setItem(e,t,r)}clearNetworkCache(){this.networkCache.clear()}_key(e,t){const r=function(e){try{const[t,r]=e.split("?",2);if(void 0===r)return t;const n=r.split("&").map(e=>e.split("=",2)),i=[...Array(n.length).keys()];i.sort((e,t)=>{const r=n[e],i=n[t];return r<i?-1:r>i?1:e-t});const o=i.map(e=>n[e]);return`${t}?${o.map(([e,t])=>void 0!==t?`${e}=${t}`:e).join("&")}`}catch(t){return e}}(e).toLowerCase().replace(this.url,"");return`${this.prefix}${r.replace(/[^-_0-9a-z]{1,}/g,".")}`}constructor(e,t){if(_define_property$1V(this,"url",void 0),_define_property$1V(this,"headers",void 0),_define_property$1V(this,"prefix",""),_define_property$1V(this,"storage",void 0),_define_property$1V(this,"networkCache",void 0),_define_property$1V(this,"ttl",void 0),_define_property$1V(this,"method","GET"),_define_property$1V(this,"_fetchOptions",void 0),_define_property$1V(this,"_fetchFunction",void 0),this.url=e,(t=t||{}).storage&&t.underlyingStorage)throw new Error("only pass storage OR underlyingStorage in sessionOptions to URLSession");const r=t.underlyingStorage||{};if(this.storage=t.storage||new GenericStorage(r),this.networkCache=new NetworkCache({storage:this.storage,prefix:this.prefix,cacheKeyFunction:this._key.bind(this)}),this.ttl=t.ttl||3e5,this._fetchOptions=_object_spread$Q({},t.fetchOptions),"function"!=typeof t.fetch&&"function"!=typeof fetch)throw new Error("window.fetch is not defined");var n;this._fetchFunction=null!==(n=t.fetch)&&void 0!==n?n:fetch.bind(window),this.headers=this._fetchOptions.headers||new Headers,delete this._fetchOptions.headers}}{get developerToken(){return this._developerToken.token}constructor(e,t,r){super(e,r),_define_property$1V(this,"userToken",void 0),_define_property$1V(this,"_developerToken",void 0),this._developerToken=new DeveloperToken(t),this.headers.set("Authorization","Bearer "+this.developerToken),r=r||{},this.userToken=r.userToken,this.userToken&&this.headers.set("Media-User-Token",this.userToken)}}function parseVersion(e){const t={version:e.toLowerCase()},r=e.toLowerCase().split(".").filter(e=>!!e);if(r.length<=1&&!/^\d+$/.test(r[0]))return t;const n=parseInt(r[0],10),i=parseInt(r[1],10),o=parseInt(r[2],10);return Number.isNaN(n)||(t.major=n,Number.isNaN(i)||(t.minor=i),Number.isNaN(o)||(t.patch=o)),t}function applyRules(e,t,r){const{userAgent:n}=null!=t?t:{};if("string"!=typeof n||""===n.trim())return r;for(let i of e){const e=i.slice(0,-1),o=i[i.length-1];let a=null;for(let i of e)if(a=n.match(i),null!==a){Object.assign(r,o(a,t,r));break}if(null!==a)break}return r}function _define_property$1U(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$P(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1U(e,t,r[t])}))}return e}function _object_spread_props$t(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}var O,I;const A={browser:[[/^(itunes|music|tv)\/([\w\.]+)\s/i,e=>_object_spread_props$t(_object_spread$P({name:"webview",variant:e[1].trim().toLowerCase().replace(/(music|tv)/i,"$1.app")},parseVersion(e[2])),{mobile:!1})],[/(?:(?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i,e=>_object_spread$P({name:"webview",variant:"facebook",mobile:!0},parseVersion(e[1]))],[/(instagram|snapchat)[\/ ]([-\w\.]+)/i,e=>_object_spread$P({name:"webview",variant:e[1].trim().toLowerCase(),mobile:!0},parseVersion(e[2]))],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i,e=>_object_spread$P({name:"webview",variant:"tiktok",mobile:!0},parseVersion(e[1]))],[/twitter/i,()=>({name:"webview",variant:"twitter",mobile:!0})],[/ wv\).+?(?:version|chrome)\/([\w\.]+)/i,e=>_object_spread$P({name:"webview",mobile:!0},parseVersion(e[1]))],[/electron\/([\w\.]+) safari/i,e=>_object_spread$P({name:"electron",mobile:!1},parseVersion(e[1]))],[/tesla\/(.*?(20\d\d\.([-\w\.])+))/i,e=>_object_spread_props$t(_object_spread$P({name:"other",variant:"tesla",mobile:!1},parseVersion(e[2])),{version:e[1]})],[/(samsung|huawei)browser\/([-\w\.]+)/i,e=>_object_spread$P({name:"other",variant:e[1].trim().toLowerCase().replace(/browser/i,""),mobile:!0},parseVersion(e[2]))],[/yabrowser\/([-\w\.]+)/i,e=>_object_spread$P({name:"other",variant:"yandex",mobile:!1},parseVersion(e[1]))],[/(brave|flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,(e,{userAgent:t})=>_object_spread$P({name:"other",variant:e[1].trim().toLowerCase(),mobile:/mobile/i.test(t)},parseVersion(e[2].replace(/\-/g,".")))],[/edg(e|ios|a)?\/([\w\.]+)/i,e=>_object_spread$P({name:"edge",mobile:/(edgios|edga)/i.test(null!==(O=e[1])&&void 0!==O?O:"")},parseVersion(e[2]))],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i,e=>_object_spread$P({name:"ie",mobile:!1},parseVersion(e[1]))],[/opr\/([\w\.]+)/i,/opera mini\/([-\w\.]+)/i,/opera [mobiletab]{3,6}\b.+version\/([-\w\.]+)/i,/opera(?:.+version\/|[\/ ]+)([\w\.]+)/i,e=>_object_spread$P({name:"opera",mobile:/mobile/i.test(e[0])},parseVersion(e[1]))],[/headlesschrome(?:\/([\w\.]+)| )/i,e=>_object_spread$P({name:"chrome",variant:"headless",mobile:!1},parseVersion(e[1]))],[/\b(?:crmo|crios)\/([\w\.]+)/i,e=>_object_spread$P({name:"chrome",mobile:!0},parseVersion(e[1]))],[/chrome(?: browser)?\/v?([\w\.]+)( mobile)?/i,e=>_object_spread$P({name:"chrome",mobile:/mobile/i.test(null!==(I=e[2])&&void 0!==I?I:"")},parseVersion(e[1]))],[/\bfocus\/([\w\.]+)/i,e=>_object_spread$P({name:"firefox",variant:"focus",mobile:!0},parseVersion(e[1]))],[/fxios\/([\w\.-]+)/i,/(?:mobile|tablet);.*(?:firefox)\/([\w\.-]+)/i,e=>_object_spread$P({name:"firefox",mobile:!0},parseVersion(e[1]))],[/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,e=>_object_spread$P({name:"firefox",variant:e[1].trim().toLowerCase(),mobile:!1},parseVersion(e[2]))],[/(?:firefox)\/([\w\.]+)/i,/(?:mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,e=>_object_spread$P({name:"firefox",mobile:!1},parseVersion(e[1]))],[/version\/([\w\.\,]+) .*mobile(?:\/\w+ | ?)safari/i,/version\/([\w\.\,]+) .*(safari)/i,/webkit.+?(?:mobile ?safari|safari)(?:\/([\w\.]+))/i,e=>_object_spread$P({name:"safari",mobile:/mobile/i.test(e[0])},parseVersion(e[1]))]],engine:[[/webkit\/(?:537\.36).+chrome\/(?!27)([\w\.]+)/i,e=>_object_spread$P({name:"blink"},parseVersion(e[1]))],[/windows.+ edge\/([\w\.]+)/i,e=>_object_spread$P({name:"blink"},parseVersion(e[1]))],[/presto\/([\w\.]+)/i,e=>_object_spread$P({name:"presto"},parseVersion(e[2]))],[/trident\/([\w\.]+)/i,e=>_object_spread$P({name:"trident"},parseVersion(e[1]))],[/gecko\/([\w\.]+)/i,e=>_object_spread$P({name:"gecko"},parseVersion(e[1]))],[/(khtml|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,e=>_object_spread$P({name:"other"},parseVersion(e[2]))],[/webkit\/([\w\.]+)/i,e=>_object_spread$P({name:"webkit"},parseVersion(e[1]))]],os:[[/microsoft windows (vista|xp)/i,/windows nt 6\.2; (arm)/i,/windows (?:phone(?: os)?|mobile)[\/ ]?([\d\.\w ]*)/i,/windows[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i,e=>_object_spread$P({name:"windows"},parseVersion(e[1]))],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,e=>_object_spread$P({name:"ios"},parseVersion(e[1].replace(/_/g,".")))],[/mac(?:intosh;?)? os x ?([\d\._]+)/i,e=>_object_spread$P({name:"macos"},parseVersion(e[1].replace(/_/g,".")))],[/cros [\w]+(?:\)| ([\w\.]+)\b)/i,e=>_object_spread$P({name:"chromeos"},parseVersion(e[1]))],[/(?:android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/droid ([\w\.]+|[\d+])\b.+(android[- ]x86|harmonyos)/i,e=>_object_spread$P({name:"android"},parseVersion(e[1]))],[/linux/i,()=>({name:"linux"})]]};function parseUserAgent(e,t){var r,n,i;var o;return function(e,t){let r=e;for(let n of t)r=n(r);return r}({navigator:e,ua:null!==(i=null===(r=e)||void 0===r?void 0:r.userAgent)&&void 0!==i?i:"",extensions:[],browser:applyRules(A.browser,e,{name:"unknown",mobile:!1}),engine:applyRules(A.engine,e,{name:"unknown"}),os:applyRules(A.os,e,{name:"unknown"})},null!==(o=null===(n=t)||void 0===n?void 0:n.extensions)&&void 0!==o?o:[])}function _define_property$1T(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$O(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1T(e,t,r[t])}))}return e}function _object_spread_props$s(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function flagsExtension(e){let t=e.os.name;const r="android"===e.os.name;let n="macos"===e.os.name,i="ios"===e.os.name;var o;const a="ipados"===t||i&&/ipad/i.test(e.ua)||n&&(null!==(o=e.navigator.maxTouchPoints)&&void 0!==o?o:0)>=2;a&&(t="ipados",i=!1,n=!1);const s=_object_spread_props$s(_object_spread$O({},e.browser),{isUnknown:"unknown"===e.browser.name,isSafari:"safari"===e.browser.name,isChrome:"chrome"===e.browser.name,isFirefox:"firefox"===e.browser.name,isEdge:"edge"===e.browser.name,isWebView:"webview"===e.browser.name,isOther:"other"===e.browser.name,isMobile:e.browser.mobile||i||a||r||!1}),c=_object_spread_props$s(_object_spread$O({},e.engine),{isUnknown:"unknown"===e.engine.name,isWebKit:"webkit"===e.engine.name,isBlink:"blink"===e.engine.name,isGecko:"gecko"===e.engine.name}),l=_object_spread_props$s(_object_spread$O({},e.os),{name:t,isUnknown:"unknown"===e.os.name,isLinux:"linux"===e.os.name,isWindows:"windows"===e.os.name,isMacOS:n,isAndroid:r,isIOS:i,isIPadOS:a});return _object_spread_props$s(_object_spread$O({},e),{extensions:[...e.extensions,"flags"],browser:s,os:l,engine:c})}function asyncGeneratorStep$1p(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$1p(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1p(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1p(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function isBrowserEnvironment(){return _isBrowserEnvironment.apply(this,arguments)}function _isBrowserEnvironment(){return(_isBrowserEnvironment=_async_to_generator$1p((function*(){var e;return void 0!==(null===(e=window)||void 0===e?void 0:e.navigator)}))).apply(this,arguments)}function asyncGeneratorStep$1o(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$1o(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1o(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1o(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function isNodeEnvironment(){return _isNodeEnvironment.apply(this,arguments)}function _isNodeEnvironment(){return(_isNodeEnvironment=_async_to_generator$1o((function*(){var e;return void 0!==(null===(e=globalThis)||void 0===e?void 0:e.process)}))).apply(this,arguments)}function asyncGeneratorStep$1n(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$1n(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1n(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1n(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}const R={playready:["com.microsoft.playready","com.youtube.playready"],widevine:["com.widevine.alpha"],clearkey:["org.w3.clearkey"],fairplay:["com.apple.fps","com.apple.fairplay"]};function detectEMESupport(){return _detectEMESupport.apply(this,arguments)}function _detectEMESupport(){return(_detectEMESupport=_async_to_generator$1n((function*(){var e,t,r,n;return void 0!==(null===(t=window)||void 0===t||null===(e=t.navigator)||void 0===e?void 0:e.requestMediaKeySystemAccess)&&void 0!==(null===(r=window)||void 0===r?void 0:r.MediaKeys)&&void 0!==(null===(n=window)||void 0===n?void 0:n.MediaKeySystemAccess)}))).apply(this,arguments)}function detectEMEKeySystems(){return _detectEMEKeySystems.apply(this,arguments)}function _detectEMEKeySystems(){return(_detectEMEKeySystems=_async_to_generator$1n((function*(){var e,t;if(yield isNodeEnvironment())return[];const r=[],n=window;if("function"==typeof(null===(e=n.WebKitMediaKeys)||void 0===e?void 0:e.isTypeSupported))for(let s of R.fairplay){var i,o;if((null===(i=n.WebKitMediaKeys)||void 0===i?void 0:i.isTypeSupported(s,"video/mp4"))||(null===(o=n.WebKitMediaKeys)||void 0===o?void 0:o.isTypeSupported(s+".1_0","video/mp4")))return r.push("fairplay"),r}if("function"==typeof(null===(t=n.MSMediaKeys)||void 0===t?void 0:t.isTypeSupported))for(let s of R.playready)n.MSMediaKeys.isTypeSupported(s,"video/mp4")&&r.push("playready");if(yield detectEMESupport()){const e=[{initDataTypes:["keyids","cenc"],distinctiveIdentifier:"optional",persistentState:"required",videoCapabilities:[{contentType:'video/mp4;codecs="avc1.42E01E"',robustness:"SW_SECURE_CRYPTO"}],audioCapabilities:[{contentType:'audio/mp4;codecs="mp4a.40.2"'}]}];for(let[t,n]of Object.entries(R))for(let i of n)try{yield navigator.requestMediaKeySystemAccess(i,e),r.push(t);break}catch(a){}}return r}))).apply(this,arguments)}function asyncGeneratorStep$1m(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$1m(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1m(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1m(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function detectMMSSupport(){return _detectMMSSupport.apply(this,arguments)}function _detectMMSSupport(){return(_detectMMSSupport=_async_to_generator$1m((function*(){var e,t,r,n,i,o;const a=null===(e=window)||void 0===e?void 0:e.ManagedSourceBuffer,s="function"==typeof(null===(r=a)||void 0===r||null===(t=r.prototype)||void 0===t?void 0:t.appendBuffer)&&"function"==typeof(null===(i=a)||void 0===i||null===(n=i.prototype)||void 0===n?void 0:n.remove);return void 0!==(null===(o=window)||void 0===o?void 0:o.ManagedMediaSource)&&s}))).apply(this,arguments)}function asyncGeneratorStep$1l(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$1l(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1l(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1l(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function detectMSESupport(){return _detectMSESupport.apply(this,arguments)}function _detectMSESupport(){return(_detectMSESupport=_async_to_generator$1l((function*(){var e,t;return void 0!==(null===(e=window)||void 0===e?void 0:e.MediaSource)&&void 0!==(null===(t=window)||void 0===t?void 0:t.SourceBuffer)}))).apply(this,arguments)}function asyncGeneratorStep$1k(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$1k(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1k(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1k(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function detectPictureInPictureSupport(){return _detectPictureInPictureSupport.apply(this,arguments)}function _detectPictureInPictureSupport(){return(_detectPictureInPictureSupport=_async_to_generator$1k((function*(){var e,t,r;if(yield isNodeEnvironment())return!1;const n=document.createElement("video");return void 0!==(null===(e=n)||void 0===e?void 0:e.webkitSupportsPresentationMode)&&"function"==typeof(null===(t=n)||void 0===t?void 0:t.webkitSetPresentationMode)||void 0!==(null===(r=document)||void 0===r?void 0:r.pictureInPictureEnabled)}))).apply(this,arguments)}function asyncGeneratorStep$1j(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _define_property$1S(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class RuntimeEnvironment{get isConfigured(){return this.configured}get userAgent(){return this.config.userAgent}get ua(){return this.userAgent.ua}get isNodeEnvironment(){return this.config.isNodeEnvironment}get isBrowserEnvironment(){return this.config.isBrowserEnvironment}get isPictureInPictureSupported(){return this.config.isPictureInPictureSupported}get isMMSSupported(){return this.config.isMMSSupported}get isMSESupported(){return this.config.isMSESupported}get isEMESupported(){return this.config.isEMESupported}get availableKeySystems(){return this.config.availableKeySystems}get browser(){return this.userAgent.browser}get engine(){return this.userAgent.engine}get os(){return this.userAgent.os}get isMobile(){return this.browser.isMobile}static detect(){var e,t=this;return(e=function*(){var e,r;const n=null!==(r=null===(e=window)||void 0===e?void 0:e.navigator)&&void 0!==r?r:{userAgent:"",maxTouchPoints:0};return new t({userAgent:yield parseUserAgent(n,{extensions:[flagsExtension]}),isNodeEnvironment:yield isNodeEnvironment(),isBrowserEnvironment:yield isBrowserEnvironment(),isPictureInPictureSupported:yield detectPictureInPictureSupport(),isMMSSupported:yield detectMMSSupport(),isMSESupported:yield detectMSESupport(),isEMESupported:yield detectEMESupport(),availableKeySystems:yield detectEMEKeySystems()})},function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1j(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1j(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}configure(e){for(const[t,r]of Object.entries(e))this.config[t]=r;this.configured=!0}constructor(e){_define_property$1S(this,"configured",!1),_define_property$1S(this,"config",void 0),this.config=e,this.configured=!0}}function dasherize$1(e){return e.replace(/([A-Z])/g,"-$1").replace(/[-_\s]+/g,"-").replace(/(^-+)|(-+$)/,"").toLowerCase()}const $=new Map;function pluralizeMediaType(e){if($.has(e))return $.get(e);let t=dasherize$1(e);return e.endsWith("y")?t=t.substring(0,t.length-1)+"ies":t.endsWith("s")||(t+="s"),$.set(e,t),t}class PubSub{publish(e,t){const r=this.getSubscribersForType(e);void 0!==r&&r.forEach(r=>{r(e,t)})}subscribe(e,t){this.getSubscribersForType(e,!0).push(t)}subscribeOnce(e,t){const onceCallback=(e,r)=>{this.unsubscribe(e,onceCallback),t(e,r)};this.subscribe(e,onceCallback)}unsubscribe(e,t){const r=this.getSubscribersForType(e);if(void 0!==r)for(let n=0;n<r.length;n++)if(r[n]===t){r.splice(n,1);break}}clear(e){void 0===e?this.events={}:delete this.events[e]}getSubscribersForType(e,t=!1){return void 0===this.events[e]&&t&&(this.events[e]=[]),this.events[e]}constructor(){!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"events",Object.create(null))}}function asyncGeneratorStep$1i(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$1i(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1i(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1i(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1Q(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class RequestManager{static create(e){var t=this;return _async_to_generator$1i((function*(){return new t(e)}))()}get fetch(){if(void 0===this.fetchFunction)throw new MKError(MKError.Reason.INTERNAL_ERROR,"Could not find fetch implementation");return this.fetchFunction}get isConfigured(){return this.configured}configure(e){void 0!==(null==e?void 0:e.fetchFunction)&&(this.fetchFunction=e.fetchFunction),this.configured=!0}buildURL(e,t,r){return new URL(buildURL(e,t,r))}buildHeaders(...e){return flattenAll(e).reduce((function(e,t){let r;return r=t instanceof Headers||t instanceof Map?Array.from(t.entries()):Object.entries(t),r.map(([t,r])=>e.set(t,r)),e}),new Headers)}buildRequest(e,t){return new Request(new URL(e),t)}fetchText(e){var t=this;return _async_to_generator$1i((function*(){let r;try{r=yield t.fetch(e)}catch(De){const r=e instanceof Request?e.url:String(e);throw new MKError(MKError.Reason.NETWORK_ERROR,"Unable to complete request for "+r)}try{return yield r.text()}catch(De){const r=e instanceof Request?e.url:String(e);throw new MKError(MKError.Reason.REQUEST_ERROR,"Unable to read body as text for "+r)}}))()}fetchJSON(e){var t=this;return _async_to_generator$1i((function*(){let r;try{r=yield t.fetch(e)}catch(De){const r=e instanceof Request?e.url:String(e);throw new MKError(MKError.Reason.NETWORK_ERROR,"Unable to complete request for "+r)}try{return yield r.json()}catch(De){const r=e instanceof Request?e.url:String(e);throw new MKError(MKError.Reason.REQUEST_ERROR,"Unable to read body as JSON for "+r)}}))()}fetchArrayBuffer(e){var t=this;return _async_to_generator$1i((function*(){let r;try{r=yield t.fetch(e)}catch(De){const r=e instanceof Request?e.url:String(e);throw new MKError(MKError.Reason.NETWORK_ERROR,"Unable to complete request for "+r)}try{return yield r.arrayBuffer()}catch(De){const r=e instanceof Request?e.url:String(e);throw new MKError(MKError.Reason.REQUEST_ERROR,"Unable to read body as ArrayBuffer for "+r)}}))()}constructor(e){var t;_define_property$1Q(this,"configured",!1),_define_property$1Q(this,"fetchFunction",void 0!==(null===(t=globalThis)||void 0===t?void 0:t.fetch)?fetch.bind(globalThis):void 0),this.configure(null!=e?e:{})}}const C=new Map;function singularizeMediaType(e){if(C.has(e))return C.get(e);let t=dasherize$1(e);return t.endsWith("s")&&(t=t.slice(0,-1)),C.set(e,t),t}const D={AFG:"143610",AGO:"143564",AIA:"143538",ALB:"143575",AND:"143611",ARE:"143481",ARG:"143505",ARM:"143524",ATG:"143540",AUS:"143460",AUT:"143445",AZE:"143568",BEL:"143446",BEN:"143576",BFA:"143578",BGD:"143490",BGR:"143526",BHR:"143559",BHS:"143539",BIH:"143612",BLR:"143565",BLZ:"143555",BMU:"143542",BOL:"143556",BRA:"143503",BRB:"143541",BRN:"143560",BTN:"143577",BWA:"143525",CAF:"143623",CAN:"143455",CHE:"143459",CHL:"143483",CHN:"143465",CIV:"143527",CMR:"143574",COD:"143613",COG:"143582",COL:"143501",CPV:"143580",CRI:"143495",CYM:"143544",CYP:"143557",CZE:"143489",DEU:"143443",DMA:"143545",DNK:"143458",DOM:"143508",DZA:"143563",ECU:"143509",EGY:"143516",ESP:"143454",EST:"143518",ETH:"143569",FIN:"143447",FJI:"143583",FRA:"143442",FSM:"143591",GAB:"143614",GBR:"143444",GEO:"143615",GHA:"143573",GIN:"143616",GMB:"143584",GNB:"143585",GRC:"143448",GRD:"143546",GTM:"143504",GUY:"143553",HKG:"143463",HND:"143510",HRV:"143494",HUN:"143482",IDN:"143476",IND:"143467",IRL:"143449",IRQ:"143617",ISL:"143558",ISR:"143491",ITA:"143450",JAM:"143511",JOR:"143528",JPN:"143462",KAZ:"143517",KEN:"143529",KGZ:"143586",KHM:"143579",KNA:"143548",KOR:"143466",KWT:"143493",LAO:"143587",LBN:"143497",LBR:"143588",LBY:"143567",LCA:"143549",LIE:"143522",LKA:"143486",LTU:"143520",LUX:"143451",LVA:"143519",MAC:"143515",MAR:"143620",MCO:"143618",MDA:"143523",MDG:"143531",MDV:"143488",MEX:"143468",MKD:"143530",MLI:"143532",MLT:"143521",MMR:"143570",MNE:"143619",MNG:"143592",MOZ:"143593",MRT:"143590",MSR:"143547",MUS:"143533",MWI:"143589",MYS:"143473",NAM:"143594",NER:"143534",NGA:"143561",NIC:"143512",NLD:"143452",NOR:"143457",NPL:"143484",NRU:"143606",NZL:"143461",OMN:"143562",PAK:"143477",PAN:"143485",PER:"143507",PHL:"143474",PLW:"143595",PNG:"143597",POL:"143478",PRT:"143453",PRY:"143513",PSE:"143596",QAT:"143498",ROU:"143487",RUS:"143469",RWA:"143621",SAU:"143479",SEN:"143535",SGP:"143464",SLB:"143601",SLE:"143600",SLV:"143506",SRB:"143500",STP:"143598",SUR:"143554",SVK:"143496",SVN:"143499",SWE:"143456",SWZ:"143602",SYC:"143599",TCA:"143552",TCD:"143581",THA:"143475",TJK:"143603",TKM:"143604",TON:"143608",TTO:"143551",TUN:"143536",TUR:"143480",TWN:"143470",TZA:"143572",UGA:"143537",UKR:"143492",URY:"143514",USA:"143441",UZB:"143566",VCT:"143550",VEN:"143502",VGB:"143543",VNM:"143471",VUT:"143609",WSM:"143607",XKX:"143624",YEM:"143571",ZAF:"143472",ZMB:"143622",ZWE:"143605"};function asyncGeneratorStep$1h(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$1h(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1h(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1h(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}const M={AW:"ABW",AF:"AFG",AO:"AGO",AI:"AIA",AX:"ALA",AL:"ALB",AD:"AND",AE:"ARE",AR:"ARG",AM:"ARM",AS:"ASM",AQ:"ATA",TF:"ATF",AG:"ATG",AU:"AUS",AT:"AUT",AZ:"AZE",BI:"BDI",BE:"BEL",BJ:"BEN",BQ:"BES",BF:"BFA",BD:"BGD",BG:"BGR",BH:"BHR",BS:"BHS",BA:"BIH",BL:"BLM",BY:"BLR",BZ:"BLZ",BM:"BMU",BO:"BOL",BR:"BRA",BB:"BRB",BN:"BRN",BT:"BTN",BV:"BVT",BW:"BWA",CF:"CAF",CA:"CAN",CC:"CCK",CH:"CHE",CL:"CHL",CN:"CHN",CI:"CIV",CM:"CMR",CD:"COD",CG:"COG",CK:"COK",CO:"COL",KM:"COM",CV:"CPV",CR:"CRI",CU:"CUB",CW:"CUW",CX:"CXR",KY:"CYM",CY:"CYP",CZ:"CZE",DE:"DEU",DJ:"DJI",DM:"DMA",DK:"DNK",DO:"DOM",DZ:"DZA",EC:"ECU",EG:"EGY",ER:"ERI",EH:"ESH",ES:"ESP",EE:"EST",ET:"ETH",FI:"FIN",FJ:"FJI",FK:"FLK",FR:"FRA",FO:"FRO",FM:"FSM",GA:"GAB",GB:"GBR",GE:"GEO",GG:"GGY",GH:"GHA",GI:"GIB",GN:"GIN",GP:"GLP",GM:"GMB",GW:"GNB",GQ:"GNQ",GR:"GRC",GD:"GRD",GL:"GRL",GT:"GTM",GF:"GUF",GU:"GUM",GY:"GUY",HK:"HKG",HM:"HMD",HN:"HND",HR:"HRV",HT:"HTI",HU:"HUN",ID:"IDN",IM:"IMN",IN:"IND",IO:"IOT",IE:"IRL",IR:"IRN",IQ:"IRQ",IS:"ISL",IL:"ISR",IT:"ITA",JM:"JAM",JE:"JEY",JO:"JOR",JP:"JPN",KZ:"KAZ",KE:"KEN",KG:"KGZ",KH:"KHM",KI:"KIR",KN:"KNA",KR:"KOR",KW:"KWT",LA:"LAO",LB:"LBN",LR:"LBR",LY:"LBY",LC:"LCA",LI:"LIE",LK:"LKA",LS:"LSO",LT:"LTU",LU:"LUX",LV:"LVA",MO:"MAC",MF:"MAF",MA:"MAR",MC:"MCO",MD:"MDA",MG:"MDG",MV:"MDV",MX:"MEX",MH:"MHL",MK:"MKD",ML:"MLI",MT:"MLT",MM:"MMR",ME:"MNE",MN:"MNG",MP:"MNP",MZ:"MOZ",MR:"MRT",MS:"MSR",MQ:"MTQ",MU:"MUS",MW:"MWI",MY:"MYS",YT:"MYT",NA:"NAM",NC:"NCL",NE:"NER",NF:"NFK",NG:"NGA",NI:"NIC",NU:"NIU",NL:"NLD",NO:"NOR",NP:"NPL",NR:"NRU",NZ:"NZL",OM:"OMN",PK:"PAK",PA:"PAN",PN:"PCN",PE:"PER",PH:"PHL",PW:"PLW",PG:"PNG",PL:"POL",PR:"PRI",KP:"PRK",PT:"PRT",PY:"PRY",PS:"PSE",PF:"PYF",QA:"QAT",RE:"REU",RO:"ROU",RU:"RUS",RW:"RWA",SA:"SAU",SD:"SDN",SN:"SEN",SG:"SGP",GS:"SGS",SH:"SHN",SJ:"SJM",SB:"SLB",SL:"SLE",SV:"SLV",SM:"SMR",SO:"SOM",PM:"SPM",RS:"SRB",SS:"SSD",ST:"STP",SR:"SUR",SK:"SVK",SI:"SVN",SE:"SWE",SZ:"SWZ",SX:"SXM",SC:"SYC",SY:"SYR",TC:"TCA",TD:"TCD",TG:"TGO",TH:"THA",TJ:"TJK",TK:"TKL",TM:"TKM",TL:"TLS",TO:"TON",TT:"TTO",TN:"TUN",TR:"TUR",TV:"TUV",TW:"TWN",TZ:"TZA",UG:"UGA",UA:"UKR",UM:"UMI",UY:"URY",US:"USA",UZ:"UZB",VA:"VAT",VC:"VCT",VE:"VEN",VG:"VGB",VI:"VIR",VN:"VNM",VU:"VUT",WF:"WLF",WS:"WSM",XK:"XKX",YE:"YEM",ZA:"ZAF",ZM:"ZMB",ZW:"ZWE"};const N={af:48,sq:1,ar:34,eu:1,bg:49,be:1,ca:42,zh:19,"zh-tw":18,"zh-cn":19,"zh-hk":45,"zh-sg":19,hr:41,cs:22,da:11,nl:10,"nl-be":65,en:1,"en-us":1,"en-eg":26,"en-au":27,"en-gb":2,"en-ca":6,"en-nz":27,"en-ie":26,"en-za":26,"en-jm":26,"en-bz":26,"en-tt":26,"en-001":26,et:30,fo:1,fa:59,fi:12,fr:3,"fr-ca":5,gd:2,de:4,"de-ch":57,el:23,he:36,hi:50,hu:21,is:31,id:37,it:7,ja:9,ko:13,lv:33,lt:32,mk:1,mt:1,no:14,nb:14,nn:14,pl:20,"pt-br":15,pt:24,rm:1,ro:39,ru:16,sr:1,sk:40,sl:52,es:8,"es-mx":28,"es-419":44,sv:17,th:35,ts:1,tn:1,tr:25,uk:29,ur:55,ve:1,vi:43,xh:1,yi:1,zu:56,ms:38,iw:36,lo:46,tl:47,kk:51,ta:53,te:54,bn:58,ga:60,ht:61,la:62,pa:63,sa:64};let L="Music-User-Token";function getLanguages(){if("undefined"==typeof navigator)return[];if(navigator.languages)return navigator.languages;const e=navigator.language||navigator.userLanguage;return e?[e]:[]}L="Media-User-Token";const x=["apps.apple.com","books.apple.com","fitness.apple.com","music.apple.com","podcasts.apple.com","tv.apple.com"];function determineBaseCookieDomain(e){let t=e;return e&&x.some((function(r){if(e.endsWith("."+r))return t=r,!0})),t}const j=new Set(["apps","books","music","podcasts","tv"]),U=/\.apple\.com$/;function getCommerceHostname(e,t){!t&&"undefined"!=typeof location&&location.hostname&&(t=location);let r=e+".itunes.apple.com";if(!t)return r;const n=function(e){if(!e||!U.test(e))return;const t=e.split(".");let r=t[t.length-3];const n=r;if(r&&r.includes("-")){const e=r.split("-");r=e[e.length-1]}return j.has(r)?n:void 0}(t.hostname);return n&&(r=`${e}.${n}.apple.com`),r}var F,B,V;function buildQueryParams(e={app:"music",p:"subscribe"}){return void 0===e.app&&(e.app="music"),void 0===e.p&&(e.p="subscribe"),Object.keys(e).map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`).join("&")}!function(e){e.APP="music",e.P="subscribe"}(F||(F={})),function(e){e.DEFAULT_CID="pldfltcid",e.TV_CID="pltvcid",e.RESTRICTIONS_ENABLED="itre",e.STOREFRONT_COUNTRY_CODE="itua",e.USER_TOKEN="media-user-token"}(B||(B={})),e.SKRealm=void 0,(V=e.SKRealm||(e.SKRealm={}))[V.MUSIC=0]="MUSIC",V[V.PODCAST=1]="PODCAST",V[V.TV=2]="TV";const G={[e.SKRealm.TV]:"com.apple.onboarding.tvappweb",[e.SKRealm.MUSIC]:"com.apple.onboarding.musicappweb",[e.SKRealm.PODCAST]:"com.apple.onboarding.podcastsweb"},H={[e.SKRealm.TV]:"pltvcid",[e.SKRealm.MUSIC]:"pldfltcid",[e.SKRealm.PODCAST]:"pldfltcid"},q={"com.apple.onboarding.tvappweb":1,"com.apple.onboarding.musicappweb":1,"com.apple.onboarding.podcastsweb":1},W={CRITICAL:50,ERROR:40,WARNING:30,NOTICE:20,INFO:10,DEBUG:2,TRACE:1,NONE:0};const Y={OFF:"NONE",0:"NONE","+":"INFO","++":"DEBUG",V:"DEBUG",D:"DEBUG",VERBOSE:"DEBUG",VV:"TRACE",SILLY:"TRACE","*":"TRACE"};function getLoggingLevel$1(e,t={}){if("number"==typeof e)return function(e){return"number"==typeof e&&Object.values(W).includes(e)}(e)?e:void 0;let r=e.toUpperCase();return t.allowShorthands&&void 0!==Y[r]&&(r=Y[r]),function(e){return"string"==typeof e&&void 0!==W[e.toUpperCase()]}(r)?W[r]:void 0}function getLoggingLevelName$1(e){for(const[t,r]of Object.entries(W))if(e===r)return t}function walk(e,t){const r=[e];for(;r.length>0;){const e=r.shift();void 0!==e&&(r.push(...e.children),t(e))}}function _define_property$1P(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$N(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1P(e,t,r[t])}))}return e}function _object_spread_props$r(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _define_property1$1(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const z=W.ERROR,DEFAULT_POLICY$1=(e,t)=>e!==W.NONE&&t>=e;class Logger$2{get parent(){return this._parent}get children(){return Array.from(this._children.values())}get namespace(){return void 0===this._parent?this.name:this._parent.namespace+"/"+this.name}get enabled(){return this.level!==W.NONE}get level(){var e,t,r;return null!==(r=null!==(t=this._level)&&void 0!==t?t:null===(e=this.parent)||void 0===e?void 0:e.level)&&void 0!==r?r:z}get levelName(){var e;return null!==(e=getLoggingLevelName$1(this.level))&&void 0!==e?e:"UNKNOWN"}get levelPolicy(){var e,t,r;return null!==(r=null!==(t=this._levelPolicy)&&void 0!==t?t:null===(e=this.parent)||void 0===e?void 0:e.levelPolicy)&&void 0!==r?r:DEFAULT_POLICY$1}get handlers(){var e,t,r;return null!==(r=null!==(t=this._handlers)&&void 0!==t?t:null===(e=this.parent)||void 0===e?void 0:e.handlers)&&void 0!==r?r:{}}isEnabledFor(e){return this.levelPolicy(this.level,e)}setLevel(e){const t=getLoggingLevel$1(e);void 0!==t&&(this._level=t)}clearLevel(){this._level=void 0}setLevelPolicy(e){this._levelPolicy=e}clearLevelPolicy(){this._levelPolicy=void 0}addHandler(e,t){this._handlers||(this._handlers={}),this._handlers[e]=t}hasHandler(e){var t;return void 0!==(null===(t=this._handlers)||void 0===t?void 0:t[e])}removeHandler(e){void 0!==this._handlers&&(delete this._handlers[e],0===Object.keys(this._handlers).length&&this.clearHandlers())}clearHandlers(){this._handlers=void 0}createChild(e,t){const r=this._children.get(e);return void 0!==r?r:new Logger$2(e,_object_spread_props$r(_object_spread$N({},t),{parent:this}))}linkChild(e){if(void 0!==e.parent&&e.parent!==this)throw new Error(`Logger '${e.name}' is already a child of a different parent ('${e.parent.name}')`);const t=this._children.get(e.name);if(void 0!==t&&t!==e)throw new Error(`A child with name '${e.name}' is already registered`);return void 0===t&&(this._children.set(e.name,e),e.linkParent(this)),e}unlinkChild(e){const t=this._children.get(e.name);return t===e&&(this._children.delete(e.name),t.unlinkParent()),e}getByName(e){return this._children.get(e)}getByNamespace(e){return function(e,t,r="/"){if(""===(t=t.trim())||"*"===t)return e;const n=t.split(r);n[0].trim()===e.name&&n.shift();if(0===n.length)return e;let i=e;for(;void 0!==i&&n.length>0;){const e=n.shift();i=i.getByName(e.trim())}return i}(this,e)}linkParent(e){return this.parent!==e&&(this.unlinkParent(),this._parent=e,e.linkChild(this)),this}unlinkParent(){return void 0!==this._parent&&(this._parent.unlinkChild(this),this._parent=void 0),this}log(e,t,...r){const n=getLoggingLevel$1(e);void 0!==n&&this.logRecord({time:Date.now(),namespace:this.namespace,level:n,message:t,args:r})}logRecord(e){if(!this.levelPolicy(this.level,e.level))return;const t=_object_spread$N({namespace:this.namespace},e);for(const r of Object.values(this.handlers))r.process(t)}error(e,...t){this.log(W.ERROR,e,...t)}warning(e,...t){this.log(W.WARNING,e,...t)}warn(e,...t){this.warning(e,...t)}info(e,...t){this.log(W.INFO,e,...t)}debug(e,...t){this.log(W.DEBUG,e,...t)}trace(e,...t){this.log(W.TRACE,e,...t)}constructor(e,t){_define_property1$1(this,"name",void 0),_define_property1$1(this,"_parent",void 0),_define_property1$1(this,"_children",new Map),_define_property1$1(this,"_level",void 0),_define_property1$1(this,"_levelPolicy",void 0),_define_property1$1(this,"_handlers",void 0),this.name=e,this._levelPolicy=null==t?void 0:t.levelPolicy,this._handlers=null==t?void 0:t.handlers,void 0!==(null==t?void 0:t.parent)&&this.linkParent(t.parent),void 0!==(null==t?void 0:t.level)&&this.setLevel(t.level)}}function _define_property$1O(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class CallbackHandler{process(e){this.enabled&&void 0!==this.callback&&this.callback(e)}constructor(e,t={}){var r;_define_property$1O(this,"enabled",void 0),_define_property$1O(this,"callback",void 0),this.callback=e,this.enabled=null===(r=t.enabled)||void 0===r||r}}const Q=/%{([^}]+)}/gi,J={timestamp:e=>String(e.time),time:e=>String(e.time),datetime:e=>new Date(e.time).toISOString(),date:e=>new Date(e.time).toISOString(),level:e=>String(e.level),levelname:e=>{var t;return null!==(t=getLoggingLevelName$1(e.level))&&void 0!==t?t:"UNKNOWN"},message:e=>e.message,name:e=>e.namespace.split("/").pop(),namespace:e=>e.namespace};function _define_property$1N(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const X=new Map([[W.CRITICAL,"error"],[W.ERROR,"error"],[W.WARNING,"warn"],[W.NOTICE,"warn"],[W.INFO,"log"],[W.DEBUG,"debug"]]),Z=(ee="%{datetime} %{levelname} - [%{namespace}] %{message}",function(e){return ee.replace(Q,(function(t,r){return r=r.toLowerCase(),void 0!==J[r]?J[r](e):t}))});var ee;const te=new Logger$2("storekit");function asyncGeneratorStep$1g(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _define_property$1M(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var re;!function(e){e[e.ParseError=-32700]="ParseError",e[e.InvalidRequest=-32600]="InvalidRequest",e[e.MethodNotFound=-32601]="MethodNotFound",e[e.InvalidParams=-32602]="InvalidParams",e[e.InternalError=-32603]="InternalError"}(re||(re={}));class Dispatch{get source(){return this._source}set source(e){if(!e&&this._source)return this._source.removeEventListener("message",this.handle),void(this._source=void 0);e.addEventListener("message",this.handle),this._source=e}apply(e,t){if(!this.destination)throw new Error("No destination");const r=this._sequence++,n=new Promise((e,t)=>{this._registry[r]={resolve:e,reject:t}});return this.send(this.destination,{jsonrpc:"2.0",id:r,method:e,params:t}),n}call(e,...t){return this.apply(e,t)}handleRequest(e){var t,r=this;return(t=function*(){const t={jsonrpc:"2.0",id:e.id},n=r.methods[e.method];if(!n)return Object.assign(t,{error:{code:-32601,message:"Method not found"}});try{const r=yield n.apply(void 0,ensureArray(e.params));return Object.assign(t,{result:r})}catch(De){return Object.assign(t,{error:{code:De.code||-32603,message:De.message}})}},function(){var e=this,r=arguments;return new Promise((function(n,i){var o=t.apply(e,r);function _next(e){asyncGeneratorStep$1g(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1g(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}handleResponse(e){const t=this._registry[e.id];delete this._registry[e.id],t&&(e.error?t.reject(Object.assign(Error(),e.error)):t.resolve(e.result))}send(e,t){e.postMessage(t,e.window===e?this.origin:void 0)}constructor(e={}){_define_property$1M(this,"destination",void 0),_define_property$1M(this,"origin",void 0),_define_property$1M(this,"methods",void 0),_define_property$1M(this,"_registry",{}),_define_property$1M(this,"_sequence",0),_define_property$1M(this,"_source",void 0),_define_property$1M(this,"handle",e=>{e.data&&"2.0"===e.data.jsonrpc&&("*"!==this.origin&&this.origin!==e.origin||(e.data.method&&this.destination?this.handleRequest(e.data).then(e=>{this.send(this.destination,e)}):(hasOwn(e.data,"result")||e.data.error)&&this.handleResponse(e.data)))}),this.destination=e.destination,this.methods=e.methods||{},this.origin=e.origin||"*",e.source&&(this.source=e.source)}}function asyncGeneratorStep$1f(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$1f(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1f(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1f(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1L(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$M(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1L(e,t,r[t])}))}return e}function _object_spread_props$q(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}var ne;function validateToken(e){if("string"!=typeof e)return!1;const t=e.match(/[a-zA-Z0-9=\/+]{32,}==$/);var r;return null!==(r=t&&t.length>0)&&void 0!==r&&r}!function(e){e[e.UNAVAILABLE=-1]="UNAVAILABLE",e[e.NOT_DETERMINED=0]="NOT_DETERMINED",e[e.DENIED=1]="DENIED",e[e.RESTRICTED=2]="RESTRICTED",e[e.AUTHORIZED=3]="AUTHORIZED"}(ne||(ne={}));const ie=`https://${getCommerceHostname("buy")}/commerce/account/authenticateMusicKitRequest`,oe="https://authorize.music.apple.com",ae=/^https?:\/\/(.+\.)*(apple\.com|apps\.mzstatic\.com)(\/[\w\d]+)*$/;var se,ce;!function(e){e[e.AUTHORIZE=0]="AUTHORIZE",e[e.SUBSCRIBE=1]="SUBSCRIBE"}(se||(se={}));class ServiceSetupView{get isServiceView(){return/(authorize\.(.+\.)*apple\.com)/i.test(window.location.hostname)||window&&window.name===this.target||!1}focus(){this._window&&window.focus&&this._window.focus()}load(e={action:0}){var t=this;return _async_to_generator$1f((function*(){return 1===e.action?t._subscribeAction(e.parameters):t._authorizeAction(e.parameters)}))()}present(e="",t){const{height:r,left:n,top:i,width:o}=this._calculateClientDimensions(),a={height:650,menubar:"no",resizable:"no",scrollbars:"no",status:"no",toolbar:"no",width:650},s=_object_spread$M(_object_spread_props$q(_object_spread$M({},a),{left:o/2-a.width/2+n,top:r/2-a.height/2+i}),t),c=Object.keys(s).map(e=>`${e}=${s[e]}`).join(",");return/trident|msie/i.test(navigator.userAgent)?(this._window=window.open(window.location.href,this.target,c)||void 0,this._window.location.href=e):this._window=window.open(e,this.target,c)||void 0,/\bedge\b/i.test(navigator.userAgent)&&(this._window.opener=self),this.focus(),this._window}_startPollingForWindowClosed(e){this._window&&void 0===this._windowClosedInterval&&(this._windowClosedInterval=setInterval(()=>{var t;(null===(t=this._window)||void 0===t?void 0:t.closed)&&(this._stopPollingForWindowClosed(),e())},500))}_stopPollingForWindowClosed(){void 0!==this._windowClosedInterval&&(clearInterval(this._windowClosedInterval),this._windowClosedInterval=void 0)}_authorizeAction(e={}){var t=this;return _async_to_generator$1f((function*(){var r;let n,i;const o=(null===(r=window.location)||void 0===r?void 0:r.href)||"";return"GET"===t.authenticateMethod?i=`${oe}/woa?${buildQueryParams(_object_spread_props$q(_object_spread$M({},t.deeplinkParameters),{a:btoa(t._thirdPartyInfo()),referrer:o}))}`:(n=t._buildFormElement(ie),document.body.appendChild(n)),new Promise((r,o)=>{const a=t.present(i);t._startPollingForWindowClosed(()=>{o(0)}),t.dispatch=new Dispatch({methods:{authorize(e,t,n){validateToken(e)?r({restricted:t&&"1"===t,userToken:e,cid:n}):o(0)},close(){},decline(){o(1)},switchUserId(){o(0)},thirdPartyInfo:()=>t._thirdPartyInfo(t.developerToken,_object_spread$M({},t.deeplinkParameters,e)),unavailable(){o(-1)}},origin:oe,source:window,destination:a}),n&&n.submit()})}))()}_buildFormElement(e,t=this.target,r=this.developerToken){const n=document.createElement("form");n.setAttribute("method","post"),n.setAttribute("action",e),n.setAttribute("target",t),n.style.display="none";const i=document.createElement("input");i.setAttribute("name","jwtToken"),i.setAttribute("value",r),n.appendChild(i);const o=document.createElement("input");o.setAttribute("name","isWebPlayer"),o.setAttribute("value","true"),n.appendChild(o);const a=document.createElement("input");return a.setAttribute("name","LogoURL"),a.setAttribute("value",""),n.appendChild(a),n}_calculateClientDimensions(e=window){return{height:e.innerHeight?e.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height,left:e.screenLeft?e.screenLeft:screen.availLeft||screen.left,top:e.screenTop?e.screenTop:screen.availTop||screen.top,width:e.innerWidth?e.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width}}_subscribeAction(e={}){var t=this;return _async_to_generator$1f((function*(){return Object.assign(e,t.deeplinkParameters),new Promise((r,n)=>{const i="https://authorize.music.apple.com/upsell?"+buildQueryParams(e);t.present(i),window.addEventListener("message",({data:e,origin:t,source:i})=>{const{closeWindow:o,launchClient:a}="string"==typeof e?JSON.parse(e):e;t&&!ae.test(t)||(a?0===a.supported?n("Unable to subscribe on this platform."):r(a):n("Subscribe action error."))})})}))()}_thirdPartyInfo(e=this.developerToken,t){let r=this.iconURL;const n=window.location.host||document.referrer,i=[...[].slice.call(document.querySelectorAll('link[rel="apple-music-app-icon"]')),...[].slice.call(document.querySelectorAll('link[rel="apple-touch-icon-precomposed"]')),...[].slice.call(document.querySelectorAll('link[rel="apple-touch-icon"]'))];if(i&&i[0]&&i[0].href){const e=i.find(e=>!!e.sizes&&"120x120"===e.sizes.value);var o;r=null!==(o=null==e?void 0:e.href)&&void 0!==o?o:i[0].href}return JSON.stringify({thirdPartyIconURL:r,thirdPartyName:n,thirdPartyParameters:t,thirdPartyToken:e})}constructor(e,t={}){if(_define_property$1L(this,"developerToken",void 0),_define_property$1L(this,"authenticateMethod",void 0),_define_property$1L(this,"deeplinkParameters",void 0),_define_property$1L(this,"iconURL",void 0),_define_property$1L(this,"target",void 0),_define_property$1L(this,"dispatch",void 0),_define_property$1L(this,"_window",void 0),_define_property$1L(this,"_windowClosedInterval",void 0),this.developerToken=e,this.authenticateMethod="GET",this.target="apple-music-service-view",this.deeplinkParameters=t&&t.deeplinkParameters||{},this.iconURL=t&&t.iconURL,this.authenticateMethod=t&&t.authenticateMethod||"GET",this.isServiceView&&window.opener!==window){var r;const e=null===(r=getSessionStorage())||void 0===r?void 0:r.getItem("ac"),t=null!=e?new URL(e).origin:void 0;var n;if(t)this.dispatch=new Dispatch({destination:null!==(n=window.opener)&&void 0!==n?n:void 0,origin:t,source:window})}}}function asyncGeneratorStep$1e(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$1e(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1e(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1e(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1K(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _fetchStorefronts(){return(_fetchStorefronts=_async_to_generator$1e((function*(e,t="https://api.music.apple.com/v1"){const r=new Headers({Authorization:"Bearer "+e}),n=yield fetch(t+"/storefronts",{headers:r}),i=yield n.json();return i.errors?Promise.reject(i.errors):i.data}))).apply(this,arguments)}!function(e){e.ID="us",e.LANGUAGE_TAG="en-gb"}(ce||(ce={}));class Storefront{static inferFromLanguages(e,t=getLanguages()){return _async_to_generator$1e((function*(){const r=yield function(e){return _fetchStorefronts.apply(this,arguments)}(e),n=r.map(e=>e.id),i=t[0]||"en-US",[o,a]=i.toLowerCase().split(/-|_/),s=n.includes(a)?a:"us";return r.find(e=>e.id===s)}))()}constructor(e,t,r){_define_property$1K(this,"id",void 0),_define_property$1K(this,"attributes",void 0),_define_property$1K(this,"href",void 0),_define_property$1K(this,"type",void 0),this.id=e,this.attributes=t,this.type="storefronts",this.href=r||`/v1/${this.type}/${e}`}}function asyncGeneratorStep$1d(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _define_property$1J(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const le=["music.apple.com","podcasts.apple.com","tv.apple.com"],de=["mut-refresh",B.DEFAULT_CID,B.STOREFRONT_COUNTRY_CODE,B.TV_CID,B.USER_TOKEN],ue=new Map([["signIn","/auth/v2/web"],["signOut","/auth/v2/web/logout"],["refresh","/auth/v2/web/refresh"]]);class Reflector{onUserTokenChange(){const e=this.getUserToken(),t=this.previousUserToken!==e;if(this.previousUserToken=e,te.debug("Reflector.onUserTokenChange hasChanged?",t),t)return e?this.reflect():this.clear()}skipJsCookieWrite(e){return de.includes(e)}refresh(){if(!this.allowMultiReflection)return;const e=getCookie("mut-refresh");return getCookie(B.USER_TOKEN)&&!e?this.makeRequests("refresh"):void 0}reflect(){if(this.allowMultiReflection)return this.makeRequests("signIn");{const e=de.map(e=>getCookie(e));this.clearAppleComCookies(),de.forEach((t,r)=>{const n=e[r],i=getCookie(t);n&&!i&&(te.debug("Reflector.reflect calling setCookie",t,n),setCookie(t,n,"/",166,void 0,determineBaseCookieDomain(this.hostname)))})}}clear(){if(this.allowMultiReflection)return this.makeRequests("signOut");te.debug("Reflector nothing to clear, no allowMultiReflection")}makeRequests(e){var t,r=this;return(t=function*(){te.debug("Reflector makeRequests()",e);try{const n=ue.get(e);for(const e of le){const i=`https://auth.${e}${n}`;te.debug("Reflector.makeRequests for",i);try{yield fetch(i,{headers:{Authorization:"Bearer "+r.developerToken},method:"POST",credentials:"include"})}catch(t){te.error("Reflector fetch failed for ",i,t)}}r.clearAppleComCookies()}catch(t){te.error("Reflector makeRequests failed",t)}te.debug("Reflector calling onRequestsComplete"),r.onRequestsComplete()},function(){var e=this,r=arguments;return new Promise((function(n,i){var o=t.apply(e,r);function _next(e){asyncGeneratorStep$1d(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1d(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}clearAppleComCookies(){te.debug("Reflector.clearAppleComCookies"),de.forEach(e=>removeCookie(e,void 0,"apple.com"))}constructor({hostname:e,developerToken:t,getUserToken:r,startingUserToken:n,onRequestsComplete:i,allowMultiReflection:o}){_define_property$1J(this,"developerToken",void 0),_define_property$1J(this,"getUserToken",void 0),_define_property$1J(this,"onRequestsComplete",void 0),_define_property$1J(this,"allowMultiReflection",!1),_define_property$1J(this,"previousUserToken",void 0),_define_property$1J(this,"hostname",void 0),this.hostname=e,this.developerToken=t,this.getUserToken=r,this.previousUserToken=n,this.onRequestsComplete=i,this.allowMultiReflection=o&&function(e){if(!e)return!1;for(const t of le)if(t===e||e.endsWith("."+t))return!0;return!1}(this.hostname),this.onUserTokenChange=this.onUserTokenChange.bind(this),te.debug("Reflector allowMultiReflection?",this.allowMultiReflection)}}function asyncGeneratorStep$1c(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$1c(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1c(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1c(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1I(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$L(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1I(e,t,r[t])}))}return e}function _ts_metadata$y(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}var pe;!function(e){e.authorizationStatusDidChange="authorizationStatusDidChange",e.authorizationStatusWillChange="authorizationStatusWillChange",e.eligibleForSubscribeView="eligibleForSubscribeView",e.needsGDPRDidChange="needsGDPRDidChange",e.storefrontCountryCodeDidChange="storefrontCountryCodeDidChange",e.storefrontIdentifierDidChange="storefrontIdentifierDidChange",e.userTokenDidChange="userTokenDidChange"}(pe||(pe={})),B.DEFAULT_CID;let he=!1;he=!0;const ye="https://"+getCommerceHostname("buy"),fe=`https://${getCommerceHostname("play")}/WebObjects/MZPlay.woa/wa`;class StoreKit extends Notifications{updateUserTokenFromStorage(){const e=this._getStorageItem(B.USER_TOKEN);this.userToken=e||void 0}get authorizationStatus(){return this._authorizationStatus}set authorizationStatus(e){this._authorizationStatus!==e&&(this._getIsActiveSubscription.updateCache(void 0),this.dispatchEvent("authorizationStatusWillChange",{authorizationStatus:this._authorizationStatus,newAuthorizationStatus:e}),this._authorizationStatus=e,this.dispatchEvent("authorizationStatusDidChange",{authorizationStatus:e}))}get cid(){if(!this._cids[this.cidNamespace]){const e=this._getStorageItem(this.cidNamespace);this._cids[this.cidNamespace]=e||void 0}return this._cids[this.cidNamespace]}set cid(e){e?this._setStorageItem(this.cidNamespace,e):this._removeStorageItem(this.cidNamespace),this._cids[this.cidNamespace]=e}eligibleForSubscribeView(){var e=this;return _async_to_generator$1c((function*(){const t=yield e.hasMusicSubscription();return(!e.hasAuthorized||e.hasAuthorized&&!t)&&!e._dispatchedSubscribeView}))()}get hasAuthorized(){return this.authorizationStatus>ne.DENIED}get logoutURL(){if(!this._disableLogoutURL)return this.iTunesBuyBase+"/account/web/logout"}get parentalControls(){return this._parentalControls}set parentalControls(t){this._parentalControls=t,t&&(this.realm===e.SKRealm.MUSIC||this.realm===e.SKRealm.PODCAST?this.restrictedEnabled=t.musicParentalControlsEnabled:this.realm===e.SKRealm.TV&&t.videoContentRestrictions&&(this.authorizationStatus=ne.RESTRICTED))}get isU13(){return!!this._isU13}set isU13(e){this._isU13=e}get _pldfltcid(){return this._cids[B.DEFAULT_CID]}set _pldfltcid(e){this._cids[B.DEFAULT_CID]=e}get privacyAcknowledgements(){return this._privacyAcknowledgements}set privacyAcknowledgements(e){if(this._privacyAcknowledgements=e,!e)return this._gdprVersion=-1,void(this._needsGDPR=void 0);if(this.bundleId){var t;const r=null!==(t=this._needsGDPR)&&void 0!==t&&t;this._gdprVersion=e[this.bundleId]||0,this._needsGDPR=this._gdprVersion<(q[this.bundleId]||0),r!==this._needsGDPR&&this.dispatchEvent("needsGDPRDidChange",{GDPRVersion:this._gdprVersion,needsGDPR:this._needsGDPR})}}get restrictedEnabled(){if(this.userToken&&"boolean"!=typeof this._restrictedEnabled){const e=this._getStorageItem(B.RESTRICTIONS_ENABLED);if(e)this._restrictedEnabled="0"!==e;else if(this._storefrontCountryCode){const e=["br","ch","gt","hu","id","in","it","kr","la","lt","my","ru","sg","tr"];this._restrictedEnabled=-1!==e.indexOf(this._storefrontCountryCode)||void 0}}return this._restrictedEnabled}set restrictedEnabled(e){this._restrictedEnabledOverridden||(this.userToken&&void 0!==e&&this._setStorageItem(B.RESTRICTIONS_ENABLED,e?"1":"0"),this._restrictedEnabled=e,e&&(this.authorizationStatus=ne.RESTRICTED))}overrideRestrictEnabled(e){this._restrictedEnabledOverridden=!1,this.restrictedEnabled=e,this._restrictedEnabledOverridden=!0}get storefrontCountryCode(){if(!this._storefrontCountryCode){const e=this._getStorageItem(B.STOREFRONT_COUNTRY_CODE);this._storefrontCountryCode=(null==e?void 0:e.toLowerCase())||ce.ID}return this._storefrontCountryCode}set storefrontCountryCode(e){e&&this.userToken?this._setStorageItem(B.STOREFRONT_COUNTRY_CODE,e):this._removeStorageItem(B.STOREFRONT_COUNTRY_CODE),e!==this._storefrontCountryCode&&(this._storefrontCountryCode=e,this.dispatchEvent("storefrontCountryCodeDidChange",{storefrontCountryCode:e}))}get storefrontIdentifier(){return this._storefrontIdentifier}set storefrontIdentifier(e){this._storefrontIdentifier=e,this.dispatchEvent("storefrontIdentifierDidChange",{storefrontIdentifier:e})}runTokenValidations(e,t=!0){e&&validateToken(e)?(t&&this._setStorageItem(B.USER_TOKEN,e),this.authorizationStatus=this.restrictedEnabled?ne.RESTRICTED:ne.AUTHORIZED):(this._removeStorageItem(B.USER_TOKEN),this.authorizationStatus=ne.NOT_DETERMINED)}wrapDynamicUserTokenForChanges(e,t=invoke(e)){if("function"!=typeof e)return e;let r=t;return()=>{const t=invoke(e);return r!==t&&(r=t,this.runTokenValidations(t,!1),this.dispatchEvent("userTokenDidChange",{userToken:t})),t||""}}get dynamicUserToken(){return this._dynamicUserToken}set dynamicUserToken(e){const t=invoke(e);this._dynamicUserToken=this.wrapDynamicUserTokenForChanges(e,t),this.runTokenValidations(t,"function"!=typeof e),this.dispatchEvent("userTokenDidChange",{userToken:t})}get userToken(){return invoke(this.dynamicUserToken)}set userToken(e){this.dynamicUserToken=e}get userTokenIsValid(){return validateToken(this.userToken)}deeplinkURL(e={}){return"https://finance-app.itunes.apple.com/deeplink?"+buildQueryParams(e=_object_spread$L({},this.deeplinkParameters||{},e))}itunesDeeplinkURL(e={p:"browse"}){return"https://itunes.apple.com/deeplink?"+buildQueryParams(e=_object_spread$L({},this.deeplinkParameters||{},e))}pldfltcid(){var e=this;return _async_to_generator$1c((function*(){if(!e._cids[B.DEFAULT_CID])try{yield e.infoRefresh()}catch(t){return}return e._cids[B.DEFAULT_CID]}))()}renewUserToken(){var e=this;return _async_to_generator$1c((function*(){if(!e.userToken)return e.requestUserToken();const t=new Headers({Authorization:"Bearer "+e.developerToken,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+e.userToken}),r=yield e.fetch(e.playBase+"/renewMusicToken",{method:"POST",headers:t});if(401===r.status)return yield e.revokeUserToken(),Promise.reject(new Error("Renew token"));const n=yield r.json();return n["music-token"]&&(e.userToken=n["music-token"]),e.userToken}))()}requestStorefrontCountryCode(){var e=this;return _async_to_generator$1c((function*(){if(e.authorizationStatus<=ne.DENIED)return Promise.reject("Not authorized: "+e.authorizationStatus);const t=new Headers({Authorization:"Bearer "+e.developerToken,[L]:e.userToken||""}),r=yield e.fetch(e.apiBase+"/me/storefront",{headers:t});if(r&&!r.ok)return e._reset(),Promise.reject("Storefront Country Code error.");const n=yield r.json();if(n.errors)return Promise.reject(n.errors);const[i]=n.data;return i&&i.id?(e.storefrontCountryCode=i.id,e.storefrontCountryCode):Promise.reject("Storefront Country Code error.")}))()}requestStorefrontIdentifier(){var e=this;return _async_to_generator$1c((function*(){if(!e.storefrontIdentifier){const t=yield Storefront.inferFromLanguages(e.developerToken);e.storefrontIdentifier=t.id}return e.storefrontIdentifier}))()}requestUserToken(){var e=this;return _async_to_generator$1c((function*(){if(e._serviceSetupView.isServiceView)return e.userToken||"";try{const t=yield e._serviceSetupView.load({action:se.AUTHORIZE});e.cid=t.cid,e.userToken=t.userToken,e.restrictedEnabled=t.restricted}catch(t){return e._reset(),e.authorizationStatus=t,Promise.reject(t)}return e.userToken}))()}revokeUserToken(){var e=this;return _async_to_generator$1c((function*(){try{yield e._webPlayerLogout()}catch(t){}e.dispatchEvent("authorizationStatusWillChange",{authorizationStatus:e.authorizationStatus,newAuthorizationStatus:ne.NOT_DETERMINED}),e._reset(),e.dispatchEvent("authorizationStatusDidChange",{authorizationStatus:e.authorizationStatus}),e.dispatchEvent("userTokenDidChange",{userToken:e.userToken})}))()}setCids(e){this._cids=_object_spread$L({},this._cids,e),Object.keys(this._cids).forEach(e=>{this._setStorageItem(e,this._cids[e])})}shouldDisplayPrivacyLink(e){var t=this;return _async_to_generator$1c((function*(){return e||(e=t.bundleId),void 0!==t._needsGDPR||(yield t.me()),t._needsGDPR}))()}hasMusicSubscription(){var e=this;return _async_to_generator$1c((function*(){return!!e.hasAuthorized&&e._getIsActiveSubscription()}))()}_getIsActiveSubscription(){var t=this;return _async_to_generator$1c((function*(){var r;if(t.realm===e.SKRealm.PODCAST)return!0;return!!(null===(r=(yield t.me()).subscription)||void 0===r?void 0:r.active)}))()}resetSubscribeViewEligibility(){this._dispatchedSubscribeView=!1}presentSubscribeViewForEligibleUsers(e={},t=!0){var r=this;return _async_to_generator$1c((function*(){const n=yield r.eligibleForSubscribeView();if(!r._serviceSetupView.isServiceView&&n){if(!t)return r.dispatchEvent("eligibleForSubscribeView",e),void(r._dispatchedSubscribeView=!0);try{const e=yield r._serviceSetupView.load({action:se.SUBSCRIBE});return r._dispatchedSubscribeView=!0,e}catch(i){return r.revokeUserToken()}}}))()}infoRefresh(){var e=this;return _async_to_generator$1c((function*(){if(e.authorizationStatus<=ne.DENIED)return Promise.reject("Not authorized: "+e.authorizationStatus);const t=new Headers({Authorization:"Bearer "+e.developerToken,[L]:e.userToken||""});try{const r=yield e.fetch(e.iTunesBuyBase+"/account/web/infoRefresh",{credentials:"include",headers:t}),n=yield r.json();e.setCids(n)}catch(r){}}))()}me(){if(this.authorizationStatus<=ne.DENIED)return Promise.reject("Not authorized: "+this.authorizationStatus);if(!this._me){var t=this;this._me=new Promise((r=_async_to_generator$1c((function*(r,n){const i=new Headers({Authorization:"Bearer "+t.developerToken,[L]:t.userToken||""}),o=buildURL(t.apiBase,"/me/account",_object_spread$L({meta:"subscription"},t.meParameters));let a;try{a=yield t.fetch(o,{headers:i})}catch(u){return n(new MKError(MKError.Reason.NETWORK_ERROR,"Failed to fetch /me/account"))}if(a&&!a.ok)return t.realm!==e.SKRealm.TV&&t._reset(),n("Account error.");let s=yield a.json();if(s.errors)return n(s.errors);const{data:c,meta:l}=s;if(!l||!l.subscription)return n("Account error.");t.storefrontCountryCode=l.subscription.storefront;const d={meta:l,subscription:l.subscription};c&&c.length&&(d.attributes=c[0].attributes);try{let e=yield t.fetch(t.iTunesBuyBase+"/account/web/info",{credentials:"include",headers:i});if(s=yield e.json(),t.isU13=s.isU13,t.parentalControls=s.parentalControlsData,t.privacyAcknowledgements=s.privacyAcknowledgement,function(e){if("object"!=typeof e)throw new TypeError("Source is not an Object");for(const t in e)if(hasOwn(e,t))return!1;return!0}(t.privacyAcknowledgements||{})){try{yield t.infoRefresh()}catch(u){r(d)}e=yield t.fetch(t.iTunesBuyBase+"/account/web/info",{credentials:"include",headers:i}),s=yield e.json(),t.isU13=s.isU13,t.parentalControls=s.parentalControlsData,t.privacyAcknowledgements=s.privacyAcknowledgement}d.info=s}catch(u){console.warn("Failed to fetch privacyAcknowledgements",u)}return r(d)})),function(e,t){return r.apply(this,arguments)})).then(e=>{var t;return this._getIsActiveSubscription.updateCache((null===(t=e.subscription)||void 0===t?void 0:t.active)||!1),this._me=null,e}).catch(e=>(this._me=null,Promise.reject(e)))}var r;return this._me}musicSubscriptionOffers(e,t=getLanguages()){var r=this;return _async_to_generator$1c((function*(){let n;if(r.hasAuthorized){n=(yield r.me()).info.storeFrontISO3A}else{if(!e){const n=yield Storefront.inferFromLanguages(r.developerToken,t);e=null==n?void 0:n.id}n=e&&M[e.toUpperCase()]||"USA"}const i=function(e="en-US"){const t=N[e.toLowerCase()];if(t)return t;if(e.includes("-")){const t=e.split("-")[0],r=N[t.toLowerCase()];if(r)return r}return N["en-us"]}(t[0]),o=D[n];if(!i||!o)return[];const a=new Headers({"X-Apple-Store-Front":`${o}-${i},8`});r.userToken&&(a.set("Authorization","Bearer "+r.developerToken),a.set("Music-User-Token",r.userToken));const s=yield r.fetch(r.iTunesBuyBase+"/commerce/web/subscription/offers/music",{headers:a});if(!s.ok)return Promise.reject(s.status);return(yield s.json()).offers}))()}_getStorageItem(e){var t;if(e)return"cookie"===this.persist?getCookie(e):"localstorage"===this.persist?null===(t=this.storage)||void 0===t?void 0:t.getItem(`${this.storagePrefix}.${e}`):void 0}_processLocationHash(e){const t=/^\#([a-zA-Z0-9+\/]{200,}={0,2})$/;if(t.test(e)){const n=e.replace(t,"$1");try{const{itre:e,musicUserToken:t,cid:r}=JSON.parse(atob(n));this.restrictedEnabled=e&&"1"===e,this.userToken=t,this.cid=r}catch(r){}history.replaceState(null,document.title," ")}}_removeStorageItem(e){if("cookie"===this.persist)this._removeCookieFromDomains(e);else if("localstorage"===this.persist){var t;return null===(t=this.storage)||void 0===t?void 0:t.removeItem(`${this.storagePrefix}.${e}`)}}_removeCookieFromDomains(e,t=window){te.debug("Calling removeCookie",e),removeCookie(e);const{hostname:r}=t.location,n=r.split(".");if(n.length&&(n.shift(),n.length>2))for(let i=n.length;i>2;i--){const r=n.join(".");n.shift(),te.debug("Calling removeCookie",e,t,r),removeCookie(e,t,r)}}_reset(e=ne.NOT_DETERMINED){this._authorizationStatus=e,this._cids={},this._dispatchedSubscribeView=!1,this._restrictedEnabled=void 0,this._storefrontCountryCode=void 0,this._getIsActiveSubscription.updateCache(void 0),Object.keys(H).forEach(e=>{this._removeStorageItem(H[e])}),this._removeStorageItem(B.RESTRICTIONS_ENABLED),this._removeStorageItem(B.USER_TOKEN),this._removeStorageItem(B.STOREFRONT_COUNTRY_CODE),this._dynamicUserToken=void 0,this._me=null,this.privacyAcknowledgements=void 0}_setStorageItem(e,t){if("cookie"===this.persist){var r;if(null===(r=this.reflector)||void 0===r?void 0:r.skipJsCookieWrite(e))return;return te.debug("Calling setCookie from _setStorageItem",e,t),setCookie(e,t,"/",180,void 0,determineBaseCookieDomain(window.location.hostname))}var n;if("localstorage"===this.persist)return null===(n=this.storage)||void 0===n?void 0:n.setItem(`${this.storagePrefix}.${e}`,t)}_webPlayerLogout(){var e=this;return _async_to_generator$1c((function*(){const t=e.logoutURL;if(!t)return;const r=new Headers({Authorization:"Bearer "+e.developerToken,Accept:"application/json","Content-Type":"application/json",["X-Apple-"+L]:""+e.userToken});r.delete("X-Apple-"+L),r.append(L,e.userToken||"");const n=yield e.fetch(t,{method:"POST",headers:r,credentials:"include"});return n&&!n.ok?Promise.reject(n.status):n.json()}))()}constructor(t,r){var n;(super(["authorizationStatusDidChange","authorizationStatusWillChange","eligibleForSubscribeView","needsGDPRDidChange","storefrontCountryCodeDidChange","userTokenDidChange","storefrontIdentifierDidChange"]),_define_property$1I(this,"developerToken",void 0),_define_property$1I(this,"apiBase",void 0),_define_property$1I(this,"bundleId",void 0),_define_property$1I(this,"cidNamespace",void 0),_define_property$1I(this,"deeplinkParameters",void 0),_define_property$1I(this,"iconURL",void 0),_define_property$1I(this,"iTunesBuyBase",void 0),_define_property$1I(this,"meParameters",void 0),_define_property$1I(this,"persist",void 0),_define_property$1I(this,"playBase",void 0),_define_property$1I(this,"prefix",void 0),_define_property$1I(this,"realm",void 0),_define_property$1I(this,"storage",void 0),_define_property$1I(this,"storagePrefix",void 0),_define_property$1I(this,"whenAuthCompleted",void 0),_define_property$1I(this,"fetch",void 0),_define_property$1I(this,"_authorizationStatus",void 0),_define_property$1I(this,"_developerToken",void 0),_define_property$1I(this,"_disableLogoutURL",void 0),_define_property$1I(this,"_dispatchedSubscribeView",void 0),_define_property$1I(this,"_me",void 0),_define_property$1I(this,"_cids",void 0),_define_property$1I(this,"_gdprVersion",void 0),_define_property$1I(this,"_needsGDPR",void 0),_define_property$1I(this,"_isU13",void 0),_define_property$1I(this,"_parentalControls",void 0),_define_property$1I(this,"_privacyAcknowledgements",void 0),_define_property$1I(this,"_restrictedEnabled",void 0),_define_property$1I(this,"_restrictedEnabledOverridden",void 0),_define_property$1I(this,"_serviceSetupView",void 0),_define_property$1I(this,"reflector",void 0),_define_property$1I(this,"_storefrontCountryCode",void 0),_define_property$1I(this,"_storefrontIdentifier",void 0),_define_property$1I(this,"_dynamicUserToken",void 0),this.developerToken=t,this.apiBase="https://api.music.apple.com/v1",this.iTunesBuyBase=ye,this.meParameters={},this.persist="localstorage",this.playBase=fe,this.prefix="music",this.realm=e.SKRealm.MUSIC,this.storage=getLocalStorage(),this._authorizationStatus=ne.NOT_DETERMINED,this._disableLogoutURL=!1,this._dispatchedSubscribeView=!1,this._me=null,this._cids={},this._gdprVersion=-1,this._needsGDPR=void 0,this._restrictedEnabledOverridden=!1,this._dynamicUserToken=getCookie(B.USER_TOKEN),te.info("StoreKit initialized"),r&&(r.apiBase&&(this.apiBase=r.apiBase),r.deeplink&&(this.deeplinkParameters=r.deeplink),r.meParameters&&(this.meParameters=r.meParameters),r.persist&&(this.persist=r.persist),r.prefix&&(this.prefix=r.prefix),void 0!==r.realm&&(this.realm=r.realm),void 0!==r.disableLogoutURL&&(this._disableLogoutURL=r.disableLogoutURL),this.bundleId=G[this.realm]),this.fetch=void 0!==r&&"function"==typeof r.fetch?r.fetch:globalThis.fetch.bind(globalThis),this.cidNamespace=H[this.realm],this._developerToken=new DeveloperToken(t),this._serviceSetupView=new ServiceSetupView(t,{authenticateMethod:r&&r.authenticateMethod,iconURL:r&&r.iconURL,deeplinkParameters:this.deeplinkParameters}),this.storagePrefix=`${this.prefix}.${this._developerToken.teamId}`.toLocaleLowerCase(),isNodeEnvironment$1()||"cookie"!==this.persist||(te.debug("Creating Reflector"),this.reflector=new Reflector({hostname:window.location.hostname,developerToken:this.developerToken,getUserToken:()=>this.userToken,startingUserToken:getCookie(B.USER_TOKEN),onRequestsComplete:()=>{this.userToken!==getCookie(B.USER_TOKEN)&&(te.debug("StoreKit.onRequestsComplete called, resetting"),this.updateUserTokenFromStorage(),this._cids={})},allowMultiReflection:!(null==r?void 0:r.disableAuthBridge)}),this.addEventListener("userTokenDidChange",this.reflector.onUserTokenChange)),this.updateUserTokenFromStorage(),this.developerToken&&this.userTokenIsValid&&(this._restrictedEnabled=this.restrictedEnabled,this.shouldDisplayPrivacyLink(this.bundleId).catch(()=>{})),this._storefrontCountryCode=this.storefrontCountryCode,this.whenAuthCompleted=Promise.resolve(),isNodeEnvironment$1())||(this._processLocationHash(window.location.hash),"cookie"===this.persist&&(null===(n=this.reflector)||void 0===n||n.refresh()))}}var _e,ve;!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([((e=300)=>(t,r,n)=>{if(void 0===n||"function"!=typeof n.value)throw new TypeError(`Only methods can be decorated with @CachedResult, but ${r} is not a method.`);return{configurable:!0,get(){const t=n.value,i=1e3*e;let o,a=-1;function cachedResultMethod(){return _cachedResultMethod.apply(this,arguments)}function _cachedResultMethod(){return(_cachedResultMethod=_async_to_generator$1h((function*(...e){const r=Date.now();return(void 0===o||-1===a||a>0&&r>a+i)&&(a=r,o=yield t.apply(this,e)),o}))).apply(this,arguments)}return cachedResultMethod.updateCache=function(e){a=Date.now(),o=e},cachedResultMethod.getCachedValue=()=>o,Object.defineProperty(this,r,{value:cachedResultMethod,configurable:!0,writable:!0}),cachedResultMethod}}})(900),_ts_metadata$y("design:type",Function),_ts_metadata$y("design:paramtypes",[]),_ts_metadata$y("design:returntype",Promise)],StoreKit.prototype,"_getIsActiveSubscription",null),e.PlaybackStates=void 0,(_e=e.PlaybackStates||(e.PlaybackStates={}))[_e.none=0]="none",_e[_e.loading=1]="loading",_e[_e.playing=2]="playing",_e[_e.paused=3]="paused",_e[_e.stopped=4]="stopped",_e[_e.ended=5]="ended",_e[_e.seeking=6]="seeking",_e[_e.waiting=8]="waiting",_e[_e.stalled=9]="stalled",_e[_e.completed=10]="completed",e.PresentationMode=void 0,(ve=e.PresentationMode||(e.PresentationMode={}))[ve.pictureinpicture=0]="pictureinpicture",ve[ve.inline=1]="inline";const me=["contributors","modalities","movie","musicVideo","musicMovie","trailer","tvEpisode","uploadedVideo","uploaded-videos","music-videos","music-movies","tv-episodes","workouts"];function isVideo(e){var t;return null!=e&&(!0===e.isUTS||me.includes(e.type)||"video"===(null===(t=e.attributes)||void 0===t?void 0:t.mediaKind))}function isLive(e){var t;return!!(null==e||null===(t=e.attributes)||void 0===t?void 0:t.isLive)}function isStream(e){var t,r;return"stream"===(null==e||null===(r=e.attributes)||void 0===r||null===(t=r.playParams)||void 0===t?void 0:t.format)}function isTracksRadioStation(e){var t,r;return"tracks"===(null==e||null===(r=e.attributes)||void 0===r||null===(t=r.playParams)||void 0===t?void 0:t.format)}function isAlgoStation(e){return function(...e){return isTracksRadioStation(...e)}(e)}function isRadioStation(e,t){var r,n,i;return"radioStation"===(null==e||null===(n=e.attributes)||void 0===n||null===(r=n.playParams)||void 0===r?void 0:r.kind)&&(void 0===t||(null===(i=e.attributes)||void 0===i?void 0:i.mediaKind)===t)}function isRadioEpisode(e,t){var r;return isRadioStation(e,t)&&isStream(e)&&!isLive(e)&&"Episode"===(null==e||null===(r=e.attributes)||void 0===r?void 0:r.streamingRadioSubType)}function isLiveRadioStation(e,t){return isRadioStation(e,t)&&isLive(e)&&isStream(e)}function normalizeContentType(e){return function(e){return pluralizeMediaType(e)}(e)}const ge={};function findOrCreate(e,t){const r=e.toLowerCase().replace(/[^a-zA-Z0-9]+(.)/g,(e,t)=>t.toUpperCase());if(hasOwn(ge,r)){const n=ge[r];if(t!==n.constructor)throw new Error(`DevFlag ${e} was already registered with a different type (${n.constructor.name})`);return n}const n=new t(e);return Object.defineProperty(ge,r,{configurable:!0,enumerable:!0,get:function(){return n},set(e){n.set(e)}}),n}class LocalStorageDevFlag{get value(){return this.get()}get configured(){return void 0!==this.value}read(){var e,t;const r=null!==(t=null===(e=getLocalStorage())||void 0===e?void 0:e.getItem(this.key))&&void 0!==t?t:null;return null!==r?r:void 0}write(e){var t;null===(t=getLocalStorage())||void 0===t||t.setItem(this.key,e)}clear(){var e;null===(e=getLocalStorage())||void 0===e||e.removeItem(this.key)}constructor(e){if(function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"key",void 0),"string"!=typeof e||""===e.trim())throw new Error("DevFlag requires a non-empty string key");this.key=e}}class StringDevFlag extends LocalStorageDevFlag{static register(e){return findOrCreate(e,this)}static get(e){return this.register(e).get()}static set(e,t){this.register(e).set(t)}get(){return this.read()}set(e){"string"!=typeof e&&console.warn("Value for StringDevFlag should be a string"),this.write(e)}}class BooleanDevFlag extends LocalStorageDevFlag{static register(e){return findOrCreate(e,this)}static get(e){return this.register(e).get()}static set(e,t){this.register(e).set(t)}get(){const e=this.read();if(void 0!==e)return"1"===e||"true"===e.toLowerCase()}set(e){"boolean"==typeof e?this.write(!0===e?"1":"0"):console.warn("Value for BooleanDevFlag should be a boolean")}get enabled(){return!0===this.get()}enable(){this.set(!0)}disable(){this.set(!1)}toggle(){this.set(!this.get())}}class JsonDevFlag extends LocalStorageDevFlag{static register(e){return findOrCreate(e,this)}static get(e){return this.register(e).get()}static set(e,t){this.register(e).set(t)}get(){const e=this.read();if(void 0!==e)try{return JSON.parse(e)}catch(De){return}}set(e){this.write(JSON.stringify(e))}prop(e){if(void 0!==this.value)return this.value[e]}}const be=["contributors","modalities","musicVideo","podcast-episodes","radioStation","song","uploaded-audios","uploadedAudio","uploaded-videos","uploadedVideo","workouts","workout-programs"],Se={mediaItemStateDidChange:"mediaItemStateDidChange",mediaItemStateWillChange:"mediaItemStateWillChange"},Pe={CRITICAL:50,ERROR:40,WARNING:30,NOTICE:20,INFO:10,DEBUG:2,TRACE:1,NONE:0};const Ee={OFF:"NONE",0:"NONE","+":"INFO","++":"DEBUG",V:"DEBUG",D:"DEBUG",VERBOSE:"DEBUG",VV:"TRACE",SILLY:"TRACE","*":"TRACE"};function getLoggingLevel(e,t={}){if("number"==typeof e)return function(e){return"number"==typeof e&&Object.values(Pe).includes(e)}(e)?e:void 0;let r=e.toUpperCase();return t.allowShorthands&&void 0!==Ee[r]&&(r=Ee[r]),function(e){return"string"==typeof e&&void 0!==Pe[e.toUpperCase()]}(r)?Pe[r]:void 0}function _define_property$1G(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$K(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1G(e,t,r[t])}))}return e}function _object_spread_props$p(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _define_property1(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Te=Pe.ERROR,DEFAULT_POLICY=(e,t)=>e!==Pe.NONE&&t>=e;class Logger$1{get parent(){return this._parent}get children(){return Array.from(this._children.values())}get namespace(){return void 0===this._parent?this.name:this._parent.namespace+"/"+this.name}get enabled(){return this.level!==Pe.NONE}get level(){var e,t,r;return null!==(r=null!==(t=this._level)&&void 0!==t?t:null===(e=this.parent)||void 0===e?void 0:e.level)&&void 0!==r?r:Te}get levelName(){var e;return null!==(e=function(e){for(const[t,r]of Object.entries(Pe))if(e===r)return t}(this.level))&&void 0!==e?e:"UNKNOWN"}get levelPolicy(){var e,t,r;return null!==(r=null!==(t=this._levelPolicy)&&void 0!==t?t:null===(e=this.parent)||void 0===e?void 0:e.levelPolicy)&&void 0!==r?r:DEFAULT_POLICY}get handlers(){var e,t,r;return null!==(r=null!==(t=this._handlers)&&void 0!==t?t:null===(e=this.parent)||void 0===e?void 0:e.handlers)&&void 0!==r?r:{}}isEnabledFor(e){return this.levelPolicy(this.level,e)}setLevel(e){const t=getLoggingLevel(e);void 0!==t&&(this._level=t)}clearLevel(){this._level=void 0}setLevelPolicy(e){this._levelPolicy=e}clearLevelPolicy(){this._levelPolicy=void 0}addHandler(e,t){this._handlers||(this._handlers={}),this._handlers[e]=t}hasHandler(e){var t;return void 0!==(null===(t=this._handlers)||void 0===t?void 0:t[e])}removeHandler(e){void 0!==this._handlers&&(delete this._handlers[e],0===Object.keys(this._handlers).length&&this.clearHandlers())}clearHandlers(){this._handlers=void 0}createChild(e,t){const r=this._children.get(e);return void 0!==r?r:new Logger$1(e,_object_spread_props$p(_object_spread$K({},t),{parent:this}))}linkChild(e){if(void 0!==e.parent&&e.parent!==this)throw new Error(`Logger '${e.name}' is already a child of a different parent ('${e.parent.name}')`);const t=this._children.get(e.name);if(void 0!==t&&t!==e)throw new Error(`A child with name '${e.name}' is already registered`);return void 0===t&&(this._children.set(e.name,e),e.linkParent(this)),e}unlinkChild(e){const t=this._children.get(e.name);return t===e&&(this._children.delete(e.name),t.unlinkParent()),e}getByName(e){return this._children.get(e)}getByNamespace(e){return function(e,t,r="/"){if(""===(t=t.trim())||"*"===t)return e;const n=t.split(r);n[0].trim()===e.name&&n.shift();if(0===n.length)return e;let i=e;for(;void 0!==i&&n.length>0;){const e=n.shift();i=i.getByName(e.trim())}return i}(this,e)}linkParent(e){return this.parent!==e&&(this.unlinkParent(),this._parent=e,e.linkChild(this)),this}unlinkParent(){return void 0!==this._parent&&(this._parent.unlinkChild(this),this._parent=void 0),this}log(e,t,...r){const n=getLoggingLevel(e);void 0!==n&&this.logRecord({time:Date.now(),namespace:this.namespace,level:n,message:t,args:r})}logRecord(e){if(!this.levelPolicy(this.level,e.level))return;const t=_object_spread$K({namespace:this.namespace},e);for(const r of Object.values(this.handlers))r.process(t)}error(e,...t){this.log(Pe.ERROR,e,...t)}warning(e,...t){this.log(Pe.WARNING,e,...t)}warn(e,...t){this.warning(e,...t)}info(e,...t){this.log(Pe.INFO,e,...t)}debug(e,...t){this.log(Pe.DEBUG,e,...t)}trace(e,...t){this.log(Pe.TRACE,e,...t)}constructor(e,t){_define_property1(this,"name",void 0),_define_property1(this,"_parent",void 0),_define_property1(this,"_children",new Map),_define_property1(this,"_level",void 0),_define_property1(this,"_levelPolicy",void 0),_define_property1(this,"_handlers",void 0),this.name=e,this._levelPolicy=null==t?void 0:t.levelPolicy,this._handlers=null==t?void 0:t.handlers,void 0!==(null==t?void 0:t.parent)&&this.linkParent(t.parent),void 0!==(null==t?void 0:t.level)&&this.setLevel(t.level)}}new Map([[Pe.CRITICAL,"error"],[Pe.ERROR,"error"],[Pe.WARNING,"warn"],[Pe.NOTICE,"warn"],[Pe.INFO,"log"],[Pe.DEBUG,"debug"]]);const ke=new Logger$1("media-item"),{none:we,loading:Oe,ready:Ie,playing:Ae,ended:Re,unavailable:$e,restricted:Ce,error:De,unsupported:Me}=y,Ne={[we]:{allowed:[Oe],unknown:[Re,$e,Ce,De,Me]},[Oe]:{allowed:[Ie,Ce,De,Me],unknown:[]},[Ie]:{allowed:[Ae],unknown:[De]},[Ae]:{allowed:[Re,De],unknown:[$e,Ce,Me]},[Re]:{allowed:[],unknown:[]},[$e]:{allowed:[],unknown:[]},[Ce]:{allowed:[],unknown:[]},[De]:{allowed:[],unknown:[]},[Me]:{allowed:[],unknown:[]}},toName=e=>y[e],createMediaItemStateGuard=(e=we)=>{const t={current:e,set(e){const{current:r}=t;if(!((e,t)=>Ne[e].allowed.includes(t))(r,e)){const t=((e,t)=>Ne[e].unknown.includes(t))(r,e);ke.debug(`MediaItem.state was changed from ${toName(r)} to ${toName(e)}`,t?"but it is unknown whether it should be allowed or not.":"and it should not be happening")}t.current=e}};return t};function isStringNotEmpty(e){return!function(e){return void 0===e||""===e.trim()}(e)}function transform$a(e){return transform$b({"attributes.albumName":"metadata.playlistName","attributes.artistName":"metadata.artistName","attributes.artwork"(){const t=null==e?void 0:e.artworkURL;if(t)return function(e){const t=e.split("/").pop(),[r,n]=!!t&&t.match(/\d+/g)||["100","100"];return{width:parseInt(r,10),height:parseInt(n,10),url:e.replace(`${r}x${n}`,"{w}x{h}")}}(t)},"attributes.composerName":"metadata.composerName","attributes.contentRating"(){var t;if(1===(null==e||null===(t=e.metadata)||void 0===t?void 0:t.explicit))return"explicit"},"attributes.discNumber"(){var t;return(null==e||null===(t=e.metadata)||void 0===t?void 0:t.discNumber)||1},"attributes.durationInMillis":"metadata.duration","attributes.genreNames"(){var t;return[null==e||null===(t=e.metadata)||void 0===t?void 0:t.genre]},"attributes.isrc"(){var t;const r=null==e||null===(t=e.metadata)||void 0===t?void 0:t.xid;if(r)return r.replace(/^([^:]+):isrc:/,"$1")},"attributes.name":"metadata.itemName","attributes.playParams.id":"metadata.itemId","attributes.playParams.kind":"metadata.kind","attributes.previews":()=>[{url:null==e?void 0:e.previewURL}],"attributes.releaseDate":"metadata.releaseDate","attributes.trackNumber":"metadata.trackNumber",assetURL:"URL",cloudId:"metadata.cloud-id",id(){var t;return""+(null==e||null===(t=e.metadata)||void 0===t?void 0:t.itemId)},flavor:"flavor",type:"metadata.kind"},e)}function _define_property$1F(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const{mediaItemStateDidChange:Le,mediaItemStateWillChange:xe}=Se,je=BooleanDevFlag.register("mk-music-movie-playback");class MediaItem extends Notifications{get ageGatePolicy(){var e;return null===(e=this.defaultPlayable)||void 0===e?void 0:e.ageGatePolicy}get albumInfo(){const{albumName:e,artistName:t}=this,r=[];return t&&r.push(t),e&&r.push(e),r.join(" - ")}get albumName(){return this.attributes.albumName}get artistName(){return this.attributes.genreNames&&this.attributes.genreNames.indexOf("Classical")>-1&&this.attributes.composerName?this.attributes.composerName:this.attributes.artistName}get artwork(){var e,t;return null!==(t=this.attributes.artwork)&&void 0!==t?t:null===(e=this.attributes.images)||void 0===e?void 0:e.coverArt16X9}get artworkURL(){if(this.artwork&&this.artwork.url)return this.artwork.url}get canPlay(){return this.isPlayable&&this.isReady}get container(){return this._container}set container(e){this._container=e}get contentRating(){return this.attributes.contentRating}get context(){return this._context}set context(e){this._context=e}get defaultPlayable(){var e;return null===(e=this.playables)||void 0===e?void 0:e[0]}get discNumber(){return this.attributes.discNumber}get hasContainerArtwork(){return this.container&&this.container.attributes&&this.container.attributes.artwork&&this.container.attributes.artwork.url}get hasPlaylistContainer(){return this.container&&"playlists"===this.container.type&&this.container.attributes}get supportsLinearScrubbing(){var e,t,r;return this.isLinearStream&&!0===(null===(r=this.defaultPlayable)||void 0===r||null===(t=r.assets)||void 0===t||null===(e=t.streamCapability)||void 0===e?void 0:e.supportsLinearScrubbing)}get isAssetScrubbingDisabled(){return!!this.isLinearStream&&!this.supportsLinearScrubbing}get isLinearStream(){return"LiveService"===(null==(e=this)?void 0:e.type)||"Event"===(null==e||null===(t=e.defaultPlayable)||void 0===t?void 0:t.type)||"EbsEvent"===(null==e||null===(r=e.defaultPlayable)||void 0===r?void 0:r.type);var e,t,r}get isAlgoStation(){return isAlgoStation(this)}get isRadioStation(){return isRadioStation(this)}get isRadioEpisode(){return isRadioEpisode(this)}get isLiveRadioStation(){return isLiveRadioStation(this)}get isLiveAudioStation(){return isLiveRadioStation(this,"audio")}get isLiveVideoStation(){return isLiveRadioStation(this,"video")}get isAOD(){return isRadioEpisode(e=this,t)||!!(null==e||null===(r=e.attributes)||void 0===r?void 0:r.isAOD);var e,t,r}get isSong(){return"song"===this.type}get info(){return`${this.title} - ${this.albumInfo}`}get isCloudItem(){return this.isLibraryItem}get isLibraryItem(){var e,t;return!0===(null===(e=this.playParams)||void 0===e?void 0:e.isLibrary)||isLibraryType(null===(t=this.playParams)||void 0===t?void 0:t.id)||isLibraryType(this.id)}get isCloudUpload(){return"-1"===String(this._songId)}get isExplicitItem(){return"explicit"===this.contentRating}get isLoading(){return this.state===y.loading}get isPlayableMediaType(){return!("musicMovie"!==this.type||!je.enabled)||(this.isUTS||-1!==be.indexOf(this.type))}get isPlayable(){var e;return!!this.isUTS||!!this.isPlayableMediaType&&(!!(this.isLiveRadioStation||this.isRadioEpisode||this.hasOffersHlsUrl)||(this.needsPlayParams?!!this.playParams:!!this.rawAssetUrl||!!(null===(e=this.attributes.previews)||void 0===e?void 0:e.length)))}get isPlaying(){return this.state===y.playing}get isPreparedToPlay(){const e=!!(this.keyURLs&&isStringNotEmpty(this.keyURLs["hls-key-cert-url"])&&isStringNotEmpty(this.keyURLs["hls-key-server-url"])&&isStringNotEmpty(this.keyURLs["widevine-cert-url"]));if("song"===this.type){var t;const n=isStringNotEmpty(this.songId)&&"-1"!==this.songId;var r;const i=(null!==(r=null===(t=this.assets)||void 0===t?void 0:t.length)&&void 0!==r?r:0)>0;return n&&i&&e}if(this.isUTS){return isStringNotEmpty(this.assetURL)&&e||this.playRawAssetURL}return!!isStringNotEmpty(this.assetURL)||this.playRawAssetURL}get isrc(){return this.attributes.isrc}get isReady(){return this.state===y.ready}get isRestricted(){return this.state===y.restricted}get isUTS(){return!!this.defaultPlayable}get isUnavailable(){return this.state===y.unavailable}get needsPlayParams(){return["musicMovie","musicVideo","song"].includes(this.type)}get normalizedType(){return normalizeContentType(this.type)}get offers(){return this.attributes.offers}get offersHlsUrl(){const{offers:e}=this,t=null==e?void 0:e.find(e=>{var t;return!!(null===(t=e.hlsUrl)||void 0===t?void 0:t.length)});return null==t?void 0:t.hlsUrl}get hasOffersHlsUrl(){return isStringNotEmpty(this.offersHlsUrl)}get rawAssetUrl(){return this.attributes.assetUrl}set playbackData(e){if(void 0===e)return;this.previewURL&&(e.previewURL=this.previewURL);const t=transform$a(e);this.artwork&&t.artwork&&delete t.artwork,t.id!==this.id&&delete t.id,this.playParams&&t.attributes.playParams&&(t.attributes.playParams=this.playParams),t.attributes=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1F(e,t,r[t])}))}return e}({},this.attributes,t.attributes),Object.assign(this,t),ke.debug("media-item: item merged with playbackData",this),this.state=y.ready}get playbackDuration(){return this.attributes.durationInMillis||this.attributes.durationInMilliseconds}get playEvent(){var e;return null===(e=this.defaultPlayable)||void 0===e?void 0:e.playEvent}get playlistArtworkURL(){var e,t,r;return this.hasPlaylistContainer&&this.hasContainerArtwork?null===(r=this.container)||void 0===r||null===(t=r.attributes)||void 0===t||null===(e=t.artwork)||void 0===e?void 0:e.url:this.artworkURL}get playlistName(){var e,t;return this.hasPlaylistContainer?null===(t=this.container)||void 0===t||null===(e=t.attributes)||void 0===e?void 0:e.name:this.albumName}get playParams(){return this.attributes.playParams}get playRawAssetURL(){return this.isCloudUpload||!!this.rawAssetUrl}get previewURL(){var e,t,r,n,i,o,a,s,c,l,d,u,p,h,y;return(null===(r=this.attributes)||void 0===r||null===(t=r.previews)||void 0===t||null===(e=t[0])||void 0===e?void 0:e.url)||(null===(o=this.attributes)||void 0===o||null===(i=o.previews)||void 0===i||null===(n=i[0])||void 0===n?void 0:n.hlsUrl)||(null===(l=this.attributes)||void 0===l||null===(c=l.trailers)||void 0===c||null===(s=c[0])||void 0===s||null===(a=s.assets)||void 0===a?void 0:a.hlsUrl)||(null===(p=this.attributes)||void 0===p||null===(u=p.movieClips)||void 0===u||null===(d=u[0])||void 0===d?void 0:d.hlsUrl)||(null===(y=this.attributes)||void 0===y||null===(h=y.video)||void 0===h?void 0:h.hlsUrl)}get rating(){return this.attributes.rating}get releaseDate(){if(this._releaseDate)return this._releaseDate;if(this.attributes&&(this.attributes.releaseDate||this.attributes.releaseDateTime)){const e=this.attributes.releaseDate||this.attributes.releaseDateTime;return this._releaseDate=/^\d{4}-\d{1,2}-\d{1,2}/.test(e)?new Date(e):void 0,this._releaseDate}}set releaseDate(e){this._releaseDate="string"==typeof e?/^\d{4}-\d{1,2}-\d{1,2}/.test(e)?new Date(e):void 0:"number"==typeof e?new Date(e):e}get songId(){return void 0!==this._songId&&"-1"!==String(this._songId)?this._songId:this.id}set songId(e){this._songId=void 0!==e?String(e):void 0}get state(){return this._state.current}set state(e){const t={oldState:this._state.current,state:e};this._stateWillChange&&this._stateWillChange(this),this.dispatchEvent(xe,t),this._state.set(e),this._stateDidChange&&this._stateDidChange(this),this.dispatchEvent(Le,t)}get title(){return this.attributes.name||this.attributes.title}get trackNumber(){return this.attributes.trackNumber}beginMonitoringStateDidChange(e){this._stateDidChange=e}beginMonitoringStateWillChange(e){this._stateWillChange=e}endMonitoringStateDidChange(){this._stateDidChange=void 0}endMonitoringStateWillChange(){this._stateWillChange=void 0}isEqual(e){return this.id===e.id&&this.type===e.type&&this.attributes===e.attributes}resetState(){this.endMonitoringStateWillChange(),this.endMonitoringStateDidChange(),this.state=y.none}restrict(){this.isExplicitItem&&(this.state=y.restricted,this._removePlayableData())}notSupported(){this.state=y.unsupported,this._removePlayableData()}updateFromLoadError(e){switch(e.reason){case MKError.Reason.CONTENT_RESTRICTED:this.state=y.restricted;break;case MKError.Reason.CONTENT_UNAVAILABLE:this.state=y.unavailable;break;default:this.state=y.error}}_removePlayableData(){var e,t,r;null===(e=this.attributes)||void 0===e||delete e.playParams,null===(t=this.attributes)||void 0===t||delete t.previews,null===(r=this.attributes)||void 0===r||delete r.trailers}constructor(t={}){super([Le,xe]),_define_property$1F(this,"id",void 0),_define_property$1F(this,"type",void 0),_define_property$1F(this,"contentType",void 0),_define_property$1F(this,"cloudId",void 0),_define_property$1F(this,"playables",void 0),_define_property$1F(this,"channels",void 0),_define_property$1F(this,"assetURL",void 0),_define_property$1F(this,"hlsMetadata",{}),_define_property$1F(this,"flavor",void 0),_define_property$1F(this,"currentKeyPlay",void 0),_define_property$1F(this,"keyPlayShelf",void 0),_define_property$1F(this,"keyServerQueryParameters",void 0),_define_property$1F(this,"podpafMetrics",void 0),_define_property$1F(this,"attributes",{}),_define_property$1F(this,"meta",{}),_define_property$1F(this,"playbackType",e.PlaybackType.none),_define_property$1F(this,"trackInfo",void 0),_define_property$1F(this,"href",void 0),_define_property$1F(this,"relationships",void 0),_define_property$1F(this,"_container",void 0),_define_property$1F(this,"_context",void 0),_define_property$1F(this,"_releaseDate",void 0),_define_property$1F(this,"_state",createMediaItemStateGuard()),_define_property$1F(this,"_stateDidChange",void 0),_define_property$1F(this,"_stateWillChange",void 0),_define_property$1F(this,"_songId",void 0),_define_property$1F(this,"assets",[]),_define_property$1F(this,"keyURLs",void 0),ke.debug("media-item: creating Media Item with options:",t);var r;t.id&&t.attributes?(Object.assign(this,t),this.type=(null===(r=this.playParams)||void 0===r?void 0:r.kind)?this.playParams.kind:this.type||"song"):(this.id=t.id||generateUUID(),this.type=t.type||"song",this.attributes={playParams:{id:this.id,kind:this.type}});this.contentType=t.contentType,this._context=t.context||{},t.container?this._container=t.container:t.containerId&&t.containerType&&(this._container={id:t.containerId,type:t.containerType})}}const Ue=new Logger$2("player"),K=()=>{},asAsync=e=>{e.then(K,K)};var Fe;!function(e){e.NONE="none",e.FAIRPLAY="com.apple.fps",e.PLAYREADY="com.microsoft.playready",e.WIDEVINE="com.widevine.alpha"}(Fe||(Fe={}));const Ke={app:{},features:{},urls:{}},Be="mk-player-tsid",Ve='audio/mp4;codecs="mp4a.40.2"';var Ge,He,qe;function asyncGeneratorStep$1b(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$1b(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1b(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1b(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function findMediaKeySystemAccess(e,t){return _findMediaKeySystemAccess.apply(this,arguments)}function _findMediaKeySystemAccess(){return(_findMediaKeySystemAccess=_async_to_generator$1b((function*(e,t){for(let n=0;n<e.length;n++)try{const r=e[n];return[r,yield navigator.requestMediaKeySystemAccess(r,t)]}catch(r){}return[]}))).apply(this,arguments)}!function(e){e.playbackLicenseError="playbackLicenseError",e.playbackSessionError="playbackSessionError",e.manifestParsed="manifestParsed",e.audioCodecIdentified="audioCodecIdentified",e.audioTracksSwitched="audioTracksSwitched",e.audioTracksUpdated="audioTracksUpdated",e.textTracksSwitched="textTracksSwitched",e.textTracksUpdated="textTracksUpdated",e.inlineStylesParsed="inlineStylesParsed",e.levelUpdated="levelUpdated"}(Ge||(Ge={})),function(e){e.MP4="audio/mp4",e.AVC1="video/mp4"}(He||(He={})),function(e){e.WIDEVINE="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",e.PLAYREADY="com.microsoft.playready",e.FAIRPLAY="com.apple.streamingkeydelivery"}(qe||(qe={}));let We;const{NONE:Ye,FAIRPLAY:ze,WIDEVINE:Qe,PLAYREADY:Je}=Fe;function supportsDrm(){if(!We)throw new Error("findKeySystemPreference has not been invoked");return We!==Ye}function potentialKeySystemsForAccess(){return function(){const e=getSessionStorage();return!!e&&"true"===e.getItem("mk-playready-cbcs-unsupported")}()?[Qe]:Ke.features["prefer-playready"]?[Je,Qe]:[Qe,Je]}function findKeySystemPreference(e){return _findKeySystemPreference.apply(this,arguments)}function _findKeySystemPreference(){return(_findKeySystemPreference=_async_to_generator$1b((function*(e){var t,r,n;if(null===(n=null==e?void 0:e.isNodeEnvironment)||void 0===n||!n){if(null===(t=window.WebKitMediaKeys)||void 0===t?void 0:t.isTypeSupported(ze+".1_0",He.AVC1))We=ze;else if(null===(r=window.MSMediaKeys)||void 0===r?void 0:r.isTypeSupported(Je,He.AVC1))We=Je;else{const e=document.createElement("video");if(hasMediaKeySupport()&&e.canPlayType('video/mp4;codecs="avc1.42E01E"')&&e.canPlayType(Ve)){const e=[{initDataTypes:["keyids","cenc"],distinctiveIdentifier:"optional",persistentState:"required",videoCapabilities:[{contentType:'video/mp4;codecs="avc1.42E01E"',robustness:"SW_SECURE_CRYPTO"}],audioCapabilities:[{contentType:Ve}]}],t=potentialKeySystemsForAccess(),[r]=yield findMediaKeySystemAccess(t,e);We=r}}return We=null!=We?We:Ye,We}We=Ye}))).apply(this,arguments)}function hasMediaKeySupport(){return!!(navigator&&navigator.requestMediaKeySystemAccess&&window.MediaKeys&&window.MediaKeySystemAccess)}const AsyncDebounce=(e=100,t)=>(r,n,i)=>{const o=i.value,a=asyncDebounce(o,e,t);i.value=a},asyncDebounce=(e,t=250,r={isImmediate:!1})=>{let n,i;function fulfill(e){return null==e?void 0:e.resolve(r.cancelledValue)}const clearLastPromise=()=>{n&&(n.resolved||(fulfill(n),n.timeoutId&&clearTimeout(n.timeoutId)),n=void 0)},invokeFn=(t,r,i,o)=>{e.apply(t,o).then(e=>{r(e),n&&(n.resolved=!0)}).catch(i)};return r.isImmediate?function(...e){const r=Date.now(),o=this;return i&&r>=i&&clearLastPromise(),i=Date.now()+t,n?fulfill(Promise):new Promise((t,r)=>{n={resolve:t,reject:r},invokeFn(o,t,r,e)})}:function(...e){const r=this;return n&&clearLastPromise(),new Promise((function(i,o){const a=setTimeout(invokeFn.bind(void 0,r,i,o,e),t);n={resolve:i,reject:o,timeoutId:a}}))}};function deprecationWarning(e,t={}){var r;const n=null!==(r=t.message)&&void 0!==r?r:e+" has been deprecated",i=[];t.since&&i.push("since: "+t.since),t.until&&i.push("until: "+t.until),console.warn("Deprecation Warning: "+n+(i.length>0?` (${i.join(", ")})`:""))}function asyncGeneratorStep$1a(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$1a(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1a(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1a(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}const Xe={},SerialAsync=e=>{let t=Promise.resolve();return(r,n,i)=>{const o=i.value;return i.value=_async_to_generator$1a((function*(...r){return e&&(t=(e=>{let t=Xe[e];return t||(t=Promise.resolve(),Xe[e]=t),t})(e)),t=t.catch(()=>{}).then(()=>o.apply(this,r)),e&&(Xe[e]=t),t})),i}};var Ze,et,tt;e.PlaybackBitrate=void 0,(Ze=e.PlaybackBitrate||(e.PlaybackBitrate={}))[Ze.STANDARD=64]="STANDARD",Ze[Ze.HIGH=256]="HIGH",function(e){e.apiStorefrontChanged="apiStorefrontChanged",e.hlsLevelUpdated="hlsLevelUpdated",e.mediaContentComplete="mediaContentComplete",e.playbackPause="playbackPause",e.playbackPlay="playbackPlay",e.playbackScrub="playbackScrub",e.playbackSeek="playbackSeek",e.playbackSkip="playbackSkip",e.playbackStop="playbackStop",e.lyricsPlay="lyricsPlay",e.lyricsStop="lyricsStop",e.playerActivate="playerActivate",e.playerExit="playerExit",e.queueModified="queueModified",e.userActivityIntent="userActivityIntent",e.applicationActivityIntent="applicationActivityIntent",e.timedMetadata="timedMetadata"}(et||(et={})),function(e){e[e.ACCURATE=0]="ACCURATE",e[e.ROUND=1]="ROUND"}(tt||(tt={}));class TimingAccuracy{time(e=0){return 1===this.mode?Math.round(e):e}constructor(e=!1){!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"mode",void 0),this.mode=e?0:1}}const rt={audioTrackAdded:"audioTrackAdded",audioTrackChanged:"audioTrackChanged",audioTrackRemoved:"audioTrackRemoved",bufferedProgressDidChange:"bufferedProgressDidChange",drmUnsupported:"drmUnsupported",forcedTextTrackChanged:"forcedTextTrackChanged",mediaCanPlay:"mediaCanPlay",mediaElementCreated:"mediaElementCreated",mediaPlaybackError:"mediaPlaybackError",nowPlayingItemDidChange:"nowPlayingItemDidChange",nowPlayingItemWillChange:"nowPlayingItemWillChange",metadataDidChange:"metadataDidChange",hlsDaterangeUpdated:"player.hls.daterangeUpdated",playbackBitrateDidChange:"playbackBitrateDidChange",playbackDurationDidChange:"playbackDurationDidChange",playbackProgressDidChange:"playbackProgressDidChange",playbackRateDidChange:"playbackRateDidChange",playbackStateDidChange:"playbackStateDidChange",playbackStateWillChange:"playbackStateWillChange",playbackTargetAvailableDidChange:"playbackTargetAvailableDidChange",playbackTargetIsWirelessDidChange:"playbackTargetIsWirelessDidChange",playbackTimeDidChange:"playbackTimeDidChange",playbackVolumeDidChange:"playbackVolumeDidChange",playerTypeDidChange:"playerTypeDidChange",presentationModeDidChange:"presentationModeDidChange",primaryPlayerDidChange:"primaryPlayerDidChange",textTrackAdded:"textTrackAdded",textTrackChanged:"textTrackChanged",textTrackRemoved:"textTrackRemoved",timedMetadataDidChange:"timedMetadataDidChange"};function _define_property$1D(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class BitrateCalculator{get bitrate(){return this._bitrate}set bitrate(e){this._bitrate!==e&&(this._bitrate=e,this._dispatcher.publish(rt.playbackBitrateDidChange,{bitrate:e}))}_calculateAverageDownlink(){return 0===this._downlinkSamples.length?0:this._downlinkSamples.reduce((e,t)=>e+t,0)/this._downlinkSamples.length||0}_recalculateBitrate(t){Ue.debug("_recalculateBitrate",t),this._downlinkSamples.push(t);this._calculateAverageDownlink()>e.PlaybackBitrate.STANDARD?(Ue.debug("setting bitrate to",e.PlaybackBitrate.HIGH),this.bitrate=e.PlaybackBitrate.HIGH):(Ue.debug("setting bitrate to",e.PlaybackBitrate.STANDARD),this.bitrate=e.PlaybackBitrate.STANDARD)}constructor(t,r=e.PlaybackBitrate.STANDARD){var n,i,o;_define_property$1D(this,"_bitrate",void 0),_define_property$1D(this,"_dispatcher",void 0),_define_property$1D(this,"_downlinkSamples",[]),this._bitrate=r,this._dispatcher=t,void 0!==(null===(o=window)||void 0===o||null===(i=o.navigator)||void 0===i||null===(n=i.connection)||void 0===n?void 0:n.downlink)&&this._recalculateBitrate(100*(window.navigator.connection.downlink||0))}}var nt,it,ot,at,st,ct,lt;!function(e){e.MUSICKIT="music_kit-integration",e.OTHER="other",e.MINI="mini",e.SONG="song",e.ALBUM="album",e.ALBUM_CLASSICAL="album-classical",e.ARTIST="artist",e.COMPILATION="compilation",e.COMPILATION_CLASSICAL="compilation-classical",e.PLAYLIST="playlist",e.PLAYLIST_CLASSICAL="playlist-classical",e.RADIO="radio",e.SEARCH="search",e.STATION="station"}(nt||(nt={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.RADIO=1]="RADIO",e[e.PLAYLIST=2]="PLAYLIST",e[e.ALBUM=3]="ALBUM",e[e.ARTIST=4]="ARTIST"}(it||(it={})),function(e){e[e.NOT_APPLICABLE=0]="NOT_APPLICABLE",e[e.OTHER=1]="OTHER",e[e.TRACK_SKIPPED_FORWARDS=2]="TRACK_SKIPPED_FORWARDS",e[e.PLAYBACK_MANUALLY_PAUSED=3]="PLAYBACK_MANUALLY_PAUSED",e[e.PLAYBACK_SUSPENDED=4]="PLAYBACK_SUSPENDED",e[e.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM=5]="MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM",e[e.PLAYBACK_PAUSED_DUE_TO_INACTIVITY=6]="PLAYBACK_PAUSED_DUE_TO_INACTIVITY",e[e.NATURAL_END_OF_TRACK=7]="NATURAL_END_OF_TRACK",e[e.PLAYBACK_STOPPED_DUE_TO_SESSION_TIMEOUT=8]="PLAYBACK_STOPPED_DUE_TO_SESSION_TIMEOUT",e[e.TRACK_BANNED=9]="TRACK_BANNED",e[e.FAILED_TO_LOAD=10]="FAILED_TO_LOAD",e[e.PAUSED_ON_TIMEOUT=11]="PAUSED_ON_TIMEOUT",e[e.SCRUB_BEGIN=12]="SCRUB_BEGIN",e[e.SCRUB_END=13]="SCRUB_END",e[e.TRACK_SKIPPED_BACKWARDS=14]="TRACK_SKIPPED_BACKWARDS",e[e.NOT_SUPPORTED_BY_CLIENT=15]="NOT_SUPPORTED_BY_CLIENT",e[e.QUICK_PLAY=16]="QUICK_PLAY",e[e.EXITED_APPLICATION=17]="EXITED_APPLICATION"}(ot||(ot={})),e.SeekReasonType=void 0,(at=e.SeekReasonType||(e.SeekReasonType={}))[at.Manual=0]="Manual",at[at.Interval=1]="Interval",at[at.SkipIntro=2]="SkipIntro",at[at.Automatic=3]="Automatic",at[at.SkipToLiveManual=4]="SkipToLiveManual",at[at.SkipToLiveAutomatic=5]="SkipToLiveAutomatic",function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.NO_RIGHTS=1]="NO_RIGHTS",e[e.PURCHASED=2]="PURCHASED",e[e.UPLOADED=3]="UPLOADED",e[e.MATCHED=4]="MATCHED",e[e.ADDED=5]="ADDED",e[e.SUBSCRIBED=6]="SUBSCRIBED",e[e.NOT_SUPPORTED=7]="NOT_SUPPORTED"}(st||(st={})),function(e){e[e.NO_SELECTION_PLAY=0]="NO_SELECTION_PLAY",e[e.RESUME_LAST_PLAYED_SONG=1]="RESUME_LAST_PLAYED_SONG",e[e.RESUME_CURRENT_DEVICE_POSITION=2]="RESUME_CURRENT_DEVICE_POSITION"}(ct||(ct={})),function(e){e[e.NOT_APPLICABLE=0]="NOT_APPLICABLE",e[e.SIMILARITIES=1]="SIMILARITIES",e[e.ESSENTIALS=2]="ESSENTIALS",e[e.USER_LIBRARY=3]="USER_LIBRARY",e[e.ALGO_HEATSEEKER=4]="ALGO_HEATSEEKER",e[e.SEED_TRACK=5]="SEED_TRACK",e[e.GN_1M_TEMPORARY=6]="GN_1M_TEMPORARY",e[e.VECTOR=8]="VECTOR",e[e.ARTIST_SIMILARITIES=9]="ARTIST_SIMILARITIES",e[e.STORY_ALBUM_LISTENERS_ALSO_BOUGHT=10]="STORY_ALBUM_LISTENERS_ALSO_BOUGHT",e[e.STORY_ALBUM_SALES_LEADER=11]="STORY_ALBUM_SALES_LEADER",e[e.STORY_BILLBOARD=12]="STORY_BILLBOARD",e[e.STORY_COMPLETE_MY_ALBUM=13]="STORY_COMPLETE_MY_ALBUM",e[e.STORY_CRITICAL_PICK=14]="STORY_CRITICAL_PICK",e[e.STORY_ITUNES_ESSENTIAL=15]="STORY_ITUNES_ESSENTIAL",e[e.STORY_HEATSEEKER=16]="STORY_HEATSEEKER",e[e.STORY_IDENTITY=17]="STORY_IDENTITY",e[e.STORY_POWER_SONG=18]="STORY_POWER_SONG",e[e.STORY_SONG_SALES_LEADER=20]="STORY_SONG_SALES_LEADER",e[e.GENRE_SIMILARITIES=21]="GENRE_SIMILARITIES",e[e.STORY_IMIX=22]="STORY_IMIX",e[e.STORY_OTHER_MIX=23]="STORY_OTHER_MIX",e[e.EDITORIAL=24]="EDITORIAL",e[e.TOP_SONGS=25]="TOP_SONGS",e[e.SUBFORMAT_SONGS=26]="SUBFORMAT_SONGS",e[e.CRITICAL_PICKS=27]="CRITICAL_PICKS",e[e.US_ARTIST_SIMS=28]="US_ARTIST_SIMS",e[e.HEAVY_ROTATION=29]="HEAVY_ROTATION",e[e.STORY_FORMAT_STATION_HEAVY_ROTATION=30]="STORY_FORMAT_STATION_HEAVY_ROTATION",e[e.ARTIST_BASED_CORE_SIMILAR_ARTISTS=31]="ARTIST_BASED_CORE_SIMILAR_ARTISTS",e[e.ARTIST_BASED_FAMILIAR_SIMILAR_ARTISTS=32]="ARTIST_BASED_FAMILIAR_SIMILAR_ARTISTS",e[e.ARTIST_BASED_DISCOVERIES=33]="ARTIST_BASED_DISCOVERIES",e[e.ARTIST_BASED_HOT_SONGS=34]="ARTIST_BASED_HOT_SONGS",e[e.ARTIST_BASED_SEED_ARTIST=35]="ARTIST_BASED_SEED_ARTIST",e[e.ARTIST_BASED_COMPOSER=36]="ARTIST_BASED_COMPOSER",e[e.EDITORIAL_STATION_INTRO=37]="EDITORIAL_STATION_INTRO",e[e.EDITORIAL_RELATIVE_REPEAT=38]="EDITORIAL_RELATIVE_REPEAT",e[e.EDITORIAL_ABSOLUTE_REPEAT=39]="EDITORIAL_ABSOLUTE_REPEAT",e[e.EDITORIAL_SCHEDULED=40]="EDITORIAL_SCHEDULED",e[e.EDITORIAL_SUGGESTED_ARTIST=41]="EDITORIAL_SUGGESTED_ARTIST",e[e.FOR_YOU_FAMILIAR=42]="FOR_YOU_FAMILIAR",e[e.FOR_YOU_RECOMMENDED=43]="FOR_YOU_RECOMMENDED",e[e.FOR_YOU_FAVORITE_ARTIST=44]="FOR_YOU_FAVORITE_ARTIST",e[e.FOR_YOU_RECOMMENDED_ARTIST=45]="FOR_YOU_RECOMMENDED_ARTIST",e[e.EDITORIAL_POSITIONAL=46]="EDITORIAL_POSITIONAL",e[e.SIMILAR_SONGS=47]="SIMILAR_SONGS",e[e.SONG_ATTRIBUTE_FAVORITE_ARTIST=48]="SONG_ATTRIBUTE_FAVORITE_ARTIST",e[e.SONG_ATTRIBUTE_FAVORITE_ARTIST_DERIVED=49]="SONG_ATTRIBUTE_FAVORITE_ARTIST_DERIVED",e[e.SONG_ATTRIBUTE_FAVORITE_ARTIST_EDITORIAL=50]="SONG_ATTRIBUTE_FAVORITE_ARTIST_EDITORIAL",e[e.SONG_ATTRIBUTE_RECOMMENDED=51]="SONG_ATTRIBUTE_RECOMMENDED",e[e.SONG_ATTRIBUTE_RECOMMENDED_DERIVED=52]="SONG_ATTRIBUTE_RECOMMENDED_DERIVED",e[e.SONG_ATTRIBUTE_RECOMMENDED_EDITORIAL=53]="SONG_ATTRIBUTE_RECOMMENDED_EDITORIAL",e[e.SONG_ATTRIBUTE_NON_PERSONALIZED=54]="SONG_ATTRIBUTE_NON_PERSONALIZED",e[e.SONG_ATTRIBUTE_NON_PERSONALIZED_DERIVED=55]="SONG_ATTRIBUTE_NON_PERSONALIZED_DERIVED",e[e.SONG_ATTRIBUTE_NON_PERSONALIZED_EDITORIAL=56]="SONG_ATTRIBUTE_NON_PERSONALIZED_EDITORIAL",e[e.PERSONAL_STATION=57]="PERSONAL_STATION",e[e.PERSONAL_STATION_FAVORITE_ARTIST=58]="PERSONAL_STATION_FAVORITE_ARTIST",e[e.PERSONAL_STATION_RECOMMENDED=59]="PERSONAL_STATION_RECOMMENDED",e[e.NEW_MUSIC_STATION=60]="NEW_MUSIC_STATION",e[e.NEW_MUSIC_STATION_FAVORITE_ARTIST=61]="NEW_MUSIC_STATION_FAVORITE_ARTIST",e[e.NEW_MUSIC_STATION_RECOMMENDED=62]="NEW_MUSIC_STATION_RECOMMENDED"}(lt||(lt={}));var dt,ut,pt,ht,yt,ft,_t,vt,mt,gt,bt,St,Pt,Et;!function(e){e[e.UNKNOWN_FORMAT=0]="UNKNOWN_FORMAT",e[e.STEREO=1]="STEREO",e[e.SPATIAL=2]="SPATIAL",e[e.PREFERENCE_FORMAT_UNSUPPORTED=3]="PREFERENCE_FORMAT_UNSUPPORTED"}(dt||(dt={})),function(e){e[e.UNKNOWN_QUALITY=0]="UNKNOWN_QUALITY",e[e.HIGH_EFFICIENCY=1]="HIGH_EFFICIENCY",e[e.HIGH_QUALITY=2]="HIGH_QUALITY",e[e.LOSSLESS=3]="LOSSLESS",e[e.HIGH_RESOLUTION_LOSSLESS=4]="HIGH_RESOLUTION_LOSSLESS",e[e.PREFERENCE_QUALITY_UNSUPPORTED=5]="PREFERENCE_QUALITY_UNSUPPORTED"}(ut||(ut={})),function(e){e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.STATIC=1]="STATIC",e[e.LINE_BY_LINE=2]="LINE_BY_LINE",e[e.WORD_BY_WORD=3]="WORD_BY_WORD"}(pt||(pt={})),function(e){e[e.REPEAT_UNKNOWN=0]="REPEAT_UNKNOWN",e[e.REPEAT_OFF=1]="REPEAT_OFF",e[e.REPEAT_ONE=2]="REPEAT_ONE",e[e.REPEAT_ALL=3]="REPEAT_ALL"}(ht||(ht={})),function(e){e[e.SHUFFLE_UNKNOWN=0]="SHUFFLE_UNKNOWN",e[e.SHUFFLE_OFF=1]="SHUFFLE_OFF",e[e.SHUFFLE_ON=2]="SHUFFLE_ON"}(yt||(yt={})),function(e){e[e.AUTO_UNKNOWN=0]="AUTO_UNKNOWN",e[e.AUTO_OFF=1]="AUTO_OFF",e[e.AUTO_ON=2]="AUTO_ON",e[e.AUTO_ON_CONTENT_UNSUPPORTED=3]="AUTO_ON_CONTENT_UNSUPPORTED"}(ft||(ft={})),function(e){e[e.NOT_SPECIFIED=0]="NOT_SPECIFIED",e[e.CONTAINER_CHANGED=1]="CONTAINER_CHANGED"}(_t||(_t={})),function(e){e[e.PLAY_END=0]="PLAY_END",e[e.PLAY_START=1]="PLAY_START",e[e.LYRIC_DISPLAY=2]="LYRIC_DISPLAY"}(vt||(vt={})),function(e){e[e.INVALID=0]="INVALID",e[e.ITUNES_STORE_CONTENT=1]="ITUNES_STORE_CONTENT",e[e.NON_SONG_CLIP=2]="NON_SONG_CLIP",e[e.AD=3]="AD",e[e.STREAM=4]="STREAM",e[e.AUDIO_AD=5]="AUDIO_AD",e[e.VIDEO_AD=6]="VIDEO_AD",e[e.TIMED_METADATA_PING=7]="TIMED_METADATA_PING",e[e.ARTIST_UPLOADED_CONTENT=8]="ARTIST_UPLOADED_CONTENT",e[e.AGGREGATE_NON_CATALOG_PLAY_TIME=9]="AGGREGATE_NON_CATALOG_PLAY_TIME",e[e.ORIGINAL_CONTENT_MOVIES=10]="ORIGINAL_CONTENT_MOVIES",e[e.ORIGINAL_CONTENT_SHOWS=11]="ORIGINAL_CONTENT_SHOWS"}(mt||(mt={})),function(e){e[e.AUDIO=0]="AUDIO",e[e.VIDEO=1]="VIDEO"}(gt||(gt={})),function(e){e[e.AUTO=0]="AUTO",e[e.MANUAL=1]="MANUAL"}(bt||(bt={})),function(e){e[e.ORIGINATING_DEVICE=0]="ORIGINATING_DEVICE",e[e.PAIRED_WATCH=1]="PAIRED_WATCH",e[e.SONOS=2]="SONOS",e[e.CAR_PLAY=3]="CAR_PLAY",e[e.WEB_AUC=4]="WEB_AUC",e[e.TWITTER_AUC=5]="TWITTER_AUC",e[e.MUSIC_SDK=6]="MUSIC_SDK",e[e.ATV_REMOTE=7]="ATV_REMOTE",e[e.WEBPLAYER=8]="WEBPLAYER",e[e.WHOLE_HOUSE_AUDIO=9]="WHOLE_HOUSE_AUDIO",e[e.MUSICKIT=10]="MUSICKIT",e[e.VW=11]="VW",e[e.UNKNOWN_SOURCE_TYPE=12]="UNKNOWN_SOURCE_TYPE",e[e.AMAZON=13]="AMAZON",e[e.PORSCHE=14]="PORSCHE",e[e.CHROMECAST=15]="CHROMECAST",e[e.WEB_APP=16]="WEB_APP",e[e.MERCEDES_BENZ=17]="MERCEDES_BENZ",e[e.THIRD_PARTY_TV=18]="THIRD_PARTY_TV",e[e.SEAT=19]="SEAT",e[e.CUPRA=20]="CUPRA"}(St||(St={})),function(e){e[e.EPISODE=1]="EPISODE",e[e.SHOUTCAST=2]="SHOUTCAST"}(Pt||(Pt={})),new Map([["play",vt.PLAY_START],["playbackstarted",vt.PLAY_START],["stop",vt.PLAY_END],["playbackstopped",vt.PLAY_END]]),new Map([["exit",ot.EXITED_APPLICATION],["next",ot.TRACK_SKIPPED_FORWARDS],["pause",ot.PLAYBACK_MANUALLY_PAUSED],["playbackfinished",ot.NATURAL_END_OF_TRACK],["playbackstopped",ot.PLAYBACK_MANUALLY_PAUSED],["previous",ot.TRACK_SKIPPED_BACKWARDS],["scrub_begin",ot.SCRUB_BEGIN],["scrub_end",ot.SCRUB_END],["stop",ot.NATURAL_END_OF_TRACK]]),new Logger$2("paf"),function(e){e[e.ALEXA=13]="ALEXA"}(Et||(Et={}));const Bind=()=>(e,t,r)=>{if(void 0===r||"function"!=typeof r.value)throw new TypeError(`Only methods can be decorated with @Bind, but ${t} is not a method.`);return{configurable:!0,get(){const e=r.value.bind(this);return Object.defineProperty(this,t,{value:e,configurable:!0,writable:!0}),e}}},Tt=["exitFullscreen","webkitExitFullscreen","mozCancelFullScreen","msExitFullscreen"],kt=["fullscreenElement","webkitFullscreenElement","mozFullScreenElement","msFullscreenElement"],wt=["requestFullscreen","webkitRequestFullscreen","mozRequestFullScreen","msRequestFullscreen"],noop=()=>Promise.resolve(),Ot=(e=>{if(void 0===e)return noop;const t=Tt.find(t=>"function"==typeof e.prototype[t]);return"string"!=typeof t?noop:(e=self.document)=>{var r;return null==e||null===(r=e[t])||void 0===r?void 0:r.call(e)}})(Document),It=(e=>{if(void 0===e)return()=>!1;const t=kt.find(t=>t in e.prototype);return"string"!=typeof t?()=>!1:(e=self.document)=>!!e[t]})(Document),At=(e=>{if(void 0===e)return noop;const t=wt.find(t=>"function"==typeof e.prototype[t]);return"string"!=typeof t?noop:e=>null==e?void 0:e[t]()})(HTMLElement);function asyncGeneratorStep$19(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$19(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$19(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$19(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}class Fullscreen{exit(){var e=this;return _async_to_generator$19((function*(){if(e.isInFullscreen())return e.stopDispatchingEvents(()=>e.exitFullscreen())}))()}request(e){var t=this;return _async_to_generator$19((function*(){if(void 0!==e)return t.stopDispatchingEvents(()=>t.requestFullscreenForElement(e))}))()}stopDispatchingEvents(e){var t=this;return _async_to_generator$19((function*(){return t.player.windowHandlers.stopListeningToVisibilityChanges(e)}))()}exitFullscreen(){return Ot()}isInFullscreen(){return It()}requestFullscreenForElement(e){return At(e)}constructor(e){!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"player",void 0),this.player=e}}function asyncGeneratorStep$18(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _define_property$1B(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class UnsupportedSeeker{start(){Ue.warn("seeker.start is not supported in this playback method")}end(){Ue.warn("seeker.end is not supported in this playback method")}seekToTime(e){return Ue.warn("seekToTime is not supported in this playback method"),Promise.resolve()}constructor(){_define_property$1B(this,"ended",!1)}}class PlayerSeeker{get ended(){return this._ended}get isEngagedInPlayback(){return this._player.isEngagedInPlayback}get stillPlayingSameItem(){return this._currentItem===this._player.nowPlayingItem}end(){Ue.debug("seeker: end"),-1!==this._startTime?this._ended?Ue.warn("seeker: Cannot end the same seeker twice."):(this.dispatchStartEvent(),this.dispatchEndEvent()):Ue.warn("seeker: Cannot end a seeker before starting it.")}seekToTime(e){var t,r=this;return(t=function*(){if(Ue.debug("seeker: seekToTime",e),!r.ended)return r.stillPlayingSameItem||(r._currentItem=r._player.nowPlayingItem,r._startTime=0),r._lastSeekedTime=e,r._player.seekToTime(e);Ue.warn("seeker: Cannot seek once the seeker has ended")},function(){var e=this,r=arguments;return new Promise((function(n,i){var o=t.apply(e,r);function _next(e){asyncGeneratorStep$18(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$18(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}start(){Ue.debug("seeker: start"),-1===this._startTime?(this._currentItem=this._player.nowPlayingItem,this._startTime=this._player.currentPlaybackTime,this._lastSeekedTime=this._startTime):Ue.warn("seeker: Cannot start same seeker twice")}dispatch(e,t){this.isEngagedInPlayback?(Ue.debug("seeker: dispatch",e),this._player.dispatch(e,t)):Ue.debug("seeker: do not dispatch because isEngagedInPlayback",this.isEngagedInPlayback)}dispatchStartEvent(){this.stillPlayingSameItem||(this._startTime=0,this._lastSeekedTime=0),this.dispatch(et.playbackScrub,{item:this._currentItem,position:this._startTime})}dispatchEndEvent(){this._ended=!0,this.dispatch(et.playbackScrub,{item:this._currentItem,position:this._lastSeekedTime,endReasonType:ot.SCRUB_END})}constructor(e){_define_property$1B(this,"_ended",!1),_define_property$1B(this,"_lastSeekedTime",-1),_define_property$1B(this,"_player",void 0),_define_property$1B(this,"_startTime",-1),_define_property$1B(this,"_currentItem",void 0),Ue.debug("seeker: new"),this._player=e}}function asyncGeneratorStep$17(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _define_property$1A(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$x(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$x(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const{visibilityChangeEvent:Rt,visibilityState:$t,unloadEventName:Ct}=(()=>{let e="visibilitychange",t="visibilityState";void 0!==document.mozHidden?(e="mozvisibilitychange",t="mozVisibilityState"):void 0!==document.msHidden?(e="msvisibilitychange",t="msVisibilityState"):document.webkitHidden&&(e="webkitvisibilitychange",t="webkitVisibilityState");return{visibilityChangeEvent:e,visibilityState:t,unloadEventName:"onpagehide"in window?"pagehide":"unload"}})();class WindowHandlers{activate(e=self,t=self.document){t.addEventListener(Rt,this.visibilityChanged),e.addEventListener("storage",this.storage,!1),e.addEventListener(Ct,this.windowUnloaded)}deactivate(){document.removeEventListener(Rt,this.visibilityChanged),window.removeEventListener("storage",this.storage),window.addEventListener(Ct,this.windowUnloaded)}stopListeningToVisibilityChanges(e){var t,r=this;return(t=function*(){r.dispatchVisibilityChanges=!1;const t=yield e();return r.dispatchVisibilityChanges=!0,t},function(){var e=this,r=arguments;return new Promise((function(n,i){var o=t.apply(e,r);function _next(e){asyncGeneratorStep$17(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$17(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}dispatch(e,t={}){this.player.dispatch(e,t)}storage({key:e,newValue:t}){e===Be&&this.player.tsidChanged(t)}visibilityChanged(e){const t=e.target[$t];Ue.info("dc visibilityState",t,e,It()),this.runtimeEnvironment.os.isIOS&&this.dispatchVisibilityChanges&&("hidden"===t?this.dispatch(et.playerExit,{item:this.player.nowPlayingItem,position:this.player.currentPlaybackTime}):"visible"===t&&this.dispatch(et.playerActivate))}windowUnloaded(){this.player.isPlaying&&this.dispatch(et.playerExit,{item:this.player.nowPlayingItem,position:this.player.currentPlaybackTime})}constructor(e,t){_define_property$1A(this,"player",void 0),_define_property$1A(this,"runtimeEnvironment",void 0),_define_property$1A(this,"dispatchVisibilityChanges",!0),this.player=e,this.runtimeEnvironment=t}}function asyncGeneratorStep$16(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$16(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$16(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$16(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1z(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$I(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1z(e,t,r[t])}))}return e}function _ts_metadata$w(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}_ts_decorate$x([Bind(),_ts_metadata$x("design:type",Function),_ts_metadata$x("design:paramtypes",[void 0]),_ts_metadata$x("design:returntype",void 0)],WindowHandlers.prototype,"storage",null),_ts_decorate$x([Bind(),_ts_metadata$x("design:type",Function),_ts_metadata$x("design:paramtypes",["undefined"==typeof Event?Object:Event]),_ts_metadata$x("design:returntype",void 0)],WindowHandlers.prototype,"visibilityChanged",null),_ts_decorate$x([Bind(),_ts_metadata$x("design:type",Function),_ts_metadata$x("design:paramtypes",[]),_ts_metadata$x("design:returntype",void 0)],WindowHandlers.prototype,"windowUnloaded",null);const{bufferedProgressDidChange:Dt,mediaCanPlay:Mt,mediaElementCreated:Nt,mediaPlaybackError:Lt,nowPlayingItemDidChange:xt,nowPlayingItemWillChange:jt,metadataDidChange:Ut,primaryPlayerDidChange:Ft,playbackDurationDidChange:Kt,playbackProgressDidChange:Bt,playbackStateDidChange:Vt,playbackRateDidChange:Gt,playbackStateWillChange:Ht,playbackTargetAvailableDidChange:qt,playbackTargetIsWirelessDidChange:Wt,playbackTimeDidChange:Yt,playbackVolumeDidChange:zt}=rt,Qt=["canplay","durationchange","ended","error","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","timeupdate","volumechange","waiting"],Jt=["NotAllowedError","NotSupportedError"],{ended:Xt,loading:Zt,paused:er,playing:tr,seeking:rr,stopped:nr,waiting:ir}=e.PlaybackStates;class BasePlayer{get bitrate(){return this._bitrateCalculator.bitrate}get currentBufferedProgress(){return this._currentBufferedProgress}get _currentDuration(){return this._targetElement.duration}get _currentTime(){const e=this._targetElement.currentTime,t=this._buffer;var r;return e-(null!==(r=null==t?void 0:t.currentTimestampOffset)&&void 0!==r?r:0)}get currentPlaybackDuration(){const t=this.nowPlayingItem;if(!t)return 0;const r="podcast-episodes"===t.type,n=t.playbackType===e.PlaybackType.encryptedFull||t.playbackType===e.PlaybackType.unencryptedFull,i=t.playbackDuration;return n&&i&&!r?this.calculateTime(i/1e3):this.calculateTime(this._currentDuration)}get currentPlaybackTime(){return this.calculateTime(this._currentTime)}calculateTime(e){return this._timing.time(e)}get currentPlaybackTimeRemaining(){return this.currentPlaybackDuration-this.currentPlaybackTime}get currentPlaybackProgress(){return this._currentPlaybackProgress||0}get hasMediaElement(){return this._targetElement instanceof HTMLElement&&null!==this._targetElement.parentNode}get isEngagedInPlayback(){return!this._stopped&&!this.isPaused()}get isPlaying(){return this.playbackState===tr}get isPrimaryPlayer(){return this._isPrimaryPlayer}set isPrimaryPlayer(e){var t;e!==this._isPrimaryPlayer&&(this._isPrimaryPlayer=e,this._isPrimaryPlayer?null===(t=getLocalStorage())||void 0===t||t.setItem(Be,this._serial):(this._dispatcher.publish(Ft,{target:this}),this.pause({userInitiated:!1})))}get isReady(){return 0!==this._targetElement.readyState}get nowPlayingItem(){return this._nowPlayingItem}set nowPlayingItem(e){const t=this._dispatcher;if(void 0===e)return t.publish(jt,{item:e}),this._nowPlayingItem=e,void t.publish(xt,{item:e});const r=this._nowPlayingItem,n=this._buffer;(null==r?void 0:r.isEqual(e))||(t.publish(jt,{item:e}),this.isPlaying&&(null==n?void 0:n.currentItem)!==e&&this._pauseMedia(),r&&(Ue.debug("setting state to ended on ",r.title),r.state=y.ended,r.endMonitoringStateDidChange(),r.endMonitoringStateWillChange()),this._nowPlayingItem=e,Ue.debug("setting state to playing on ",e.title),e.state=y.playing,e&&e.info&&this._setTargetElementTitle(e.info),t.publish(xt,{item:e}),t.publish(Kt,{currentTarget:this._targetElement,duration:this.currentPlaybackDuration,target:this._targetElement,type:"durationchange"}))}get playbackRate(){return this._targetElement.playbackRate}set playbackRate(e){this._targetElement.playbackRate=e}get playbackState(){return this._playbackState}setPlaybackState(e,t){const r=this._playbackState;if(e===r)return;const n={oldState:r,state:e,nowPlayingItem:t};Ue.debug("BasePlayer.playbackState is changing",n),this._dispatcher.publish(Ht,n),this._playbackState=e,this._dispatcher.publish(Vt,n)}get playbackTargetAvailable(){return void 0!==window.WebKitPlaybackTargetAvailabilityEvent&&this._playbackTargetAvailable}set playbackTargetAvailable(e){e!==this._playbackTargetAvailable&&(this._playbackTargetAvailable=e,this._dispatcher.publish(qt,{available:e}))}get playbackTargetIsWireless(){return void 0!==window.WebKitPlaybackTargetAvailabilityEvent&&this._playbackTargetIsWireless}set playbackTargetIsWireless(e){e!==this._playbackTargetIsWireless&&(this._playbackTargetIsWireless=e,this._dispatcher.publish(Wt,{playing:e}))}get volume(){return this._targetElement.volume}set volume(e){this._targetElement.volume=e}get isDestroyed(){return this._isDestroyed}get isInitialized(){return this._isInitialized}clearNextManifest(){var e;null===(e=this._buffer)||void 0===e||e.clearNextManifest()}initialize(){var e=this;return _async_to_generator$16((function*(){Ue.trace("BasePlayer.initialize"),e._isInitialized?Ue.warn("Player is already initialized"):(yield e.initializeMediaElement(),yield e.initializeExtension(),e.initializeEventHandlers(),e._dispatcher.publish(Nt,e._targetElement),e._isInitialized=!0)}))()}initializeEventHandlers(){if(this.windowHandlers.activate(),!this.hasMediaElement)return;const e=this._targetElement;window.WebKitPlaybackTargetAvailabilityEvent&&(e.addEventListener("webkitplaybacktargetavailabilitychanged",e=>{this.playbackTargetAvailable="available"===e.availability}),e.addEventListener("webkitcurrentplaybacktargetiswirelesschanged",e=>{this.playbackTargetIsWireless=e.target===this._targetElement&&!this.playbackTargetIsWireless})),Ue.debug(`Adding event handlers to <HTMLMediaElement id=${this._targetElement.id} />`,this._targetElement),Qt.forEach(t=>e.addEventListener(t,this)),this._dispatcher.publish(et.playerActivate)}removeEventHandlers(){Ue.trace("BasePlayer.removeEventHandlers()"),setTimeout(()=>{Ue.debug(`Removing event handlers from <HTMLMediaElement id=${this._targetElement.id} />`,this._targetElement),Qt.forEach(e=>this._targetElement.removeEventListener(e,this)),this.windowHandlers.deactivate()},0)}isPaused(){return this._paused}exitFullscreen(){return this.fullscreen.exit()}requestFullscreen(e){return this.fullscreen.request(e)}newSeeker(){var e;return null===(e=this._seeker)||void 0===e||e.end(),this._seeker=new PlayerSeeker(this),this._seeker}stop(e){var t=this;return _async_to_generator$16((function*(){Ue.debug("BasePlayer.stop",e),yield t._waitForPendingPlay(),t.isPlaying&&(Ue.debug("BasePlayer.play dispatching playbackStop"),t.dispatch(et.playbackStop,_object_spread$I({item:t.nowPlayingItem,position:t.currentPlaybackTime,startPosition:t.initialBufferPosition,playingDate:t.currentPlayingDate,startPlayingDate:t.initialPlayingDate},e))),yield t.stopMediaAndCleanup()}))()}stopMediaAndCleanup(e=nr){var t=this;return _async_to_generator$16((function*(){Ue.debug("BasePlayer.stopMediaAndCleanup",e),yield t.stopMediaElement(),t._stopped=!0,t._paused=!1;const r=t.nowPlayingItem;t.nowPlayingItem=void 0,t.initialBufferPosition=void 0,t.initialPlayingDate=void 0,t.setPlaybackState(e,r)}))()}onPlaybackError(e,t){this.resetDeferredPlay(),this.stop({endReasonType:ot.FAILED_TO_LOAD,userInitiated:!1})}calculatePlaybackProgress(){const e=Math.round(100*(this.currentPlaybackTime/this.currentPlaybackDuration||0))/100;this._currentPlaybackProgress!==e&&(this._currentPlaybackProgress=e,this._dispatcher.publish(Bt,{progress:this._currentPlaybackProgress}))}calculateBufferedProgress(e){const t=Math.round(e/this.currentPlaybackDuration*100);this._currentBufferedProgress!==t&&(this._currentBufferedProgress=t,this._dispatcher.publish(Dt,{progress:t}))}destroy(){var e,t;if(Ue.debug("BasePlayer.destroy()"),this._isDestroyed=!0,this._dispatcher.unsubscribe(Lt,this.onPlaybackError),!this.hasMediaElement)return;const r=this._targetElement;null===(e=this.extension)||void 0===e||e.destroy(r),this.resetMediaElement(),this.removeEventHandlers(),null===(t=r.parentNode)||void 0===t||t.removeChild(r)}handleEvent(e){var t=this;return _async_to_generator$16((function*(){"timeupdate"!==e.type&&Ue.debug("BasePlayer.handleEvent: ",e.type,e);const{nowPlayingItem:r}=t;switch(e.timestamp=Date.now(),e.type){case"canplay":t._dispatcher.publish(Mt,e),t._playbackState!==ir||t._targetElement.paused||t.setPlaybackState(tr,r);break;case"durationchange":t._targetElement.duration!==1/0&&(e.duration=t.currentPlaybackDuration,t._dispatcher.publish(Kt,e),t.calculatePlaybackProgress());break;case"ended":{var n;if(Ue.debug('media element "ended" event'),null===(n=t.nowPlayingItem)||void 0===n?void 0:n.isLinearStream)return void Ue.warn("ignoring ended event for linear stream",e);if(t.isElementCleaned()){Ue.debug('media element already cleaned, ignoring "ended" event');break}const r=t.nowPlayingItem,i=(null==r?void 0:r.playbackDuration)?r.playbackDuration/1e3:t.currentPlaybackTime,o=t.currentPlayingDate;yield t.stopMediaAndCleanup(Xt),t.dispatch(et.playbackStop,{item:r,position:i,playingDate:o,endReasonType:ot.NATURAL_END_OF_TRACK});break}case"error":Ue.error("Playback Error",e,t._targetElement.error),t._dispatcher.publish(Lt,new MKError(MKError.Reason.MEDIA_PLAYBACK,"Playback Error"));break;case"loadedmetadata":t._dispatcher.publish(Ut,e);break;case"loadstart":t.setPlaybackState(Zt,r);break;case"pause":t.setPlaybackState(t._stopped?nr:er,r);break;case"play":case"playing":t._paused=!1,t._stopped=!1,t.isPrimaryPlayer=!0,t.setPlaybackState(tr,r);break;case"progress":{const e=t._targetElement.buffered;t.handleBufferStart(),1===e.length&&0===e.start(0)&&t.calculateBufferedProgress(e.end(0));break}case"ratechange":t._dispatcher.publish(Gt,e);break;case"seeked":t._stopped?t.setPlaybackState(nr,r):t._paused?t.setPlaybackState(er,r):t.playbackState!==Xt&&t.setPlaybackState(tr,r);break;case"seeking":t.playbackState===er?t._paused=!0:t.playbackState===nr&&(t._stopped=!0),t.playbackState!==Xt&&t.setPlaybackState(rr,r);break;case"timeupdate":{t._dispatcher.publish(Yt,{currentPlaybackDuration:t.currentPlaybackDuration,currentPlaybackTime:t.currentPlaybackTime,currentPlaybackTimeRemaining:t.currentPlaybackTimeRemaining}),t.calculatePlaybackProgress();const e=t._buffer;e&&(e.currentTime=t.currentPlaybackTime);break}case"volumechange":t._dispatcher.publish(zt,e);break;case"waiting":t.setPlaybackState(ir,r)}}))()}handleBufferStart(){const{_targetElement:e}=this;void 0!==this.initialBufferPosition||e.paused||0===e.buffered.length||(this.initialBufferPosition=e.buffered.start(0),this.initialPlayingDate=this.currentPlayingDate,Ue.debug("BasePlayer.handleBufferStart: setting initial buffer position ",this.initialBufferPosition))}pause(e={}){var t=this;return _async_to_generator$16((function*(){yield t._waitForPendingPlay(),t.isPlaying&&(yield t._pauseMedia(),t._paused=!0,t.dispatch(et.playbackPause,_object_spread$I({item:t.nowPlayingItem,position:t.currentPlaybackTime,playingDate:t.currentPlayingDate},e)))}))()}play(e=!0){var t=this;return _async_to_generator$16((function*(){if(Ue.debug("BasePlayer.play()"),t.nowPlayingItem)try{yield t._playMedia(),Ue.debug("BasePlayer.play dispatching playbackPlay"),t.dispatch(et.playbackPlay,{userInitiated:e,item:t.nowPlayingItem,position:t.currentPlaybackTime,playingDate:t.currentPlayingDate})}catch(r){if(r&&Jt.includes(r.name)&&Ue.error("BasePlayer.play() rejected due to",r),"NotAllowedError"===(null==r?void 0:r.name))throw new MKError(MKError.Reason.USER_INTERACTION_REQUIRED,"Playback of media content requires user interaction first and cannot be automatically started on page load.")}}))()}preload(){return this._loadMedia()}showPlaybackTargetPicker(){this.playbackTargetAvailable&&this._targetElement.webkitShowPlaybackTargetPicker()}dispatch(e,t){void 0===t.item&&(t.item=this.nowPlayingItem),hasOwn(t,"isPlaying")||(t.isPlaying=this.isPlaying),this._dispatcher.publish(e,t)}tsidChanged(e){void 0!==e&&""!==e&&(this.isPrimaryPlayer=e===this._serial)}_waitForPendingPlay(){var e=this;return _async_to_generator$16((function*(){e._deferredPlay&&(yield e._deferredPlay.promise,e._deferredPlay=void 0)}))()}_loadMedia(){var e=this;return _async_to_generator$16((function*(){Ue.debug("BasePlayer._loadMedia",e._targetElement),e._targetElement.load()}))()}_pauseMedia(){var e=this;return _async_to_generator$16((function*(){e._targetElement.pause()}))()}_playAssetURL(e,t){var r=this;return _async_to_generator$16((function*(){Ue.debug("BasePlayer._playAssetURL",e),r._targetElement.src=e;const n=r._loadMedia();if(t)return Ue.debug("BasePlayer.loadOnly"),void(yield n);yield r._playMedia()}))()}playItemFromUnencryptedSource(e,t,r){var n=this;return _async_to_generator$16((function*(){return(null==r?void 0:r.startTime)&&(e+="#t="+r.startTime),t||n.startPlaybackSequence(),yield n._playAssetURL(e,t),n.finishPlaybackSequence()}))()}_playMedia(){var e=this;return _async_to_generator$16((function*(){Ue.debug("BasePlayer._playMedia",e._targetElement,e.extension);try{yield e._targetElement.play(),e._playbackDidStart=!0}catch(De){throw Ue.error("BasePlayer._playMedia: targetElement.play() rejected",De),De}}))()}_setTargetElementTitle(e){this.hasMediaElement&&(this._targetElement.title=e)}resetDeferredPlay(){this._deferredPlay=void 0}stopMediaElement(){var e=this;return _async_to_generator$16((function*(){Ue.trace("BasePlayer.stopMediaElement()"),e.hasMediaElement&&(Ue.debug("Stopping HTMLMediaElement id="+e._targetElement.id,e._targetElement),e._targetElement.pause(),e.resetMediaElement())}))()}resetMediaElement(){Ue.trace("BasePlayer.cleanupElement()");const e=this._targetElement;e&&!this.isElementCleaned()?(Ue.debug("Resetting HTMLMediaElement",e),e.currentTime=0,e.removeAttribute("src"),e.removeAttribute("title")):Ue.debug("No HTMLMediaElement to reset")}isElementCleaned(){const e=this._targetElement;return!e||0===e.currentTime&&""===e.src&&""===e.title}finishPlaybackSequence(){var e;Ue.debug("BasePlayer.finishPlaybackSequence",this._deferredPlay);const t=null===(e=this._deferredPlay)||void 0===e?void 0:e.resolve(void 0);return this._deferredPlay=void 0,t}startPlaybackSequence(){return Ue.debug("BasePlayer.startPlaybackSequence",this._deferredPlay),this._deferredPlay&&(Ue.warn("Previous playback sequence not cleared"),this.finishPlaybackSequence()),this._deferredPlay=function(){let e,t;return{promise:new Promise((function(r,n){e=r,t=n})),resolve(t){null==e||e(t)},reject(e){null==t||t(e)}}}(),this._deferredPlay.promise}constructor(t){var r;_define_property$1z(this,"privateEnabled",!1),_define_property$1z(this,"siriInitiated",!1),_define_property$1z(this,"windowHandlers",void 0),_define_property$1z(this,"_dispatcher",void 0),_define_property$1z(this,"_buffer",void 0),_define_property$1z(this,"services",void 0),_define_property$1z(this,"_context",void 0),_define_property$1z(this,"_currentBufferedProgress",0),_define_property$1z(this,"initialBufferPosition",void 0),_define_property$1z(this,"initialPlayingDate",void 0),_define_property$1z(this,"_paused",!1),_define_property$1z(this,"_playbackState",e.PlaybackStates.none),_define_property$1z(this,"_stopped",!1),_define_property$1z(this,"_playbackDidStart",!1),_define_property$1z(this,"_nowPlayingItem",void 0),_define_property$1z(this,"_bitrateCalculator",void 0),_define_property$1z(this,"_currentPlaybackProgress",0),_define_property$1z(this,"_isPrimaryPlayer",!0),_define_property$1z(this,"_playbackTargetAvailable",!1),_define_property$1z(this,"_playbackTargetIsWireless",!1),_define_property$1z(this,"_seeker",void 0),_define_property$1z(this,"_serial",Date.now().toString()),_define_property$1z(this,"_timing",void 0),_define_property$1z(this,"fullscreen",void 0),_define_property$1z(this,"_isDestroyed",!1),_define_property$1z(this,"_isInitialized",!1),_define_property$1z(this,"_deferredPlay",void 0),this.services=t.services,this._dispatcher=t.services.dispatcher,this._timing=t.services.timing,this._context=t.context||{},this.privateEnabled=t.privateEnabled||!1,this.siriInitiated=t.siriInitiated||!1,this._bitrateCalculator=t.services.bitrateCalculator,this.windowHandlers=new WindowHandlers(this,t.services.runtime),this.fullscreen=new Fullscreen(this),null===(r=getLocalStorage())||void 0===r||r.setItem(Be,this._serial),this._dispatcher.subscribe(Lt,this.onPlaybackError)}}function generateAssetUrl(e,t){if("Preview"===e.type&&isStringNotEmpty(e.previewURL))return e.previewURL;if(!e.assetURL)throw new Error("Cannot generate asset URL");const r={};return(null==t?void 0:t.startOver)&&(r.startOver=!0),(null==t?void 0:t.bingeWatching)&&(r.bingeWatching=!0),e.supportsLinearScrubbing&&(r.linearScrubbingSupported=!0),e.assetURL.match(/xapsub=accepts-css/)||(r.xapsub="accepts-css"),buildURL(e.assetURL,r)}var or;!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$w("design:type",Function),_ts_metadata$w("design:paramtypes",[String,void 0===MKError?Object:MKError]),_ts_metadata$w("design:returntype",void 0)],BasePlayer.prototype,"onPlaybackError",null),function(e){e.Home="com.apple.amp.appletv.home-team-radio",e.Away="com.apple.amp.appletv.away-team-radio"}(or||(or={}));function isHomeRadioTrack(e){return void 0!==e.characteristics&&e.characteristics.includes("com.apple.amp.appletv.home-team-radio")}function isAwayRadioTrack(e){return void 0!==e.characteristics&&e.characteristics.includes("com.apple.amp.appletv.away-team-radio")}function toPersistedTrack(e){return{label:e.label,kind:e.kind,language:e.language}}function saveTrack(e,t){var r,n;r=e,n=toPersistedTrack(t),hasLocalStorage()&&(n?getLocalStorage().setItem(r,JSON.stringify(n)):getLocalStorage().setItem(r,""))}function loadTrack(e){return getJsonFromLocalStorage(e)}function trackEquals(e,t){const r=toPersistedTrack(e),n=toPersistedTrack(t);for(const i of Object.keys(r))if(r[i]!==n[i])return!1;return!0}function _define_property$1y(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class AudioTrackManager{get isDestroyed(){return this._isDestroyed}get currentTrack(){return this.tracks.find(e=>e.enabled)}set currentTrack(e){e&&(Ue.debug("MEDIA_TRACK Setting audio track "+e.label),this.extensionTracks?(Ue.debug(`MEDIA_TRACK Setting track on extension ${e.id}-${e.label}`),this.extensionTracks.audioTrack=e):(Ue.debug("MEDIA_TRACK disabling all audio tracks"),Array.from(this.mediaElement.audioTracks).forEach(t=>{t!==e&&(t.enabled=!1)}),Ue.debug("MEDIA_TRACK enabling",e),e.enabled=!0),isHomeRadioTrack(e)||isAwayRadioTrack(e)||(saveTrack("mk-audio-track",e),Ue.debug(`MEDIA_TRACK save track selection ${e.language},${e.label},${e.kind}`)))}get tracks(){return this.extensionTracks?this._extensionTracks||this.extensionTracks.audioTracks||[]:Array.from(this.mediaElement.audioTracks)}destroy(){if(this._isDestroyed=!0,this.extensionTracks){const e=this.extensionTracks;e.removeEventListener(Ge.audioTracksUpdated,this.onExtensionAudioTracksUpdated),e.removeEventListener(Ge.audioTracksSwitched,this.onExtensionAudioTrackSwitched)}else{if(!this.mediaElement.audioTracks)return;this.mediaElement.audioTracks.removeEventListener("addtrack",this.onAudioTrackAdded),this.mediaElement.audioTracks.removeEventListener("change",this.onAudioTrackChanged),this.mediaElement.audioTracks.removeEventListener("removetrack",this.onAudioTrackRemoved)}}onExtensionAudioTracksUpdated(e){var t;Ue.debug("MEDIA_TRACK Extension audio tracks updated "+JSON.stringify(e)),this._extensionTracks=e;const r=loadTrack("mk-audio-track");if((null===(t=this.tracks)||void 0===t?void 0:t.length)>=0&&void 0!==r&&(void 0===this.currentTrack||!trackEquals(this.currentTrack,r)))for(const n of this.tracks)if(trackEquals(n,r)){Ue.debug("Found track matching persisted track: "+n.label),this.currentTrack=n;break}this.dispatcher.publish(rt.audioTrackAdded,e)}onExtensionAudioTrackSwitched(e){if(Ue.debug("MEDIA_TRACK Extension audio track switched "+JSON.stringify(e)),this._extensionTracks){const preserveSelectedTrack=t=>{t.enabled=e.selectedId===t.id};this._extensionTracks.forEach(preserveSelectedTrack)}this.dispatcher.publish(rt.audioTrackChanged,e)}onAudioTrackAdded(e){const t=loadTrack("mk-audio-track");void 0!==t&&trackEquals(e.track,t)&&(Ue.debug("Found new track matching persisted track: "+e.track.label),this.currentTrack=e.track),this.dispatcher.publish(rt.audioTrackAdded,e)}onAudioTrackChanged(e){this.dispatcher.publish(rt.audioTrackChanged,e)}onAudioTrackRemoved(e){this.dispatcher.publish(rt.audioTrackRemoved,e)}constructor(e,t,r){if(_define_property$1y(this,"mediaElement",void 0),_define_property$1y(this,"dispatcher",void 0),_define_property$1y(this,"extensionTracks",void 0),_define_property$1y(this,"_extensionTracks",void 0),_define_property$1y(this,"_isDestroyed",void 0),this.mediaElement=e,this.dispatcher=t,this.extensionTracks=r,this._extensionTracks=[],this._isDestroyed=!1,this.extensionTracks){Ue.debug("MEDIA_TRACK Initializing audio track manager for hls track events"),this.onExtensionAudioTracksUpdated=this.onExtensionAudioTracksUpdated.bind(this),this.onExtensionAudioTrackSwitched=this.onExtensionAudioTrackSwitched.bind(this);const e=this.extensionTracks;e.addEventListener(Ge.audioTracksUpdated,this.onExtensionAudioTracksUpdated),e.addEventListener(Ge.audioTracksSwitched,this.onExtensionAudioTrackSwitched)}else{if(!e.audioTracks)return;Ue.debug("MEDIA_TRACK Initializing audio track manager for native track events"),this.onAudioTrackAdded=this.onAudioTrackAdded.bind(this),this.onAudioTrackChanged=this.onAudioTrackChanged.bind(this),this.onAudioTrackRemoved=this.onAudioTrackRemoved.bind(this),e.audioTracks.addEventListener("addtrack",this.onAudioTrackAdded),e.audioTracks.addEventListener("change",this.onAudioTrackChanged),e.audioTracks.addEventListener("removetrack",this.onAudioTrackRemoved)}}}const ar=[],sr=[];function nextAvailableAudioElement(){let e=sr.pop();return e?Ue.debug(`dom-helpers: retrieving audio tag, ${sr.length} remain`):(Ue.debug("dom-helpers: no available audio tags, creating one"),e=document.createElement("audio")),e}function deferPlayback(){fillAvailableElements("audio",sr),fillAvailableElements("video",ar),Ue.debug(`dom-helpers: defer playback called.  There are ${ar.length} available video elements and ${sr.length} available audio elements.`)}function fillAvailableElements(e,t){let r=100-t.length;for(;r>0;){const n=document.createElement(e);n.load(),t.push(n),r--}}const cr=BooleanDevFlag.register("mk-load-manifest-once"),shouldLoadManifestOnce=()=>!cr.configured||cr.enabled;var lr="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==t?t:"undefined"!=typeof self?self:{};function unwrapExports(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}var dr=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.isValidScrollSetting=t.isValidPositionAlignSetting=t.isValidLineAlignSetting=t.isValidLineAndPositionSetting=t.isValidDirectionSetting=t.isValidAlignSetting=t.isValidPercentValue=void 0,t.isValidPercentValue=function(e){return"number"==typeof e&&e>=0&&e<=100},t.isValidAlignSetting=function(e){return"string"==typeof e&&["start","center","end","left","right","middle"].includes(e)},t.isValidDirectionSetting=function(e){return"string"==typeof e&&["","rl","lr"].includes(e)},t.isValidLineAndPositionSetting=function(e){return"number"==typeof e||"auto"===e},t.isValidLineAlignSetting=function(e){return"string"==typeof e&&["start","center","end"].includes(e)},t.isValidPositionAlignSetting=function(e){return"string"==typeof e&&["line-left","center","line-right","auto","left","start","middle","end","right"].includes(e)},t.isValidScrollSetting=function(e){return["","up"].includes(e)}}));unwrapExports(dr),dr.isValidScrollSetting,dr.isValidPositionAlignSetting,dr.isValidLineAlignSetting,dr.isValidLineAndPositionSetting,dr.isValidDirectionSetting,dr.isValidAlignSetting,dr.isValidPercentValue;var ur=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});const r={"&amp;":"&","&lt;":"<","&gt;":">","&lrm;":"‎","&rlm;":"‏","&nbsp;":" "},n={c:"span",i:"i",b:"b",u:"u",ruby:"ruby",rt:"rt",v:"span",lang:"span"},i={v:"title",lang:"lang"},o={rt:"ruby"},a={"text-combine-upright":"-webkit-text-combine:horizontal; text-orientation: mixed;"};class ParserUtility{static parseTimeStamp(e){function computeSeconds(e){const[t,r,n,i]=e.map(e=>e?parseInt(""+e):0);return 3600*t+60*r+n+i/1e3}const t=/^(\d+):(\d{2})(:\d{2})?\.(\d{3})/.exec(e);return t?t[3]?computeSeconds([t[1],t[2],t[3].substring(1),t[4]]):parseInt(t[1])>59?computeSeconds([t[1],t[2],null,t[4]]):computeSeconds([null,t[1],t[2],t[4]]):null}static parseContent(e,t,s){let c=t.text;function nextToken(){if(!c)return null;const e=/^([^<]*)(<[^>]+>?)?/.exec(c);return t=e[1]?e[1]:e[2],c=c.substr(t.length),t;var t}function unescape1(e){return r[e]}function shouldAdd(e,t){return!o[t.dataset.localName]||o[t.dataset.localName]===e.dataset.localName}function createElement(t,r,o){const c=n[t];if(!c)return null;const l=e.document.createElement(c);l.dataset.localName=c;const d=i[t];if(d&&o&&(l[d]=o.trim()),r)if(s[r]){const e=function(e){let t="";for(const r in e)t+=a[r]?a[r]:r+":"+e[r]+";";return t}(s[r]);l.setAttribute("style",e)}else console.info(`WebVTT: parseContent: Style referenced, but no style defined for '${r}'!`);return l}const l=e.document.createElement("div"),d=[];let u,p,h=l;for(;null!==(u=nextToken());)if("<"!==u[0])h.appendChild(e.document.createTextNode(u.replace(/&(amp|lt|gt|lrm|rlm|nbsp);/g,unescape1)));else{if("/"===u[1]){d.length&&d[d.length-1]===u.substr(2).replace(">","")&&(d.pop(),h=h.parentNode);continue}const t=ParserUtility.parseTimeStamp(u.substr(1,u.length-2));let r;if(t){r=e.document.createProcessingInstruction("timestamp",t.toString()),h.appendChild(r);continue}if(p=/^<([^.\s/0-9>]+)(\.[^\s\\>]+)?([^>\\]+)?(\\?)>?$/.exec(u),!p)continue;if(r=createElement(p[1],p[2],p[3]),!r)continue;if(!shouldAdd(h,r))continue;p[2],d.push(p[1]),h.appendChild(r),h=r}return l}}t.default=ParserUtility}));unwrapExports(ur);var pr=createCommonjsModule((function(e,t){var r=lr&&lr.__decorate||function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a};Object.defineProperty(t,"__esModule",{value:!0}),t.VTTCue=void 0;let n=class{get id(){return this._id}set id(e){this._id=""+e}get pauseOnExit(){return this._pauseOnExit}set pauseOnExit(e){this._pauseOnExit=!!e}get startTime(){return this._startTime}set startTime(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number: "+e);this._startTime=e,this.hasBeenReset=!0}get endTime(){return this._endTime}set endTime(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number: "+e);this._endTime=e,this.hasBeenReset=!0}get text(){return this._text}set text(e){this._text=""+e,this.hasBeenReset=!0}get region(){return this._region}set region(e){this._region=e,this.hasBeenReset=!0}get vertical(){return this._vertical}set vertical(e){if(!dr.isValidDirectionSetting(e))throw new SyntaxError("An invalid or illegal string was specified for vertical: "+e);this._vertical=e,this.hasBeenReset=!0}get snapToLines(){return this._snapToLines}set snapToLines(e){this._snapToLines=!!e,this.hasBeenReset=!0}get line(){return this._line}set line(e){if(!dr.isValidLineAndPositionSetting(e))throw new SyntaxError("An invalid number or illegal string was specified for line: "+e);this._line=e,this.hasBeenReset=!0}get lineAlign(){return this._lineAlign}set lineAlign(e){if(!dr.isValidLineAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for lineAlign: "+e);this._lineAlign=e,this.hasBeenReset=!0}get position(){return this._position}set position(e){if(!dr.isValidLineAndPositionSetting(e))throw new Error("Position must be between 0 and 100 or auto: "+e);this._position=e,this.hasBeenReset=!0}get positionAlign(){return this._positionAlign}set positionAlign(e){if(!dr.isValidPositionAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for positionAlign: "+e);this._positionAlign=e,this.hasBeenReset=!0}get size(){return this._size}set size(e){if(e<0||e>100)throw new Error("Size must be between 0 and 100: "+e);this._size=e,this.hasBeenReset=!0}get align(){return this._align}set align(e){if(!dr.isValidAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for align: "+e);this._align=e,this.hasBeenReset=!0}getCueAsHTML(){return ur.default.parseContent(window,this,{})}static create(e){if(!e.hasOwnProperty("startTime")||!e.hasOwnProperty("endTime")||!e.hasOwnProperty("text"))throw new Error("You must at least have start time, end time, and text.");const t=new this(e.startTime,e.endTime,e.text);return Object.keys(e).forEach(r=>{t.hasOwnProperty(r)&&(t[r]=e[r])}),t}static fromJSON(e){return this.create(JSON.parse(e))}toJSON(){const e={};return Object.keys(this).forEach(t=>{this.hasOwnProperty(t)&&"getCueAsHTML"!==t&&"hasBeenReset"!==t&&"displayState"!==t&&(e[t]=this[t])}),e}constructor(e,t,r){this._id="",this._pauseOnExit=!1,this._region=null,this._vertical="",this._snapToLines=!0,this._line="auto",this._lineAlign="start",this._position="auto",this._positionAlign="auto",this._size=100,this._align="center",this.hasBeenReset=!1,this._startTime=e,this._endTime=t,this._text=r}};n=r([function(e){let t=e;"undefined"!=typeof window&&null!=window.VTTCue&&(t=window.VTTCue,t.create=e.create,t.fromJSON=e.fromJSON,t.prototype.toJSON=e.prototype.toJSON);return t}],n),t.VTTCue=n}));unwrapExports(pr),pr.VTTCue;var hr=createCommonjsModule((function(e,t){var r=lr&&lr.__decorate||function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a};Object.defineProperty(t,"__esModule",{value:!0}),t.VTTRegion=void 0;let n=class{get id(){return this._id}set id(e){if("string"!=typeof e)throw new Error("ID must be a string.");this._id=e}get lines(){return this._lines}set lines(e){if("number"!=typeof e)throw new TypeError("Lines must be set to a number.");this._lines=e}get regionAnchorX(){return this._regionAnchorX}set regionAnchorX(e){if(!dr.isValidPercentValue(e))throw new TypeError("RegionAnchorX must be between 0 and 100.");this._regionAnchorX=e}get regionAnchorY(){return this._regionAnchorY}set regionAnchorY(e){if(!dr.isValidPercentValue(e))throw new TypeError("RegionAnchorY must be between 0 and 100.");this._regionAnchorY=e}get scroll(){return this._scroll}set scroll(e){if("string"==typeof e){const t=e.toLowerCase();if(dr.isValidScrollSetting(t))return void(this._scroll=t)}throw new SyntaxError("An invalid or illegal string was specified.")}get viewportAnchorX(){return this._viewportAnchorX}set viewportAnchorX(e){if(!dr.isValidPercentValue(e))throw new TypeError("ViewportAnchorX must be between 0 and 100.");this._viewportAnchorX=e}get viewportAnchorY(){return this._viewportAnchorY}set viewportAnchorY(e){if(!dr.isValidPercentValue(e))throw new TypeError("ViewportAnchorY must be between 0 and 100.");this._viewportAnchorY=e}get width(){return this._width}set width(e){if(!dr.isValidPercentValue(e))throw new TypeError("Width must be between 0 and 100.");this._lines=e}toJSON(){const e={};return Object.keys(this).forEach(t=>{this.hasOwnProperty(t)&&(e[t]=this[t])}),e}static create(e){const t=new this;return Object.keys(e).forEach(r=>{t.hasOwnProperty(r)&&(t[r]=e[r])}),t}static fromJSON(e){return this.create(JSON.parse(e))}constructor(){this._id="",this._lines=3,this._regionAnchorX=0,this._regionAnchorY=100,this._scroll="",this._viewportAnchorX=0,this._viewportAnchorY=100,this._width=100}};n=r([function(e){let t=e;"undefined"!=typeof window&&null!=window.VTTRegion&&(t=window.VTTRegion,t.create=e.create,t.fromJSON=e.fromJSON,t.prototype.toJSON=e.prototype.toJSON);return t}],n),t.VTTRegion=n}));unwrapExports(hr),hr.VTTRegion;var yr=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0})}));unwrapExports(yr);var fr=createCommonjsModule((function(e,t){var r=lr&&lr.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),n=lr&&lr.__exportStar||function(e,t){for(var n in e)"default"===n||t.hasOwnProperty(n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),t.VTTRegion=t.VTTCue=t.WebVTTParser=t.ParsingError=void 0,Object.defineProperty(t,"VTTCue",{enumerable:!0,get:function(){return pr.VTTCue}}),Object.defineProperty(t,"VTTRegion",{enumerable:!0,get:function(){return hr.VTTRegion}});class ParsingError extends Error{constructor(e,t){super(),this.name="ParsingError",this.code="number"==typeof e?e:e.code,t?this.message=t:e instanceof ParsingError&&(this.message=e.message)}}t.ParsingError=ParsingError,ParsingError.Errors={BadSignature:new ParsingError(0,"Malformed WebVTT signature."),BadTimeStamp:new ParsingError(1,"Malformed time stamp.")};class Settings{set(e,t){this.get(e)||""===t||(this.values[e]=t)}get(e,t,r){return"object"==typeof t&&"string"==typeof r?this.has(e)?this.values[e]:t[r]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,r){for(let n=0;n<r.length;++n)if(t===r[n]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(t.match(/^([\d]{1,3})(\.[\d]*)?%$/))try{const r=parseFloat(t);if(r>=0&&r<=100)return this.set(e,r),!0}catch(r){return!1}return!1}constructor(){this.values={}}}class WebVTTParser{static StringDecoder(){return{decode:e=>{if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}}reportOrThrowError(e){if(!(e instanceof ParsingError&&"function"==typeof this.onparsingerror))throw e;this.onparsingerror(e)}parseOptions(e,t,r,n){const i=n?e.split(n):[e];for(const o of i){if("string"!=typeof o)continue;const e=o.split(r);if(2!==e.length)continue;t(e[0],e[1])}}parseCue(e,t,r){const n=e,consumeTimeStamp=()=>{const t=ur.default.parseTimeStamp(e);if(null===t)throw new ParsingError(ParsingError.Errors.BadTimeStamp,"Malformed timestamp: "+n);return e=e.replace(/^[^\sa-zA-Z-]+/,""),t},skipWhitespace=()=>{e=e.replace(/^\s+/,"")};if(skipWhitespace(),t.startTime=consumeTimeStamp(),skipWhitespace(),"--\x3e"!==e.substr(0,3))throw new ParsingError(ParsingError.Errors.BadTimeStamp,"Malformed time stamp (time stamps must be separated by '--\x3e'): "+n);e=e.substr(3),skipWhitespace(),t.endTime=consumeTimeStamp(),skipWhitespace(),((e,t)=>{const n=new Settings;this.parseOptions(e,(e,t)=>{let i,o;switch(e){case"region":for(let i=r.length-1;i>=0;i--)if(r[i].id===t){n.set(e,r[i].region);break}break;case"vertical":n.alt(e,t,["rl","lr"]);break;case"line":i=t.split(","),o=i[0],n.integer(e,o),n.percent(e,o)&&n.set("snapToLines",!1),n.alt(e,o,["auto"]),2===i.length&&n.alt("lineAlign",i[1],["start","middle","center","end"]);break;case"position":if(i=t.split(","),n.percent(e,i[0]),2===i.length){let e=["line-left","line-right","center","auto","left","start","middle","end","right"];n.alt("positionAlign",i[1],e)}break;case"size":n.percent(e,t);break;case"align":let a=["start","center","end","left","right","middle"];n.alt(e,t,a)}},/:/,/\s/),t.region=n.get("region",null),t.vertical=n.get("vertical",""),t.line=n.get("line",void 0===t.line?"auto":t.line);const i=n.get("lineAlign","start");t.lineAlign="center"===i||"middle"===i?this.middleOrCenter:i,t.snapToLines=n.get("snapToLines",!0),t.size=n.get("size",100);const o=n.get("align","center");t.align="center"===o||"middle"===o?this.middleOrCenter:o,t.position=n.get("position","auto");let a=n.get("positionAlign",{start:"start",left:"start",center:"center",middle:"middle",right:"end",end:"end"},t.align);t.positionAlign="center"===a||"middle"===a?this.middleOrCenter:{start:"start","line-left":"start",left:"start",center:"center",middle:"middle","line-right":"end",right:"end",end:"end"}[a]})(e,t)}parseRegion(e){const t=new Settings;if(this.parseOptions(e,(e,r)=>{switch(e){case"id":t.set(e,r);break;case"width":t.percent(e,r);break;case"lines":t.integer(e,r);break;case"regionanchor":case"viewportanchor":{const n=r.split(",");if(2!==n.length)break;const i=new Settings;if(i.percent("x",n[0]),i.percent("y",n[1]),!i.has("x")||!i.has("y"))break;t.set(e+"X",i.get("x")),t.set(e+"Y",i.get("y"));break}case"scroll":t.alt(e,r,["up"])}},/=/,/\s/),t.has("id")){const e=new hr.VTTRegion;e.width=t.get("width",100),e.lines=t.get("lines",3),e.regionAnchorX=t.get("regionanchorX",0),e.regionAnchorY=t.get("regionanchorY",100),e.viewportAnchorX=t.get("viewportanchorX",0),e.viewportAnchorY=t.get("viewportanchorY",100),e.scroll=t.get("scroll",""),this.onregion&&this.onregion(e),this.regionList.push({id:t.get("id"),region:e})}}parseStyle(e){const parseStyles=e=>{const t={},r=e.split(";");for(let n=0;n<r.length;n++)if(r[n].includes(":")){const e=r[n].split(":",2),i=e[0].trim(),o=e[1].trim();""!==i&&""!==o&&(t[i]=o)}return t},t=e.split("}");t.pop();for(const r of t){let e=null,t=null;const n=r.split("{");n[0]&&(e=n[0].trim()),n[1]&&(t=parseStyles(n[1])),e&&t&&(this._styles[e]=t)}this.onStylesParsedCallback&&this.onStylesParsedCallback(this._styles)}parseHeader(e){this.parseOptions(e,(function(e,t){switch(e){case"Region":this.parseRegion(t)}}),/:/)}parse(e){e&&(this.buffer+=this.decoder.decode(e,{stream:!0}));const collectNextLine=()=>{const e=this.buffer;let t=0;const calculateBreakPosition=(e,t)=>{const r={start:-1,length:-1};if("\r"===e[t])r.start=t,r.length=1;else if("\n"===e[t])r.start=t,r.length=1;else if("<"===e[t]&&t+1<e.length&&"b"===e[t+1]&&t+2<e.length&&"r"===e[t+2]){let n=t+2;for(;n<e.length&&">"!==e[n++];);r.start=t,r.length=n-t}return r};let r={start:e.length,length:0};for(;t<e.length;){const n=calculateBreakPosition(e,t);if(n.length>0){r=n;break}++t}const n=e.substr(0,r.start);return this.buffer=e.substr(r.start+r.length),n};try{let e;if("INITIAL"===this.state){if(!/\r\n|\n/.test(this.buffer))return this;this.alreadyCollectedLine="",e=collectNextLine();const t=/^(ï»¿)?WEBVTT([ \t].*)?$/.exec(e);if(!t||!t[0])throw new ParsingError(ParsingError.Errors.BadSignature);this.state="HEADER"}for(;this.buffer;){if(!/\r\n|\n/.test(this.buffer))return this;switch(this.alreadyCollectedLine?(e=this.alreadyCollectedLine,this.alreadyCollectedLine=""):e=collectNextLine(),this.state){case"HEADER":e.includes(":")?this.parseHeader(e):e||(this.state="ID");continue;case"NOTE":e||(this.state="ID");continue;case"STYLE":e?this.styleCollector+=e:(this.parseStyle(this.styleCollector),this.state="ID",this.styleCollector="");continue;case"ID":if(/^NOTE($|[ \t])/.test(e)){this.state="NOTE";break}if(/^STYLE($|[ \t])/.test(e)){this.state="STYLE";break}if(!e)continue;if(this.cue=new pr.VTTCue(0,0,""),this.state="CUE",!e.includes("--\x3e")){this.cue.id=e;continue}case"CUE":try{this.parseCue(e,this.cue,this.regionList)}catch(t){this.reportOrThrowError(t),this.cue=null,this.state="BADCUE";continue}this.state="CUETEXT";continue;case"CUETEXT":{const t=e.includes("--\x3e");if(!e||t){this.alreadyCollectedLine=e,this.oncue&&this.oncue(this.cue),this.cue=null,this.state="ID";continue}this.cue.text&&(this.cue.text+="\n"),this.cue.text+=e;continue}case"BADCUE":e||(this.state="ID");continue}}}catch(t){this.reportOrThrowError(t),"CUETEXT"===this.state&&this.cue&&this.oncue&&this.oncue(this.cue),this.cue=null,this.state="INITIAL"===this.state?"BADWEBVTT":"BADCUE"}return this}flush(){try{if(this.buffer+=this.decoder.decode(),(this.cue||"HEADER"===this.state)&&(this.buffer+="\n\n",this.parse()),"INITIAL"===this.state)throw new ParsingError(ParsingError.Errors.BadSignature)}catch(e){this.reportOrThrowError(e)}return this.onflush&&this.onflush(),this}styles(){return this._styles}constructor(e,t,r){this.window=e,this.state="INITIAL",this.styleCollector="",this.buffer="",this.decoder=t||new TextDecoder("utf8"),this.regionList=[],this.alreadyCollectedLine="",this.onStylesParsedCallback=r,this._styles={},this.middleOrCenter="center";const n=new pr.VTTCue(0,0,"middleOrCenter");try{n.align="center","center"!==n.align&&(this.middleOrCenter="middle")}catch(i){this.middleOrCenter="middle"}}}t.default=WebVTTParser,t.WebVTTParser=WebVTTParser,n(yr,t)}));unwrapExports(fr),fr.VTTRegion,fr.VTTCue,fr.WebVTTParser,fr.ParsingError;var _r=createCommonjsModule((function(e,t){var r=lr&&lr.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),n=lr&&lr.__exportStar||function(e,t){for(var n in e)"default"===n||t.hasOwnProperty(n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),t.VTTCue=t.WebVTTRenderer=t.BoxPosition=t.CueStyleBox=t.StyleBox=void 0,Object.defineProperty(t,"VTTCue",{enumerable:!0,get:function(){return pr.VTTCue}});const i=[/^(::cue\()(\..*)(\))/,/^(::cue\()(#.*)(\))/,/^(::cue\()(c|i|b|u|ruby|rt|v|lang)(\))/],o=[[1470,1470],[1472,1472],[1475,1475],[1478,1478],[1488,1514],[1520,1524],[1544,1544],[1547,1547],[1549,1549],[1563,1563],[1566,1610],[1645,1647],[1649,1749],[1765,1766],[1774,1775],[1786,1805],[1807,1808],[1810,1839],[1869,1957],[1969,1969],[1984,2026],[2036,2037],[2042,2042],[2048,2069],[2074,2074],[2084,2084],[2088,2088],[2096,2110],[2112,2136],[2142,2142],[2208,2208],[2210,2220],[8207,8207],[64285,64285],[64287,64296],[64298,64310],[64312,64316],[64318,64318],[64320,64321],[64323,64324],[64326,64449],[64467,64829],[64848,64911],[64914,64967],[65008,65020],[65136,65140],[65142,65276],[67584,67589],[67592,67592],[67594,67637],[67639,67640],[67644,67644],[67647,67669],[67671,67679],[67840,67867],[67872,67897],[67903,67903],[67968,68023],[68030,68031],[68096,68096],[68112,68115],[68117,68119],[68121,68147],[68160,68167],[68176,68184],[68192,68223],[68352,68405],[68416,68437],[68440,68466],[68472,68479],[68608,68680],[126464,126467],[126469,126495],[126497,126498],[126500,126500],[126503,126503],[126505,126514],[126516,126519],[126521,126521],[126523,126523],[126530,126530],[126535,126535],[126537,126537],[126539,126539],[126541,126543],[126545,126546],[126548,126548],[126551,126551],[126553,126553],[126555,126555],[126557,126557],[126559,126559],[126561,126562],[126564,126564],[126567,126570],[126572,126578],[126580,126583],[126585,126588],[126590,126590],[126592,126601],[126603,126619],[126625,126627],[126629,126633],[126635,126651],[1114109,1114109]];class StyleBox{applyStyles(e,t){t=t||this.div;for(const r in e)e.hasOwnProperty(r)&&(t.style[r]=e[r])}formatStyle(e,t){return 0===e?"0":e+t}}t.StyleBox=StyleBox;class CueStyleBox extends StyleBox{determineBidi(e){let t,r=[],n="";if(!e||!e.childNodes)return"ltr";function pushNodes(e,t){for(let r=t.childNodes.length-1;r>=0;r--)e.push(t.childNodes[r])}function nextTextNode(e){if(!e||!e.length)return null;let t=e.pop(),r=t.textContent||t.innerText;if(r){const t=/^.*(\n|\r)/.exec(r);return t?(e.length=0,t[0]):r}return"ruby"===t.tagName?nextTextNode(e):t.childNodes?(pushNodes(e,t),nextTextNode(e)):void 0}function isContainedInCharacterList(e,t){for(const r of t)if(e>=r[0]&&e<=r[1])return!0;return!1}for(pushNodes(r,e);n=nextTextNode(r);)for(let e=0;e<n.length;e++)if(t=n.charCodeAt(e),isContainedInCharacterList(t,o))return"rtl";return"ltr"}parseOpacity(e){if(!e||"string"!=typeof e)return null;const t=(e=e.replace(/ /g,"").replace("rgba(","").replace(")","")).split(",");return t&&t.length>=4?t[3]:null}directionSettingToWritingMode(e){return""===e?"horizontal-tb":"lr"===e?"vertical-lr":"vertical-rl"}move(e){this.applyStyles({top:this.formatStyle(e.top,"px"),bottom:this.formatStyle(e.bottom,"px"),left:this.formatStyle(e.left,"px"),right:this.formatStyle(e.right,"px"),height:this.formatStyle(e.height,"px"),width:this.formatStyle(e.width,"px")})}constructor(e,t,r,n,i){super(),this.cue=t;let o={start:"left","line-left":"left",left:"left",center:"center",middle:"center","line-right":"right",right:"right",end:"right"}[t.positionAlign]||t.align;"middle"===o&&(o="center");let a={textAlign:o,whiteSpace:"pre-line",position:"absolute"};a.direction=this.determineBidi(this.cueDiv),a.writingMode=this.directionSettingToWritingMode(t.vertical),a.unicodeBidi="plaintext",this.div=e.document.createElement("div"),this.applyStyles(a),a={backgroundColor:n.backgroundColor,display:"inline-block"},this.parseOpacity(a.backgroundColor)&&(a.padding="5px",a.borderRadius="5px"),this.backgroundDiv=e.document.createElement("div"),this.applyStyles(a,this.backgroundDiv),a={color:r.color,backgroundColor:r.backgroundColor,textShadow:r.textShadow,fontSize:r.fontSize,fontFamily:r.fontFamily,position:"relative",left:"0",right:"0",top:"0",bottom:"0",display:"inline-block",textOrientation:"upright"},a.writingMode=this.directionSettingToWritingMode(t.vertical),a.unicodeBidi="plaintext",this.cueDiv=ur.default.parseContent(e,t,i),this.applyStyles(a,this.cueDiv),this.backgroundDiv.appendChild(this.cueDiv),this.div.appendChild(this.backgroundDiv);let s=0;if("number"==typeof t.position){let e=t.positionAlign||t.align;if(e)switch(e){case"start":case"left":s=t.position;break;case"center":case"middle":s=t.position-t.size/2;break;case"end":case"right":s=t.position-t.size}}""===t.vertical?this.applyStyles({left:this.formatStyle(s,"%"),width:this.formatStyle(t.size,"%")}):this.applyStyles({top:this.formatStyle(s,"%"),height:this.formatStyle(t.size,"%")})}}t.CueStyleBox=CueStyleBox;class BoxPosition{calculateNewLines(e){let t=1;for(let r=0;r<e.length;r++)"\n"===e[r]&&t++;return t}move(e,t){switch(t=void 0!==t?t:this.singleLineHeight,e){case"+x":this.left+=t,this.right+=t;break;case"-x":this.left-=t,this.right-=t;break;case"+y":this.top+=t,this.bottom+=t;break;case"-y":this.top-=t,this.bottom-=t}}overlaps(e){return this.left<e.right&&this.right>e.left&&this.top<e.bottom&&this.bottom>e.top}overlapsAny(e){for(const t of e)if(this.overlaps(t))return!0;return!1}within(e){return this.top>=e.top&&this.bottom<=e.bottom&&this.left>=e.left&&this.right<=e.right}moveIfOutOfBounds(e,t){switch(t){case"+x":this.left<e.left&&(this.left=e.left,this.right=this.left+this.width);break;case"-x":this.right>e.right&&(this.right=e.right,this.left=this.right-this.width);break;case"+y":this.top<e.top&&(this.top=e.top,this.bottom=this.top+this.height);break;case"-y":this.bottom>e.bottom&&(this.bottom=e.bottom,this.top=this.bottom-this.height)}}toCSSCompatValues(e){return{top:this.top-e.top,bottom:e.bottom-this.bottom,left:this.left-e.left,right:e.right-this.right,height:this.height,width:this.width}}static getSimpleBoxPosition(e){let t=null;e instanceof StyleBox&&e.div?t=e.div:e instanceof HTMLElement&&(t=e);let r=t.offsetHeight||0,n=t.offsetWidth||0,i=t.offsetTop||0,o=i+r,a=t.getBoundingClientRect();const{left:s,right:c}=a;return a.top&&(i=a.top),a.height&&(r=a.height),a.width&&(n=a.width),a.bottom&&(o=a.bottom),{left:s,right:c,top:i,height:r,bottom:o,width:n}}static getBoxPosition(e,t){if(e&&e.length>0){let r=0,n=e[0][t];for(let i=0;i<e.length;i++)t in["top","right"]?e[i][t]>n&&(r=i,n=e[i][t]):t in["bottom","left"]&&e[i][t]<n&&(r=i,n=e[i][t]);return e[r]}return null}static moveToMinimumDistancePlacement(e,t,r){"height"===e.property?"+y"===t?(e.top=r.topMostBoxPosition.bottom+0,e.bottom=e.top+e.height):"-y"===t&&(e.bottom=r.bottomMostBoxPosition.top-0,e.top=e.bottom-e.height):"width"===e.property&&("+x"===t?(e.left=r.rightMostBoxPosition.right+0,e.right=e.left+e.width):"-x"===t&&(e.right=r.leftMostBoxPosition.left-0,e.left=e.right-e.width))}static moveBoxToLinePosition(e,t,r){const n=e.cue;let i,o=new BoxPosition(e),a=function(e){if("number"==typeof e.line&&(e.snapToLines||e.line>=0&&e.line<=100))return e.line;if(!e.track||!e.track.textTrackList||!e.track.textTrackList.mediaElement)return-1;let t=0;const r=e.track,n=r.textTrackList;for(let i=0;i<n.length&&n[i]!==r;i++)"showing"===n[i].mode&&t++;return-1*++t}(n),s=[];if(n.snapToLines){let e=0;switch(n.vertical){case"":s=["+y","-y"],i="height";break;case"rl":s=["+x","-x"],i="width";break;case"lr":s=["-x","+x"],i="width"}const r=o.lineHeight,c=t[i]+r,l=s[0];if(a<0){let i=0;switch(n.vertical){case"":i=t.height-r-.05*t.height;break;case"rl":case"lr":i=-t.width+r+.05*t.width}e=i,s=s.reverse()}else{switch(n.vertical){case"":e=r*Math.round(a);break;case"rl":e=t.width-r*Math.round(a);break;case"lr":e=r*Math.round(a)}Math.abs(e)>c&&(e=e<0?-1:1,e*=Math.ceil(c/r)*r)}o.move(l,e)}else{const r=""===n.vertical?t.height:t.width,i=o.lineHeight/r*100;switch(n.lineAlign){case"center":case"middle":a-=i/2;break;case"end":a-=i}switch(n.vertical){case"":e.applyStyles({top:e.formatStyle(a,"%")});break;case"rl":e.applyStyles({right:e.formatStyle(a,"%")});break;case"lr":e.applyStyles({left:e.formatStyle(a,"%")})}s=["+y","-y","+x","-x"],"+y"===n.axis?s=["+y","-y","+x","-x"]:"-y"===n.axis&&(s=["-y","+y","+x","-x"]),o=new BoxPosition(e)}const c=function(e,n){let i;for(let o=0;o<n.length;o++){e.moveIfOutOfBounds(t,n[o]);let a=0,s=!1;for(;e.overlapsAny(r)&&!(a>9);)s?e.move(n[o]):(r&&r.length>0&&(i||(i={topMostBoxPosition:BoxPosition.getBoxPosition(r,"top"),bottomMostBoxPosition:BoxPosition.getBoxPosition(r,"bottom"),leftMostBoxPosition:BoxPosition.getBoxPosition(r,"left"),rightMostBoxPosition:BoxPosition.getBoxPosition(r,"right")}),BoxPosition.moveToMinimumDistancePlacement(e,n[o],i)),s=!0),a++}return e}(o,s);e.move(c.toCSSCompatValues(t))}constructor(e){var t;let r,n,i,o,a,s;if(e instanceof CueStyleBox&&e.cue?(t=e.cue)&&""!==t.vertical?this.property="width":this.property="height":e instanceof BoxPosition&&(this.property=e.property||"height"),e instanceof CueStyleBox&&e.div){i=e.div.offsetHeight,o=e.div.offsetWidth,a=e.div.offsetTop;const t=e.div.firstChild;if(s=t?t.getBoundingClientRect():e.div.getBoundingClientRect(),r=s&&s[this.property]||null,t&&t.firstChild){const e=t.firstChild;if(e&&"string"==typeof e.textContent){n=r/this.calculateNewLines(e.textContent)}}}else e instanceof BoxPosition&&(s=e);this.left=s.left,this.right=s.right,this.top=s.top||a,this.height=s.height||i,this.bottom=s.bottom||a+(s.height||i),this.width=s.width||o,this.lineHeight=null!==r?r:s.lineHeight,this.singleLineHeight=null!==n?n:s.singleLineHeight,this.singleLineHeight||(this.singleLineHeight=41)}}t.BoxPosition=BoxPosition;class WebVTTRenderer{initSubtitleCSS(){const e=[new pr.VTTCue(0,0,"String to init CSS - Won't be visible to user")];this.paddedOverlay.style.opacity="0",this.processCues(e),this.processCues([]),this.paddedOverlay.style.opacity="1"}convertCueToDOMTree(e){return e?ur.default.parseContent(this.window,e,this.globalStyleCollection):null}setStyles(e){function applyStyles(e,t,r){for(const n in t)t.hasOwnProperty(n)&&(!0===r&&void 0!==e[n]||!1===r)&&(e[n]=t[n])}for(const t in e){let r=!1,n=null;"::cue"===t?(n=this.foregroundStyleOptions,r=!0):"::-webkit-media-text-track-display"===t&&(n=this.backgroundStyleOptions,r=!0);const o=e[t];if(!0===r)applyStyles(n,o,r);else for(let e=0;e<i.length;e++){const n=i[e].exec(t);if(n&&4===n.length){const e=n[2],t={};applyStyles(t,o,r),this.globalStyleCollection[e]=t}}}this.initSubtitleCSS(),this.loggingEnabled&&(console.log("WebVTTRenderer setStyles foregroundStyleOptions: "+JSON.stringify(this.foregroundStyleOptions)),console.log("WebVTTRenderer setStyles backgroundStyleOptions: "+JSON.stringify(this.backgroundStyleOptions)),console.log("WebVTTRenderer setStyles globalStyleCollection: "+JSON.stringify(this.globalStyleCollection)))}processCues(e){if(!e)return;for(;this.paddedOverlay.firstChild;)this.paddedOverlay.removeChild(this.paddedOverlay.firstChild);if(!function(e){for(let t=0;t<e.length;t++)if(e[t].hasBeenReset||!e[t].displayState)return!0;return!1}(e)){for(let t=0;t<e.length;t++)this.paddedOverlay.appendChild(e[t].displayState);return}const t=[],r=BoxPosition.getSimpleBoxPosition(this.paddedOverlay);e.length>1&&(e=function(e){const t=[];let r=0;for(let n=0;n<e.length;n++){let i=e[n];if("number"!=typeof i.line)return e;r+=i.line,t.push(i)}return r/=e.length,r>50?(t.forEach((function(e){e.axis="-y"})),t.sort((e,t)=>t.line-e.line)):(t.forEach((function(e){e.axis="+y"})),t.sort((e,t)=>e.line-t.line)),t}(e));for(let n=0;n<e.length;n++){let i=e[n],o=new CueStyleBox(this.window,i,this.foregroundStyleOptions,this.backgroundStyleOptions,this.globalStyleCollection);this.paddedOverlay.appendChild(o.div),BoxPosition.moveBoxToLinePosition(o,r,t),i.displayState=o.div,t.push(BoxPosition.getSimpleBoxPosition(o))}}setSize(e,t){e&&(this.overlay.style.width=e+"px"),t&&(this.overlay.style.height=t+"px")}getOverlay(){return this.overlay}constructor(e,t,r=!0){if(!e)return null;this.window=e,this.overlay=t,this.loggingEnabled=r,this.foregroundStyleOptions={fontFamily:"Helvetica",fontSize:"36px",color:"rgba(255, 255, 255, 1)",textShadow:"",backgroundColor:"rgba(0, 0, 0, 0)"},this.backgroundStyleOptions={backgroundColor:"rgba(0, 0, 0, 0.5)"},this.globalStyleCollection={};const n=e.document.createElement("div");n.style.position="absolute",n.style.left="0",n.style.right="0",n.style.top="0",n.style.bottom="0",n.style.margin="1.5%",this.paddedOverlay=n,t.appendChild(this.paddedOverlay),this.initSubtitleCSS()}}t.default=WebVTTRenderer,t.WebVTTRenderer=WebVTTRenderer,n(yr,t)}));unwrapExports(_r),_r.VTTCue,_r.WebVTTRenderer,_r.BoxPosition,_r.CueStyleBox,_r.StyleBox;var vr=createCommonjsModule((function(e,t){var r=lr&&lr.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),n=lr&&lr.__exportStar||function(e,t){for(var n in e)"default"===n||t.hasOwnProperty(n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),n(fr,t),n(_r,t)}));unwrapExports(vr);var mr=vr.WebVTTRenderer;function isTextTrackID3FrameCue(e){return null!=e&&"string"==typeof e.id&&void 0!==e.value&&"string"==typeof e.value.key}function _define_property$1x(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const{textTracksSwitched:gr,textTracksUpdated:br,inlineStylesParsed:Sr}=Ge;class TextTrackManager{get isDestroyed(){return this._isDestroyed}get currentTrack(){return this.tracks.find(e=>"showing"===e.mode)}set currentTrack(e){if(!e)return;let t;saveTrack("mk-text-track",e),Ue.debug(`MEDIA_TRACK save track selection ${e.language},${e.label},${e.kind}`),this.extensionTracks?(Ue.debug("MEDIA_TRACK Setting track on extension "+e.label),"Off"===e.label?(this.clearCurrentlyPlayingTrack(),t=this.extensionTracks.selectForcedTrack(),void 0===t&&this.onExtensionTextTrackSwitched({track:e})):this.extensionTracks.textTrack=e):(Ue.debug("MEDIA_TRACK Setting track on element "+e.label),this._tracks.forEach(t=>{t!==e&&"showing"===t.mode&&(t.mode="disabled")}),e&&(Ue.debug("MEDIA_TRACK setting track mode to showing for "+e.label),this.isTrackOff(e)?(this._tracks[0].mode="showing",t=this.selectNativeForcedTrack(this.mediaElement.audioTracks)):e.mode="showing")),this.dispatcher.publish(rt.forcedTextTrackChanged,t)}get tracks(){return this._tracks}destroy(){if(this._isDestroyed=!0,this.clearCurrentlyPlayingTrack(),this.extensionTracks){const e=this.extensionTracks;e.removeEventListener(br,this.onExtensionTextTracksAdded),e.removeEventListener(gr,this.onExtensionTextTrackSwitched),e.removeEventListener(Sr,this.onExtensionInlineStylesParsed)}else this.mediaElement.textTracks.removeEventListener("addtrack",this.onTextTrackAdded),this.mediaElement.textTracks.removeEventListener("change",this.onTextTrackChanged),this.mediaElement.textTracks.removeEventListener("removetrack",this.onTextTrackRemoved),this.mediaElement.removeEventListener("playing",this.onPlayStart);this.dispatcher.unsubscribe(rt.audioTrackChanged,this.onAudioTrackAddedOrChanged),this.dispatcher.unsubscribe(rt.audioTrackAdded,this.onAudioTrackAddedOrChanged)}restoreSelectedTrack(){var e;const t=loadTrack("mk-text-track");if((null===(e=this.tracks)||void 0===e?void 0:e.length)>=0&&void 0!==t&&(void 0===this.currentTrack||!trackEquals(this.currentTrack,t)))for(const r of this.tracks)if(trackEquals(r,t)){Ue.debug("Found track matching persisted track: "+r.label),this.currentTrack=r;break}}getSavedTrack(){return loadTrack("mk-text-track")}onExtensionInlineStylesParsed(e){Ue.debug("MEDIA_TRACK Extension inline styles parsed",e),this.renderer.setStyles(e.styles)}onExtensionTextTracksAdded(e){Ue.debug("MEDIA_TRACK Extension text tracks updated "+JSON.stringify(e)),this._tracks.push(...e),this.restoreSelectedTrack(),this.dispatcher.publish(rt.textTrackAdded,e)}onExtensionTextTrackSwitched(e){Ue.debug("MEDIA_TRACKS Extension text track switched "+e),this.handleVTT(e);const t=e.track;if(this._tracks){const preserveSelectedTrack=r=>{e.track?t.forced&&"Off"===r.label||"Off"===t.label&&"Off"===r.label?r.mode="showing":r.mode=e.track.persistentID===r.id?"showing":"disabled":r.mode="Off"===r.label?"showing":"disabled"};this._tracks.forEach(preserveSelectedTrack)}this.dispatcher.publish(rt.textTrackChanged,e)}handleVTT(e){const t=e&&e.track&&e.track.id;if(void 0!==t&&t>=0){const e=this.filterSelectableTextTracks(this.mediaElement.textTracks)[t];this.onNativeTrackChange(e)}else this.clearCurrentlyPlayingTrack()}onAudioTrackAddedOrChanged(e,t){if(Ue.debug("MEDIA_TRACKS text track manager detects audio track change"),this.shouldForceSubtitle())if(this.extensionTracks){Ue.debug("MEDIA_TRACKS selecting forced text track via extension");const e=this.extensionTracks.selectForcedTrack();e?this.dispatcher.publish(rt.forcedTextTrackChanged,e):this.clearCurrentlyPlayingTrack()}else Ue.debug("MEDIA_TRACKS selecting forced text track natively"),this.currentTrack=this._tracks[0]}onTextTrackAdded(e){this._tracks.push(e.track),this.dispatcher.publish(rt.textTrackAdded,e)}onPlayStart(){this.restoreSelectedTrack()}onTextTrackRemoved(e){this.dispatcher.publish(rt.textTrackRemoved,e)}onTextTrackChanged(e){const t=this.findNativeSelectedTextTrack();let r=this.getSavedTrack();if(r||(r=this._tracks[0]),t&&!trackEquals(t,r))if(this.isTrackOff(r)&&"forced"!==t.kind){const e=this.tracks.find(e=>trackEquals(e,r));this.currentTrack=e}else{const e=this.findNativeTrack(r);e&&(this.currentTrack=e)}else this.dispatcher.publish(rt.textTrackChanged,e)}findNativeSelectedTextTrack(){for(let e=0;e<this.mediaElement.textTracks.length;e++){const t=this.mediaElement.textTracks[e];if("showing"===t.mode)return t}}findNativeTrack(e){for(let t=0;t<this.mediaElement.textTracks.length;t++){const r=this.mediaElement.textTracks[t];if(trackEquals(r,e))return r}}selectNativeForcedTrack(e){for(let t=0;t<e.length;t++){const r=e[t];if(r.enabled){const e=this.findNativeForcedTrack(r);return e&&"showing"!==e.mode&&(e.mode="showing"),e}}}findNativeForcedTrack(e){const t=this.mediaElement.textTracks;for(let r=0;r<t.length;r++){const n=t[r];if("forced"===n.kind&&n.language===e.language)return n}}onNativeTrackChange(e){this.clearCurrentlyPlayingTrack(),this._currentlyPlayingTrack=e,e.addEventListener("cuechange",this.onCueChange)}clearCurrentlyPlayingTrack(){void 0!==this._currentlyPlayingTrack&&function(e){return null!=e&&"string"==typeof e.id&&"removeEventListener"in e}(this._currentlyPlayingTrack)&&(this._currentlyPlayingTrack.removeEventListener("cuechange",this.onCueChange),this.renderer.processCues({}),delete this._currentlyPlayingTrack)}onCueChange(e){const t=e&&e.target&&e.target.activeCues;t&&this.renderer.processCues(t)}filterSelectableTextTracks(e){const t=[];for(let r=0;r<e.length;r++){const n=e[r];("captions"===n.kind||"subtitles"===n.kind||"metadata"===n.kind&&n.customTextTrackCueRenderer)&&t.push(n)}return t}shouldForceSubtitle(){Ue.debug("MEDIA_TRACKS Determining whether to select forced text track");const e=this.getSavedTrack();return!e||this.isTrackOff(e)}isTrackOff(e){return"Off"===e.label||"Auto"===e.label}constructor(e,t,r){_define_property$1x(this,"mediaElement",void 0),_define_property$1x(this,"dispatcher",void 0),_define_property$1x(this,"extensionTracks",void 0),_define_property$1x(this,"_tracks",void 0),_define_property$1x(this,"renderer",void 0),_define_property$1x(this,"_currentlyPlayingTrack",void 0),_define_property$1x(this,"_isDestroyed",void 0),this.mediaElement=e,this.dispatcher=t,this.extensionTracks=r,this._tracks=[],this._isDestroyed=!1;const n=this.getSavedTrack();if(this._tracks.push({id:-2,label:"Off",language:"",kind:"subtitles",mode:!n||this.isTrackOff(n)?"showing":"disabled"}),this.extensionTracks){Ue.debug("MEDIA_TRACK Initializing text track manager for HLS.js track events");const t=e.parentElement;this.renderer=new mr(window,t,!1),this.renderer.setStyles({"::cue":{fontSize:"calc(1vw + 1em)"}}),this.onExtensionTextTracksAdded=this.onExtensionTextTracksAdded.bind(this),this.onExtensionTextTrackSwitched=this.onExtensionTextTrackSwitched.bind(this),this.onExtensionInlineStylesParsed=this.onExtensionInlineStylesParsed.bind(this),this.onCueChange=this.onCueChange.bind(this);const r=this.extensionTracks;r.addEventListener(br,this.onExtensionTextTracksAdded),r.addEventListener(gr,this.onExtensionTextTrackSwitched),r.addEventListener(Sr,this.onExtensionInlineStylesParsed)}else Ue.debug("MEDIA_TRACK Initializing text track manager for native track events"),this.onTextTrackAdded=this.onTextTrackAdded.bind(this),this.onTextTrackChanged=this.onTextTrackChanged.bind(this),this.onTextTrackRemoved=this.onTextTrackRemoved.bind(this),this.onPlayStart=this.onPlayStart.bind(this),e.textTracks.addEventListener("addtrack",this.onTextTrackAdded),e.textTracks.addEventListener("change",this.onTextTrackChanged),e.textTracks.addEventListener("removetrack",this.onTextTrackRemoved),e.addEventListener("playing",this.onPlayStart);this.onAudioTrackAddedOrChanged=debounce(this.onAudioTrackAddedOrChanged.bind(this)),t.subscribe(rt.audioTrackChanged,this.onAudioTrackAddedOrChanged),t.subscribe(rt.audioTrackAdded,this.onAudioTrackAddedOrChanged)}}function asyncGeneratorStep$15(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$15(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$15(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$15(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1w(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_metadata$v(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const Pr={"picture-in-picture":e.PresentationMode.pictureinpicture,inline:e.PresentationMode.inline},Er={};Er[e.PresentationMode.pictureinpicture]="picture-in-picture",Er[e.PresentationMode.inline]="inline";const{presentationModeDidChange:Tr}=rt,{playbackLicenseError:kr}=Ge,{stopped:wr}=e.PlaybackStates;class VideoPlayer extends BasePlayer{get audioTracks(){var e,t;return null!==(t=null===(e=this.audioTrackManager)||void 0===e?void 0:e.tracks)&&void 0!==t?t:[]}get containerElement(){return this._context.videoContainerElement?this._context.videoContainerElement:document.getElementById("apple-music-video-container")}get currentAudioTrack(){var e;return null===(e=this.audioTrackManager)||void 0===e?void 0:e.currentTrack}set currentAudioTrack(e){void 0!==this.audioTrackManager&&(this.audioTrackManager.currentTrack=e)}get currentTextTrack(){var e;return null===(e=this.textTrackManager)||void 0===e?void 0:e.currentTrack}set currentTextTrack(e){void 0!==this.textTrackManager&&(this.textTrackManager.currentTrack=e)}get _targetElement(){return this.video||function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1w(e,t,r[t])}))}return e}({},document.createElement("video"))}get textTracks(){var e,t;return null!==(t=null===(e=this.textTrackManager)||void 0===e?void 0:e.tracks)&&void 0!==t?t:[]}initializeExtension(){var e=this;return _async_to_generator$15((function*(){const{os:t}=e.services.runtime;e.restrictPlatforms&&t.isAndroid?Ue.warn("videoPlayer.initializeExtension Not supported on the current platform"):e.video||Ue.warn("videoPlayer.initializeExtension No video element, not initializing extension")}))()}onPlaybackLicenseError(e){this.resetDeferredPlay(),this._dispatcher.publish(kr,e)}setupTrackManagers(e){var t,r,n,i;null===(r=this.textTrackManager)||void 0===r||null===(t=r.destroy)||void 0===t||t.call(r),this.textTrackManager=new TextTrackManager(this._targetElement,this._dispatcher,e),null===(i=this.audioTrackManager)||void 0===i||null===(n=i.destroy)||void 0===n||n.call(i),this.audioTrackManager=new AudioTrackManager(this._targetElement,this._dispatcher,e)}destroy(){var e,t;this.finishPlaybackSequence(),null===(e=this.textTrackManager)||void 0===e||e.destroy(),null===(t=this.audioTrackManager)||void 0===t||t.destroy(),super.destroy()}initializeEventHandlers(){var e=this,_superprop_get_initializeEventHandlers=()=>super.initializeEventHandlers;return _async_to_generator$15((function*(){_superprop_get_initializeEventHandlers().call(e),e.hasMediaElement&&(e._targetElement.addEventListener("webkitpresentationmodechanged",e.pipEventHandler),e._targetElement.addEventListener("enterpictureinpicture",e.pipEventHandler),e._targetElement.addEventListener("leavepictureinpicture",e.pipEventHandler))}))()}removeEventHandlers(){if(super.removeEventHandlers(),!this.hasMediaElement)return;const{_targetElement:e}=this;e.removeEventListener("webkitpresentationmodechanged",this.pipEventHandler),e.removeEventListener("enterpictureinpicture",this.pipEventHandler),e.removeEventListener("leavepictureinpicture",this.pipEventHandler)}initializeMediaElement(){var e=this;return _async_to_generator$15((function*(){Ue.debug("videoPlayer.initializeMediaElement Initializing media element");const t=e.containerElement;t?(e.video=function(){let e=ar.pop();return e?Ue.debug(`dom-helpers: retrieving video tag, ${ar.length} remain`):(Ue.debug("dom-helpers: no available video tags, creating one"),e=document.createElement("video")),e}(),e.video.autoplay=!1,e.video.controls=!1,e.video.playsInline=!0,e.video.id="apple-music-video-player",t.appendChild(e.video)):Ue.warn("videoPlayer.initializeMediaElement No video element; no container defined")}))()}stopMediaElement(){var e=this,_superprop_get_stopMediaElement=()=>super.stopMediaElement;return _async_to_generator$15((function*(){yield _superprop_get_stopMediaElement().call(e),e.destroy()}))()}pipEventHandler(t){switch(t.type){case"enterpictureinpicture":this._dispatcher.publish(Tr,{mode:e.PresentationMode.pictureinpicture});break;case"leavepictureinpicture":this._dispatcher.publish(Tr,{mode:e.PresentationMode.inline});break;case"webkitpresentationmodechanged":{const e=this._targetElement;this._dispatcher.publish(Tr,{mode:this._translateStringToPresentationMode(e.webkitPresentationMode)});break}}}playItemFromEncryptedSource(t,r=!1,n={}){var i=this;return _async_to_generator$15((function*(){if(Ue.debug("videoPlayer.playItemFromEncryptedSource",t,r),i.playbackState===wr)return void Ue.debug("video-player.playItemFromEncryptedSource aborting playback because player is stopped");t.playbackType=e.PlaybackType.encryptedFull,i.nowPlayingItem=t,t.state=y.loading,i.userInitiated=r;const o=generateAssetUrl(t,n);yield i.playHlsStream(o,t,n)}))()}playItemFromUnencryptedSource(e,t,r){var n=this;return _async_to_generator$15((function*(){if(Ue.debug("videoPlayer.playItemFromUnencryptedSource",e,t),n.playbackState===wr)return void Ue.debug("videoPlayer.playItemFromUnencryptedSource aborting playback because player is stopped");const[r]=e.split("?");r.endsWith("m3u")||r.endsWith("m3u8")?yield n.playHlsStream(e):yield n._playAssetURL(e,t)}))()}setPresentationMode(t){var r=this;return _async_to_generator$15((function*(){const n=r._targetElement;if(n.webkitSupportsPresentationMode&&"function"==typeof n.webkitSetPresentationMode)return n.webkitSetPresentationMode(r._translatePresentationModeToString(t));if(n.requestPictureInPicture&&document.exitPictureInPicture){if(t===e.PresentationMode.pictureinpicture)return n.requestPictureInPicture();if(t===e.PresentationMode.inline)return document.exitPictureInPicture()}}))()}_translateStringToPresentationMode(t){let r=Pr[t];return void 0===r&&(Ue.warn(`videoPlayer._translateStringToPresentationMode ${t} is not a valid presentation mode, setting to inline`),r=e.PresentationMode.inline),r}_translatePresentationModeToString(e){let t=Er[e];return void 0===t&&(Ue.warn(`videoPlayer._translatePresentationModeToString ${e} is not a valid presentation mode, setting to inline`),t="inline"),t}preloadItem(e,t){return _async_to_generator$15((function*(){}))()}constructor(e){super(e),_define_property$1w(this,"extension",void 0),_define_property$1w(this,"video",void 0),_define_property$1w(this,"mediaPlayerType","video"),_define_property$1w(this,"restrictPlatforms",void 0),_define_property$1w(this,"textTrackManager",void 0),_define_property$1w(this,"audioTrackManager",void 0),_define_property$1w(this,"_shouldLoadManifestsOnce",!1),_define_property$1w(this,"userInitiated",!1),this.restrictPlatforms=!("restrict-platforms"in Ke.features)||Ke.features["restrict-platforms"],this.pipEventHandler=this.pipEventHandler.bind(this),this._shouldLoadManifestsOnce=shouldLoadManifestOnce()}}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$v("design:type",Function),_ts_metadata$v("design:paramtypes",[void 0]),_ts_metadata$v("design:returntype",void 0)],VideoPlayer.prototype,"onPlaybackLicenseError",null);const decayingOperation=(e,t,r,n=0)=>e().catch(i=>{const o=n+1;function possiblyRetry(n){if(n&&o<3){const n=1e3*o;return new Promise((i,a)=>{setTimeout(()=>{decayingOperation(e,t,r,o).then(i,a)},n)})}throw i}const a=t(i);return"boolean"==typeof a?possiblyRetry(a):a.then(possiblyRetry)});let Or={developerToken:"developerTokenNotSet",musicUserToken:"musicUserTokenNotSet",cid:"cidNotSet"};function asyncGeneratorStep$14(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$14(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$14(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$14(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1v(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$G(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1v(e,t,r[t])}))}return e}function createHlsOffersLicenseChallengeBody(e){return{"adam-id":e.id,id:1}}function createStreamingKeysLicenseChallengeBody(e,t,r=0){var n;return _object_spread$G({id:r,"lease-action":t},null!==(n=e.keyServerQueryParameters)&&void 0!==n?n:{})}function createLicenseChallengeBody(e,t,r,n,i,o){let a;const s={challenge:r.challenge||c(r.licenseChallenge),"key-system":n,uri:r.keyuri};return o&&(s["extended-lease"]=o),a=t.isUTS?{"streaming-request":{version:1,"streaming-keys":[_object_spread$G({},s,createStreamingKeysLicenseChallengeBody(t,e))]}}:t.isLiveRadioStation?_object_spread$G({},s,function(e){return{event:e.isLiveAudioStation?"beats1":"amtv"}}(t)):t.hasOffersHlsUrl?{"license-requests":[_object_spread$G({},s,createHlsOffersLicenseChallengeBody(t))]}:_object_spread$G({},s,function(e,t=!1){return{adamId:e.songId,isLibrary:e.isCloudItem,"user-initiated":t}}(t,i)),a}class License{fetch(e){const t={Authorization:"Bearer "+Or.developerToken,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+Or.musicUserToken};this.keySystem===Fe.WIDEVINE&&(t["X-Apple-Renewal"]=!0);const r=new Headers(t);return decayingOperation(()=>fetch(this.licenseUrl,{method:"POST",body:JSON.stringify(e),headers:r}),e=>e instanceof TypeError,"license fetch")}reset(){this.licenseUrl=void 0,this.playableItem=void 0,this.data=void 0,this.initiated=void 0,this.keySystem=void 0,this.startResponse=void 0}start(e,t,r,n,i=!1,o=!1){var a=this;return _async_to_generator$14((function*(){a.licenseUrl=e,a.playableItem=t,a.data=r,a.keySystem=n,a.initiated=i;const s=r.isRenewalRequest?"renew":"start",c=createLicenseChallengeBody(s,t,r,n,i,o);t.hasOffersHlsUrl&&!a.licenseUrl.includes("start")&&(a.licenseUrl+="/"+s),a.startResponse=a.fetch(c);try{var l,d,u;const e=yield a.startResponse;if(!e.ok){let t;try{t=yield e.json()}catch(p){}a.processJsonError(t)}const t=yield e.json();let r=t;return(null==t||null===(d=t["streaming-response"])||void 0===d||null===(l=d["streaming-keys"])||void 0===l?void 0:l.length)?r=t["streaming-response"]["streaming-keys"][0]:(null==t||null===(u=t["license-responses"])||void 0===u?void 0:u.length)&&(r=t["license-responses"][0]),0!==r.status&&a.processJsonError(r),r}catch(De){throw a.startResponse=void 0,De}}))()}processJsonError(e){let t=new MKError(MKError.Reason.MEDIA_LICENSE,"Error acquiring license");if((null==e?void 0:e.errorCode)&&(e.status=e.errorCode),-1021===(null==e?void 0:e.status)&&(e.status=190121),e&&0!==e.status){if(!e.message)switch(e.status){case-1004:e.message=MKError.Reason.DEVICE_LIMIT;break;case-1017:e.message=MKError.Reason.GEO_BLOCK;break;default:e.message=MKError.Reason.MEDIA_LICENSE}t=MKError.serverError(e),t.data=e,t.reason===MKError.Reason.PLAYREADY_CBC_ENCRYPTION_ERROR&&function(){const e=getSessionStorage();e&&e.setItem("mk-playready-cbcs-unsupported","true")}()}throw t}stop(){var e=this;return _async_to_generator$14((function*(){if(e.startResponse)try{yield e.startResponse}catch(De){}if(!e.playableItem||!e.data||!e.licenseUrl)return;if(!e.playableItem.isUTS)return;const t=createLicenseChallengeBody("stop",e.playableItem,e.data,e.keySystem,e.initiated),r=e.fetch(t);e.reset();try{yield r}catch(De){Ue.warn("license.stop request error",De)}}))()}constructor(){_define_property$1v(this,"licenseUrl",void 0),_define_property$1v(this,"playableItem",void 0),_define_property$1v(this,"data",void 0),_define_property$1v(this,"initiated",void 0),_define_property$1v(this,"keySystem",void 0),_define_property$1v(this,"startResponse",void 0)}}function asyncGeneratorStep$13(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$13(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$13(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$13(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1u(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_metadata$u(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}class KeySession extends Notifications{get extID(){if(this.extURI)return this.extURI.replace("data:;base64,","")}get isFairplay(){return this.keySystem===Fe.FAIRPLAY}get isPlayReady(){return this.keySystem===Fe.PLAYREADY}get isWidevine(){return this.keySystem===Fe.WIDEVINE}acquirePlaybackLicense(e,t,r,n){var i=this;return _async_to_generator$13((function*(){if(!i.keyServerURL||!i.developerToken||!i.userToken)return;const{keyServerURL:r,keySystem:o}=i,a=n.item;try{return yield i.license.start(r,a,{challenge:t,keyuri:e},o,i.initiated,i.isLegacyEme&&a.isUTS)}catch(s){i.dispatchEvent(Ge.playbackLicenseError,s)}}))()}startLicenseSession(e){var t=this;return _async_to_generator$13((function*(){let r;Ue.debug("Starting License Session",e);const{message:n,target:i,messageType:o}=e;if(t.keySystem!==Fe.FAIRPLAY&&"license-request"!==o)return void Ue.debug("not making license request for",o);if(t.isPlayReady){const e=String.fromCharCode.apply(null,new Uint16Array(n.buffer||n));r=(new DOMParser).parseFromString(e,"application/xml").getElementsByTagName("Challenge")[0].childNodes[0].nodeValue}else r=c(new Uint8Array(n));const a=i.extURI||t.extURI,s=t.mediaKeySessions[a];if(!s)return void Ue.debug("no key session info, aborting license request");const l=t.acquirePlaybackLicense(a,r,t.initiated,s);if(s.delayCdmUpdate)s["license-json"]=l;else{const e=yield l;yield t.handleLicenseJson(e,i,a)}}))()}setKeyURLs(e){this.keyCertURL=e[this.isFairplay?"hls-key-cert-url":"widevine-cert-url"],this.keyServerURL=e["hls-key-server-url"]}dispatchKeyError(e){var t,r;this.isFairplay&&4294955417===(null==e||null===(r=e.target)||void 0===r||null===(t=r.error)||void 0===t?void 0:t.systemCode)?Ue.error("Ignoring error",e):(console.error(MKError.Reason.MEDIA_KEY+" error in dispatchKeyError:",e),this.dispatchEvent(Ge.playbackSessionError,new MKError(MKError.Reason.MEDIA_KEY,e)))}dispatchSessionError(e){this.dispatchEvent(Ge.playbackSessionError,new MKError(MKError.Reason.MEDIA_SESSION,e))}loadCertificateBuffer(){var e=this;return _async_to_generator$13((function*(){if(!e.keyCertURL)return Promise.reject(new MKError(MKError.Reason.MEDIA_SESSION,"No certificate URL"));let t;try{t=yield fetch(`${e.keyCertURL}?t=${Date.now()}`)}catch(De){throw e.dispatchKeyError(De),De}const r=yield t.arrayBuffer(),n=String.fromCharCode.apply(String,new Uint8Array(r));return/^\<\?xml/.test(n)?Promise.reject(new MKError(MKError.Reason.MEDIA_CERTIFICATE,"Invalid certificate.")):r}))()}handleSessionCreation(e){var t=this;return _async_to_generator$13((function*(){return t.createSession(e).catch(e=>{t.dispatchSessionError(e)})}))()}handleLicenseJson(e,t,r){var n=this;return _async_to_generator$13((function*(){if(Ue.debug(`updating session ${r} with license response`,e),null==e?void 0:e.license){const r=o(e.license);try{yield t.update(r)}catch(i){Ue.error("Failed to updated media keys",i),n.dispatchKeyError(i)}}}))()}addMediaKeySessionInfo(e,t,r,n=!1){const i=this.mediaKeySessions[e];i?(Ue.debug(`keySession info exists for ${r.title}, making existing session ${i.session.sessionId} the old session`),i.oldSession=i.session,i.session=t):(Ue.debug("creating key session info for "+r.title),this.mediaKeySessions[e]={session:t,item:r,delayCdmUpdate:n})}stopLicenseSession(){Ue.info("key session sending license stop"),this.license.stop()}constructor(){super([Ge.playbackLicenseError,Ge.playbackSessionError]),_define_property$1u(this,"developerToken",void 0),_define_property$1u(this,"adamId",void 0),_define_property$1u(this,"userToken",void 0),_define_property$1u(this,"extURI",void 0),_define_property$1u(this,"item",void 0),_define_property$1u(this,"initiated",!0),_define_property$1u(this,"isLibrary",!1),_define_property$1u(this,"keyCertURL",void 0),_define_property$1u(this,"keyServerURL",void 0),_define_property$1u(this,"keySystem",Fe.FAIRPLAY),_define_property$1u(this,"isLegacyEme",!1),_define_property$1u(this,"boundDispatchKeyError",void 0),_define_property$1u(this,"boundDispatchSessionError",void 0),_define_property$1u(this,"boundHandleSessionCreation",void 0),_define_property$1u(this,"boundStartLicenseSession",void 0),_define_property$1u(this,"mediaKeySessions",{}),_define_property$1u(this,"_pendingRenewal",void 0),_define_property$1u(this,"license",void 0),this.boundDispatchKeyError=this.dispatchKeyError.bind(this),this.boundDispatchSessionError=this.dispatchSessionError.bind(this),this.boundHandleSessionCreation=this.handleSessionCreation.bind(this),this.boundStartLicenseSession=this.startLicenseSession.bind(this),this.license=new License}}function asyncGeneratorStep$12(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$12(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$12(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$12(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1t(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_metadata$t(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$u("design:type",Function),_ts_metadata$u("design:paramtypes",[void 0]),_ts_metadata$u("design:returntype",Promise)],KeySession.prototype,"startLicenseSession",null);class FairplayEncryptedSession extends KeySession{attachMedia(e,t){var r=this;return _async_to_generator$12((function*(){r.keySystem=t.keySystem,r._keySystemAccess=t,e.addEventListener("encrypted",r.boundHandleSessionCreation,!1)}))()}detachMedia(e){e.removeEventListener("encrypted",this.boundHandleSessionCreation);const t=this._mediaKeySessions,r=this._mediaKeySessionRenewals;Object.values(t).forEach(e=>{e.removeEventListener("message",this.boundStartLicenseSession),asAsync(e.close())}),this._mediaKeySessions={},Object.values(r).forEach(e=>clearTimeout(e)),this._mediaKeySessionRenewals={}}createSession(e){var t=this;return _async_to_generator$12((function*(){Ue.debug("fairplay eme:  createSession",e);const r=t._keySystemAccess;if(!r)return;const{initData:n,target:i,initDataType:o}=e;var a;t._mediaKeysPromise||(t._mediaKeysPromise=new Promise((a=_async_to_generator$12((function*(e,n){const o=yield r.createMediaKeys();try{yield i.setMediaKeys(o),t._mediaKeys=o;const e=yield t.loadCertificateBuffer();yield o.setServerCertificate(e)}catch(De){t.dispatchKeyError(De),n(De)}e(o)})),function(e,t){return a.apply(this,arguments)})));const s=yield t._mediaKeysPromise,c=new Uint8Array(n),l=String.fromCharCode.apply(void 0,Array.from(c));if(t.mediaKeySessions[l])return void Ue.error("fairplay eme: not creating new session for extURI",l);const d=s.createSession();Ue.debug("fairplay eme: creating new key session for",l),t.addMediaKeySessionInfo(l,d,t.item),d.addEventListener("message",t.startFairplayLicenseSession),d.extURI=l,yield d.generateRequest(o,n),t._mediaKeySessions[d.sessionId]=d,Ue.debug("fairplay eme: created session",d)}))()}startFairplayLicenseSession(e){const{message:t,target:r}=e,n=c(new Uint8Array(t)),i=r.extURI||this.extURI,o=this.mediaKeySessions[i];if(o)return this.acquirePlaybackLicense(i,n,this.initiated,o).then(e=>this.handleLicenseJson(e,r,i));Ue.debug("fairplay eme: no key session info, aborting license request",i)}handleLicenseJson(e,t,r){var n=this,_superprop_get_handleLicenseJson=()=>super.handleLicenseJson;return _async_to_generator$12((function*(){if(!e)return;const i=n.mediaKeySessions[r];if(!i)return void Ue.debug("fairplay eme: media key session does not exist, not updating");const o=e["renew-after"];if(e.license&&o){Ue.debug("fairplay eme: got renew after value",o,r);const e=n._mediaKeySessionRenewals,a=e[t.sessionId];a&&clearTimeout(a),e[t.sessionId]=setTimeout(()=>n._renewMediaKeySession(i,r),1e3*o)}yield _superprop_get_handleLicenseJson().call(n,e,t,r)}))()}_renewMediaKeySession(e,t){delete this._mediaKeySessionRenewals[e.session.sessionId],Ue.debug("fairplay eme: renewing session",e),e.session.update(a("renew"))}applyDelayedCdmUpdates(){}loadKeys(e){return _async_to_generator$12((function*(){}))()}clearSessions(){return _async_to_generator$12((function*(){}))()}constructor(...e){super(...e),_define_property$1t(this,"_keySystemAccess",void 0),_define_property$1t(this,"_mediaKeysPromise",void 0),_define_property$1t(this,"_mediaKeySessions",{}),_define_property$1t(this,"_mediaKeySessionRenewals",{}),_define_property$1t(this,"_mediaKeys",void 0)}}function asyncGeneratorStep$11(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$11(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$11(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$11(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$t("design:type",Function),_ts_metadata$t("design:paramtypes",[void 0]),_ts_metadata$t("design:returntype",void 0)],FairplayEncryptedSession.prototype,"startFairplayLicenseSession",null);const Ir=/^(?:.*)(skd:\/\/.+)$/i;class WebKitSession extends KeySession{get isDestroyed(){return this._isDestroyed}attachMedia(e,t){return this.target=e,e.addEventListener("webkitneedkey",this.boundHandleSessionCreation,!1),e.addEventListener("webkitkeyerror",this.boundDispatchKeyError),e}detachMedia(e){e&&(e.removeEventListener("webkitneedkey",this.boundHandleSessionCreation,!1),e.removeEventListener("webkitkeyerror",this.boundDispatchKeyError))}destroy(){Ue.debug("FPS destroy"),this._isDestroyed=!0,this.detachMedia(this.target),this.session&&(this.session.removeEventListener("webkitkeyerror",this.boundDispatchKeyError),this.session.removeEventListener("webkitkeymessage",this.boundStartLicenseSession))}createSession(e){Ue.debug("FPS createSession",e);const{initData:t,target:r}=e,{item:n}=this;if(!n)return Ue.error("Cannot createSession without item"),Promise.resolve();const i=this._extractAssetId(t);if(Ue.debug("extURI",i),!r.webkitKeys&&window.WebKitMediaKeys){const e=new window.WebKitMediaKeys(this.keySystem);r.webkitSetMediaKeys(e)}return this.loadCertificateBuffer().then(e=>{const o=this._concatInitDataIdAndCertificate(t,i,e),a="VIDEO"===r.tagName?He.AVC1:He.MP4,s=r.webkitKeys.createSession(a,o);this.addMediaKeySessionInfo(i,s,n),this.session=s,s.extURI=i,s.addEventListener("webkitkeyerror",this.boundDispatchKeyError),s.addEventListener("webkitkeymessage",this.boundStartLicenseSession)})}_extractAssetId(e){let t=String.fromCharCode.apply(null,new Uint16Array(e.buffer||e));const r=t.match(Ir);return r&&r.length>=2&&(t=r[1]),Ue.debug("Extracted assetId from EXT-X-KEY URI",t),t}_concatInitDataIdAndCertificate(e,t,r){"string"==typeof t&&(t=s(t)),r=new Uint8Array(r);let n=0;const i=new ArrayBuffer(e.byteLength+4+t.byteLength+4+r.byteLength),o=new DataView(i);new Uint8Array(i,n,e.byteLength).set(e),n+=e.byteLength,o.setUint32(n,t.byteLength,!0),n+=4;const a=new Uint8Array(i,n,t.byteLength);a.set(t),n+=a.byteLength,o.setUint32(n,r.byteLength,!0),n+=4;return new Uint8Array(i,n,r.byteLength).set(r),new Uint8Array(i,0,i.byteLength)}applyDelayedCdmUpdates(){}loadKeys(e){return _async_to_generator$11((function*(){}))()}clearSessions(){return _async_to_generator$11((function*(){}))()}constructor(...e){super(...e),_define_property$1s(this,"target",void 0),_define_property$1s(this,"session",void 0),_define_property$1s(this,"_isDestroyed",!1),_define_property$1s(this,"isLegacyEme",!0)}}function asyncGeneratorStep$10(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$10(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$10(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$10(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}class MSSession extends KeySession{attachMedia(e,t){return this.keySystem=t.keySystem,e.addEventListener("msneedkey",this.boundHandleSessionCreation,!1),e.addEventListener("mskeyerror",this.boundDispatchKeyError),e}detachMedia(e){e.removeEventListener("msneedkey",this.boundHandleSessionCreation,!1),e.removeEventListener("mskeyerror",this.boundDispatchKeyError)}createSession(e){const{initData:t,target:r}=e;if(!r.msKeys){const e=new MSMediaKeys(this.keySystem);r.msSetMediaKeys(e)}const n=r.msKeys.createSession(He.MP4,t);return n.addEventListener("mskeyerror",this.dispatchKeyError),n.addEventListener("mskeymessage",this.startLicenseSession.bind(this)),n}applyDelayedCdmUpdates(){}loadKeys(e){return _async_to_generator$10((function*(){}))()}clearSessions(){return _async_to_generator$10((function*(){}))()}}const Ar={[Fe.WIDEVINE]:qe.WIDEVINE,[Fe.FAIRPLAY]:qe.FAIRPLAY,[Fe.PLAYREADY]:qe.PLAYREADY},Rr=[0,0,1,222,112,115,115,104,0,0,0,0,154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149,0,0,1,190],$r=[190,1,0,0,1,0,1,0,180,1];function concatenate(e,...t){let r=0;for(const o of t)r+=o.length;const n=new e(r);let i=0;for(const o of t)n.set(o,i),i+=o.length;return n}const{WIDEVINE:Cr,PLAYREADY:Dr}=Fe,Mr={};Mr[Cr]=e=>{Ue.debug("generating Widevine pssh for keyId");const t=new Uint8Array([0,0,0,52,112,115,115,104,0,0,0,0,237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237,0,0,0,20,8,1,18,16,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);for(let r=0;r<e.length;r++)t[t.length-16+r]=e[r];return Ue.debug("generatePSSH",t),t},Mr[Dr]=e=>{Ue.debug("generating Playready pssh for keyId"),(e=>{const swap=(e,t,r)=>{const n=e[t];e[t]=e[r],e[r]=n};swap(e,0,3),swap(e,1,2),swap(e,4,5),swap(e,6,7)})(e);const t=c(e),r='<WRMHEADER xmlns="http://schemas.microsoft.com/DRM/2007/03/PlayReadyHeader" version="4.3.0.0"><DATA><PROTECTINFO><KIDS><KID ALGID="AESCTR" VALUE="[KEYID]"></KID></KIDS></PROTECTINFO></DATA></WRMHEADER>'.replace("[KEYID]",t),n=s(r),i=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);return concatenate(Uint8Array,Rr,$r,i)};function asyncGeneratorStep$$(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$$(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$$(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$$(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class PreloadingEncryptedSession extends KeySession{attachMedia(e,t){this.keySystem=t.keySystem,this._keySystemAccess=t,this._target=e}detachMedia(){asAsync(this.clearSessions())}createSession(e){return _async_to_generator$$((function*(){}))()}_mediaKeysSetup(){var e=this;return _async_to_generator$$((function*(){const t=e._keySystemAccess;var r;t&&(e._mediaKeysPromise||(e._mediaKeysPromise=new Promise((r=_async_to_generator$$((function*(r,n){const i=yield t.createMediaKeys();try{var o;yield null===(o=e._target)||void 0===o?void 0:o.setMediaKeys(i),e._mediaKeys=i}catch(De){e.dispatchKeyError(De),n(De)}if(e.isWidevine){const t=yield e.loadCertificateBuffer();yield i.setServerCertificate(t)}r(i)})),function(e,t){return r.apply(this,arguments)}))),yield e._mediaKeysPromise)}))()}createSessionAndGenerateRequest(e,t,r){var n=this;return _async_to_generator$$((function*(){var i;const a=!!(null==r?void 0:r.isRenewal),s=!!(null==r?void 0:r.delayCdmUpdate);if(!a&&n.mediaKeySessions[e])return;Ue.debug(`createSessionAndGenerateRequest for item ${t.title}, isRenewal ${a}`);const l=null===(i=n._mediaKeys)||void 0===i?void 0:i.createSession(),{keySystem:d}=n;if(!l)return;n.addMediaKeySessionInfo(e,l,t,s);const u=(e=>{if(e.includes("data")){const[t,r]=e.split(",");return r}return e})(e),p=o(u),h=n.isWidevine&&t.isSong||16===p.length;let y;var f;return Ue.debug("extracted uri",e),n.isPlayReady&&!h?(Ue.debug("handling Playready object"),l.extURI=e,f=p,y=concatenate(Uint8Array,new Uint8Array(Rr),f)):h?(Ue.debug("handling keyId only initData"),l.extURI="data:;base64,"+c(p),y=((e,t)=>{const r=Mr[t];if(!r)return Ue.warn("No pssh generator for ",t),e;return r(Uint8Array.from(e))})(p,d)):(Ue.debug("handling pssh initData"),l.extURI=e,y=p),l.addEventListener("message",n.startLicenseSession),l.generateRequest("cenc",y).catch(e=>{if(e.message.match(/generateRequest.*\(75\)/))return l.generateRequest("cenc",y);throw e})}))()}handleLicenseJson(e,t,r){var n=this,_superprop_get_handleLicenseJson=()=>super.handleLicenseJson;return _async_to_generator$$((function*(){var i;if(!e)return;const o=n.mediaKeySessions[r];if(!o)return void Ue.debug("media key session does not exist, not updating");const a=e["renew-after"];if(e.license&&a){Ue.debug("Got renew after value",a,r);const e=n._mediaKeySessionRenewals,i=e[t.sessionId];i&&clearTimeout(i),e[t.sessionId]=setTimeout(()=>n._renewMediaKeySession(o,r),1e3*a)}yield _superprop_get_handleLicenseJson().call(n,e,t,r);const s=null===(i=n.mediaKeySessions[r])||void 0===i?void 0:i.oldSession;s&&(Ue.debug("removing old key session after updating",r),yield n._removeAndCloseSession(s),delete n.mediaKeySessions[r].oldSession,delete n._mediaKeySessionRenewals[s.sessionId])}))()}_renewMediaKeySession(e,t){delete this._mediaKeySessionRenewals[e.session.sessionId],asAsync(this.createSessionAndGenerateRequest(t,e.item,{isRenewal:!0}))}applyDelayedCdmUpdates(){var e=this;return _async_to_generator$$((function*(){Ue.debug("applying delayed CDM updates");const t=Object.entries(e.mediaKeySessions);for(const r of t){const[t,n]=r;if(n.delayCdmUpdate){const r=yield n["license-json"];Ue.debug("delayed update of license",r),n.delayCdmUpdate=!1,yield e.handleLicenseJson(r,n.session,t)}}}))()}loadKeys(e,t,r){var n=this;return _async_to_generator$$((function*(){yield n._mediaKeysSetup();const i=n.filterKeyValues(e);for(const e of i){const{dataUri:i}=e;yield n.createSessionAndGenerateRequest(i,t,r)}if(null==t?void 0:t.isLiveAudioStation){const e=Object.keys(n.mediaKeySessions),t=i.reduce((e,t)=>(e[t.dataUri]=!0,e),{});for(const r of e)t[r]||(yield n._scheduleRemoveSession(r))}}))()}filterKeyValues(e){let t;if(1===e.length)t=e;else{const r=Ar[this.keySystem];t=e.filter(e=>e.keyFormat===r)}return t}clearSessions(e){var t=this;return _async_to_generator$$((function*(){const r=t.mediaKeySessions;if(null==e?void 0:e.length){const r=t.filterKeyValues(e);for(const e of r){const r=e.dataUri;clearTimeout(t._sessionRemovalTimeouts[r]),yield t._removeSessionImmediately(r)}}else{Object.values(t._sessionRemovalTimeouts).forEach(e=>clearTimeout(e)),Ue.debug("clearing key sessions",r);for(const e of Object.keys(r))yield t._removeSessionImmediately(e)}}))()}_scheduleRemoveSession(e){var t=this;return _async_to_generator$$((function*(){if(!t.mediaKeySessions[e])return void Ue.warn("no session for dataUri, not scheduling remove",e);if(t._sessionRemovalTimeouts[e])return;const r=setTimeout(()=>{asAsync(t._removeSessionImmediately(e))},6e4);Ue.debug("deferring removal of keysession for dataUri",e),t._sessionRemovalTimeouts[e]=r}))()}_removeSessionImmediately(e){var t=this;return _async_to_generator$$((function*(){const r=t.mediaKeySessions[e];if(!r)return void Ue.warn("no session for dataUri, not removing",e);Ue.debug("removing keysession for",e);const{session:n,oldSession:i}=r;t._clearSessionRenewal(n),delete t.mediaKeySessions[e],yield t._removeAndCloseSession(n),i&&(yield t._removeAndCloseSession(i))}))()}_removeAndCloseSession(e){var t=this;return _async_to_generator$$((function*(){e.removeEventListener("message",t.startLicenseSession),Ue.debug("tearing down session",e.sessionId);try{yield e.remove()}catch(r){Ue.warn("Error invoking session.remove()",r)}finally{try{yield e.close()}catch(r){Ue.warn("Error invoking session.close()",r)}}}))()}_clearSessionRenewal(e){const t=this._mediaKeySessionRenewals[e.sessionId];t&&(Ue.debug("clearing scheduled license renewal for session",e.sessionId),clearTimeout(t),delete this._mediaKeySessionRenewals[e.sessionId])}constructor(...e){super(...e),_define_property$1r(this,"_keySystemAccess",void 0),_define_property$1r(this,"_mediaKeysPromise",void 0),_define_property$1r(this,"_mediaKeys",void 0),_define_property$1r(this,"_target",void 0),_define_property$1r(this,"_sessionRemovalTimeouts",{}),_define_property$1r(this,"_mediaKeySessionRenewals",{})}}function asyncGeneratorStep$_(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$_(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$_(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$_(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1q(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Nr=BooleanDevFlag.register("mk-safari-modern-eme");class MediaExtension extends Notifications{get hasMediaKeySupport(){return hasMediaKeySupport()}get hasMediaSession(){return void 0!==this._session}get isFairplay(){return this._session.isFairplay}set extURI(e){this._session.extURI=e}set initiated(e){this._session.initiated=e}get session(){return this._session}clearSessions(e){var t=this;return _async_to_generator$_((function*(){var r;return null===(r=t.session)||void 0===r?void 0:r.clearSessions(e)}))()}initializeKeySystem(){var e=this;return _async_to_generator$_((function*(){yield e._attachSession();const{_session:t}=e;t&&[Ge.playbackLicenseError,Ge.playbackSessionError].forEach(r=>{t.addEventListener(r,t=>{e.dispatchEvent(r,t)})})}))()}_requestModernFairplayAccess(){var e=this;return _async_to_generator$_((function*(){const{contentType:t}=e,r=[{initDataTypes:["skd"],audioCapabilities:[{contentType:t,robustness:""}],videoCapabilities:[{contentType:t,robustness:""}],distinctiveIdentifier:"not-allowed",persistentState:"not-allowed",sessionTypes:["temporary"]}],[,n]=yield findMediaKeySystemAccess([Fe.FAIRPLAY],r);return n}))()}_attachSession(){var e=this;return _async_to_generator$_((function*(){var t,r;const{mediaElement:n,contentType:i}=e;if(null===(t=window.WebKitMediaKeys)||void 0===t?void 0:t.isTypeSupported(Fe.FAIRPLAY+".1_0",He.MP4)){let t;Nr.enabled&&e.hasMediaKeySupport&&(t=yield e._requestModernFairplayAccess()),t?(Ue.warn("media-extension: Using Fairplay modern EME"),e._session=new FairplayEncryptedSession,e._session.attachMedia(n,t)):(Ue.warn("media-extension: Using Fairplay legacy EME"),e._session=new WebKitSession,e._session.attachMedia(n,{keySystem:Fe.FAIRPLAY}))}else if(null===(r=window.MSMediaKeys)||void 0===r?void 0:r.isTypeSupported(Fe.PLAYREADY,He.MP4))e._session=new MSSession,e._session.attachMedia(n,{keySystem:Fe.PLAYREADY});else if(e.hasMediaKeySupport&&n.canPlayType(i)){e._session=new PreloadingEncryptedSession;const t=[{initDataTypes:["cenc","keyids"],audioCapabilities:[{contentType:i}],distinctiveIdentifier:"optional",persistentState:"required"}],r=potentialKeySystemsForAccess(),[,a]=yield findMediaKeySystemAccess(r,t);var o;if(a)null===(o=e._session)||void 0===o||o.attachMedia(n,a);else Ue.warn("media-extension: No keysystem detected!")}}))()}setMediaItem(e){!function(e,t){t.keyURLs&&(e.developerToken=Or.developerToken,e.userToken=Or.musicUserToken,e.item=t,e.adamId=t.songId,e.isLibrary=t.isCloudItem,e.setKeyURLs(t.keyURLs))}(this._session,e)}destroy(e){var t;null===(t=this._session)||void 0===t||t.detachMedia(e)}constructor(e,t){super([Ge.playbackLicenseError,Ge.playbackSessionError]),_define_property$1q(this,"_session",void 0),_define_property$1q(this,"mediaElement",void 0),_define_property$1q(this,"contentType",void 0),this.mediaElement=e,this.contentType=t}}const Lr=BooleanDevFlag.register("mk-force-audio-mse"),shouldForceAudioMse=()=>Lr.enabled;function asyncGeneratorStep$Z(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _define_property$1p(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class ByteRangeSegment{load(){var e,t=this;return(e=function*(){const{url:e,range:r}=t;if(!e)return new Uint8Array;const n=new Headers;n.append("Range",r);const i=yield fetch(e,{headers:n}),o=yield i.arrayBuffer();return new Uint8Array(o)},function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$Z(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$Z(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}constructor({url:e,startByte:t,length:r,isInitSegment:n=!1}){_define_property$1p(this,"url",void 0),_define_property$1p(this,"range",void 0),_define_property$1p(this,"startByte",void 0),_define_property$1p(this,"endByte",void 0),_define_property$1p(this,"length",void 0),_define_property$1p(this,"startTime",void 0),_define_property$1p(this,"endTime",void 0),_define_property$1p(this,"isInitSegment",void 0),this.url=e,this.isInitSegment=n,this.startByte=parseInt(t,10),this.length=parseInt(r,10),this.endByte=this.startByte+this.length-1,this.range=`bytes=${this.startByte}-${this.endByte}`}}function asyncGeneratorStep$Y(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _define_property$1o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class ContinuousSegment{load(){var e,t=this;return(e=function*(){const{url:e}=t;if(!e)return new Uint8Array;const r=yield fetch(e),n=yield r.arrayBuffer();return new Uint8Array(n)},function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$Y(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$Y(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}constructor(e,t=!1){_define_property$1o(this,"url",void 0),_define_property$1o(this,"isInitSegment",void 0),this.url=e,this.isInitSegment=t}}function _define_property$1n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const xr=/^#EXT-X-BYTERANGE:([^\n]+)\n/gim,jr=/^#EXT-X-MAP:([^\n]+)\n/im,Ur=/#EXTINF:\d*\.\d*\,[\n](.+)|^#EXT-X-MAP:URI="([^"]*)"/gim,Fr=/#EXTINF:\d*\.\d*,\s*#EXT-X-BITRATE:\d{1,3}[\n](.+)|^#EXT-X-MAP:URI="([^"]*)"/gim;class SegmentList{get segments(){return this._segments}addSegment(e,t){this._addedSegments[t]||(Ue.debug("Adding segment",t),this._segments.push(e),this._addedSegments[t]=!0)}extractLiveRadioSegments(e,t){this._extractContinuousSegments(Ur,e,t)}extractHlsOffersSegments(e,t){this._extractContinuousSegments(Fr,e,t)}_extractContinuousSegments(e,t,r){if(!t||!e.test(t))return;let n;for(e.lastIndex=0;n=e.exec(t);){const e=n[0].startsWith("#EXT-X-MAP")?n[2]:n[1];let t=e;/^http(s)?:\/\//.test(t)||(t=joinURLPath([...splitURLPath(r).slice(0,-1),e]));const i=n[0].startsWith("#EXT-X-MAP");this.addSegment(new ContinuousSegment(t,i),e)}}extractByteRangeSegments(e,t){if(!e||!xr.test(e))return;const r=function(e){if(!e||!jr.test(e))return;const[,t]=e.match(jr);return t.split(",").reduce((e,t)=>{const[r,n]=t.split("=");return e[r.toLowerCase()]=n.replace(/\"/gi,""),e},{})}(e);var n;const i=null!==(n=t.split("/").pop())&&void 0!==n?n:"",o=t.replace(i,r.uri),[a,s]=r.byterange.split("@"),c=new ByteRangeSegment({url:o,startByte:s,length:a});var l;this.addSegment(c,c.range),(null!==(l=e.match(xr))&&void 0!==l?l:[]).forEach(e=>{const[,t,r]=e.match(/^#EXT-X-BYTERANGE:(\d+)@(\d+)\n/),n=new ByteRangeSegment({url:o,startByte:r,length:t});this.addSegment(n,n.range)})}constructor(){_define_property$1n(this,"_segments",[]),_define_property$1n(this,"_addedSegments",{})}}var Kr;function asyncGeneratorStep$X(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$X(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$X(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$X(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1m(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_metadata$s(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}!function(e){e.keysParsed="keysParsed"}(Kr||(Kr={}));const Br=/^#EXT-X-TARGETDURATION:(\d+)/im,Vr=/^#EXT-X-KEY:[^\n]+URI="([^"]+)"/im,Gr=/^#EXT-X-KEY:.*(.*$)/gim;function loadManifestData(e){return _loadManifestData.apply(this,arguments)}function _loadManifestData(){return(_loadManifestData=_async_to_generator$X((function*(e){return(yield fetch(e)).text()}))).apply(this,arguments)}class Manifest extends Notifications{parse(){const e=this._item,t=this._data;if(We!==Fe.FAIRPLAY||shouldForceAudioMse())if(this._detectKeyTags(),e.hasOffersHlsUrl)this._segmentList.extractHlsOffersSegments(t,e.assetURL);else if(e.isLiveRadioStation){this._segmentList.extractLiveRadioSegments(t,e.assetURL);const[,r]=this._data.match(Br);Ue.debug(`manifest: setting up manifest refresh interval at ${r} seconds`);const n=1e3*parseInt(r,10);this._manifestRefreshInterval=setInterval(this.liveRadioRefresh,n)}else this._segmentList.extractByteRangeSegments(t,e.assetURL)}static load(e,t=!0){var r=this;return _async_to_generator$X((function*(){Ue.debug("loading manifest for item",e.title);const n=e.assetURL;let i;const o=getSessionStorage(),a=!!o&&t;if(a&&(i=null==o?void 0:o.getItem(n),i))return new r(i,e);const s=(new Date).getTime();i=yield loadManifestData(n);const c=new r(i,e);return c.downlink=function(e,t){return 8*t.length/(((new Date).getTime()-e)/1e3)/1024}(s,i),a&&(null==o||o.setItem(n,i)),Promise.resolve(c)}))()}get downlink(){return this._downlink}set downlink(e){this._downlink=e}get mediaItem(){return this._item}liveRadioRefresh(){var e=this;return _async_to_generator$X((function*(){const t=yield loadManifestData(e._url);e._data=t,e._detectKeyTags(),e._segmentList.extractLiveRadioSegments(t,e._url),e.dispatchEvent(Ge.manifestParsed)}))()}segmentsForTimeRange(e){const t=Math.floor(e.start/10)+1,r=Math.floor(e.end/10)+1,{segments:n}=this;return[n[0],...n.slice(t,r+1)]}get segments(){return this._segmentList.segments}get extURI(){if(!this._extURI){const e=this._data.match(Vr);Ue.debug("manifest: EXT_X_KEY_URI matches",e),this._extURI=e&&e[1]||void 0}return this._extURI}get keyValues(){let e=this._modernKeys;return e.length||(e=this._legacyKeys),e}_detectKeyTags(){const e=this.keyValues;e.length&&this.dispatchEvent(Kr.keysParsed,{item:this.mediaItem,keys:e})}get _legacyKeys(){const e=this._data.match(Vr);Ue.debug("manifest: EXT_X_KEY_URI matches",e);const t=e&&e[1]||void 0;this._extURI=t;const r=[];return t&&r.push({keyFormat:qe.WIDEVINE,dataUri:t}),r}get _modernKeys(){let e;const t=[];for(;e=Gr.exec(this._data);){var r,n;const a=e[0];var i;const s=null!==(i=null===(r=/KEYFORMAT="(.*?)"/.exec(a))||void 0===r?void 0:r[1])&&void 0!==i?i:"";var o;const c=null!==(o=null===(n=/URI="(.*?)"/.exec(a))||void 0===n?void 0:n[1])&&void 0!==o?o:"";s&&c&&t.push({keyFormat:s,dataUri:c})}return t}stop(){this._manifestRefreshInterval&&clearInterval(this._manifestRefreshInterval)}constructor(e,t){super([Ge.manifestParsed,Kr.keysParsed]),_define_property$1m(this,"_data",void 0),_define_property$1m(this,"_downlink",0),_define_property$1m(this,"_extURI",void 0),_define_property$1m(this,"_url",void 0),_define_property$1m(this,"_item",void 0),_define_property$1m(this,"_segmentList",new SegmentList),_define_property$1m(this,"_manifestRefreshInterval",void 0),this._data=e,this._item=t,this._url=t.assetURL}}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$s("design:type",Function),_ts_metadata$s("design:paramtypes",[]),_ts_metadata$s("design:returntype",Promise)],Manifest.prototype,"liveRadioRefresh",null);const Hr="seamlessAudioTransition",qr="bufferTimedMetadataDidChange",Wr="loadSegmentError";function encodedArrayToString(e,t="utf-8"){return"iso-8859-1"===t?String.fromCharCode(...e):new TextDecoder(t).decode(e)}function readNullTerminatedString(e,t=0,r){const n=[];r=null!=r?r:e.length;for(let i=t;i<r;i++){const t=e[i];if("\0"===String.fromCharCode(t))break;n.push(String.fromCharCode(t))}return[n.join(""),n.length]}function _define_property$1l(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class BaseMp4Box{get size(){return this.end-this.start}get rawBytes(){return this.data.slice(this.start,this.end)}constructor(e,t,r,n){_define_property$1l(this,"id",void 0),_define_property$1l(this,"data",void 0),_define_property$1l(this,"start",void 0),_define_property$1l(this,"end",void 0),this.id=e,this.data=t,this.start=r,this.end=n}}const Yr=[237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237];class PsshBox extends BaseMp4Box{get systemId(){const{data:e,start:t}=this,r=t+12;return e.slice(r,r+16)}get dataSize(){return this.view.getUint32(28)}get psshData(){const{data:e,start:t,dataSize:r}=this,n=t+32;return e.slice(n,n+r)}get keyBytes(){const{psshData:e}=this;return e.slice(2,18)}get isWidevine(){return arrayEquals(this.systemId,Yr)}constructor(e,t,r){super("pssh",e,t,r),function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"view",void 0),this.view=new DataView(e.buffer,t)}}function _define_property$1j(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class TencBox extends BaseMp4Box{get isProtected(){const{data:e,start:t}=this;return e[t+14]}get defaultKeyId(){const{data:e,start:t}=this;return e.slice(t+16,t+32)}set defaultKeyId(e){const{data:t,start:r}=this;for(let n=0;n<e.length;n++)t[n+r+16]=e[n]}constructor(e,t,r){super("tenc",e,t,r),_define_property$1j(this,"data",void 0),_define_property$1j(this,"start",void 0),_define_property$1j(this,"end",void 0),this.data=e,this.start=t,this.end=r}}function findBox(e,t,r=[]){for(let n=t;n<e.length;){if(0===r.length)return;const t=new DataView(e.buffer,n).getUint32(0),i=encodedArrayToString(e.subarray(n+4,n+8)),o=n+t;if(1===r.length&&i===r[0])return new BaseMp4Box(i,e,n,o);if(i===r[0])return findBox(e,n+8,r.slice(1));n+=t}}const rewriteDefaultKid=e=>{const[t]=function(e){const t=findBox(e,0,["moov","trak","mdia","minf","stbl","stsd"]),r=[];if(!t)return r;for(let n=t.start+16;n<t.end;){let i=findBox(e,n,["enca"]),o=36;if(i||(i=findBox(e,n,["encv"]),o=86),!i)return r;const a=findBox(e,i.start+o,["sinf","schi","tenc"]);a?(r.push(new TencBox(a.data,a.start,a.end)),n=a.end):n=t.end}return r}(e);if(!t)return;const r=function(e){const t=findBox(e,0,["moov"]),r=[];if(!t)return r;const n=new DataView(e.buffer,0);for(let i=t.start+8;i<t.size;){const t=n.getUint32(i);"pssh"===encodedArrayToString(e.subarray(i+4,i+8))&&r.push(new PsshBox(e,i,i+t)),i+=t}return r}(e).find(e=>e.isWidevine);r&&(t.defaultKeyId=r.keyBytes)};function _define_property$1i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class ID3Tag{get major(){return this.version[0]}get minor(){return this.version[1]}get revision(){var e;return null!==(e=this.version[2])&&void 0!==e?e:0}static parse(e){return function(e){if(0===e.length||"ID3"!==function(e,t=0){return decodeString(e.subarray(t,3))}(e))return;const t={};let r=3;t.version=[3,e[r++],e[r++]],t.flags=function(e,t=5){const r=e[t];return{unsynchronized:decodeBitFlag(r,7),extendedHeader:decodeBitFlag(r,6),experimental:decodeBitFlag(r,5),footer:decodeBitFlag(r,4)}}(e),r+=1;const n=r+4+decodeSynchSafeUint32(e.subarray(r,r+4));r+=4,t.flags.extendedHeader&&(r+=decodeSynchSafeUint32(e.subarray(r,r+4)));t.version[1]>2&&(t.frames=decodeID3Frames(e,t.version,[r,n]));return new ID3Tag(t)}(e)}constructor(e){var t;_define_property$1i(this,"version",[3,2,0]),_define_property$1i(this,"frames",[]),_define_property$1i(this,"flags",{unsynchronized:!1,extendedHeader:!1,footer:!1,experimental:!1}),this.version=e.version,this.flags=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1i(e,t,r[t])}))}return e}({unsynchronized:!1,extendedHeader:!1,footer:!1,experimental:!1},e.flags),this.frames=null!==(t=e.frames)&&void 0!==t?t:[]}}const zr={WXXX:function(e,t,r){const n=decodeCharset(t[0]),[i,o]=decodeNullTerminatedString(t.subarray(1),n),a=o>0?o+2:0;return{key:"WXXX",data:decodeString(t.subarray(a),n),description:i}},TXXX:function(e,t,r){const n=decodeCharset(t[0]),[i,o]=decodeNullTerminatedString(t.subarray(1),n),a=o>0?o+2:0;return{key:"TXXX",data:decodeString(t.subarray(a),n),description:i}},TPE1:function(e,t,r){return{key:"TPE1",data:trimNull(decodeString(t.subarray(1),decodeCharset(t[0])))}},TIT2:function(e,t,r){return{key:"TIT2",data:trimNull(decodeString(t.subarray(1),decodeCharset(t[0])))}},TALB:function(e,t,r){return{key:"TALB",data:trimNull(decodeString(t.subarray(1),decodeCharset(t[0])))}},TEXT:function(e,t,r){return{key:"TEXT",data:trimNull(decodeString(t.subarray(1),decodeCharset(t[0])))}},PRIV:function(e,t,r){const[n,i]=decodeNullTerminatedString(t);if(0===i)return;return{key:"PRIV",owner:n,data:t.slice(i+1)}},CHAP:function(e,t,r){const n=new DataView(t.buffer),i={key:"CHAP",elementId:"",startTime:0,endTime:0,frames:[]},[o,a]=decodeNullTerminatedString(t);i.elementId=o;let s=a+1;return i.startTime=n.getUint32(s),s+=4,i.endTime=n.getUint32(s),s+=4,i.startOffset=n.getUint32(s),s+=4,i.endOffset=n.getUint32(s),s+=4,i.frames=decodeID3Frames(t,r,[s,t.length]),i}};function decodeID3Frames(e,t,r){var n;const i=null!==(n=(r=null!=r?r:[0,e.byteLength])[1])&&void 0!==n?n:e.byteLength;var o;let a=null!==(o=r[0])&&void 0!==o?o:0;const s=new DataView(e.buffer,0,i),c=[];for(;a+8<=i;){var l;const r=decodeString(e.subarray(a,a+4));a+=4;const n=4===t[1]?decodeSynchSafeUint32(e.subarray(a,a+4)):s.getUint32(a);if(a+=4,e[a++],e[a++],a+n>i)break;const o=e.slice(a,a+n),d=null===(l=zr[r])||void 0===l?void 0:l.call(zr,r,o,t);d&&c.push(d),a+=n}return c}function decodeString(e,t="utf-8"){return new TextDecoder(t).decode(e)}function decodeBitFlag(e,t){return 0!=(e&1<<t)}const Qr={0:"iso-8859-1",1:"utf-16",2:"utf-16be",3:"utf-8"};function decodeCharset(e){var t;return null!==(t=Qr[e])&&void 0!==t?t:"iso-8859-1"}function trimNull(e){return e.replace(/^\0*|\0*/g,"")}function decodeNullTerminatedString(e,t="utf-8",r=0){const n=[];for(let i=r;i<e.byteLength;i++){const t=e[i];if(0===t)break;n.push(t)}return[decodeString(new Uint8Array(n),t),n.length]}function decodeSynchSafeUint32(e){return 2097152*(127&e[0])+16384*(127&e[1])+128*(127&e[2])+(127&e[3])}function checkBoxName(e,t,r){return!(t+4>e.length)&&(e[t]===r[0]&&e[t+1]===r[1]&&e[t+2]===r[2]&&e[t+3]===r[3])}function findEmsgs(e){const t=e.length,r=[];if(function(e){return(null==e?void 0:e.length)>=8&&checkBoxName(e,4,[102,116,121,112])}(e))return r;for(let n=0;n<t;n++){if(checkBoxName(e,n,[109,111,111,102]))return r;if(checkBoxName(e,n,[101,109,115,103])){const t=n-4,i=new DataView(e.buffer,t).getUint32(0),o=e.subarray(t,t+i);n=n+i-1,r.push(o)}}return r}function _define_property$1h(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class TimedMetadata{storefrontAdamId(e){var t;return null===(t=this.storefrontAdamIds)||void 0===t?void 0:t[e]}equals(e){return function(e,t){var r,n,i,o;if(void 0===e&&void 0===t)return!0;if(typeof e!=typeof t)return!1;if(t=t,(e=e).album!==t.album||e.title!==t.title||e.performer!==t.performer)return!1;if((null===(r=e.links)||void 0===r?void 0:r.length)!==(null===(n=t.links)||void 0===n?void 0:n.length))return!1;for(let c=0;c<(null!==(o=null===(i=e.links)||void 0===i?void 0:i.length)&&void 0!==o?o:0);c++){var a,s;if(!objectKeyValueEquals(null===(a=e.links)||void 0===a?void 0:a[c],null===(s=t.links)||void 0===s?void 0:s[c]))return!1}if(!objectKeyValueEquals(e.storefrontAdamIds,t.storefrontAdamIds))return!1;if(!function(e,t){if(void 0===e&&void 0===t)return!0;if(typeof e!=typeof t)return!1;if(t=t,(e=e).byteLength!==t.byteLength)return!1;for(let r=0;r<e.byteLength;r++)if(e[r]!==t[r])return!1;return!0}(e.blob,t.blob))return!1;return!0}(this,e)}constructor(e){var t;_define_property$1h(this,"performer",void 0),_define_property$1h(this,"title",void 0),_define_property$1h(this,"album",void 0),_define_property$1h(this,"links",void 0),_define_property$1h(this,"storefrontAdamIds",void 0),_define_property$1h(this,"blob",void 0),this.performer=null==e?void 0:e.performer,this.title=null==e?void 0:e.title,this.album=null==e?void 0:e.album,this.links=null==e?void 0:e.links,this.storefrontAdamIds=null!==(t=null==e?void 0:e.storefrontAdamIds)&&void 0!==t?t:{},this.blob=null==e?void 0:e.blob}}function objectKeyValueEquals(e,t){if(void 0===e&&void 0===t)return!0;if(typeof e!=typeof t)return!1;e=e,t=t;const r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return!1;for(const i of r)if(e[i]!==t[i])return!1;return!0}function parseStorefrontAdamIds(e){let t;t="Uint8Array"===e.constructor.name?new TextDecoder("utf-8").decode(e):e;const r=t.trim().split(",");if(0===r.length)return;const isEmptyString=e=>void 0===e||""===e,n={};for(const i of r){const[e,t]=i.split(":",2).map(e=>e.trim());isEmptyString(e)||isEmptyString(t)||"0"===t||void 0!==n[e]||(n[e]=t)}return n}function parsePingBlob(e){return"string"==typeof e?Uint8Array.from(atob(e),e=>e.charCodeAt(0)):e}function _define_property$1g(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class Emsg{get length(){return this.data.length}get elementPresentationTime(){const{presentationTime:e,timeScale:t}=this;return e&&t?Math.round(e/t):NaN}get timedMetadata(){var e;if(this._timedMetadata)return this._timedMetadata;const t=null===(e=this.id3)||void 0===e?void 0:e.frames;return t?(this._timedMetadata=function(e){const t={};for(const n of e)if(void 0!==n.key)switch(n.key){case"TALB":t.album=n.data;break;case"TIT2":t.title=n.data;break;case"TPE1":t.performer=n.data;break;case"WXXX":var r;if(void 0!==n.description)if(void 0===t.links&&(t.links=[]),!t.links.some(e=>e.url===n.data))t.links.push({description:null!==(r=n.description)&&void 0!==r?r:"",url:n.data});break;case"PRIV":"com.apple.radio.adamid"===n.owner&&(t.storefrontAdamIds=parseStorefrontAdamIds(n.data)),"com.apple.radio.ping.jingle"===n.owner&&(t.blob=parsePingBlob(n.data))}return new TimedMetadata(t)}(t),this._timedMetadata):void 0}constructor(e){_define_property$1g(this,"data",void 0),_define_property$1g(this,"schemeIdUri",void 0),_define_property$1g(this,"eventDuration",void 0),_define_property$1g(this,"presentationTime",void 0),_define_property$1g(this,"payload",void 0),_define_property$1g(this,"timeScale",void 0),_define_property$1g(this,"id3",void 0),_define_property$1g(this,"id",void 0),_define_property$1g(this,"_timedMetadata",void 0),this.data=e;const t=new DataView(e.buffer);let r=8;if(1!==e[r])return;r+=4,this.timeScale=t.getUint32(r),r+=4;const n=t.getUint32(r);r+=4;const i=t.getUint32(r);if(r+=4,this.presentationTime=Math.pow(2,32)*n+i,!Number.isSafeInteger(this.presentationTime))throw this.presentationTime=Number.MAX_SAFE_INTEGER,new Error("Failed to create 64 bit integer");this.eventDuration=t.getUint32(r),r+=4,this.id=t.getUint32(r),r+=4;const[o,a]=readNullTerminatedString(e,r);r+=a+1,this.schemeIdUri=o;const[s,c]=readNullTerminatedString(e,r);r+=c+1,this.payload=e.subarray(r,e.byteLength),this.id3=ID3Tag.parse(this.payload)}}function _define_property$1f(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class TimedMetadataManager{processEmsgs(e){const t=findEmsgs(e);t.length&&(this._currentEmsgInterval||(this._currentEmsgInterval=setInterval(this._getCurrentEmsg,1e3)),t.forEach(e=>{const t=new Emsg(e);this._emsgLookup[t.elementPresentationTime]=t}))}stop(){const{_currentEmsgInterval:e}=this;e&&clearInterval(e)}_getCurrentEmsg(){const{_currentTime:e,_emsgLookup:t}=this,r=Math.round(e()),n=[],i=Object.keys(t);for(let a=0;a<i.length;a++){const e=parseInt(i[a],10);if(!(e<r))break;n.push(e)}const o=n.pop();if(o){const e=t[o];if(!e)return;const{_currentEmsg:r,_onDidChange:n}=this,i=null==r?void 0:r.payload,a=e.payload;i&&arrayEquals(i,a)||(this._currentEmsg=e,n(e)),this._cleanupEmsgs(o)}}_cleanupEmsgs(e){const{_emsgLookup:t}=this;Object.keys(t).forEach(r=>{parseInt(r,10)<e&&delete t[r]})}constructor(e,t){_define_property$1f(this,"_currentTime",void 0),_define_property$1f(this,"_onDidChange",void 0),_define_property$1f(this,"_currentEmsgInterval",void 0),_define_property$1f(this,"_emsgLookup",void 0),_define_property$1f(this,"_currentEmsg",void 0),this._currentTime=e,this._onDidChange=t,this._emsgLookup={},this._getCurrentEmsg=this._getCurrentEmsg.bind(this)}}function _define_property$1e(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class SegmentProcessor{process(e,t){const{_item:r}=this;try{r.isLiveRadioStation?this._processLiveRadioSegment(e,t):r.hasOffersHlsUrl&&this._processHlsOffersSegment(e,t)}catch(n){Ue.error("Error processing segment",n)}}stop(){this._timedMetadataManager.stop()}_processHlsOffersSegment(e,t){e.isInitSegment&&rewriteDefaultKid(t)}_processLiveRadioSegment(e,t){e.isInitSegment&&rewriteDefaultKid(t),this._timedMetadataManager.processEmsgs(t)}constructor(e,t,r){_define_property$1e(this,"_item",void 0),_define_property$1e(this,"_timedMetadataManager",void 0),this._item=e,this._timedMetadataManager=new TimedMetadataManager(()=>t.currentTime,e=>{r.publish(qr,{item:this._item,metadata:e.timedMetadata,position:t.currentTime,playingDate:void 0})})}}function asyncGeneratorStep$W(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$W(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$W(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$W(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1d(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$r(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$r(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const Jr=Ue.createChild("mse"),Xr=BooleanDevFlag.get("mk-mse-buffer"),{manifestParsed:Zr}=Ge;class MseBuffer{onSourceOpen(){Jr.debug("mediaSource open handler");const{mediaSource:e}=this;if(e.activeSourceBuffers.length>0)return void Jr.debug("not adding new source buffer");Jr.debug("adding new source buffer");const t=e.addSourceBuffer(Ve);this.sourceBuffer=t,t.addEventListener("updateend",this.updateEndHandler);const{clip:r,hasAppendWindowSupport:n}=this;r&&(n?(Jr.debug("appendWindowStart/End",r.start,r.end),t.appendWindowStart=r.start,t.appendWindowEnd=r.end):(Jr.debug("seeking for clip",r.start),asAsync(this.seek(r.start)))),this.updateSegmentToFetch(0,!0)}setNextManifest(e){Jr.debug("setting next manifest for ",e.mediaItem.title),this.nextSeamlessTransition?(Jr.debug("abandoning transition scheduled for "+this.nextSeamlessTransition),this.revertSeamlessTransition(!0),this.playbackTimeline.next={manifest:e}):(this.playbackTimeline.next={manifest:e},this.isFullyBuffered&&(Jr.debug("current song is fully buffered, beginning transition to next"),this.transitionToNextManifest()))}isItemPlaying(e){var t,r;const{playbackTimeline:n}=this,i=this.nextSeamlessTransition?null===(t=n.previous)||void 0===t?void 0:t.manifest.mediaItem:null===(r=n.current)||void 0===r?void 0:r.manifest.mediaItem;return!!i&&(Jr.debug(`isItemPlaying ${e.title}, ${i.title}, ${e.id===i.id}`),e.id===i.id)}get currentItem(){return this.manifest.mediaItem}get playableUrl(){let e=this._playableUrl;return e||(e=window.URL.createObjectURL(this.mediaSource),Jr.debug("created url",e),this._playableUrl=e,e)}get segments(){const{manifest:e,clip:t}=this;return t?e.segmentsForTimeRange(t):e.segments||[]}get currentTime(){return this._currentTime}set currentTime(e){if(e+=this.currentTimestampOffset,this._currentTime===e)return;const{nextSeamlessTransition:t}=this;if(t&&e>=t){var r,n;Jr.debug("setting offset to",t),this.currentTimestampOffset=t||0,this.nextSeamlessTransition=void 0,this.duration=this.manifest.mediaItem.playbackDuration/1e3,Jr.debug("buffer setting duration to",this.duration);const e={previous:null===(n=this.playbackTimeline.previous)||void 0===n||null===(r=n.manifest)||void 0===r?void 0:r.mediaItem,current:this.manifest.mediaItem};Jr.debug("dispatching seamless audio transition",e),this.dispatcher.publish(Hr,e)}this._currentTime=e;const{isOverBufferLimit:i,timeToTrim:o}=this,a=e>this.timeToTrim;i&&a&&(Jr.debug("buffer over limit, trimming to ",o),this.removeToTime(o),this.timeToTrim+=10)}get hasAppendWindowSupport(){var e;return void 0!==(null===(e=this.sourceBuffer)||void 0===e?void 0:e.appendWindowStart)}seek(e){var t=this;return _async_to_generator$W((function*(){const{duration:r,seekWhenUpdated:n,sourceBuffer:i}=t;if(t.resolveSeekPromise(!1),Jr.debug("seek to ",e),(e=+e)>r&&(Jr.debug("rounding seek time to duration",e,r),e=r),!i)return!1;if(t.revertSeamlessTransition(),i.updating)return Jr.debug("sourcebuffer updating, deferring seek"),new Promise(r=>{n&&n.resolve(!1),t.seekWhenUpdated={seek:t.seek.bind(t,e),resolve:r}});t.currentlyLoadingSegmentIndex=void 0,t.updateSegmentToFetch(0,!0),t.removeToTime(e),t.timeToTrim=10*Math.floor(e/10);const o=t.getSegmentForTime(e);0!==o&&(yield t.firstSegmentLoadPromise),Jr.debug("seeking to",e,"segment",o),t.updateSegmentToFetch(o,!0);const a=new Promise(r=>{t.seekResolver={time:e,resolve:r}});return t.checkSeekBuffered(),a}))()}clearNextManifest(){this.revertSeamlessTransition(!0),this.playbackTimeline.next=void 0}revertSeamlessTransition(e=!1){const{playbackTimeline:t,nextSeamlessTransition:r}=this;if(!r||!t.previous)return void Jr.debug("no need to revert, no transition");this.isAtEndOfStream=e,Jr.debug("reverting seamless transition with discardNextManifest",e),e?this.clearBufferToEnd(r):this.clearBuffer(),Jr.debug("abandoning transition to "+this.manifest.mediaItem.title),t.next=e?void 0:t.current,t.current=t.previous,t.previous=void 0;const n=this.manifest.mediaItem;Jr.debug("current item reverted to "+n.title),this.nextSeamlessTransition=void 0,this.duration=n.playbackDuration/1e3,Jr.debug("reverted duration to "+this.duration),e||(this.currentTimestampOffset=0,this.timestampOffsetAdjustment=0,Jr.debug("reverted currentTimestampOffset and timestampOffsetAdjustment to 0")),this.printInfo(),this.segmentIndexToFetch=-1}get streamHasEnding(){return!this.manifest.mediaItem.isLiveRadioStation}stop(){this.segmentProcessor.stop(),this.setEndOfStream(),this.remove()}remove(){var e;Jr.debug("removing sourceBuffer and mediaSource");const{sourceBuffer:t,mediaSource:r}=this;null===(e=this.seekResolver)||void 0===e||e.resolve(!1),this.manifest.removeEventListener(Zr,this.onManifestParsed);const n=this._playableUrl;n&&(Jr.debug("revoking url",n),window.URL.revokeObjectURL(n)),r.removeEventListener("sourceopen",this.onSourceOpen),t&&(t.removeEventListener("updateend",this.updateEndHandler),this.sourceBuffer=void 0)}onManifestParsed(){const e=this.segmentIndexToFetch+1;Jr.debug("manifestParsed, loading segment",e),this.updateSegmentToFetch(e,!0)}updateEndHandler(){if(this.kickstartBuffer(),this.clearDeferredRemove())return;if(Jr.debug("update end",this.seekWhenUpdated),this.seekWhenUpdated){Jr.debug("updateEndHandler resolving seekWhenUpdated");const{seekWhenUpdated:e}=this;return asAsync(e.seek().then(e.resolve)),void(this.seekWhenUpdated=void 0)}this.checkSeekBuffered();const{clip:e,sourceBuffer:t,hasAppendWindowSupport:r}=this;if(e&&t&&!r){const{buffered:r}=t;if(this.isTimeBuffered(e.end+1)){const n=r.end(r.length-1);return Jr.debug("clipping sourcebuffer to",e.end,n),void t.remove(e.end,n)}}if(this.isAtEndOfStream)return Jr.debug("buffer is at end of stream"),this.streamHasEnding&&(Jr.debug("isAtEndOfStream, not fetching any more segments"),this.playbackTimeline.next||this.setEndOfStream(),this.transitionToNextManifest()),void(this.isAtEndOfStream=!1);Jr.debug("updateEndHandler invoking loadSegment"),asAsync(this.loadSegment())}clearDeferredRemove(){if(0===this.deferredRemoves.length)return!1;const e=this.deferredRemoves.shift();var t;(Jr.trace("clearDeferredRemove",e),e.end>e.start)?null===(t=this.sourceBuffer)||void 0===t||t.remove(e.start,e.end):e.end<=e.start&&Jr.warn(`Trying to remove an invalid time range from SourceBuffer: |${e.start} <=> ${e.end}| (${e.end-e.start})`);return!0}transitionToNextManifest(){var e;Jr.debug("beginning transition to next manifest");const{playbackTimeline:t,sourceBuffer:r}=this;if(!t.next||!r)return void Jr.debug("no next manifest");const n=this.endOfBufferTime||this.currentTimestampOffset;Jr.debug("setting seamless transition at",n),this.nextSeamlessTransition=n,this.timestampOffsetAdjustment=n,this.playbackTimeline.current.endTime=n,t.previous=t.current,Jr.debug("previous manifest set to",null===(e=t.previous)||void 0===e?void 0:e.manifest.mediaItem.title),t.current=t.next,Jr.debug("current manifest set to",t.current.manifest.mediaItem.title),t.next=void 0,this.updateSegmentToFetch(0,!0),this.printInfo()}updateSegmentToFetch(e,t=!1){this.segments.length&&e<this.segments.length&&e!==this.segmentIndexToFetch&&(this.segmentIndexToFetch=e,t&&(Jr.debug("updateSegmentToFetch invoking loadSegment"),asAsync(this.loadSegment())))}loadSegment(){var e=this;return _async_to_generator$W((function*(){const t=e.segmentIndexToFetch,r=e.segments[t];if(t!==e.currentlyLoadingSegmentIndex){if(r)try{Jr.debug("begin loadSegment "+t),e.currentlyLoadingSegmentIndex=t;const i=r.load();0===t&&(e.firstSegmentLoadPromise=i);const o=yield i;if(0!==t&&t!==e.segmentIndexToFetch)return void Jr.debug("load segment index to fetch changed, not processing bytes for segment",t);e.segmentProcessor.process(r,o),Jr.debug("loadSegment processed: "+t);const{sourceBuffer:a,timestampOffsetAdjustment:s}=e;if(!a)return;try{"number"==typeof s&&(Jr.debug("adjusting timestampOffset of sourcebuffer to",s),a.timestampOffset=s,e.timestampOffsetAdjustment=void 0),a.appendBuffer(o),e.isFullyBuffered=!1,e.isOverBufferLimit=!1,Jr.debug("appended to buffer",o.length),e.printBufferTimes(),t===e.segments.length-1?e.isAtEndOfStream=!0:t===e.segmentIndexToFetch&&(Jr.debug("loadSegment bumping segment index to fetch to ",t+1),e.updateSegmentToFetch(t+1))}catch(n){"QuotaExceededError"===n.name?(e.isOverBufferLimit=!0,Jr.debug("reached buffer limit")):Jr.warn("Error appending to source buffer",n)}}catch(i){Jr.error("Error loading segment",i),e.dispatcher.publish(Wr,i)}finally{e.currentlyLoadingSegmentIndex=void 0}}else Jr.debug(`segment ${t} is currently loading, not loading it again`)}))()}setEndOfStream(){const{sourceBuffer:e,mediaSource:t}=this;e&&"ended"!==t.readyState&&(e.updating||"open"!==t.readyState?Jr.error("Could not end of stream (updating, readyState)",e.updating,t.readyState):(Jr.debug("mediaSource.endOfStream"),t.endOfStream(),this.isFullyBuffered=!0))}removeToTime(e){Jr.debug("removing to time",e),e>0&&(this.isTimeBuffered(e)||this.isOverBufferLimit)&&this.safeSourceBufferRemove(0,e)}safeSourceBufferRemove(e,t){Jr.trace("safeSourceBufferRemove",e,t);const{sourceBuffer:r}=this;r&&(r.updating?this.deferredRemoves.push({start:e,end:t}):t<=e?Jr.warn(`Trying to remove an invalid time range from SourceBuffer: |${e} <=> ${t}| (${t-e})`):r.remove(e,t))}get previousOffset(){var e,t;return(null===(t=this.playbackTimeline)||void 0===t||null===(e=t.previous)||void 0===e?void 0:e.endTime)||0}get manifest(){var e;return null===(e=this.playbackTimeline.current)||void 0===e?void 0:e.manifest}checkSeekBuffered(){const{seekResolver:e,currentTimestampOffset:t}=this;if(!e)return;const{time:r}=e,n=r+t,i=this.isTimeBuffered(n);Jr.debug("resolving seek for time, adjustedTime, isBuffered",r,n,i),this.printBufferTimes(),i&&(Jr.debug("resolving seek to true for time:",n),this.element.currentTime=n,this.resolveSeekPromise(!0))}resolveSeekPromise(e){this.seekResolver&&(this.seekResolver.resolve(e),this.seekResolver=void 0)}get endOfBufferTime(){var e;const t=null===(e=this.sourceBuffer)||void 0===e?void 0:e.buffered;return!(!t||!t.length)&&t.end(t.length-1)}isTimeBuffered(e){var t;const r=null===(t=this.sourceBuffer)||void 0===t?void 0:t.buffered;if(!r)return!1;for(let n=0;n<r.length;n++)if(Jr.debug("isTimeBuffered",r.start(n),e,r.end(n)),e>=r.start(n)&&e<=r.end(n))return!0;return!1}clearBufferToEnd(e){const{sourceBuffer:t}=this;if(!t||!t.buffered)return;const r=t.buffered.end(t.buffered.length-1);this.safeSourceBufferRemove(e,r)}clearBuffer(){const{sourceBuffer:e}=this;if(!e||!e.buffered)return;const t=e.buffered;for(let r=0;r<t.length;r++)this.safeSourceBufferRemove(t.start(r),t.end(r))}get bufferTimesString(){var e;const t=null===(e=this.sourceBuffer)||void 0===e?void 0:e.buffered;if(!t)return"";const r=[];for(let n=0;n<t.length;n++)r.push(`start ${t.start(n)} end: ${t.end(n)}`);return r.join(",")}printBufferTimes(){Xr&&Jr.debug("buffer times",this.bufferTimesString)}getSegmentForTime(e){return Math.floor(e/10)+1}kickstartBuffer(){const{hasKickstarted:e,element:t,clip:r}=this,{buffered:n}=t;e||(this.manifest.mediaItem.isSong?r&&this.isTimeBuffered(r.start)&&(t.currentTime=r.start,this.hasKickstarted=!0):n.length&&(t.currentTime=n.start(0),this.hasKickstarted=!0))}printInfo(){var e,t;const{playbackTimeline:r}=this;Jr.info("---- Buffer Info ----"),Jr.info("currently buffering item",r.current.manifest.mediaItem.title),Jr.info("next item to buffer",null===(e=r.next)||void 0===e?void 0:e.manifest.mediaItem.title),Jr.info("previously buffered item",null===(t=r.previous)||void 0===t?void 0:t.manifest.mediaItem.title),Jr.info("currentTimestampOffset",this.currentTimestampOffset),Jr.info("currentTime",this.currentTime),Jr.info("duration",this.duration),Jr.info("nextSeamlessTransition",this.nextSeamlessTransition),Jr.info("timestampOffsetAdjustment",this.timestampOffsetAdjustment),Jr.info("buffered times",this.bufferTimesString),Jr.info("isAtEndOfStream",this.isAtEndOfStream),Jr.info("isFullyBuffered",this.isFullyBuffered),Jr.info("segmentIndexToFetch",this.segmentIndexToFetch),Jr.info("segments.length",this.segments.length),Jr.info("---- End Buffer Info ----")}constructor({dispatcher:e,element:t,manifest:r,currentTime:n,duration:i,clip:o}){_define_property$1d(this,"dispatcher",void 0),_define_property$1d(this,"mediaSource",void 0),_define_property$1d(this,"sourceBuffer",void 0),_define_property$1d(this,"element",void 0),_define_property$1d(this,"_currentTime",void 0),_define_property$1d(this,"currentlyLoadingSegmentIndex",void 0),_define_property$1d(this,"duration",void 0),_define_property$1d(this,"firstSegmentLoadPromise",Promise.resolve()),_define_property$1d(this,"hasKickstarted",!1),_define_property$1d(this,"isOverBufferLimit",void 0),_define_property$1d(this,"seekResolver",void 0),_define_property$1d(this,"seekWhenUpdated",void 0),_define_property$1d(this,"segmentIndexToFetch",-1),_define_property$1d(this,"segmentProcessor",void 0),_define_property$1d(this,"timeToTrim",10),_define_property$1d(this,"isAtEndOfStream",!1),_define_property$1d(this,"isFullyBuffered",!1),_define_property$1d(this,"_playableUrl",void 0),_define_property$1d(this,"clip",void 0),_define_property$1d(this,"deferredRemoves",[]),_define_property$1d(this,"timestampOffsetAdjustment",void 0),_define_property$1d(this,"playbackTimeline",void 0),_define_property$1d(this,"currentTimestampOffset",0),_define_property$1d(this,"nextSeamlessTransition",void 0),this.dispatcher=e,this.clip=o,this.element=t,this.mediaSource=new MediaSource,this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this.segmentProcessor=new SegmentProcessor(r.mediaItem,t,e),this.playbackTimeline={current:{manifest:r}},r.addEventListener(Zr,this.onManifestParsed),this._currentTime=n||0,this.duration=i,window.mseBuffer=this}}function asyncGeneratorStep$V(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$V(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$V(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$V(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1c(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$q(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$q(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}_ts_decorate$r([Bind(),_ts_metadata$r("design:type",Function),_ts_metadata$r("design:paramtypes",[]),_ts_metadata$r("design:returntype",void 0)],MseBuffer.prototype,"onSourceOpen",null),_ts_decorate$r([Bind(),_ts_metadata$r("design:type",Function),_ts_metadata$r("design:paramtypes",[]),_ts_metadata$r("design:returntype",void 0)],MseBuffer.prototype,"onManifestParsed",null),_ts_decorate$r([Bind(),_ts_metadata$r("design:type",Function),_ts_metadata$r("design:paramtypes",[]),_ts_metadata$r("design:returntype",void 0)],MseBuffer.prototype,"updateEndHandler",null);const{mediaPlaybackError:en}=rt;class AudioPlayer extends BasePlayer{destroy(){var e=this,_superprop_get_destroy=()=>super.destroy;return _async_to_generator$V((function*(){_superprop_get_destroy().call(e),e._dispatcher.unsubscribe(Wr,e.onLoadSegmentError)}))()}onLoadSegmentError(e){this._dispatcher.publish(en,new MKError(MKError.Reason.MEDIA_SESSION,e)),this.destroy()}get currentPlayingDate(){}get isPlayingAtLiveEdge(){return!1}get seekableTimeRanges(){return this.currentPlaybackDuration?[{start:0,end:this.currentPlaybackDuration}]:void 0}get supportsPreviewImages(){return!1}get _targetElement(){return this.audio}initializeExtension(){var e=this;return _async_to_generator$V((function*(){e.extension=new MediaExtension(e.audio,Ve),yield e.extension.initializeKeySystem(),e.extension.addEventListener(Ge.playbackLicenseError,t=>{e.resetDeferredPlay(),e._dispatcher.publish(en,t)}),e.extension.addEventListener(Ge.playbackSessionError,t=>{e._dispatcher.publish(en,new MKError(MKError.Reason.MEDIA_SESSION,t)),e.destroy()})}))()}initializeMediaElement(){var e=this;return _async_to_generator$V((function*(){const t=nextAvailableAudioElement();t.autoplay=!1,t.id="apple-music-player",t.controls=!1,t.muted=!1,t.playbackRate=1,t.preload="metadata",t.volume=1,e.audio=t,document.body.appendChild(t),Ue.debug("initializedMediaElement",t)}))()}removeEventHandlers(){this._targetElement.removeEventListener("timeupdate",this.onTimeUpdate),this._targetElement.removeEventListener("timeupdate",this.delayedCdmUpdateCheck),super.removeEventHandlers()}stopMediaElement(){var e=this,_superprop_get_stopMediaElement=()=>super.stopMediaElement;return _async_to_generator$V((function*(){var t;yield _superprop_get_stopMediaElement().call(e),yield e.tearDownManifests(),null===(t=e._buffer)||void 0===t||t.stop(),e._buffer=void 0}))()}preloadItem(e){var t=this;return _async_to_generator$V((function*(){const{extension:r,nextManifest:n}=t,i=t._buffer;if("song"!==e.type||!i||!r||!t.isSeamlessAudioTransitionsEnabled)return;if((null==n?void 0:n.mediaItem.id)===e.id)return void Ue.debug("already have next manifest for ",e.title);t._targetElement.removeEventListener("timeupdate",t.onTimeUpdate),t._targetElement.addEventListener("timeupdate",t.onTimeUpdate),Ue.debug("player preparing next manifest for",e.title);const o=yield t.loadAndParseManifest(e,!1);i.setNextManifest(o),r.setMediaItem(e),r.extURI=o.extURI,t.nextManifest=o}))()}playItemFromEncryptedSource(t,r=!1,n){var i=this;return _async_to_generator$V((function*(){const o=i._paused&&!r;Ue.debug("playItemFromEncryptedSource",t.title);const a=o?void 0:i.startPlaybackSequence();if(t.playRawAssetURL)return t.playbackType=e.PlaybackType.unencryptedFull,i.nowPlayingItem=t,yield i._playAssetURL(t.assetURL,o),i.finishPlaybackSequence();const{extension:s}=i;var c,l;i.delaySeamlessCdmUpdates&&(null===(l=i.extension)||void 0===l||null===(c=l.session)||void 0===c||c.applyDelayedCdmUpdates());if(!s)return a;s.initiated=r,s.setMediaItem(t),t.playbackType=e.PlaybackType.encryptedFull,i.nowPlayingItem=t,t.state=y.loading;const d=yield i.getManifestForItem(t);i.manifest=d;const u=shouldForceAudioMse();if((t.isSong||s.isFairplay&&u)&&(s.extURI=d.extURI),t.state=y.ready,s.isFairplay&&!u){let e=t.assetURL;(null==n?void 0:n.startTime)&&(e+="#t="+n.startTime),yield i._playAssetURL(e,o)}else{const e=i._buffer;e&&i.isSeamlessAudioTransitionsEnabled&&e.isItemPlaying(d.mediaItem)?Ue.debug("already have buffer, continuing playback"):yield i.beginNewBufferForItem(o,d,n)}return i.finishPlaybackSequence()}))()}getManifestForItem(e){var t=this;return _async_to_generator$V((function*(){var r,n;Ue.debug("reconciling item to play against playing item");const{nextManifest:i,manifest:o,isSeamlessAudioTransitionsEnabled:a}=t,s=t._buffer;if(!s||!o)return Ue.debug("no buffer or manifest, creating manifest [title, buffer, manifest]",e.title,!!s,!!o),t.loadAndParseManifest(e);if(!a)return Ue.debug("seamless transitions disabled, stopping and creating manifest for",e.title),yield t.tearDownManifests(),t.loadAndParseManifest(e);const c=!s.isItemPlaying(e);let l;return Ue.debug("itemMismatch",c),i&&!c?(Ue.debug(`replacing manifest for ${o.mediaItem.title} with next manifest ${i.mediaItem.title}`),l=i,t.nextManifest=void 0,Ue.debug("cease listening for keys on manifest for",o.mediaItem.title),yield t.tearDownManifest(o)):c?(null==i?void 0:i.mediaItem.id)!==e.id?(Ue.debug(`item to play ${e.title} does not match playing or next items, tearing down all manifests`),yield t.tearDownManifests(),l=yield t.loadAndParseManifest(e)):(Ue.debug(`item to play ${e.title} matches next item, tearing down current manifest`),yield t.tearDownManifest(o),l=i):(Ue.debug("item is already playing, returning existing manifest"),l=o),Ue.debug("getManifestForItem loading keys for",o.mediaItem.title),null===(n=t.extension)||void 0===n||null===(r=n.session)||void 0===r||r.loadKeys(l.keyValues,l.mediaItem),l}))()}seekToTime(e){var t=this;return _async_to_generator$V((function*(){const r=t._buffer;if(r){Ue.debug("audio-player: buffer seek to",e);if(!(yield r.seek(e)))return;t.isSeamlessAudioTransitionsEnabled&&t.onTimeUpdate()}else Ue.debug("audio-player: media element seek to",e),t._targetElement.currentTime=e}))()}tearDownManifests(){var e=this;return _async_to_generator$V((function*(){e.manifest=yield e.tearDownManifest(e.manifest),e.nextManifest=yield e.tearDownManifest(e.nextManifest)}))()}tearDownManifest(e){var t=this;return _async_to_generator$V((function*(){const{extension:r}=t;e&&(Ue.debug("tearing down manifest for",e.mediaItem.title),e.stop(),r&&(yield r.clearSessions(e.keyValues)),e.removeEventListener(Kr.keysParsed,t.loadKeysHandler))}))()}loadAndParseManifest(e,t=!0){var r=this;return _async_to_generator$V((function*(){let n;Ue.debug(`will load and parse manifest for ${e.title}, loadKeys ${t}`);try{return n=yield Manifest.load(e,!1),t&&n.addEventListener(Kr.keysParsed,r.loadKeysHandler),n.parse(),n}catch(De){r.resetDeferredPlay();const t=new MKError(MKError.Reason.NETWORK_ERROR,"Could not fetch manifest");throw t.data=De,r._dispatcher.publish(en,t),t}}))()}onTimeUpdate(){if(!this._buffer)return;const{currentPlaybackTimeRemaining:e,nextManifest:t,delaySeamlessCdmUpdates:r}=this;if(t&&e<15){var n,i,o,a;if(Ue.debug("player loading keys for",t.mediaItem.title,r),r)null===(i=this.extension)||void 0===i||null===(n=i.session)||void 0===n||n.loadKeys(t.keyValues,t.mediaItem,{delayCdmUpdate:!0}),this._targetElement.addEventListener("timeupdate",this.delayedCdmUpdateCheck);else null===(a=this.extension)||void 0===a||null===(o=a.session)||void 0===o||o.loadKeys(t.keyValues,t.mediaItem);this._targetElement.removeEventListener("timeupdate",this.onTimeUpdate)}}delayedCdmUpdateCheck(){var e;const t=null===(e=this.nowPlayingItem)||void 0===e?void 0:e.playbackDuration,r=t?t/1e3:this.currentPlaybackDuration,n=this._currentTime,i=Number((r-n).toFixed(3));if(i<1){const e=1e3*i;Ue.debug("delayed CDM update in ",e),setTimeout(()=>{var e,t;Ue.debug("applying delayed CDM update"),null===(t=this.extension)||void 0===t||null===(e=t.session)||void 0===e||e.applyDelayedCdmUpdates()},e),this._targetElement.removeEventListener("timeupdate",this.delayedCdmUpdateCheck)}}loadKeysHandler(e){var t,r;null===(r=this.extension)||void 0===r||null===(t=r.session)||void 0===t||t.loadKeys(e.keys,e.item)}beginNewBufferForItem(e,t,r){var n=this;return _async_to_generator$V((function*(){if(Ue.debug("creating new MseBuffer for item",t.mediaItem.title,e),n._buffer&&(Ue.debug("stopping old buffer"),n._buffer.stop()),n._buffer=new MseBuffer({dispatcher:n._dispatcher,element:n._targetElement,duration:t.mediaItem.playbackDuration/1e3,manifest:t}),yield n._playAssetURL(n._buffer.playableUrl,!0),!e){let e=Promise.resolve();return(null==r?void 0:r.startTime)&&(e=n.seekToTime(r.startTime)),e.then(()=>n._playMedia())}}))()}setPresentationMode(e){return _async_to_generator$V((function*(){return Promise.resolve()}))()}loadPreviewImage(e){return _async_to_generator$V((function*(){}))()}constructor(e){var t,r;super(e),_define_property$1c(this,"currentAudioTrack",void 0),_define_property$1c(this,"currentTextTrack",void 0),_define_property$1c(this,"textTracks",[]),_define_property$1c(this,"audioTracks",[]),_define_property$1c(this,"audio",void 0),_define_property$1c(this,"isSeamlessAudioTransitionsEnabled",!1),_define_property$1c(this,"delaySeamlessCdmUpdates",!1),_define_property$1c(this,"extension",void 0),_define_property$1c(this,"mediaPlayerType","audio"),_define_property$1c(this,"manifest",void 0),_define_property$1c(this,"nextManifest",void 0);const n=null!==(r=null===(t=e.bag)||void 0===t?void 0:t.features)&&void 0!==r?r:{};this.isSeamlessAudioTransitionsEnabled=!!n["seamless-audio-transitions"],this.delaySeamlessCdmUpdates=!!n["delay-seamless-cdm-updates"],window.audioPlayer=this,this._dispatcher.subscribe(Wr,this.onLoadSegmentError)}}function asyncGeneratorStep$U(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$U(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$U(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$U(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1b(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}_ts_decorate$q([Bind(),_ts_metadata$q("design:type",Function),_ts_metadata$q("design:paramtypes",[void 0]),_ts_metadata$q("design:returntype",void 0)],AudioPlayer.prototype,"onLoadSegmentError",null),_ts_decorate$q([AsyncDebounce(250),_ts_metadata$q("design:type",Function),_ts_metadata$q("design:paramtypes",[Number]),_ts_metadata$q("design:returntype",Promise)],AudioPlayer.prototype,"seekToTime",null),_ts_decorate$q([Bind(),_ts_metadata$q("design:type",Function),_ts_metadata$q("design:paramtypes",[]),_ts_metadata$q("design:returntype",void 0)],AudioPlayer.prototype,"onTimeUpdate",null),_ts_decorate$q([Bind(),_ts_metadata$q("design:type",Function),_ts_metadata$q("design:paramtypes",[]),_ts_metadata$q("design:returntype",void 0)],AudioPlayer.prototype,"delayedCdmUpdateCheck",null),_ts_decorate$q([Bind(),_ts_metadata$q("design:type",Function),_ts_metadata$q("design:paramtypes",[void 0]),_ts_metadata$q("design:returntype",void 0)],AudioPlayer.prototype,"loadKeysHandler",null);class EncryptedSession extends KeySession{attachMedia(e,t){var r=this;return _async_to_generator$U((function*(){r.keySystem=t.keySystem,r._keySystemAccess=t,e.addEventListener("encrypted",r.boundHandleSessionCreation,!1)}))()}detachMedia(e){e.removeEventListener("encrypted",this.boundHandleSessionCreation)}createSession(e){var t=this;return _async_to_generator$U((function*(){Ue.debug("Encrypted createSession",e);const r=t._keySystemAccess;if(!r)return;const{initData:n,initDataType:i,target:o}=e;var a;return t._mediaKeysPromise||(t._mediaKeysPromise=new Promise((a=_async_to_generator$U((function*(e,n){const i=yield r.createMediaKeys();try{yield o.setMediaKeys(i)}catch(De){t.dispatchKeyError(De),n(De)}const a=yield t.loadCertificateBuffer();yield i.setServerCertificate(a),t._mediaKeysServerCertificate=a,e(i)})),function(e,t){return a.apply(this,arguments)}))),yield t._mediaKeysPromise,t._mediaKeysServerCertificate?t._createSession(o,n,i):void 0}))()}generatePSSH(e){const t=new Uint8Array([0,0,0,52,112,115,115,104,0,0,0,0,237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237,0,0,0,20,8,1,18,16,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),r=o(e);for(let n=0;n<r.length;n++)t[t.length-16+n]=r[n];return Ue.debug("generatePSSH",t),t}_createSession(e,t,r){const n=e.mediaKeys.createSession(),{item:i}=this;if(!i)return;this._teardownCurrentSession(),Ue.debug("creating media key session",n);let o;if(this.isWidevine&&i.isSong)o=this.generatePSSH(this.extID);else{const e=function(e){const t=[],r=new DataView(e.buffer);for(let n=0;n<e.length;){const i=r.getUint32(n);t.push(new PsshBox(e,n,n+i)),n+=i}return t}(new Uint8Array(t)).find(e=>e.isWidevine),r=null==e?void 0:e.rawBytes,i=c(r);Ue.debug("extracted uri",i),n.extURI=i,o=t}return n.addEventListener("message",this.startLicenseSession),this._currentSession=n,n.generateRequest(r,o).catch(e=>{if(e.message.match(/generateRequest.*\(75\)/))return n.generateRequest(r,o);throw e})}_teardownCurrentSession(){this._currentSession&&(Ue.debug("tearing down media key session",this._currentSession),this._currentSession.removeEventListener("message",this.startLicenseSession),this._currentSession=void 0)}applyDelayedCdmUpdates(){}loadKeys(e,t,r){return _async_to_generator$U((function*(){}))()}clearSessions(){return _async_to_generator$U((function*(){}))()}constructor(...e){super(...e),_define_property$1b(this,"_currentSession",void 0),_define_property$1b(this,"_keySystemAccess",void 0),_define_property$1b(this,"_mediaKeysPromise",void 0),_define_property$1b(this,"_mediaKeysServerCertificate",void 0)}}function asyncGeneratorStep$T(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$T(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$T(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$T(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class MediaExtensionStub extends Notifications{destroy(e){}setMediaItem(e){}initializeKeySystem(){var e=this;return _async_to_generator$T((function*(){e.session=new EncryptedSession}))()}clearSessions(){return _async_to_generator$T((function*(){}))()}constructor(e){super(e),_define_property$1a(this,"audioTracks",[]),_define_property$1a(this,"textTracks",[]),_define_property$1a(this,"session",void 0),_define_property$1a(this,"extURI",void 0),_define_property$1a(this,"hasMediaKeySupport",void 0),_define_property$1a(this,"hasMediaSession",void 0),_define_property$1a(this,"initiated",void 0),_define_property$1a(this,"isFairplay",void 0),this.extURI="",this.hasMediaKeySupport=!0,this.initiated=!0,this.isFairplay=!0,this.hasMediaKeySupport=!0,this.hasMediaSession=!0}}function asyncGeneratorStep$S(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$S(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$S(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$S(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$19(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class PlayerStub{get hasMediaElement(){return!0}get isEngagedInPlayback(){return!this.paused}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._dispatcher.publish(rt.playbackRateDidChange,new Event("ratechange"))}get volume(){return this._volume}set volume(e){this._volume=e,this._dispatcher.publish(rt.playbackVolumeDidChange,new Event("volumeChange"))}destroy(){}dispatch(){}exitFullscreen(){return _async_to_generator$S((function*(){}))()}loadPreviewImage(e){return _async_to_generator$S((function*(){}))()}initialize(){return _async_to_generator$S((function*(){}))()}isPaused(){return this.paused}calculateTime(e){return e}clearNextManifest(){}mute(){}newSeeker(){return new PlayerSeeker(this)}pause(e){return _async_to_generator$S((function*(){}))()}play(){return _async_to_generator$S((function*(){}))()}playItemFromEncryptedSource(e,t,r){return _async_to_generator$S((function*(){}))()}playItemFromUnencryptedSource(e,t,r){return _async_to_generator$S((function*(){}))()}preload(){return _async_to_generator$S((function*(){}))()}seekToTime(e){return _async_to_generator$S((function*(){}))()}requestFullscreen(){return _async_to_generator$S((function*(){}))()}setPlaybackState(e,t){}setPresentationMode(e){return _async_to_generator$S((function*(){}))()}showPlaybackTargetPicker(){}stop(e){return _async_to_generator$S((function*(){}))()}stopMediaAndCleanup(){return _async_to_generator$S((function*(){}))()}supportsPictureInPicture(){return!1}tsidChanged(){}preloadItem(e,t){return _async_to_generator$S((function*(){}))()}constructor(t){_define_property$19(this,"bitrate",e.PlaybackBitrate.STANDARD),_define_property$19(this,"audioTracks",[]),_define_property$19(this,"currentBufferedProgress",0),_define_property$19(this,"currentPlaybackDuration",0),_define_property$19(this,"currentPlaybackProgress",0),_define_property$19(this,"currentPlaybackTime",0),_define_property$19(this,"currentPlaybackTimeRemaining",0),_define_property$19(this,"currentPlayingDate",void 0),_define_property$19(this,"isPlayingAtLiveEdge",!1),_define_property$19(this,"isPlaying",!1),_define_property$19(this,"isPrimaryPlayer",!0),_define_property$19(this,"isReady",!1),_define_property$19(this,"nowPlayingItem",void 0),_define_property$19(this,"paused",!1),_define_property$19(this,"playbackState",e.PlaybackStates.none),_define_property$19(this,"playbackTargetAvailable",!1),_define_property$19(this,"playbackTargetIsWireless",!1),_define_property$19(this,"previewOnly",!1),_define_property$19(this,"supportsPreviewImages",!1),_define_property$19(this,"textTracks",[]),_define_property$19(this,"extension",new MediaExtensionStub([])),_define_property$19(this,"hasAuthorization",!0),_define_property$19(this,"windowHandlers",void 0),_define_property$19(this,"isDestroyed",!1),_define_property$19(this,"services",void 0),_define_property$19(this,"_dispatcher",void 0),_define_property$19(this,"_volume",1),_define_property$19(this,"_playbackRate",1),_define_property$19(this,"currentAudioTrack",void 0),_define_property$19(this,"currentTextTrack",void 0),_define_property$19(this,"seekableTimeRanges",void 0),this.services=t.services,this._dispatcher=t.services.dispatcher,this.windowHandlers=new WindowHandlers(this,t.services.runtime)}}class VideoMediaExtension extends MediaExtension{destroy(e){var t;null===(t=this._session)||void 0===t||t.stopLicenseSession(),super.destroy(e)}}const tn=BooleanDevFlag.register("mk-send-manifest-headers");function asyncGeneratorStep$R(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$R(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$R(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$R(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$18(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const rn=["https://play.itunes.apple.com/","https://linear.tv.apple.com/","https://play-edge.itunes.apple.com"];const nn=new class{fetchManifest(e){var t=this;return _async_to_generator$R((function*(){return Ue.info("fetching manifest at",e),shouldLoadManifestOnce()?t.fetchForCache(e):t.fetchOnly(e)}))()}getManifest(e){return this.cache.get(e)}clear(e){e?this.cache.delete(e):this.cache.clear()}fetchForCache(e){var t=this;return _async_to_generator$R((function*(){const r=function(e){const t={};rn.some(t=>e.startsWith(t))&&Or.musicUserToken&&(!tn.configured||tn.enabled)&&(t["media-user-token"]=Or.musicUserToken,t.Authorization="Bearer "+Or.developerToken);return t}(e),n=yield t.fetch(e,{headers:new Headers(r)});let i=yield n.text();var o;i=((e,t)=>{Ue.info("converting manifest URIs to absolute paths");const r=new URL(e);let n=t.replace(/URI="([^"]*)"/g,(function(e,t){return`URI="${new URL(t,r).href}"`}));return n=n.replace(/^(#EXT-X-STREAM-INF:[^\n]*\n)(.*$)/gim,(function(e,t,n){return`${t}${new URL(n,r).href}`})),n})(e,i);const a={url:e,content:i,contentType:null!==(o=n.headers.get("content-type"))&&void 0!==o?o:void 0};return t.cache.set(e,a),a}))()}fetchOnly(e){var t=this;return _async_to_generator$R((function*(){const r=yield t.fetch(e),n=yield r.text();var i;return{url:e,content:n,contentType:null!==(i=r.headers.get("content-type"))&&void 0!==i?i:void 0}}))()}constructor(e={}){var t,r;_define_property$18(this,"cache",void 0),_define_property$18(this,"fetch",void 0),this.fetch=null!==(t=e.fetch)&&void 0!==t?t:fetch.bind(globalThis),this.cache=null!==(r=e.cache)&&void 0!==r?r:new Map}};function asyncGeneratorStep$Q(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$Q(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$Q(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$Q(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _ts_decorate$p(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$p(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const{mediaPlaybackError:on}=rt,{playbackLicenseError:an,playbackSessionError:sn}=Ge;class NativeSafariVideoPlayer extends VideoPlayer{get currentPlayingDate(){}get isPlayingAtLiveEdge(){return!1}get seekableTimeRanges(){return this.currentPlaybackDuration?[{start:0,end:this.currentPlaybackDuration}]:void 0}get supportsPreviewImages(){return!1}initializeExtension(){var e=this;return _async_to_generator$Q((function*(){if(!e.video)return void Ue.warn("NativeSafariVideoPlayer.initializeExtension No video element, not initializing extension");const t=new VideoMediaExtension(e.video,'video/mp4;codecs="avc1.42E01E"');e.extension=t,yield t.initializeKeySystem(),t.addEventListener(an,e.onPlaybackLicenseError),t.addEventListener(sn,e.onPlaybackSessionError)}))()}destroy(){Ue.debug("native-safari-video-player.destroy");const{extension:e,video:t}=this;this._blobUrl&&(URL.revokeObjectURL(this._blobUrl),this._blobUrl=void 0),e&&t&&(e.removeEventListener(an,this.onPlaybackLicenseError),e.removeEventListener(sn,this.onPlaybackSessionError),t.removeEventListener("loadedmetadata",this.onMetadataLoaded),super.destroy())}loadPreviewImage(e){return _async_to_generator$Q((function*(){}))()}preloadItem(e,t){return _async_to_generator$Q((function*(){}))()}playHlsStream(e,t,r={}){var n=this;return _async_to_generator$Q((function*(){Ue.debug("native-safari-video-player.playHlsStream",e);const{video:i}=n;if(!i){const e="NativeSafariVideoPlayer.playHlsStream(): No video element";throw Ue.error(e),new Error(e)}n.setupTrackManagers();const o=n.startPlaybackSequence(),a=(n._shouldLoadManifestsOnce?n.playByBlob(e,i,r):n.playBySource(e,i,r)).then(()=>o);var s;t&&(null===(s=n.extension)||void 0===s||s.setMediaItem(t));return i.addEventListener("loadedmetadata",n.onMetadataLoaded),a}))()}onPlaybackSessionError(e){this._dispatcher.publish(on,new MKError(MKError.Reason.MEDIA_SESSION,e))}onMetadataLoaded(){var e=this;return _async_to_generator$Q((function*(){Ue.debug("native-safari-video-player.onMetadataLoaded");const{nowPlayingItem:t}=e;t&&(t.state=y.ready),yield e._playMedia(),e.finishPlaybackSequence()}))()}seekToTime(e){var t=this;return _async_to_generator$Q((function*(){Ue.debug("native-safari-video-player: media element seek to",e),t._targetElement.currentTime=e}))()}playByBlob(e,t,r={}){var n=this;return _async_to_generator$Q((function*(){Ue.debug("native-safari-video-player: playing video by blob");let i=nn.getManifest(e);if(!i&&(Ue.debug("native-safari-video-player: fetching manifest"),i=yield nn.fetchManifest(e),!i))throw Ue.error("No manifest for "+e),new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"Failed to load manifest");Ue.debug("native-safari-video-player: loaded manifest",!!i),nn.clear(e);const o=i.contentType,a=i.content.replace(/^#EXT-X-SESSION-DATA-ITUNES:.*$/gm,""),s=new Blob([a],{type:o});e=URL.createObjectURL(s),n._blobUrl=e;const c=document.createElement("source");c.setAttribute("src",e),o&&c.setAttribute("type",o),Ue.debug("native-safari-video-player: blob url",e),void 0!==r.startTime&&(t.currentTime=r.startTime),t.appendChild(c)}))()}playBySource(e,t,r={}){return _async_to_generator$Q((function*(){Ue.debug("native-safari-video-player: playing video by source"),void 0!==r.startTime&&(e+="#t="+r.startTime),t.src=e}))()}constructor(...e){super(...e),function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"_blobUrl",void 0)}}_ts_decorate$p([Bind(),_ts_metadata$p("design:type",Function),_ts_metadata$p("design:paramtypes",[void 0]),_ts_metadata$p("design:returntype",void 0)],NativeSafariVideoPlayer.prototype,"onPlaybackSessionError",null),_ts_decorate$p([Bind(),_ts_metadata$p("design:type",Function),_ts_metadata$p("design:paramtypes",[]),_ts_metadata$p("design:returntype",Promise)],NativeSafariVideoPlayer.prototype,"onMetadataLoaded",null),_ts_decorate$p([AsyncDebounce(250),_ts_metadata$p("design:type",Function),_ts_metadata$p("design:paramtypes",[Number]),_ts_metadata$p("design:returntype",Promise)],NativeSafariVideoPlayer.prototype,"seekToTime",null);const cn=new RegExp("^https://([a-z0-9]+-)?"+("js-cdn.music.apple.com"+"/musickit/v3/".replace(/v3/,"(v2|v3)")).replace(/[\.\/]/g,"\\$&"),"i"),ln=/^https:\/\/(.*\/includes\/js-cdn)\//i,dn=/^([a-z]+:)?\/\//;function findScript(e){return isNodeEnvironment$1()||!e?null:document.querySelector(`script[src*="${e}"]`)}function getScriptSrcElements(){if("undefined"==typeof document||!document.querySelectorAll)return[];return Array.from(document.querySelectorAll("script[src]"))}function determineCdnBaseHost(){if(isNodeEnvironment$1())return"";return`//${function(){for(const e of getScriptSrcElements()){const t=cn.exec(e.src);if(t)return t[1]||""}return""}()}js-cdn.music.apple.com`}function determineCdnPathHost(){const e=function(){for(const e of getScriptSrcElements()){const t=ln.exec(e.src);if(t)return t[1]||""}return""}();return e?"//"+e:e}const un=StringDevFlag.register("mk-hlsjs-log-level"),pn=StringDevFlag.register("mk-hlsjs-version");function getHlsJsCdnConfig(){const e={hls:"",rtc:""};if(isNodeEnvironment$1())return e;const t=determineCdnPathHost()||determineCdnBaseHost(),r=pn.get()||"2.910.1",n=function(){const e=un.value;switch(e){case"info":case"error":case"warn":return"hls.production.verbose.min.js";case"trace":case"debug":return console.warn(`HLS log level ${e} is not supported, loading production build.`),"hls.js";default:return"hls.js"}}();return e.hls=`https:${t}/hls.js/${r}/hls.js/${n}`,e.rtc=`https:${t}/hls.js/${r}/rtc.js/rtc.min.js`,e}function cdnBaseURL(e,t=window){var r;if(isNodeEnvironment$1())return"";const n=null===(r=getLocalStorage())||void 0===r?void 0:r.getItem("mkCDNBaseURLOverride");if(n)return n;const i=findScript(e);return i?i.getAttribute("src").replace(new RegExp(e+"$"),""):(determineCdnPathHost()||determineCdnBaseHost())+"/musickit/v3/"}const hn=new Map;function loadScript(e,t){const r=hn.get(e);if(r)return r;const n=new Promise((r,n)=>{isNodeEnvironment$1()&&n("Dynamic script loading is unsupported in Node environments.");if(findScript(e))return r();const i=document.createElement("script");let o;if(t&&Object.keys(t).forEach(e=>{i.setAttribute(e,t[e])}),i.onload=()=>{r()},i.onerror=e=>{n(e)},dn.test(e))o=e;else{o=`${cdnBaseURL(e)}${e}`}i.src=o,document.head.appendChild(i)});return hn.set(e,n),n}const yn=Ue.createChild("tracks");function _define_property$16(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$E(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$16(e,t,r[t])}))}return e}function _object_spread_props$o(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _ts_decorate$o(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$o(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const{audioTracksSwitched:fn,audioTracksUpdated:_n,inlineStylesParsed:vn,textTracksSwitched:mn,textTracksUpdated:gn}=Ge;class HlsJsTracks extends Notifications{get isDestroyed(){return this._isDestroyed}get audioTracks(){return this._audioTracks}get textTracks(){return this._textTracks}set audioTrack(e){this.session&&e&&void 0!==e.id&&(this.session.audioSelectedPersistentID=e.id)}set textTrack(e){var t;this.session.subtitleSelectedPersistentID=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:-1}selectForcedTrack(){const{session:e}=this;if(!(null==e?void 0:e.audioTracks))return;const t=e.audioTracks.filter(t=>t.persistentID===e.audioSelectedPersistentID),r=t&&t.length&&t[0];if(!r)return;const n=e.subtitleMediaOptions.filter(e=>0===e.MediaSelectionOptionsDisplaysNonForcedSubtitles&&e.MediaSelectionOptionsExtendedLanguageTag===r.lang),i=null==n?void 0:n[0];let o;return i?(yn.debug("hlsjsTracks: found forced track for "+i.MediaSelectionOptionsExtendedLanguageTag),e.subtitleSelectedPersistentID=i.MediaSelectionOptionsPersistentID,o=this.normalizeTextTrack(i)):e.subtitleSelectedPersistentID=-1,o}audioTracksUpdated(e,t){const r=(t&&t.audioMediaSelectionGroup&&t.audioMediaSelectionGroup.MediaSelectionGroupOptions||[]).map(this.normalizeAudioTrack,this);this._audioTracks=r,this.dispatchEvent(_n,r)}handleAudioTrackSwitched(){this.dispatchEvent(fn,{selectedId:this.session.audioSelectedPersistentID})}handleInlineStylesParsed(e,t){this.dispatchEvent(vn,t)}handleManifestLoaded(e,t){this.audioTracksUpdated(e,t),this.subtitleTracksUpdated(e,t)}handleSessionDataComplete(e,t){var r;null==t||null===(r=t.itemList)||void 0===r||r.forEach(e=>{if("_hls.localized-rendition-names"===e["DATA-ID"]&&e.VALUE)try{this._localizedRenditionNames=JSON.parse(e.VALUE),this._audioTracks.forEach(e=>{var t;const r=null===(t=this._localizedRenditionNames)||void 0===t?void 0:t[e.label];r&&(e.localizedRenditionNames=r)}),this.dispatchEvent(_n,this._audioTracks)}catch(t){return void yn.error("Failed to parse _hls.localized-rendition-names",t)}})}handleSubtitleTrackSwitch(e,t){this.dispatchEvent(mn,t)}subtitleTracksUpdated(e,t){const r=t&&t.subtitleMediaSelectionGroup&&t.subtitleMediaSelectionGroup.MediaSelectionGroupOptions||[],n=[];r.forEach(e=>{0!==e.MediaSelectionOptionsDisplaysNonForcedSubtitles&&n.push(this.normalizeTextTrack(e))}),this._textTracks=n,this.dispatchEvent(gn,n)}normalizeAudioTrack(e){const t=e.MediaSelectionOptionsTaggedMediaCharacteristics,r=(null!=t?t:[]).includes("public.accessibility.describes-video")?"description":"main";return _object_spread_props$o(_object_spread$E({},this.normalizeSelectionOption(e)),{enabled:!1,kind:r,characteristics:t})}normalizeTextTrack(e){var t;let r;return r=(null===(t=e.MediaSelectionOptionsTaggedMediaCharacteristics)||void 0===t?void 0:t.includes("public.accessibility.describes-music-and-sound"))||"clcp"===e.MediaSelectionOptionsMediaType?"captions":"subtitles",_object_spread_props$o(_object_spread$E({},this.normalizeSelectionOption(e)),{mode:"disabled",kind:r})}normalizeSelectionOption(e){return{id:e.MediaSelectionOptionsPersistentID,label:e.MediaSelectionOptionsName,language:e.MediaSelectionOptionsExtendedLanguageTag}}destroy(){this._isDestroyed=!0;const{MANIFEST_LOADED:e,AUDIO_TRACK_SWITCHED:t,SUBTITLE_TRACK_SWITCH:r,INLINE_STYLES_PARSED:n,SESSION_DATA_COMPLETE:i}=window.Hls.Events;this.session.off(e,this.handleManifestLoaded),this.session.off(t,this.handleAudioTrackSwitched),this.session.off(r,this.handleSubtitleTrackSwitch),this.session.off(n,this.handleInlineStylesParsed),this.session.off(i,this.handleSessionDataComplete)}constructor(e){super([fn,_n,vn,mn,gn]),_define_property$16(this,"session",void 0),_define_property$16(this,"_audioTracks",void 0),_define_property$16(this,"_textTracks",void 0),_define_property$16(this,"_localizedRenditionNames",void 0),_define_property$16(this,"_isDestroyed",void 0),this.session=e,this._audioTracks=[],this._textTracks=[],this._isDestroyed=!1;const{MANIFEST_LOADED:t,AUDIO_TRACK_SWITCHED:r,SUBTITLE_TRACK_SWITCH:n,INLINE_STYLES_PARSED:i,SESSION_DATA_COMPLETE:o}=window.Hls.Events;this.session.on(t,this.handleManifestLoaded),this.session.on(r,this.handleAudioTrackSwitched),this.session.on(n,this.handleSubtitleTrackSwitch),this.session.on(i,this.handleInlineStylesParsed),this.session.on(o,this.handleSessionDataComplete)}}function _define_property$15(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}_ts_decorate$o([Bind(),_ts_metadata$o("design:type",Function),_ts_metadata$o("design:paramtypes",[]),_ts_metadata$o("design:returntype",void 0)],HlsJsTracks.prototype,"handleAudioTrackSwitched",null),_ts_decorate$o([Bind(),_ts_metadata$o("design:type",Function),_ts_metadata$o("design:paramtypes",[void 0,void 0]),_ts_metadata$o("design:returntype",void 0)],HlsJsTracks.prototype,"handleInlineStylesParsed",null),_ts_decorate$o([Bind(),_ts_metadata$o("design:type",Function),_ts_metadata$o("design:paramtypes",[void 0,void 0]),_ts_metadata$o("design:returntype",void 0)],HlsJsTracks.prototype,"handleManifestLoaded",null),_ts_decorate$o([Bind(),_ts_metadata$o("design:type",Function),_ts_metadata$o("design:paramtypes",[void 0,void 0]),_ts_metadata$o("design:returntype",void 0)],HlsJsTracks.prototype,"handleSessionDataComplete",null),_ts_decorate$o([Bind(),_ts_metadata$o("design:type",Function),_ts_metadata$o("design:paramtypes",[void 0,void 0]),_ts_metadata$o("design:returntype",void 0)],HlsJsTracks.prototype,"handleSubtitleTrackSwitch",null);class HlsJsPreviewImageLoader{loadPreviewImage(e){return this.lastPosition===e||(this.lastPosition=e,this.lastPromise=new Promise((t,r)=>{this.hls.loadImageIframeData$(e).subscribe(e=>{const{data:r}=e,n=new Blob([r],{type:"image/jpeg"});t(n)})})),this.lastPromise}constructor(e){_define_property$15(this,"hls",void 0),_define_property$15(this,"lastPosition",void 0),_define_property$15(this,"lastPromise",void 0),this.hls=e}}function asyncGeneratorStep$P(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$P(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$P(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$P(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$14(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$n(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$n(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const bn={bufferStalledError:"bufferStalledError",keySystemGenericError:"keySystemGenericError"};var Sn;!function(e){e.Seek="Seek",e.HighBuffer="HighBuffer",e.LowBuffer="LowBuffer"}(Sn||(Sn={}));const Pn=new Set([MKError.Reason.DEVICE_LIMIT,MKError.Reason.GEO_BLOCK,MKError.Reason.WIDEVINE_CDM_EXPIRED]),En={};En[Fe.FAIRPLAY]="fairplaystreaming",En[Fe.PLAYREADY]="playready",En[Fe.WIDEVINE]="widevine";const Tn=BooleanDevFlag.get("mk-block-report-cdn-server"),kn=BooleanDevFlag.get("mk-hlsjs-item-preloading"),wn=JsonDevFlag.register("mk-hlsjs-config-overrides");class HlsJsVideoPlayer extends VideoPlayer{get shouldDispatchErrors(){return!this.userInitiated||this._playbackDidStart}get supportsPreviewImages(){var e,t;return!this.services.runtime.isMobile&&(null===(t=this._hls)||void 0===t||null===(e=t.iframeVariants)||void 0===e?void 0:e.some(e=>"mjpg"===e.imageCodec))}get currentPlayingDate(){var e;return null===(e=this._hls)||void 0===e?void 0:e.playingDate}get isPlayingAtLiveEdge(){var e;const t=this._hls;return!(!t||!(null===(e=this.nowPlayingItem)||void 0===e?void 0:e.isLinearStream))&&!!t.isPlayingAtLive}get seekableTimeRanges(){const e=this._hls;return e?e.seekableTimeRanges:this.currentPlaybackDuration?[{start:0,end:this.currentPlaybackDuration}]:void 0}initializeExtension(){var e=this;return _async_to_generator$P((function*(){e._keySystem=yield findKeySystemPreference(e.services.runtime);try{var t;if(!Ke.urls.hls)throw new Error("bag.urls.hls is not configured");yield Promise.all([loadScript(Ke.urls.hls),null===(t=e._rtcTracker)||void 0===t?void 0:t.loadScript()])}catch(r){throw Ue.error("hlsjs-video-player failed to load script "+Ke.urls.hls,r),r}}))()}destroy(){var e;if(Ue.debug("hlsjs-video-player.destroy"),null===(e=this._hlsJsTracks)||void 0===e||e.destroy(),this._hls){const{DATERANGE_UPDATED:e,ERROR:t,INTERNAL_ERROR:r,MANIFEST_PARSED:n,KEY_REQUEST_STARTED:i,LICENSE_CHALLENGE_CREATED:o,LEVEL_SWITCHED:a,UNRESOLVED_URI_LOADING:s}=window.Hls.Events,c=this._hls;c.stopLoad(),c.detachMedia(),c.off(t,this.handleHlsError),c.off(r,this.handleHlsError),c.off(n,this.handleManifestParsed),c.off(i,this.handleKeyRequestStarted),c.off(o,this.handleLicenseChallengeCreated),c.off(a,this.handleLevelSwitched),c.off(e,this.handleDaterangeUpdated),this._shouldLoadManifestsOnce&&c.off(s,this.handleUnresolvedUriLoading),c.destroy(),window.hlsSession=void 0}super.destroy(),asAsync(this._license.stop())}playHlsStream(e,t,r={}){var n=this;return _async_to_generator$P((function*(){Ue.debug("hlsjs-video-player.playHlsStream",e,t);const{_keySystem:i}=n;if(!i)return;let o,a;n._unrecoverableError=void 0,n.createHlsPlayer();const hasKey=(e,t)=>{var r;return void 0!==(null==t||null===(r=t.keyURLs)||void 0===r?void 0:r[e])};i===Fe.WIDEVINE&&hasKey("widevine-cert-url",t)&&(o="WIDEVINE_SOFTWARE",a={initDataTypes:["cenc","keyids"],distinctiveIdentifier:"optional",persistentState:"required"});const s={itemId:null==t?void 0:t.id,subs:"accepts-css",platformInfo:{requiresCDMAttachOnStart:i!==Fe.NONE,maxSecurityLevel:o,keySystemConfig:a},appData:{serviceName:Ke.app.name}},{_rtcTracker:c,_hls:l}=n;if(c){const e=c.prepareReportingAgent(t);void 0!==e&&(s.appData.reportingAgent=e)}Ue.debug("RTC: loadSource with load options",s);const d=n.startPlaybackSequence();return n._shouldLoadManifestsOnce&&(e=e.replace("https://","manifest://"),Ue.info("Manifest already loaded, passing url to HLSJS",e)),l.loadSource(e,s,r.startTime),l.attachMedia(n.video),t&&(n._licenseServerUrl=t.keyURLs["hls-key-server-url"],i===Fe.FAIRPLAY&&hasKey("hls-key-cert-url",t)?l.setProtectionData({fairplaystreaming:{serverCertUrl:t.keyURLs["hls-key-cert-url"]}}):hasKey("widevine-cert-url",t)&&l.setProtectionData({widevine:{serverCertUrl:t.keyURLs["widevine-cert-url"]}})),d}))()}preloadItem(e,t){var r=this;return _async_to_generator$P((function*(){if(Ue.trace("preloadItem",e,t),!0===kn){const n=generateAssetUrl(e,t);Ue.debug(`Prefetching HLS source for item "${e.id}" with license URL "${n}"`),r._hls.prefetchSource(n,{itemId:e.id})}}))()}createHlsPlayer(){const{_keySystem:e}=this,{Hls:t}=window,r=un.get(),{os:n}=this.services.runtime,i={clearMediaKeysOnPromise:!1,customTextTrackCueRenderer:!0,debug:!!r,debugLevel:r,enableItemPreloading:!0===kn,enableIFramePreloading:!1,enablePerformanceLogging:!!r,enablePlayReadyKeySystem:!0,enableQueryParamsForITunes:!this._shouldLoadManifestsOnce,enableRtcReporting:void 0!==this._rtcTracker,keySystemPreference:En[e],useMediaKeySystemAccessFilter:!0,maintainMediaKeysBetweenSessions:!1,nativeControlsEnabled:n.isAndroid,enableContentSteering:!0,allowFastSwitchUp:!0,liveAllowLowLatencyPlayback:!0};(e=>{const{Hls:t}=window;if(t&&Tn){const r=deepClone(t.DefaultConfig.fragLoadPolicy);r.default.reportCDNServer=!1,r.customURL.reportCDNServer=!1,e.fragLoadPolicy=r}})(i),(e=>{const t=wn.value;t&&"object"==typeof t&&Object.assign(e,t)})(i);const o=new t(i),{ERROR:a,INTERNAL_ERROR:s,MANIFEST_PARSED:c,KEY_REQUEST_STARTED:l,LICENSE_CHALLENGE_CREATED:d,LEVEL_SWITCHED:u,UNRESOLVED_URI_LOADING:p,DATERANGE_UPDATED:h}=t.Events;o.on(a,this.handleHlsError),o.on(s,this.handleHlsError),o.on(c,this.handleManifestParsed),o.on(l,this.handleKeyRequestStarted),o.on(d,this.handleLicenseChallengeCreated),o.on(u,this.handleLevelSwitched),o.on(h,this.handleDaterangeUpdated),this._shouldLoadManifestsOnce&&o.on(p,this.handleUnresolvedUriLoading),this._hls=o,window.hlsSession=o,this._hlsJsTracks=new HlsJsTracks(this._hls),this.setupTrackManagers(this._hlsJsTracks),this._hlsPreviewImageLoader=new HlsJsPreviewImageLoader(this._hls)}handleUnresolvedUriLoading(e,t){var r=this;return _async_to_generator$P((function*(){const e=r._hls,n=t.uri,i=n.replace("manifest://","https://");var o;Ue.debug("handleUnresolvedUriLoading for uri ",n);const a=null!==(o=nn.getManifest(i))&&void 0!==o?o:yield nn.fetchManifest(i);a?(nn.clear(i),e.off(window.Hls.Events.UNRESOLVED_URI_LOADING,r.handleUnresolvedUriLoading),e.handleResolvedUri(n,{url:i,status:200,data:a.content})):Ue.error("No cached manifest for "+i)}))()}handleLevelSwitched(e,t){var r,n;const{level:i}=t;if(!i)return;const o=null===(r=this._levels)||void 0===r?void 0:r.find(e=>e.persistentId===i);if(!o||(null===(n=this._currentLevel)||void 0===n?void 0:n.persistentId)===(null==o?void 0:o.persistentId))return;this._currentLevel=o;const a=void 0!==o.audioGroupId?this._channelsByGroup[o.audioGroupId]:void 0;this._dispatcher.publish(et.hlsLevelUpdated,{level:o,channels:a})}handleDaterangeUpdated(e,t){Ue.info("handleDaterangeUpdated",JSON.stringify(t)),this._dispatcher.publish(rt.hlsDaterangeUpdated,t)}handleHlsError(e,t){var r;if(Ue.warn("HLS.js error",JSON.stringify(t)),this._unrecoverableError)return;let n=new MKError(MKError.Reason.UNSUPPORTED_ERROR,t.reason);n.data=t;const{bufferStalledError:i,keySystemGenericError:o}=bn;if(t.details===o)return void this._dispatcher.publish(o,n);let a=!1;var s;t.details===i&&"Seek"===t.stallType&&-12909===(null===(r=t.response)||void 0===r?void 0:r.code)&&(n=new MKError(MKError.Reason.BUFFER_STALLED_ERROR,t.stallType),n.data={stallType:t.stallType,code:null===(s=t.response)||void 0===s?void 0:s.code},a=!0);if("output-restricted"===t.reason&&(n=new MKError(MKError.Reason.OUTPUT_RESTRICTED,t.reason)),t.fatal){if(this._hls.destroy(),!this.shouldDispatchErrors&&!a)throw n;this._dispatcher.publish(rt.mediaPlaybackError,n)}}handleManifestParsed(e,t){var r=this;return _async_to_generator$P((function*(){var e,n;let i;Ue.debug("handleManifestParsed",t),r._levels=null!==(e=t.levels)&&void 0!==e?e:[],r.nowPlayingItem.state=y.ready,r._channelsByGroup=(null!==(n=t.audioTracks)&&void 0!==n?n:[]).reduce((e,t)=>(e[t.groupId]=t.channels,e),{});try{yield r._playMedia()}catch(o){throw Ue.warn("error from media element, possibly non-fatal",o),o}finally{i=yield r.finishPlaybackSequence()}return i}))()}handleKeyRequestStarted(e,t){Ue.debug("hlsjs-video.handleKeyRequestStarted"),this._hls.generateKeyRequest(t.keyuri,{})}handleLicenseChallengeCreated(e,t){var r=this;return _async_to_generator$P((function*(){Ue.trace("handleLicenseChallengeCreated",t);const{_licenseServerUrl:e,nowPlayingItem:n,_keySystem:i,userInitiated:a}=r;try{var s;const c=yield null===(s=r._license)||void 0===s?void 0:s.start(e,n,t,i,a),l={statusCode:c.status};(null==c?void 0:c.license)&&(i===Fe.FAIRPLAY?l.ckc=o(c.license):l.license=o(c.license));const d=c["renew-after"];d&&(l.renewalDate=new Date(Date.now()+1e3*d)),r._hls.setLicenseResponse(t.keyuri,l)}catch(De){if(r._unrecoverableError)return;const n=De.data,i={};void 0!==(null==n?void 0:n.status)&&(i.statusCode=+n.status),Ue.warn("Passing license response error to Hls.js",i),r._hls.setLicenseResponse(t.keyuri,i),MKError.isMKError(De)&&Pn.has(De.reason)&&(r._unrecoverableError=De,r.resetDeferredPlay(),yield r.stop({endReasonType:ot.FAILED_TO_LOAD,userInitiated:a})),r.onPlaybackLicenseError(De)}}))()}seekToTime(e){var t=this;return _async_to_generator$P((function*(){t._hls?(Ue.debug("hlsjs-video: hls seekTo",e),t._hls.seekTo=e):(Ue.debug("hlsjs-video: media element seek to",e),t._targetElement.currentTime=e)}))()}loadPreviewImage(e){var t=this;return _async_to_generator$P((function*(){var r;return null===(r=t._hlsPreviewImageLoader)||void 0===r?void 0:r.loadPreviewImage(e)}))()}constructor(e){var t;super(e),_define_property$14(this,"_hls",void 0),_define_property$14(this,"_hlsPreviewImageLoader",void 0),_define_property$14(this,"_hlsJsTracks",void 0),_define_property$14(this,"_keySystem",void 0),_define_property$14(this,"_license",void 0),_define_property$14(this,"_rtcTracker",void 0),_define_property$14(this,"_levels",void 0),_define_property$14(this,"_channelsByGroup",{}),_define_property$14(this,"_currentLevel",void 0),_define_property$14(this,"_licenseServerUrl",void 0),_define_property$14(this,"_unrecoverableError",void 0),this._rtcTracker=null==e||null===(t=e.playbackServices)||void 0===t?void 0:t.getRTCStreamingTracker(),this._license=new License}}var On;_ts_decorate$n([Bind(),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[String,"undefined"==typeof HlsUnresolvedUriData?Object:HlsUnresolvedUriData]),_ts_metadata$n("design:returntype",Promise)],HlsJsVideoPlayer.prototype,"handleUnresolvedUriLoading",null),_ts_decorate$n([Bind(),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[void 0,void 0]),_ts_metadata$n("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleLevelSwitched",null),_ts_decorate$n([Bind(),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[String,"undefined"==typeof HlsDaterangeUpdatedData?Object:HlsDaterangeUpdatedData]),_ts_metadata$n("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleDaterangeUpdated",null),_ts_decorate$n([Bind(),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[void 0,void 0]),_ts_metadata$n("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleHlsError",null),_ts_decorate$n([Bind(),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[void 0,void 0]),_ts_metadata$n("design:returntype",Promise)],HlsJsVideoPlayer.prototype,"handleManifestParsed",null),_ts_decorate$n([Bind(),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[void 0,void 0]),_ts_metadata$n("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleKeyRequestStarted",null),_ts_decorate$n([Bind(),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[void 0,void 0]),_ts_metadata$n("design:returntype",Promise)],HlsJsVideoPlayer.prototype,"handleLicenseChallengeCreated",null),_ts_decorate$n([AsyncDebounce(250),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[Number]),_ts_metadata$n("design:returntype",Promise)],HlsJsVideoPlayer.prototype,"seekToTime",null),_ts_decorate$n([(On=250,(e,t,r)=>{const n=function(e,t){let r,n,i=0;const resetState=()=>{clearTimeout(n),n=0,r=void 0};return function(...o){const a=this;return new Promise((function(s,c){const l=Date.now();l-i<t?(r&&(r.resolve(void 0),resetState()),r={resolve:s,reject:c,args:o},n=setTimeout(()=>{e.apply(a,r.args).then(r.resolve).catch(r.reject),resetState()},t-(l-i+1))):(resetState(),i=l,e.apply(a,o).then(s).catch(c))}))}}(r.value,On);r.value=n}),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[Number]),_ts_metadata$n("design:returntype",Promise)],HlsJsVideoPlayer.prototype,"loadPreviewImage",null),e.version="3.2450.4";const In=e.version.split("."),An=In[0],Rn=In[In.length-1];var $n,Cn;In[0]="3",In[In.length-1]=Rn+"-prerelease",In[0]=An,In[In.length-1]=Rn,e.version=In.join("."),function(e){e.REPEAT="REPEAT",e.SHUFFLE="SHUFFLE",e.AUTOPLAY="AUTOPLAY"}($n||($n={})),e.PlaybackMode=void 0,(Cn=e.PlaybackMode||(e.PlaybackMode={}))[Cn.PREVIEW_ONLY=0]="PREVIEW_ONLY",Cn[Cn.MIXED_CONTENT=1]="MIXED_CONTENT",Cn[Cn.FULL_PLAYBACK_ONLY=2]="FULL_PLAYBACK_ONLY",Cn[Cn.SHAREPLAY_PARTICIPANT=3]="SHAREPLAY_PARTICIPANT";const Dn={configured:"musickitconfigured",loaded:"musickitloaded",audioTrackAdded:rt.audioTrackAdded,audioTrackChanged:rt.audioTrackChanged,audioTrackRemoved:rt.audioTrackRemoved,authorizationStatusDidChange:pe.authorizationStatusDidChange,authorizationStatusWillChange:pe.authorizationStatusWillChange,bufferedProgressDidChange:rt.bufferedProgressDidChange,capabilitiesChanged:"capabilitiesChanged",autoplayEnabledDidChange:"autoplayEnabledDidChange",drmUnsupported:rt.drmUnsupported,eligibleForSubscribeView:pe.eligibleForSubscribeView,forcedTextTrackChanged:rt.forcedTextTrackChanged,hlsDaterangeUpdated:rt.hlsDaterangeUpdated,mediaCanPlay:rt.mediaCanPlay,mediaElementCreated:rt.mediaElementCreated,mediaItemStateDidChange:Se.mediaItemStateDidChange,mediaItemStateWillChange:Se.mediaItemStateWillChange,mediaPlaybackError:rt.mediaPlaybackError,mediaSkipAvailable:"mediaSkipAvailable",mediaRollEntered:"mediaRollEntered",mediaUpNext:"mediaUpNext",metadataDidChange:rt.metadataDidChange,needsGDPRDidChange:"needsGDPRDidChange",nowPlayingItemDidChange:rt.nowPlayingItemDidChange,nowPlayingItemWillChange:rt.nowPlayingItemWillChange,playInitiated:"playInitiated",playbackBitrateDidChange:rt.playbackBitrateDidChange,playbackDurationDidChange:rt.playbackDurationDidChange,playbackProgressDidChange:rt.playbackProgressDidChange,playbackRateDidChange:rt.playbackRateDidChange,playbackStateDidChange:rt.playbackStateDidChange,playbackStateWillChange:rt.playbackStateWillChange,playbackTargetAvailableDidChange:rt.playbackTargetAvailableDidChange,playbackTargetIsWirelessDidChange:rt.playbackTargetIsWirelessDidChange,playbackTimeDidChange:rt.playbackTimeDidChange,playbackVolumeDidChange:rt.playbackVolumeDidChange,playerTypeDidChange:rt.playerTypeDidChange,presentationModeDidChange:rt.presentationModeDidChange,primaryPlayerDidChange:rt.primaryPlayerDidChange,queueIsReady:"queueIsReady",queueItemsDidChange:"queueItemsDidChange",queueItemForStartPosition:"queueItemForStartPosition",queuePositionDidChange:"queuePositionDidChange",shuffleModeDidChange:"shuffleModeDidChange",repeatModeDidChange:"repeatModeDidChange",storefrontCountryCodeDidChange:pe.storefrontCountryCodeDidChange,storefrontIdentifierDidChange:pe.storefrontIdentifierDidChange,textTrackAdded:rt.textTrackAdded,textTrackChanged:rt.textTrackChanged,textTrackRemoved:rt.textTrackRemoved,timedMetadataDidChange:rt.timedMetadataDidChange,userTokenDidChange:pe.userTokenDidChange,webComponentsLoaded:"musickitwebcomponentsloaded"};function parseSkipItems(e){const t=parseInt(e.hlsMetadata["skip.count"],10),r=[];if(isNaN(t)||0===t)return r;for(let n=0;n<t;n++){const t={start:parseFloat(e.hlsMetadata[`skip.${n}.start`]),duration:parseFloat(e.hlsMetadata[`skip.${n}.duration`]),target:parseFloat(e.hlsMetadata[`skip.${n}.target`]),label:e.hlsMetadata[`skip.${n}.label`]};void 0!==e.hlsMetadata[`skip.${n}.promo.enabled`]&&(t.promo={enabled:"true"===e.hlsMetadata[`skip.${n}.promo.enabled`],image:e.hlsMetadata[`skip.${n}.promo.image`],"image-height":parseInt(e.hlsMetadata[`skip.${n}.promo.image-height`],10),"image-width":parseInt(e.hlsMetadata[`skip.${n}.promo.image-width`],10),genre:e.hlsMetadata[`skip.${n}.promo.genre`],"release-year":parseInt(e.hlsMetadata[`skip.${n}.promo.release-year`],10),"rating-display-name":e.hlsMetadata[`skip.${n}.promo.rating-display-name`],"rating-system":e.hlsMetadata[`skip.${n}.promo.rating-system`],"canonical-id":e.hlsMetadata[`skip.${n}.promo.canonical-id`],title:e.hlsMetadata[`skip.${n}.promo.title`],"rating-tag":e.hlsMetadata[`skip.${n}.promo.rating-tag`],"rating-rank":e.hlsMetadata[`skip.${n}.promo.rating-rank`],"up-next":{"is-added":"true"===e.hlsMetadata[`skip.${n}.promo.up-next.is-added`],"add-label":e.hlsMetadata[`skip.${n}.promo.up-next.add-label`],"added-label":e.hlsMetadata[`skip.${n}.promo.up-next.added-label`]},runtime:parseInt(e.hlsMetadata[`skip.${n}.promo.runtime`],10)}),r.push(t)}return r}function parseRollItems(e,t=["pre-roll","mid-roll","post-roll"]){if(void 0===e.hlsMetadata)return[];const r=[];return t.forEach(t=>{const n=parseInt(e.hlsMetadata[t+".count"],10);if(!isNaN(n))for(let i=0;i<n;i++){const n=`${t}.${i}`,o={index:i,type:t,skippable:"true"===e.hlsMetadata[n+".skippable"],"adam-id":e.hlsMetadata[n+".adam-id"],start:Math.round(parseFloat(e.hlsMetadata[n+".start"])),duration:Math.round(parseFloat(e.hlsMetadata[n+".duration"]))},a=n+".dynamic-slot.data-set-id";void 0!==e.hlsMetadata[a]&&(o["dynamic-id"]=e.hlsMetadata[a]),r.push(o)}}),r}const addRollItemDuration=(e,t)=>e+t.duration;function asyncGeneratorStep$O(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _define_property$13(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_metadata$m(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}class SpanWatcher{startMonitor(){this.dispatcher.unsubscribe(Dn.playbackTimeDidChange,this.handleTimeChange),this.dispatcher.subscribe(Dn.playbackTimeDidChange,this.handleTimeChange)}stopMonitor(){this.dispatcher.unsubscribe(Dn.playbackTimeDidChange,this.handleTimeChange)}handleTimeChange(e,{currentPlaybackTime:t}){var r,n=this;return(r=function*(){!Number.isFinite(t)||t<n.start||t>n.stop?n.inWatchSpan=!1:n.inWatchSpan||(n.allowMultiple||n.stopMonitor(),n.inWatchSpan=!0,yield n.callback(t,n))},function(){var e=this,t=arguments;return new Promise((function(n,i){var o=r.apply(e,t);function _next(e){asyncGeneratorStep$O(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$O(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}constructor(e,t,r,n,i=!1){_define_property$13(this,"dispatcher",void 0),_define_property$13(this,"callback",void 0),_define_property$13(this,"start",void 0),_define_property$13(this,"stop",void 0),_define_property$13(this,"allowMultiple",void 0),_define_property$13(this,"inWatchSpan",void 0),this.dispatcher=e,this.callback=t,this.start=r,this.stop=n,this.allowMultiple=i,this.inWatchSpan=!1}}function _define_property$12(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_metadata$l(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$m("design:type",Function),_ts_metadata$m("design:paramtypes",[void 0,void 0]),_ts_metadata$m("design:returntype",Promise)],SpanWatcher.prototype,"handleTimeChange",null);class PlaybackMonitor{activate(){this.isActive=!0,this.startMonitor()}deactivate(){this.isActive=!1,this.clearMonitor()}clearMonitor(){this.isMonitoring&&(this.watchers.forEach(e=>e.stopMonitor()),this.isMonitoring=!1)}shouldMonitor(){return this.isActive}startMonitor(){this.shouldMonitor()&&(this.watchers.forEach(e=>e.startMonitor()),this.isMonitoring=!0)}handleMediaItemChange(){this.isActive&&(this.clearMonitor(),this.shouldMonitor()&&this.startMonitor())}constructor(e){_define_property$12(this,"isActive",!1),_define_property$12(this,"isMonitoring",!1),_define_property$12(this,"apiManager",void 0),_define_property$12(this,"dispatcher",void 0),_define_property$12(this,"playbackController",void 0),_define_property$12(this,"watchers",[]),this.handlePlaybackThreshold=this.handlePlaybackThreshold.bind(this),this.playbackController=e.controller,this.dispatcher=e.services.dispatcher,this.dispatcher.subscribe(Dn.nowPlayingItemDidChange,this.handleMediaItemChange),this.apiManager=e.services.apiManager}}function asyncGeneratorStep$N(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$l("design:type",Function),_ts_metadata$l("design:paramtypes",[]),_ts_metadata$l("design:returntype",void 0)],PlaybackMonitor.prototype,"handleMediaItemChange",null);class RollMonitor extends PlaybackMonitor{handlePlaybackThreshold(e,t){var r,n=this;return(r=function*(){if(!n.rollMap.has(t))return;const e=n.rollMap.get(t);n.dispatcher.publish(Dn.mediaRollEntered,e),n.rollMap.delete(t)},function(){var e=this,t=arguments;return new Promise((function(n,i){var o=r.apply(e,t);function _next(e){asyncGeneratorStep$N(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$N(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}shouldMonitor(){if(!super.shouldMonitor())return!1;return this.getRollMetadata().length>0}startMonitor(){this.setupWatchers(this.getRollMetadata()),super.startMonitor()}getRollMetadata(){const e=this.playbackController.nowPlayingItem;return void 0===e?[]:parseRollItems(e,["pre-roll","post-roll"])}setupWatchers(e){const t=[];e.forEach(e=>{const{start:r,duration:n}=e,i=new SpanWatcher(this.dispatcher,this.handlePlaybackThreshold,r,r+n);t.push(i),this.rollMap.set(i,e)}),this.watchers=t}constructor(e){super(e),function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"rollMap",new Map)}}function asyncGeneratorStep$M(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}class SkipAvailable extends PlaybackMonitor{handlePlaybackThreshold(e,t){var r,n=this;return(r=function*(){if(!n.skipMap.has(t))return;const e=n.skipMap.get(t);n.dispatcher.publish(Dn.mediaSkipAvailable,e)},function(){var e=this,t=arguments;return new Promise((function(n,i){var o=r.apply(e,t);function _next(e){asyncGeneratorStep$M(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$M(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))})()}shouldMonitor(){if(!super.shouldMonitor())return!1;return this.getNowPlayingMetadata().length>0}startMonitor(){this.setupWatchers(this.getNowPlayingMetadata()),super.startMonitor()}getNowPlayingMetadata(){const e=this.playbackController.nowPlayingItem;return void 0===e?[]:parseSkipItems(e)}setupWatchers(e){const t=[];e.forEach(e=>{const{start:r,target:n,duration:i,promo:o}=e,a=new SpanWatcher(this.dispatcher,this.handlePlaybackThreshold,r,o?n:r+i,!0);t.push(a),this.skipMap.set(a,e)}),this.watchers=t}constructor(e){super(e),function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"skipMap",new Map)}}const Mn=new Logger$2("services");function asyncGeneratorStep$L(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _define_property$$(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const hasContentCompletionThresholdData=e=>!isNaN(getUpNextStart(e))&&!isNaN(getWatchedTime(e)),getUpNextStart=e=>parseFloat(e.hlsMetadata["up-next.start"]),getWatchedTime=e=>parseFloat(e.hlsMetadata["watched.time"]),Nn=(Ln=function*(e,t){if(e.isUTS&&e.assetURL)try{const r=generateAssetUrl(e,t),n=yield nn.fetchManifest(r);e.hlsMetadata=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$$(e,t,r[t])}))}return e}({},e.hlsMetadata,function(e,t={}){const r=/^(?:#EXT-X-SESSION-DATA:?)DATA-ID="([^"]+)".+VALUE="([^"]+)".*$/,n={};for(const i of e.split("\n")){const e=i.match(r);if(e){let r=e[1];e[1].startsWith("com.apple.hls.")&&!1!==t.stripPrefix&&(r=e[1].slice("com.apple.hls.".length));const i=e[2];n[r]=i}}return n}(n.content))}catch(De){Mn.error(De.message,De)}},xn=function(){var e=this,t=arguments;return new Promise((function(r,n){var i=Ln.apply(e,t);function _next(e){asyncGeneratorStep$L(i,r,n,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$L(i,r,n,_next,_throw,"throw",e)}_next(void 0)}))},function(e,t){return xn.apply(this,arguments)});var Ln,xn;function asyncGeneratorStep$K(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _ts_metadata$k(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}class UpNextMonitor extends PlaybackMonitor{handlePlaybackThreshold(){var e=this;return function(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$K(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$K(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}((function*(){e.dispatcher.publish(Dn.mediaUpNext)}))()}shouldMonitor(){if(!super.shouldMonitor())return!1;const e=this.playbackController.nowPlayingItem;return void 0!==e&&hasContentCompletionThresholdData(e)}startMonitor(){this.setupWatchers(),super.startMonitor()}setupWatchers(){const e=this.playbackController.nowPlayingItem;e&&hasContentCompletionThresholdData(e)&&(this.watchers=[new SpanWatcher(this.dispatcher,this.handlePlaybackThreshold,Math.round(this.getStartTime(e)),Number.POSITIVE_INFINITY)])}getStartTime(e){const t=getUpNextStart(e);return isNaN(t)?getWatchedTime(e):t}constructor(e){super(e)}}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$k("design:type",Function),_ts_metadata$k("design:paramtypes",[]),_ts_metadata$k("design:returntype",Promise)],UpNextMonitor.prototype,"handlePlaybackThreshold",null);const jn=BooleanDevFlag.register("mk-console-logging"),Un=StringDevFlag.register("mk-logging-levels"),Fn=W.ERROR;let Kn=Fn;const Bn=new Logger$2("mk",{level:Kn,handlers:{console:new class{get hasConsole(){return"undefined"!=typeof console}process(e){if(!this.enabled||!this.hasConsole)return;let t="log";if(this.mapLevels){const r=this.levelMapping.get(e.level);(function(e){return void 0!==e&&e in console})(r)&&(t=r)}var r;const n=null!==(r=e.args)&&void 0!==r?r:[],i=this.format(e);console[t](i,...n)}constructor(e={}){var t,r,n,i;_define_property$1N(this,"enabled",void 0),_define_property$1N(this,"mapLevels",void 0),_define_property$1N(this,"levelMapping",void 0),_define_property$1N(this,"format",void 0),this.enabled=null===(t=e.enabled)||void 0===t||t,this.mapLevels=null===(r=e.mapLevels)||void 0===r||r,this.levelMapping=null!==(n=e.levelMapping)&&void 0!==n?n:X,this.format=null!==(i=e.formatter)&&void 0!==i?i:Z}}({enabled:!1}),external:new CallbackHandler(()=>{})}});function applyLoggingLevels(e){!function(e,t){walk(e,(function(e){let r;const n=e.namespace;e.clearLevel(),void 0===e.parent&&void 0!==t["*"]?r=getLoggingLevel$1(t["*"]):void 0!==t[n]&&(r=getLoggingLevel$1(t[n])),void 0!==r&&e.setLevel(r)}))}(Bn,function(e){const t=getLoggingLevel$1(e.trim(),{allowShorthands:!0});if(void 0!==t)return{"*":t};const r={},n=e.split(",").filter(e=>""!==e.trim());for(const c of n){var i,o;const e=c.split("=",2);if(2!==e.length)continue;var a;const t=null!==(a=null===(i=e[0])||void 0===i?void 0:i.trim())&&void 0!==a?a:"";var s;const n=getLoggingLevel$1(null!==(s=null===(o=e[1])||void 0===o?void 0:o.trim())&&void 0!==s?s:"",{allowShorthands:!0});""!==t&&void 0!==n&&(r[t]=n)}return r}(e))}function clearLoggingLevels(){Bn.setLevel(Kn),function(e,t={includeRoot:!0}){walk(e,(function(e){(void 0!==e.parent||t.includeRoot)&&e.clearLevel()}))}(Bn,{includeRoot:!1})}function setConsoleOutput(e){Bn.handlers.console.enabled=null!=e&&e}function setRootLoggingLevel(e){var t;Kn=null!==(t=getLoggingLevel$1(e))&&void 0!==t?t:Kn}const Vn={getLogger:(e="*")=>Bn.getByNamespace(null!=e?e:"*"),setConsoleOutput(e){!0===e?(jn.enable(),setConsoleOutput(!0),Bn.info("Console output is enabled with level "+Bn.levelName)):(jn.disable(),setConsoleOutput(!1))},setLoggingLevels(e,t){""!==e.trim()?(Un.set(e),applyLoggingLevels(e),Vn.setConsoleOutput(null==t||t)):Vn.clearLoggingLevels(null!=t&&t)},clearLoggingLevels(e=!1){Vn.setConsoleOutput(e),Un.clear(),clearLoggingLevels()},listLoggers:e=>function(e){const t={};void 0!==e&&(e=e.startsWith("mk/")?e:"mk/"+e);const r=Bn.children;for(;r.length>0;){const n=r.shift();if(void 0===n)break;(void 0===e||n.namespace.startsWith(e))&&(t[n.namespace]=n.levelName,r.unshift(...n.children))}return t}(e)};function _define_property$_(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var Gn;jn.enabled&&Vn.setConsoleOutput(jn.enabled),void 0!==Un.value&&Vn.setLoggingLevels(Un.value,jn.enabled),function(e){e[e.none=0]="none",e[e.one=1]="one",e[e.all=2]="all"}(Gn||(Gn={}));class BaseRepeatable{get repeatMode(){return 0}set repeatMode(e){e!==this.repeatMode&&Mn.warn("setting repeatMode is not supported in this playback method")}constructor(){_define_property$_(this,"canSetRepeatMode",!1)}}class Repeatable{get repeatMode(){return this._repeatMode}set repeatMode(e){e in Gn&&e!==this._repeatMode&&(this._repeatMode=e,this.dispatcher.publish(Dn.repeatModeDidChange,this._repeatMode))}constructor(e,t=0){_define_property$_(this,"canSetRepeatMode",!0),_define_property$_(this,"dispatcher",void 0),_define_property$_(this,"_repeatMode",void 0),this.dispatcher=e,this._repeatMode=t}}const Hn=getHlsJsCdnConfig(),qn={app:{},autoplay:{maxQueueSizeForAutoplay:50,maxQueueSizeInRequest:10,maxUpcomingTracksToMaintain:10},features:{xtrick:!0,isWeb:!0,bookmarking:!1,"seamless-audio-transitions":!0,"enhanced-hls":!1,"fetch-all-tracks":!1},urls:{hls:Hn.hls,rtc:Hn.rtc,mediaApi:"https://amp-api.music.apple.com/v1",webPlayback:`https://${getCommerceHostname("play")}/WebObjects/MZPlay.woa/wa/webPlayback`}},Wn=JsonDevFlag.register("mk-offers-key-urls").get();function asyncGeneratorStep$J(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$J(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$J(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$J(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$Z(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread_props$n(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}let Yn;qn.urls.hlsOffersKeyUrls=Wn||{"hls-key-cert-url":"https://s.mzstatic.com/skdtool_2021_certbundle.bin","hls-key-server-url":"https://play.itunes.apple.com/WebObjects/MZPlay.woa/podcast/hls/license/streaming/start","widevine-cert-url":"https://play.itunes.apple.com/WebObjects/MZPlay.woa/wa/widevineCert"};class Store{get authorizationStatus(){return this.storekit.authorizationStatus}get cid(){return this.storekit.cid}get developerToken(){return this.storekit.developerToken}get hasAuthorized(){return this._hasAuthorized}get isAuthorized(){return this.storekit.hasAuthorized}get isRestricted(){return this.storekit.authorizationStatus===ne.RESTRICTED}get isU13(){return this.storekit.isU13}get metricsClientId(){return this._metricsClientId}set metricsClientId(e){this._metricsClientId=e}get musicUserToken(){return this.storekit.userToken}set musicUserToken(e){this.storekit.userToken=e}updateUserTokenFromStorage(){return this.storekit.updateUserTokenFromStorage()}set dynamicMusicUserToken(e){this.storekit.dynamicUserToken=e}get needsGDPR(){Mn.error("needsGDPR has been deprecated. Plesae migrate to shouldDisplayPrivacyLink()")}get realm(){return this.storekit.realm}set requestUserToken(e){this._providedRequestUserToken=!0,this.storekit.requestUserToken=e}get restrictedEnabled(){return this.storekit.restrictedEnabled}set restrictedEnabled(e){this.storekit.overrideRestrictEnabled(e)}get storefrontCountryCode(){var e;return this.isAuthorized?this.storekit.storefrontCountryCode:null!==(e=this._defaultStorefrontCountryCode)&&void 0!==e?e:this.storekit.storefrontCountryCode}get storefrontId(){return this._apiStorefrontId||this.storekit.storefrontCountryCode}set storefrontId(e){e&&(e=e.toLowerCase()),e!==this._apiStorefrontId&&(this._apiStorefrontId=e,this.dispatcher.publish(et.apiStorefrontChanged,{storefrontId:e}))}get subscribeURL(){return this.storekit.deeplinkURL({p:"subscribe"})}get subscribeFamilyURL(){return this.storekit.deeplinkURL({p:"subscribe-family"})}get subscribeIndividualURL(){return this.storekit.deeplinkURL({p:"subscribe-individual"})}get subscribeStudentURL(){return this.storekit.deeplinkURL({p:"subscribe-student"})}get userToken(){return this.musicUserToken}authorize(){var e=this;return _async_to_generator$J((function*(){if(e.storekit.userTokenIsValid)return e.storekit.userToken;let t;try{t=yield e.storekit.requestUserToken()}catch(De){try{yield e.unauthorize()}catch(r){}throw new MKError(MKError.Reason.AUTHORIZATION_ERROR,"Unauthorized")}return e._providedRequestUserToken&&(e.storekit.userToken=t),e.storekit.userTokenIsValid?(yield e.storekit.requestStorefrontCountryCode().catch(function(){var t=_async_to_generator$J((function*(t){return yield e.unauthorize(),Promise.reject(t)}));return function(e){return t.apply(this,arguments)}}()),t):void 0}))()}shouldDisplayPrivacyLink(e){var t=this;return _async_to_generator$J((function*(){return t.storekit.shouldDisplayPrivacyLink(e)}))()}unauthorize(){var e=this;return _async_to_generator$J((function*(){return e.storekit.revokeUserToken()}))()}constructor(t,r={}){var n,i;_define_property$Z(this,"precache",void 0),_define_property$Z(this,"storekit",void 0),_define_property$Z(this,"dispatcher",void 0),_define_property$Z(this,"_apiStorefrontId",void 0),_define_property$Z(this,"_defaultStorefrontCountryCode",void 0),_define_property$Z(this,"_hasAuthorized",!1),_define_property$Z(this,"_metricsClientId",void 0),_define_property$Z(this,"_providedRequestUserToken",!1),this.dispatcher=r.services.dispatcher,"precache"in r&&(this.precache=r.precache),r.storefrontId&&(this.storefrontId=r.storefrontId),this._defaultStorefrontCountryCode=r.storefrontCountryCode,("affiliateToken"in r||"campaignToken"in r)&&(r.linkParameters=_object_spread_props$n(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$Z(e,t,r[t])}))}return e}({},r.linkParameters||{}),{at:r.affiliateToken,ct:r.campaignToken})),this.storekit=new StoreKit(t,{apiBase:qn.urls.mediaApi,authenticateMethod:qn.features["legacy-authenticate-method"]?"POST":"GET",deeplink:r.linkParameters,disableAuthBridge:r.disableAuthBridge,iconURL:qn.app.icon,meParameters:r.meParameters,persist:r.persist,realm:r.realm||e.SKRealm.MUSIC,fetch:null==r||null===(i=r.services)||void 0===i||null===(n=i.request)||void 0===n?void 0:n.fetch,disableLogoutURL:r.disableLogoutURL}),this.storekit.addEventListener(Dn.authorizationStatusDidChange,e=>{const{authorizationStatus:t}=e;this._hasAuthorized=[ne.AUTHORIZED,ne.RESTRICTED].includes(t)})}}function formattedSeconds(e){return{hours:Math.floor(e/3600),minutes:Math.floor(e%3600/60)}}function asyncGeneratorStep$I(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$I(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$I(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$I(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function hasAuthorization(e){return void 0===e&&(e=Yn&&Yn.storekit),void 0!==e&&e.hasAuthorized&&e.userTokenIsValid}function hasMusicSubscription(e){return _hasMusicSubscription.apply(this,arguments)}function _hasMusicSubscription(){return(_hasMusicSubscription=_async_to_generator$I((function*(e){return void 0===e&&(e=Yn&&Yn.storekit),e.hasMusicSubscription()}))).apply(this,arguments)}function _define_property$Y(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function transform$9(e){return function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$Y(e,t,r[t])}))}return e}({attributes:{}},transform$b({id:"metadata.itemId",type:"metadata.itemType","attributes.contentRating"(){var t;if(1===(null==e||null===(t=e.metadata)||void 0===t?void 0:t.isExplicit))return"explicit"},"attributes.playParams"(){var t,r,n;return 0!==(null==e||null===(t=e.metadata)||void 0===t?void 0:t.isPlayable)&&{id:null==e||null===(r=e.metadata)||void 0===r?void 0:r.itemId,kind:null==e||null===(n=e.metadata)||void 0===n?void 0:n.itemType}},"container.id":"metadata.containerId","container.name":"metadata.containerName","container.type":"metadata.containerType"},e))}function _define_property$X(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$A(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$X(e,t,r[t])}))}return e}function _object_spread_props$m(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const zn={condition:()=>!0,toOptions:(e,t,r)=>[_object_spread_props$m(_object_spread$A({},e),{context:r})]};function _define_property$W(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$z(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$W(e,t,r[t])}))}return e}function _object_spread_props$l(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const Qn={condition:e=>{var t;return"stations"===e.type&&(null===(t=e.attributes)||void 0===t?void 0:t.isLive)},toOptions:(e,t,r)=>[_object_spread_props$l(_object_spread$z({},e),{context:r,container:{attributes:e.attributes,id:e.id,type:e.type,name:null==r?void 0:r.featureName}})]};function _define_property$V(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$y(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$V(e,t,r[t])}))}return e}function _object_spread_props$k(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const Jn={condition:function(e){var t,r,n,i;return"stations"===e.type&&"streaming"===(null===(t=e.attributes)||void 0===t?void 0:t.kind)&&"episode"===(null===(n=e.attributes)||void 0===n||null===(r=n.streamingRadioSubType)||void 0===r?void 0:r.toLowerCase())&&!1===(null===(i=e.attributes)||void 0===i?void 0:i.isLive)},toOptions:function(e,t,r){var n,i;return[_object_spread_props$k(_object_spread$y({},e),{context:r,container:{attributes:e.attributes,id:e.id,type:e.type,name:null==r?void 0:r.featureName,stationHash:null===(i=e.attributes)||void 0===i||null===(n=i.playParams)||void 0===n?void 0:n.stationHash}})]}},hasRelationship=e=>t=>{var r,n;return!!(null===(n=t.relationships)||void 0===n||null===(r=n[e])||void 0===r?void 0:r.data)},typeIs=(...e)=>({type:t})=>e.includes(t),withBagPrefix=e=>{if(void 0===e||""===e)return;const{prefix:t}=qn;return t?`${t}:${e}`:e};function _define_property$U(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread_props$j(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const getContainerName=(e,t)=>{var r,n;return null!==(n=null!=t?t:null==e||null===(r=e.container)||void 0===r?void 0:r.name)&&void 0!==n?n:nt.SONG},Xn={toOptions:(e,t,r)=>{const n=_object_spread_props$j(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$U(e,t,r[t])}))}return e}({id:e.id},t),{name:withBagPrefix(getContainerName(e,null==r?void 0:r.featureName))});return[{relationships:e.relationships,attributes:e.attributes,id:e.id,type:e.type,container:n,context:r}]},condition:typeIs("songs","library-songs","music-videos")};function _define_property$T(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$w(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$T(e,t,r[t])}))}return e}function _object_spread_props$i(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const parseAssets=({type:e,attributes:{assetTokens:t}})=>e.includes("udio")?(e=>{if(void 0===e)return;const[t]=Object.keys(e);return e[t]})(t):(e=>{if(void 0===e)return;const t=Object.keys(e);return e[t[t.length-1]]})(t),Zn={condition:typeIs("uploaded-audios","uploadedAudio","uploaded-videos","uploadedVideo"),toOptions:(e,t,r)=>{var n,i;const o=_object_spread_props$i(_object_spread$w({},e),{context:r,attributes:_object_spread_props$i(_object_spread$w({},e.attributes),{assetUrl:parseAssets(e),playParams:null!==(i=null==e||null===(n=e.attributes)||void 0===n?void 0:n.playParams)&&void 0!==i?i:{id:e.id,kind:e.type}})});return void 0!==t&&(o.container=t),void 0!==(null==r?void 0:r.featureName)&&(o.container=_object_spread_props$i(_object_spread$w({},o.container),{name:null==r?void 0:r.featureName})),[o]}};function _define_property$S(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread_props$h(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const ei={toOptions:(e,t,r)=>e.relationships.episodes.data.map(e=>_object_spread_props$h(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$S(e,t,r[t])}))}return e}({},e),{context:r})),condition:hasRelationship("episodes"),requiredRelationships:["episodes"]};function asyncGeneratorStep$H(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$H(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$H(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$H(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$R(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$u(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$R(e,t,r[t])}))}return e}function formatRatingsContentType(e,t){return isLibraryType(t)&&n(t)?e.replace(/^library-/,""):isLibraryType(t)&&!/^library-/.test(e)?"library-"+e:e}function normalizeAdamId(e){return e.replace(/^a\./,"")}function makeRequest(e,t,r){return _makeRequest.apply(this,arguments)}function _makeRequest(){return(_makeRequest=_async_to_generator$H((function*(e,t,r,n={}){let i,o=t;const a=r&&r.ids;n=_object_spread$u({},n);const{shouldCacheResults:s=!0,returnRawJSONApiRecords:c=!1,includePagination:l=e.defaultIncludePaginationMetadata,includeResponseMeta:d=!1}=n;delete n.shouldCacheResults,delete n.returnRawJSONApiRecords,delete n.includePagination,delete n.includeResponseMeta,"string"==typeof a&&(o=`${t}/${encodeURIComponent(a)}`,r&&delete r.ids);try{(l||d)&&(n.useRawResponse=!0),i=yield e.request(o,r,n)}catch(u){return"status"in u?404===u.status?Promise.reject(new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"The requested content is not available.")):Promise.reject(MKError.responseError(u)):Promise.reject(MKError.internalError(u))}try{const t=i.results||i.data||i;if("object"==typeof i&&"results"in i&&"meta"in i&&(t.meta=i.meta),0===t.length)return Promise.reject(new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"The requested content is not available."));const o=c?t:e.parseResultData(s,t);if(!l&&!d)return o;if("results"in i){for(const t in i.results)"meta"!==t&&(o[t]=paginateResultSet(i.results[t],o[t],e,r,n));return o}return paginateResultSet(i,o,e,r,n)}catch(De){return Promise.reject(MKError.parseError(De))}}))).apply(this,arguments)}function paginateResultSet(e,t,r,n,i={}){let o,a;i.includePagination=!0;const s=_object_spread$u({},i);return delete s.offset,e.next&&(o=()=>makeRequest(r,formatPaginatedUrl(r.url,e.next),n,s)),e.previous&&(a=()=>makeRequest(r,formatPaginatedUrl(r.url,e.previous),n,s)),{data:t,next:o,previous:a,meta:e.meta}}function mapRequestResult(e,t){return"data"in e?(e.data=t(e.data),e):t(e)}function formatPaginatedUrl(e,t){if("function"!=typeof URL)throw new Error("formatPaginatedUrl requires an implementation of URL");const{pathname:r}=new URL(e),n=new RegExp(`^${r}/`);return t.replace(n,"")}const getFeatureName=(e,t)=>{if(t)return t;const r=function(e=[]){return 0!==e.length&&e.filter(({attributes:e})=>!!e&&(e.workName||e.movementName||e.movementCount||e.movementNumber)).length>0}(e.relationships.tracks.data);return"albums"===e.type||"library-albums"===e.type?r?nt.ALBUM_CLASSICAL:nt.ALBUM:"playlists"===e.type||"library-playlists"===e.type?r?nt.PLAYLIST_CLASSICAL:nt.PLAYLIST:void 0};function _define_property$Q(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$t(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$Q(e,t,r[t])}))}return e}function _object_spread_props$g(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const ti=[{toOptions:(e,t,r)=>{const n={attributes:e.attributes,id:e.id,type:e.type,name:withBagPrefix(getFeatureName(e,null==r?void 0:r.featureName))};return e.relationships.tracks.data.map(e=>({attributes:e.attributes,id:e.id,type:e.type,container:n,context:r}))},condition:hasRelationship("tracks"),requiredRelationships:["tracks"]},ei,Xn,Qn,Jn,Zn,{condition:typeIs("music-movies"),toOptions:(e,t,r)=>{var n,i;const o=_object_spread_props$g(_object_spread$t({},e),{context:r,attributes:_object_spread_props$g(_object_spread$t({},e.attributes),{playParams:null!==(i=null==e||null===(n=e.attributes)||void 0===n?void 0:n.playParams)&&void 0!==i?i:{id:e.id,kind:"musicMovie"},offers:void 0})});return void 0!==t&&(o.container=t),void 0!==(null==r?void 0:r.featureName)&&(o.container=_object_spread_props$g(_object_spread$t({},o.container),{name:null==r?void 0:r.featureName})),[o]}}],transform=(e,t,r={})=>{var n,i,o;t=null!==(i=null==t||null===(n=t.serialize)||void 0===n?void 0:n.call(t).data)&&void 0!==i?i:t;return(null!==(o=ti.find(n=>n.condition(e,t,r)))&&void 0!==o?o:zn).toOptions(e,t,r).map(e=>new MediaItem(e))},ri=ti.reduce((e,t)=>{const r=t.requiredRelationships;return r&&e.push(...r),e},[]),ni=new Set(ri),isArrayOf=(e,t)=>Array.isArray(e)&&(0===e.length||t(e[0])),isMediaAPIResource$1=e=>e&&void 0!==e.id&&void 0!==e.type,isMediaItem=e=>e&&void 0!==e.id,isMPMediaItem=e=>e&&void 0!==e.contentId&&void 0!==e.metadata&&void 0!==e.metadata.itemId&&void 0!==e.metadata.itemType,isQueueLoaded=e=>e&&e.loaded;function _define_property$P(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const ii=Bn.linkChild(new Logger$2("queue")),descriptorToMediaItems=e=>{if(!(e=>e&&e.items&&Array.isArray(e.items))(e)&&!isQueueLoaded(e))return[];const t=isQueueLoaded(e)?loadedDescriptorToMediaItem(e):unloadedDescriptorToMediaItem(e);return t.forEach(t=>t.context=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$P(e,t,r[t])}))}return e}({},e.context,t.context)),t},unloadedDescriptorToMediaItem=({items:e})=>isArrayOf(e,isMPMediaItem)?e.map(e=>new MediaItem(transform$9(e))):isArrayOf(e,isMediaItem)?e.map(e=>new MediaItem(e)):[],loadedDescriptorToMediaItem=e=>{const t=[],{loaded:r,container:n,context:i}=e;return void 0===r?[]:isArrayOf(r,isDataRecord)?(r.forEach(e=>{t.push(...dataRecordToMediaItems(e,n,i))}),t):isArrayOf(r,isMediaAPIResource$1)?(r.forEach(e=>{t.push(...resourceToMediaItem(e,n,i))}),t):isDataRecord(r)?dataRecordToMediaItems(r,n,i):isMediaAPIResource$1(r)?resourceToMediaItem(r,n,i):[]},dataRecordToMediaItems=(e,t,r={})=>{const{data:n}=e.serialize(!0,void 0,{includeRelationships:ni,allowFullDuplicateSerializations:!0});return resourceToMediaItem(n,t,r)},resourceToMediaItem=(e,t,r={})=>(ii.debug("_resourceToMediaItem",e),transform(e,t,r));function _define_property$O(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Bn.createChild("queue");class QueueItem{restrict(){return this.item.restrict()}constructor(e,t){var r;_define_property$O(this,"isAutoplay",!1),_define_property$O(this,"item",void 0),this.item=e,this.isAutoplay=null!==(r=null==t?void 0:t.isAutoplay)&&void 0!==r&&r}}function toQueueItems(e,t){return e.map(e=>new QueueItem(e,t))}function toMediaItems(e){return e.map(e=>e.item)}const{queueItemsDidChange:oi,queuePositionDidChange:ai}=Dn;class Queue{get isEmpty(){return 0===this.length}set isRestricted(e){var t;this._isRestricted=e;const r=null===(t=this.currentItem)||void 0===t?void 0:t.id;this._isRestricted&&!this.isEmpty&&(this.removeQueueItems(e=>e.item.isExplicitItem),this.isEmpty&&this._dispatcher.publish(Dn.mediaPlaybackError,new MKError(MKError.Reason.CONTENT_RESTRICTED,"Content restricted")),r&&(this.position=this._getStartItemPosition(r)))}get isRestricted(){return this._isRestricted}get appendTargetIndex(){let e=this.length;const t=this._queueItems.findIndex(e=>e.isAutoplay);return-1!==t&&this.position<t&&(e=t),e}get items(){return toMediaItems(this._queueItems)}get autoplayItems(){return toMediaItems(this._queueItems.filter(e=>e.isAutoplay))}get unplayedAutoplayItems(){return toMediaItems(this._unplayedQueueItems.filter(e=>e.isAutoplay))}get userAddedItems(){return toMediaItems(this._queueItems.filter(e=>!e.isAutoplay))}get unplayedUserItems(){return toMediaItems(this._unplayedQueueItems.filter(e=>!e.isAutoplay))}get playableItems(){return toMediaItems(this._queueItems.filter(e=>canPlay(e.item,this.playbackMode)))}get unplayedPlayableItems(){return toMediaItems(this._unplayedQueueItems.filter(e=>canPlay(e.item,this.playbackMode)))}get length(){return this._queueItems.length}get nextPlayableItem(){if(-1!==this.nextPlayableItemIndex)return this.item(this.nextPlayableItemIndex)}get nextPlayableItemIndex(){return this._nextPlayableItemIndex=this.findPlayableIndexForward(),this._nextPlayableItemIndex}get position(){return this._position}set position(e){this._updatePosition(e)}get isInitiated(){return this.position>=0}get previousPlayableItem(){if(-1!==this.previousPlayableItemIndex)return this.item(this.previousPlayableItemIndex)}get previousPlayableItemIndex(){return this.findPlayableIndexBackward()}removeQueueItems(e){for(let t=this.length-1;t>=0;t--)e(this.queueItem(t),t)&&this.spliceQueueItems(t,1)}indexForItem(e){return("string"==typeof e?this._itemIDs:this.items).indexOf(e)}item(e){var t;return null===(t=this.queueItem(e))||void 0===t?void 0:t.item}get currentItem(){return this.item(this.position)}queueItem(e){var t;return null===(t=this._queueItems)||void 0===t?void 0:t[e]}updateItems(e){this._queueItems=toQueueItems(e),this._reindex(),this._dispatcher.publish(Dn.queueItemsDidChange,this.items)}get currentQueueItem(){return this.queueItem(this.position)}remove(e){if(deprecationWarning("remove",{message:"The queue remove function has been deprecated"}),e===this.position)throw new MKError(MKError.Reason.INVALID_ARGUMENTS);this.splice(e,1)}append(e=[]){return this.appendQueueItems(toQueueItems(e))}appendQueueItems(e=[]){this.spliceQueueItems(this.appendTargetIndex,0,e)}splice(e,t,r=[]){return toMediaItems(this.spliceQueueItems(e,t,toQueueItems(r)))}spliceQueueItems(e,t,r=[],n=!0){r=r.filter(e=>isPlayable(null==e?void 0:e.item,this.playbackMode));const i=this._queueItems.splice(e,t,...r);return this._itemIDs.splice(e,t,...r.map(e=>e.item.id)),n&&(this._dispatcher.publish(et.queueModified,{start:e,added:toMediaItems(r),removed:toMediaItems(i)}),this._dispatcher.publish(oi,this.items)),i}clearAfterCurrent(){if(-1===this.position)this.clear();else if(this.length>0&&this.position+1<this.length){const e=this.position+1;this.splice(e,this.length)}}clear(){this.length>0&&(this.splice(0,this.length),this.reset())}reset(){const e=this.position;this._position=-1,e>=0&&this._dispatcher.publish(ai,{oldPosition:e,position:this.position})}_isSameItems(e){if(e.length!==this.length)return!1;const t=e.map(e=>e.id).sort(),r=[...this._itemIDs].sort();let n,i;try{n=JSON.stringify(t),i=JSON.stringify(r)}catch(o){return!1}return n===i}_reindex(){this._queueItems&&(this._itemIDs=this._queueItems.map(e=>e.item.id))}_updatePosition(e){if(e===this._position)return;const t=this._position;this._position=e;const r=this.item(e);r&&canPlay(r,this.playbackMode)||(this._position=this.findPlayableIndexForward(e)),this._position!==t&&this._dispatcher.publish(ai,{oldPosition:t,position:this._position})}findPlayableIndexForward(e=this.position){var t;if(this.isEmpty)return-1;if(this.isInitiated&&!indexInBounds([0,this.position],e))return-1;const r=null===(t=this.repeatable)||void 0===t?void 0:t.repeatMode;if(e<this.length)for(let n=e+1;n<this.length;n++){if(canPlay(this.item(n),this.playbackMode))return n}if(r===Gn.all)for(let n=0;n<=e;n++){if(canPlay(this.item(n),this.playbackMode))return n}return-1}findPlayableIndexBackward(e=this.position){var t;if(this.isEmpty)return-1;if(!indexInBounds([0,this.position],e))return-1;const r=null===(t=this.repeatable)||void 0===t?void 0:t.repeatMode;if(e>0)for(let n=e-1;n>=0;n--){if(canPlay(this.item(n),this.playbackMode))return n}if(r===Gn.all)for(let n=this.length-1;n>=e;n--){if(canPlay(this.item(n),this.playbackMode))return n}return-1}get _unplayedQueueItems(){const e=this.position<0?0:this.position;return this._queueItems.slice(e)}_getStartItemPosition(e){if(void 0===e)return-1;if("object"==typeof e&&"id"in e&&(e=e.id),"string"==typeof e)return this.indexForItem(e);const t=parseInt(""+e,10);return t>=0&&t<this.length?t:-1}constructor(t){if(_define_property$O(this,"repeatable",void 0),_define_property$O(this,"hasAutoplayStation",!1),_define_property$O(this,"playbackMode",e.PlaybackMode.MIXED_CONTENT),_define_property$O(this,"_itemIDs",[]),_define_property$O(this,"_queueItems",[]),_define_property$O(this,"_isRestricted",!1),_define_property$O(this,"_nextPlayableItemIndex",-1),_define_property$O(this,"_position",-1),_define_property$O(this,"_dispatcher",void 0),this._dispatcher=t.services.dispatcher,this.playbackMode=t.playbackMode,!t.descriptor)return;const r=descriptorToMediaItems(t.descriptor).filter(e=>isPlayable(e,this.playbackMode));this._queueItems=toQueueItems(r),this._reindex(),void 0!==t.descriptor.startWith&&(this.position=this._getStartItemPosition(t.descriptor.startWith))}}function isPlayable(t,r){return t.isPlayable||r!==e.PlaybackMode.FULL_PLAYBACK_ONLY&&void 0!==t.previewURL}function canPlay(e,t){return isPlayable(e,t)&&!function(e){return e.isRestricted}(e)&&!function(e){return e.isUnavailable}(e)}function indexInBounds(e,t){return e[0]<=t&&t<=e[1]}function _define_property$N(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const si=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$N(e,t,r[t])}))}return e}({},{NEXT_ITEM:"NEXT"},ot);function asyncGeneratorStep$G(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$G(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$G(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$G(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$M(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const ci=["EditorialVideoClip","uploaded-videos","uploadedVideo","musicVideo"],li=function(){var e=_async_to_generator$G((function*(){}));return function(){return e.apply(this,arguments)}}();class BaseSeekable{getSeekSeconds(e){return{BACK:0,FORWARD:0}}seekBackward(e=li){Mn.warn("seekBackward is not supported in this playback method")}seekForward(e=li){Mn.warn("seekForward is not supported in this playback method")}seekToTime(e,t){return _async_to_generator$G((function*(){Mn.warn("seekToTime is not supported in this playback method")}))()}constructor(e){_define_property$M(this,"mediaItemPlayback",void 0),_define_property$M(this,"canSeek",void 0),this.mediaItemPlayback=e,this.canSeek=!1}}class Seekable{getSeekSeconds(e){return(e=>(null==e?void 0:e.isUTS)||ci.includes(null==e?void 0:e.type)?{FORWARD:10,BACK:10}:(null==e?void 0:e.isAOD)?{FORWARD:30,BACK:30}:{FORWARD:30,BACK:15})(e)}seekBackward(t=this._seekToBeginning){var r=this;return _async_to_generator$G((function*(){if(void 0===r.mediaItemPlayback.nowPlayingItem)return void Mn.warn("Cannot seekBackward when nowPlayingItem is not yet set.");const n=r.mediaItemPlayback.currentPlaybackTime-r.getSeekSeconds(r.mediaItemPlayback.nowPlayingItem).BACK;n<0?yield t.call(r):yield r.seekToTime(n,e.SeekReasonType.Interval)}))()}seekForward(t=this._seekToEnd){var r=this;return _async_to_generator$G((function*(){if(void 0===r.mediaItemPlayback.nowPlayingItem)return void Mn.warn("Cannot seekForward when nowPlayingItem is not yet set.");const n=r.mediaItemPlayback.currentPlaybackTime+r.getSeekSeconds(r.mediaItemPlayback.nowPlayingItem).FORWARD;n>r.mediaItemPlayback.currentPlaybackDuration?yield t.call(r):yield r.seekToTime(n,e.SeekReasonType.Interval)}))()}seekToTime(t,r=e.SeekReasonType.Manual){var n=this;return _async_to_generator$G((function*(){if(void 0===n.mediaItemPlayback.nowPlayingItem)return void Mn.warn("Cannot seekToTime when nowPlayingItem is not yet set.");const e=n.mediaItemPlayback.nowPlayingItem,i=n.mediaItemPlayback.currentPlaybackTime,o=n.mediaItemPlayback.currentPlayingDate,a=Math.min(Math.max(0,t),n.mediaItemPlayback.currentPlaybackDuration);let s;if(e.isLinearStream&&void 0!==o){const e=1e3*(a-i);s=new Date(o.getTime()+e)}yield n.mediaItemPlayback.seekToTime(a,r),n._dispatcher.publish(et.playbackSeek,{item:e,startPosition:i,position:a,playingDate:s,startPlayingDate:o,seekReasonType:r})}))()}_seekToBeginning(){var t=this;return _async_to_generator$G((function*(){yield t.seekToTime(0,e.SeekReasonType.Interval)}))()}_seekToEnd(){var t=this;return _async_to_generator$G((function*(){yield t.seekToTime(t.mediaItemPlayback.currentPlaybackDuration,e.SeekReasonType.Interval)}))()}constructor(e,t){_define_property$M(this,"_dispatcher",void 0),_define_property$M(this,"mediaItemPlayback",void 0),_define_property$M(this,"canSeek",void 0),this._dispatcher=e,this.mediaItemPlayback=t,this.canSeek=!0}}const shuffleCollection=e=>{const t=[...e],{length:r}=t;for(let n=0;n<r;++n){const e=n+Math.floor(Math.random()*(r-n)),i=t[e];t[e]=t[n],t[n]=i}return t};function _define_property$L(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_metadata$j(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}var di;!function(e){e[e.off=0]="off",e[e.songs=1]="songs"}(di||(di={}));const ui="Shuffling is not supported in this playback method.";class BaseShuffler{set shuffle(e){Mn.warn(ui)}get shuffleMode(){return 0}set shuffleMode(e){Mn.warn(ui)}checkAndReshuffle(e){Mn.warn(ui)}constructor(){_define_property$L(this,"canSetShuffleMode",!1),_define_property$L(this,"queue",void 0)}}class Shuffler{get queue(){return this._queue}set queue(e){this._queue=e,this._unshuffledIDs=e.userAddedItems.map(e=>e.id),this.checkAndReshuffle(!1)}queueModifiedHandler(e,t){if(this._isSpliceFromShuffle)return void(this._isSpliceFromShuffle=!1);const{start:r,added:n,removed:i}=t;if(i.length>0){const e=i.map(e=>e.id);this._unshuffledIDs=this._unshuffledIDs.filter(t=>!e.includes(t))}n.length>0&&this._unshuffledIDs.splice(r,0,...n.map(e=>e.id))}set shuffle(e){this.shuffleMode=e?1:0}get shuffleMode(){return this.mode}set shuffleMode(e){e!==this.shuffleMode&&e in di&&(Mn.debug(`mk: set shuffleMode from ${this.shuffleMode} to ${e}`),this.mode=e,1===this.mode?this.shuffleQueue():this.unshuffleQueue(),this.controller.nowPlayingItem&&(this._queue.position=this._queue.indexForItem(this.controller.nowPlayingItem.id)),this.dispatcher.publish(Dn.shuffleModeDidChange,this.shuffleMode))}checkAndReshuffle(e=!1){1===this.shuffleMode&&this.shuffleQueue(e)}shuffleQueue(e=!0){const{userAddedItems:t}=this._queue;if(t.length<=1)return t;const r=t.slice(0),n=this._queue.position>-1?r.splice(this._queue.position,1):[];let i=[];do{i=shuffleCollection(r)}while(r.length>1&&arrayEquals(i,r));const o=[...n,...i];this._isSpliceFromShuffle=!0,this._queue.spliceQueueItems(0,o.length,toQueueItems(o),e)}unshuffleQueue(e=!0){let t=[];const r=this._unshuffledIDs.reduce((e,t,r)=>(e[t]=r,e),{}),n=[];let i=0;const o=this._queue.item(this._queue.position);this._queue.userAddedItems.forEach(e=>{const a=r[e.id];void 0===a&&n.push(e),t[a]=e,e.id===(null==o?void 0:o.id)&&(i=a)}),t=t.filter(Boolean);const a=t.concat(n);this._isSpliceFromShuffle=!0,this._queue.spliceQueueItems(0,a.length,toQueueItems(a),e),this._queue.position=i}constructor(e,{dispatcher:t}){_define_property$L(this,"controller",void 0),_define_property$L(this,"canSetShuffleMode",void 0),_define_property$L(this,"dispatcher",void 0),_define_property$L(this,"mode",void 0),_define_property$L(this,"_queue",void 0),_define_property$L(this,"_unshuffledIDs",void 0),_define_property$L(this,"_isSpliceFromShuffle",void 0),this.controller=e,this.canSetShuffleMode=!0,this.mode=0,this._unshuffledIDs=[],this._isSpliceFromShuffle=!1,this.dispatcher=t,this.dispatcher.subscribe(et.queueModified,this.queueModifiedHandler),this._queue=e.queue}}function asyncGeneratorStep$F(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$F(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$F(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$F(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$K(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$q(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$K(e,t,r[t])}))}return e}function _ts_metadata$i(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}var pi;!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$j("design:type",Function),_ts_metadata$j("design:paramtypes",[String,Object]),_ts_metadata$j("design:returntype",void 0)],Shuffler.prototype,"queueModifiedHandler",null),function(e){e.continuous="continuous",e.serial="serial"}(pi||(pi={}));const{queueItemsDidChange:hi}=Dn;class PlaybackController{get isActive(){return this._isActive}get isDestroyed(){return this._isDestroyed}updateAutoplay(e,t){this.autoplayEnabled=t}constructContext(e,t){let r=null==e?void 0:e.context;var n;return void 0!==(null==e?void 0:e.featureName)&&void 0===(null==r?void 0:r.featureName)&&(Mn.warn("featureName is deprecated, pass it inside context"),r||(r={}),r.featureName=e.featureName),null!==(n=null!=r?r:t)&&void 0!==n?n:{}}get context(){return this._context}get shuffler(){return this._shuffler}get continuous(){return this._continuous||this.hasAuthorization}set continuous(e){this._continuous=e}get autoplayEnabled(){return this._autoplayEnabled}set autoplayEnabled(e){this._autoplayEnabled=e}get previewOnly(){return this._mediaItemPlayback.previewOnly}get _dispatcher(){return this._services.dispatcher}get hasAuthorization(){return hasAuthorization(this.storekit)}get isPlaying(){return this._mediaItemPlayback.isPlaying}get isPrimaryPlayer(){return this._mediaItemPlayback.isPrimaryPlayer}set isPrimaryPlayer(e){this._mediaItemPlayback.isPrimaryPlayer=e}get isReady(){return this._mediaItemPlayback.isReady}get _mediaItemPlayback(){return this._services.mediaItemPlayback}get nowPlayingItem(){return this._mediaItemPlayback.nowPlayingItem}get nowPlayingItemIndex(){return this.queue?this.queue.position:-1}get playbackMode(){return this._playbackMode}set playbackMode(e){this._playbackMode=e,this.queue&&(this.queue.playbackMode=e)}get queue(){return this._queue}set queue(e){this.setQueue(e)}get repeatMode(){return this._repeatable.repeatMode}set repeatMode(e){this._repeatable.repeatMode=e}get seekSeconds(){const{nowPlayingItem:e}=this;if(void 0!==e)return this._seekable.getSeekSeconds(e)}set shuffle(e){this._shuffler.shuffle=e}get shuffleMode(){return this._shuffler.shuffleMode}set shuffleMode(e){this._shuffler.shuffleMode=e}get storekit(){return this._storekit}set storekit(e){if(e){var t=this;e.addEventListener(pe.authorizationStatusWillChange,function(){var e=_async_to_generator$F((function*({authorizationStatus:e,newAuthorizationStatus:r}){e>ne.DENIED&&r<ne.RESTRICTED?yield t.stop({endReasonType:ot.PLAYBACK_SUSPENDED,userInitiated:!1}):yield t.stop({userInitiated:!1})}));return function(t){return e.apply(this,arguments)}}()),this._storekit=e}}changeToMediaAtIndex(e=0){var t=this;return _async_to_generator$F((function*(){var r,n,i;yield t.stop();const o=null===(r=t.queue.item(e))||void 0===r?void 0:r.id,a=null===(i=t._mediaItemPlayback)||void 0===i||null===(n=i.playOptions)||void 0===n?void 0:n.get(o);let s=(null==a?void 0:a.startTime)||0;const c=yield t._changeToMediaAtIndex(e,{userInitiated:!0});c&&(c.id!==o&&(s=0),t._dispatcher.publish(et.playbackPlay,{item:c,position:s,playingDate:t._mediaItemPlayback.currentPlayingDate,userInitiated:!0}))}))()}changeToMediaItem(e){var t=this;return _async_to_generator$F((function*(){const r=t.queue.indexForItem(e);return-1===r?Promise.reject(new MKError(MKError.Reason.MEDIA_DESCRIPTOR)):t.changeToMediaAtIndex(r)}))()}activate(){var e=this;return _async_to_generator$F((function*(){Mn.debug("PlaybackController.activate()"),e._isActive=!0,e._dispatcher.unsubscribe(Dn.playbackStateDidChange,e.onPlaybackStateDidChange),e._dispatcher.subscribe(Dn.playbackStateDidChange,e.onPlaybackStateDidChange),e._skipIntro.activate(),e._upNext.activate(),e._rollMonitor.activate()}))()}deactivate(){var e=this;return _async_to_generator$F((function*(){Mn.debug("PlaybackController.deactivate()"),e._isActive=!1,yield e.stop(),e._dispatcher.unsubscribe(Dn.playbackStateDidChange,e.onPlaybackStateDidChange),e._skipIntro.deactivate(),e._upNext.deactivate(),e._rollMonitor.deactivate()}))()}destroy(){var e=this;return _async_to_generator$F((function*(){e._isDestroyed=!0,yield e.deactivate(),e._dispatcher.unsubscribe(Dn.autoplayEnabledDidChange,e.updateAutoplay)}))()}pause(e){var t=this;return _async_to_generator$F((function*(){return t._mediaItemPlayback.pause(e)}))()}play(){var e=this;return _async_to_generator$F((function*(){if(e.nowPlayingItem)return e._mediaItemPlayback.play();if(!e._queue||e._queue.isEmpty)return;if(e.nowPlayingItemIndex>=0)return e.changeToMediaAtIndex(e.nowPlayingItemIndex);const{queue:t}=e;return-1!==t.nextPlayableItemIndex?e.changeToMediaAtIndex(t.nextPlayableItemIndex):void 0}))()}playSingleMediaItem(e,t){var r=this;return _async_to_generator$F((function*(){yield Nn(e,t),r._dispatcher.publish(Dn.queueItemsDidChange,[e]);const n=yield r._mediaItemPlayback.startMediaItemPlayback(e,!0);if(n){var i;const e={item:n,position:null!==(i=r._mediaItemPlayback.currentPlaybackTime)&&void 0!==i?i:0,playingDate:r._mediaItemPlayback.currentPlayingDate,userInitiated:!0};Mn.debug("playSingleMediaItem: Dispatching DispatchTypes.playbackPlay event",e),r._dispatcher.publish(et.playbackPlay,e)}}))()}onPlaybackStateDidChange(t,r){var n=this;return _async_to_generator$F((function*(){r.state===e.PlaybackStates.ended&&(n.continuous||n.repeatMode===Gn.one)&&(Mn.debug("controller detected track ended event, moving to next item."),n._dispatcher.publish(et.applicationActivityIntent,{endReasonType:ot.TRACK_SKIPPED_FORWARDS,userInitiated:!1}),yield n._next())}))()}preload(){var e=this;return _async_to_generator$F((function*(){return e._mediaItemPlayback.preload()}))()}showPlaybackTargetPicker(){this._mediaItemPlayback.showPlaybackTargetPicker()}seekBackward(){var e=this;return _async_to_generator$F((function*(){return e._seekable.seekBackward()}))()}seekForward(){var e=this;return _async_to_generator$F((function*(){return e._seekable.seekForward(e.skipToNextItem.bind(e))}))()}skipToNextItem(){var e=this;return _async_to_generator$F((function*(){return e._next({userInitiated:!0})}))()}skipToPreviousItem(){var e=this;return _async_to_generator$F((function*(){return e._previous({userInitiated:!0})}))()}getNewSeeker(){return this._mediaItemPlayback.getNewSeeker()}seekToTime(e,t){var r=this;return _async_to_generator$F((function*(){yield r._seekable.seekToTime(e,t)}))()}replaceQueue(e,t){var r=this;return _async_to_generator$F((function*(){var n;if(yield r.extractGlobalValues(t),yield r._mediaItemPlayback.stop(),void 0!==(null==t?void 0:t.context)&&(r._context=t.context),r.setQueue(new Queue({services:{runtime:r._services.runtime,request:r._services.request,dispatcher:r._services.dispatcher},descriptor:{loaded:e,context:r.context,startWith:null!==(n=null==t?void 0:t.startWith)&&void 0!==n?n:null==t?void 0:t.startPosition},playbackMode:r.playbackMode})),0===e.length)throw Mn.warn("No items (0) are playable for new queue"),new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"No playable items for queue");if(void 0!==(null==t?void 0:t.shuffleMode)&&(r.shuffleMode=t.shuffleMode),void 0!==(null==t?void 0:t.repeatMode)&&(r.repeatMode=t.repeatMode),function(e){return"number"==typeof e&&!Number.isNaN(e)}(null==t?void 0:t.startTime)){const e=r.queue.nextPlayableItem;e&&r._mediaItemPlayback.playOptions.set(e.id,{startTime:null==t?void 0:t.startTime})}return r._dispatcher.publish("queue.created",r.queue),r._dispatcher.publish("queue.ready",r.queue),r._dispatcher.publish(Dn.queueIsReady,r.queue.items),r.queue}))()}extractGlobalValues(e){var t=this;return _async_to_generator$F((function*(){t._context=t.constructContext(e),void 0!==(null==e?void 0:e.featureName)&&e.context&&(Mn.warn("featureName is deprecated, pass it inside context"),e.context.featureName=e.featureName)}))()}stop(e){var t=this;return _async_to_generator$F((function*(){yield t._mediaItemPlayback.stop(e)}))()}_changeToMediaAtIndex(e=0,t={}){var r=this;return _async_to_generator$F((function*(){if(r.queue.isEmpty)return;r.queue.position=e;const n=r.queue.item(r.queue.position);if(!n)return;var i;const o=yield r._mediaItemPlayback.startMediaItemPlayback(n,null!==(i=t.userInitiated)&&void 0!==i&&i);if(o||n.state!==y.unsupported)return o;yield r.skipToNextItem()}))()}_next(e={}){var t=this;return _async_to_generator$F((function*(){if(t.queue.isEmpty)return;const{userInitiated:r=!1}=e;return t.repeatMode===Gn.one&&void 0!==t.queue.currentItem?(yield t.stop(_object_spread$q({userInitiated:r},e)),void(yield t.play())):(!r&&e.seamlessAudioTransition&&(t._dispatcher.publish(et.playbackStop,_object_spread$q({userInitiated:r,endReasonType:ot.NATURAL_END_OF_TRACK},e)),e={userInitiated:e.userInitiated,seamlessAudioTransition:!0}),t._nextAtIndex(t.queue.nextPlayableItemIndex,e))}))()}_nextAtIndex(t,r={}){var n=this;return _async_to_generator$F((function*(){if(n.queue.isEmpty)return;const{_mediaItemPlayback:i}=n;var o;const a=null!==(o=r.userInitiated)&&void 0!==o&&o;if(t<0)return Mn.debug("controller/index._next no next item available, stopping playback"),yield n.stop({userInitiated:a,seamlessAudioTransition:r.seamlessAudioTransition}),void(i.playbackState=e.PlaybackStates.completed);const s=n.isPlaying,c=i.currentPlaybackTime,l=yield n._changeToMediaAtIndex(t,{userInitiated:a});var d;return n._notifySkip(s,l,{userInitiated:a,seamlessAudioTransition:null!==(d=r.seamlessAudioTransition)&&void 0!==d&&d,position:c,direction:ot.TRACK_SKIPPED_FORWARDS}),l}))()}_previous(e={}){var t=this;return _async_to_generator$F((function*(){if(t.queue.isEmpty)return;const{userInitiated:r=!1}=e;if(t.repeatMode===Gn.one&&void 0!==t.queue.currentItem)return yield t.stop({endReasonType:ot.TRACK_SKIPPED_BACKWARDS,userInitiated:r}),void(yield t.play());const n=t.queue.previousPlayableItemIndex;if(r&&t.repeatMode===Gn.none&&void 0!==t.nowPlayingItem&&-1===n)return yield t.stop({endReasonType:ot.TRACK_SKIPPED_BACKWARDS,userInitiated:!0}),void(yield t.play());if(-1===n)return;const i=t.isPlaying,o=t._mediaItemPlayback.currentPlaybackTime,a=yield t._changeToMediaAtIndex(n,{userInitiated:r});return t._notifySkip(i,a,{userInitiated:r,seamlessAudioTransition:!1,direction:ot.TRACK_SKIPPED_BACKWARDS,position:o}),a}))()}_notifySkip(e,t,r){const{userInitiated:n,direction:i,position:o,seamlessAudioTransition:a=!1}=r,s=this._dispatcher;a?(Mn.debug("seamlessAudioTransition transition, PAF play"),s.publish(et.playbackPlay,{item:t,position:0,endReasonType:ot.NATURAL_END_OF_TRACK})):e?t?s.publish(et.playbackSkip,{item:t,userInitiated:n,direction:i,position:o}):s.publish(et.playbackStop,{item:t,userInitiated:n,position:o}):t&&s.publish(et.playbackPlay,_object_spread$q({item:t,playingDate:this._mediaItemPlayback.currentPlayingDate,position:0},n?{endReasonType:ot.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM}:{}))}setQueue(e){return Mn.trace("PlaybackController.prepareQueue()"),this.hasAuthorization&&(e.isRestricted=this.storekit.restrictedEnabled||!1),e.repeatable=this._repeatable,this._queue=e,this._shuffler.queue=this._queue,this._dispatcher.publish(hi,e.items),e}constructor(e){var t;_define_property$K(this,"_continuous",void 0),_define_property$K(this,"_context",{}),_define_property$K(this,"_autoplayEnabled",void 0),_define_property$K(this,"_playerOptions",void 0),_define_property$K(this,"_queue",void 0),_define_property$K(this,"_storekit",void 0),_define_property$K(this,"_repeatable",void 0),_define_property$K(this,"_shuffler",void 0),_define_property$K(this,"_seekable",void 0),_define_property$K(this,"_services",void 0),_define_property$K(this,"_rollMonitor",void 0),_define_property$K(this,"_skipIntro",void 0),_define_property$K(this,"_upNext",void 0),_define_property$K(this,"_playbackMode",void 0),_define_property$K(this,"_isActive",!1),_define_property$K(this,"_isDestroyed",!1),this.onPlaybackStateDidChange=this.onPlaybackStateDidChange.bind(this),this._autoplayEnabled=null!==(t=null==e?void 0:e.autoplayEnabled)&&void 0!==t&&t,this._continuous=!1,this._services=e.services,this._playerOptions=e,this.storekit=e.storekit,this._skipIntro=new SkipAvailable({controller:this,services:e.services}),this._upNext=new UpNextMonitor({controller:this,services:e.services}),this._rollMonitor=new RollMonitor({controller:this,services:e.services}),this._shuffler=new BaseShuffler,this._seekable=new BaseSeekable(this._mediaItemPlayback),this._repeatable=new BaseRepeatable,this._dispatcher.subscribe(Dn.autoplayEnabledDidChange,this.updateAutoplay),this._playbackMode=e.playbackMode}}function _define_property$J(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$h(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$h(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$i("design:type",Function),_ts_metadata$i("design:paramtypes",[String,Boolean]),_ts_metadata$i("design:returntype",void 0)],PlaybackController.prototype,"updateAutoplay",null);class MediaSessionManager{onCapabilitiesChanged(){this._resetHandlers(),this._setMediaSessionHandlers()}onNowPlayingItemDidChange(e,{item:t}){this._setMediaSessionMetadata(t)}_setMediaSessionMetadata(e){var t,r;this.session&&"MediaMetadata"in window&&e&&(this.session.metadata=new window.MediaMetadata({title:e.title,artist:null!==(r=e.artistName)&&void 0!==r?r:null===(t=e.attributes)||void 0===t?void 0:t.showTitle,album:e.albumName,artwork:e.artwork?[96,128,192,256,384,512].map(t=>({src:formatArtworkURL(e.artwork,t,t),sizes:`${t}x${t}`,type:"image/jpeg"})):[]}))}_setMediaSessionHandlers(){this.session&&(this._resetHandlers(),this.session.setActionHandler("play",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.play()}),this.capabilities.canPause?this.session.setActionHandler("pause",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.pause()}):this.session.setActionHandler("pause",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.stop()}),this.capabilities.canSeek&&(this.session.setActionHandler("seekforward",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.seekForward()}),this.session.setActionHandler("seekbackward",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.seekBackward()})),this.capabilities.canSkipToNextItem&&this.session.setActionHandler("nexttrack",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.skipToNextItem()}),this.capabilities.canSkipToPreviousItem&&this.session.setActionHandler("previoustrack",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.skipToPreviousItem()}))}_resetHandlers(){this.session&&(this.session.setActionHandler("play",void 0),this.session.setActionHandler("pause",void 0),this.session.setActionHandler("seekforward",void 0),this.session.setActionHandler("seekbackward",void 0),this.session.setActionHandler("nexttrack",void 0),this.session.setActionHandler("previoustrack",void 0))}constructor(e,t){_define_property$J(this,"capabilities",void 0),_define_property$J(this,"dispatcher",void 0),_define_property$J(this,"controller",void 0),_define_property$J(this,"session",void 0),this.capabilities=e,this.dispatcher=t,this.session=navigator.mediaSession,this.session&&(this.dispatcher.subscribe(Dn.nowPlayingItemDidChange,this.onNowPlayingItemDidChange),this.dispatcher.subscribe(Dn.capabilitiesChanged,this.onCapabilitiesChanged),this._setMediaSessionHandlers())}}function _define_property$I(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var yi;_ts_decorate$h([Bind(),_ts_metadata$h("design:type",Function),_ts_metadata$h("design:paramtypes",[]),_ts_metadata$h("design:returntype",void 0)],MediaSessionManager.prototype,"onCapabilitiesChanged",null),_ts_decorate$h([Bind(),_ts_metadata$h("design:type",Function),_ts_metadata$h("design:paramtypes",[void 0,void 0]),_ts_metadata$h("design:returntype",void 0)],MediaSessionManager.prototype,"onNowPlayingItemDidChange",null),function(e){e[e.PAUSE=0]="PAUSE",e[e.EDIT_QUEUE=1]="EDIT_QUEUE",e[e.SEEK=2]="SEEK",e[e.REPEAT=3]="REPEAT",e[e.SHUFFLE=4]="SHUFFLE",e[e.SKIP_NEXT=5]="SKIP_NEXT",e[e.SKIP_PREVIOUS=6]="SKIP_PREVIOUS",e[e.SKIP_TO_ITEM=7]="SKIP_TO_ITEM",e[e.AUTOPLAY=8]="AUTOPLAY",e[e.VOLUME=9]="VOLUME"}(yi||(yi={}));class Capabilities{set controller(e){this._mediaSession.controller=e}updateChecker(e){this._checkCapability!==e&&(this._checkCapability=e,this._dispatcher.publish(Dn.capabilitiesChanged))}get canEditPlaybackQueue(){return this._checkCapability(1)}get canPause(){return this._checkCapability(0)}get canSeek(){return this._checkCapability(2)}get canSetRepeatMode(){return this._checkCapability(3)}get canSetShuffleMode(){return this._checkCapability(4)}get canSkipToNextItem(){return this._checkCapability(5)}get canSkipToMediaItem(){return this._checkCapability(7)}get canSkipToPreviousItem(){return this._checkCapability(6)}get canAutoplay(){return this._checkCapability(8)}get canSetVolume(){return this._checkCapability(9)}constructor(e){_define_property$I(this,"_dispatcher",void 0),_define_property$I(this,"_checkCapability",void 0),_define_property$I(this,"_mediaSession",void 0),this._dispatcher=e,this._checkCapability=e=>9===e,this._mediaSession=new MediaSessionManager(this,e)}}function asyncGeneratorStep$E(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$E(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$E(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$E(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$H(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$g(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$g(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}class ContinuousPlaybackController extends PlaybackController{get continuous(){return!0}set continuous(e){if(!0!==e)throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Continuous playback cannot be disabled for station queues.")}get isLive(){return this._isLiveStation}set isLive(e){e!==this._isLiveStation&&(this._isLiveStation=e,this._dispatcher.publish(Dn.capabilitiesChanged))}get isTracksStation(){return this._isTracksStation}set isTracksStation(e){e!==this._isTracksStation&&(this._isTracksStation=e,this._dispatcher.publish(Dn.capabilitiesChanged))}changeToMediaItem(e){return _async_to_generator$E((function*(){Mn.warn("changeToMediaItem is not supported for this type of playback")}))()}hasCapabilities(e){switch(e){case yi.VOLUME:return!0;case yi.PAUSE:case yi.SKIP_NEXT:case yi.SKIP_PREVIOUS:case yi.SEEK:return!this.isLive;case yi.SKIP_TO_ITEM:case yi.AUTOPLAY:case yi.EDIT_QUEUE:case yi.SHUFFLE:case yi.REPEAT:default:return!1}}pause(e){var t=this,_superprop_get_pause=()=>super.pause;return _async_to_generator$E((function*(){if(!t.isLive)return _superprop_get_pause().call(t,e);Mn.warn("pause is not supported for this type of playback")}))()}skipToPreviousItem(){var e=this,_superprop_get_skipToPreviousItem=()=>super.skipToPreviousItem;return _async_to_generator$E((function*(){if(!e.isLive)return _superprop_get_skipToPreviousItem().call(e);Mn.warn("skipToPreviousItem is not supported for this type of playback")}))()}replaceQueue(e,t){var r=this,_superprop_get_replaceQueue=()=>super.replaceQueue;return _async_to_generator$E((function*(){var n;const i=e[0];if(void 0===i)throw new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"No Queue item");if(!isRadioStation(i))throw new MKError(MKError.Reason.MEDIA_DESCRIPTOR,"Item is not a Radio Station");return r.station=i,r.isLive=!!(null==i?void 0:i.isLiveRadioStation)||!!(null==i||null===(n=i.attributes)||void 0===n?void 0:n.isLive),r.isTracksStation=isTracksRadioStation(i),r._context=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$H(e,t,r[t])}))}return e}({featureName:nt.STATION},null==t?void 0:t.context),r._seekable=r.isLive?new BaseSeekable(r._mediaItemPlayback):new Seekable(r._dispatcher,r._mediaItemPlayback),r.isTracksStation?e=yield r.loadNextTracks(r.station,{context:r.context}):(e.length>1&&Mn.warn(`Attempting to play multiple Live Radio Station items (${e.length})`),e=[i]),_superprop_get_replaceQueue().call(r,e,{context:r.context})}))()}appendToQueue(e){return _async_to_generator$E((function*(){throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Appending to the Queue is not supported for this type of playback")}))()}insertInQueue(e,t){return _async_to_generator$E((function*(){throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Inserting into the Queue is not supported for this type of playback")}))()}prependToQueue(e,t){return _async_to_generator$E((function*(){throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Prepending to the Queue is not supported for this type of playback")}))()}clearQueue(){return _async_to_generator$E((function*(){throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Clearing the Queue is not supported for this type of playback")}))()}getNewSeeker(){return this.hasCapabilities(yi.SEEK)?super.getNewSeeker():new UnsupportedSeeker}skipToNextItem(){var e=this,_superprop_get_skipToNextItem=()=>super.skipToNextItem;return _async_to_generator$E((function*(){if(!e.isLive)return _superprop_get_skipToNextItem().call(e);Mn.warn("Method skipToNextItem is not supported for this type of playback")}))()}loadNextTracks(e,t){var r=this;return _async_to_generator$E((function*(){if(0===(null==t?void 0:t.limit))return Mn.warn("Not loading next tracks, limit is set to zero (0)"),[];var n;Mn.debug("Loading tracks for station "+e.id);let i=yield r._services.itemLoader.loadStationNextTracks(e.id,{container:null!==(n=null==t?void 0:t.container)&&void 0!==n?n:e,context:null==t?void 0:t.context,limit:null==t?void 0:t.limit});var o;if(Mn.debug(`Loaded ${i.length} tracks for station ${e.id}`),0===i.length)throw Mn.warn("No track data is available for the current station",{stationId:null===(o=r.station)||void 0===o?void 0:o.id}),new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"No track data is available for the current station.");return"number"==typeof(null==t?void 0:t.limit)&&t.limit>0&&(i=i.slice(0,t.limit)),i}))()}queueNextTracks(){var e=this;return _async_to_generator$E((function*(){if(!e.isActive)return void Mn.debug("Not loading next tracks, controller is not active");if(void 0===e.station||!e.isTracksStation)return void Mn.debug("Not loading next tracks, not a tracks radio station");if(e.queue.isEmpty)return void Mn.debug("Not loading next tracks, queue is empty");if(-1!==e.queue.nextPlayableItemIndex)return void Mn.debug("Not loading next tracks, enough playable items in queue");const t=yield e.loadNextTracks(e.station,{context:e.context,limit:1});t.length>0&&(Mn.debug(`Queueing ${t.length} ${1===t.length?"track":"tracks"}`),e.queue.append(t))}))()}activate(){var e=this,_superprop_get_activate=()=>super.activate;return _async_to_generator$E((function*(){yield _superprop_get_activate().call(e),e._dispatcher.subscribe(Dn.queuePositionDidChange,e.queueNextTracks),e.queueNextTracks()}))()}deactivate(){var e=this,_superprop_get_deactivate=()=>super.deactivate;return _async_to_generator$E((function*(){yield _superprop_get_deactivate().call(e),e._dispatcher.unsubscribe(Dn.queuePositionDidChange,e.queueNextTracks)}))()}constructor(e){super(e),_define_property$H(this,"type",pi.continuous),_define_property$H(this,"_isLiveStation",!1),_define_property$H(this,"_isTracksStation",!1),_define_property$H(this,"station",void 0),this._continuous=!0}}function asyncGeneratorStep$D(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _define_property$G(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$f(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$f(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}_ts_decorate$g([Bind(),_ts_metadata$g("design:type",Function),_ts_metadata$g("design:paramtypes",[void 0===yi?Object:yi]),_ts_metadata$g("design:returntype",Boolean)],ContinuousPlaybackController.prototype,"hasCapabilities",null),_ts_decorate$g([Bind(),_ts_metadata$g("design:type",Function),_ts_metadata$g("design:paramtypes",[]),_ts_metadata$g("design:returntype",Promise)],ContinuousPlaybackController.prototype,"queueNextTracks",null);class PercentageWatcher{startMonitor(){this.dispatcher.unsubscribe(Dn.playbackDurationDidChange,this.updateThreshold),this.dispatcher.unsubscribe(Dn.playbackTimeDidChange,this.handleTimeChange),this.dispatcher.subscribe(Dn.playbackDurationDidChange,this.updateThreshold),this.dispatcher.subscribe(Dn.playbackTimeDidChange,this.handleTimeChange)}stopMonitor(){this.dispatcher.unsubscribe(Dn.playbackDurationDidChange,this.updateThreshold),this.dispatcher.unsubscribe(Dn.playbackTimeDidChange,this.handleTimeChange),this.threshold=-1}handleTimeChange(e,{currentPlaybackDuration:t,currentPlaybackTime:r}){var n=this;return function(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$D(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$D(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}((function*(){n.threshold<0&&n.updateThreshold(e,{duration:t}),r<n.threshold||(n.stopMonitor(),yield n.callback(r,n))}))()}updateThreshold(e,{duration:t}){this.threshold=t*this.percentage}constructor(e,t,r){_define_property$G(this,"dispatcher",void 0),_define_property$G(this,"callback",void 0),_define_property$G(this,"percentage",void 0),_define_property$G(this,"threshold",void 0),this.dispatcher=e,this.callback=t,this.percentage=r,this.threshold=-1}}function asyncGeneratorStep$C(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}_ts_decorate$f([Bind(),_ts_metadata$f("design:type",Function),_ts_metadata$f("design:paramtypes",[void 0,void 0]),_ts_metadata$f("design:returntype",Promise)],PercentageWatcher.prototype,"handleTimeChange",null),_ts_decorate$f([Bind(),_ts_metadata$f("design:type",Function),_ts_metadata$f("design:paramtypes",[void 0,void 0]),_ts_metadata$f("design:returntype",void 0)],PercentageWatcher.prototype,"updateThreshold",null);class Preloader extends PlaybackMonitor{handlePlaybackThreshold(){var e=this;return function(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$C(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$C(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}((function*(){yield e.playbackController.prepareToPlayNextItem()}))()}shouldMonitor(){if(!super.shouldMonitor())return!1;if(!this.playbackController.hasAuthorization||this.playbackController.previewOnly)return!1;const e=this.getNextPlayableItem(),t=void 0!==e;return this.isSeamlessAudioTransitionsEnabled?t:t&&!(null==e?void 0:e.isPreparedToPlay)}getNextPlayableItem(){return this.playbackController.queue.nextPlayableItem}constructor(e){super(e),function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"isSeamlessAudioTransitionsEnabled",!1),this.watchers=[new PercentageWatcher(this.dispatcher,this.handlePlaybackThreshold,.3)],this.isSeamlessAudioTransitionsEnabled=qn.features["seamless-audio-transitions"]}}function asyncGeneratorStep$B(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$B(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$B(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$B(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$E(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$E(e,t,r[t])}))}return e}function _object_spread_props$f(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _ts_decorate$e(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$e(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}class SerialPlaybackController extends PlaybackController{get autoplayStation(){return this._autoplayStation}get autoplayStarted(){return void 0!==this._autoplayStation}get autoplayEnabled(){return this._autoplayEnabled}set autoplayEnabled(e){this._autoplayEnabled=e,!0===e?this.startAutoplay():this.stopAutoplay()}activate(){var e=this,_superprop_get_activate=()=>super.activate;return _async_to_generator$B((function*(){yield _superprop_get_activate().call(e),e._preloader.activate(),e._dispatcher.subscribe(Dn.repeatModeDidChange,e.onRepeatModeChange),e._dispatcher.subscribe(Dn.queueItemsDidChange,e.onQueueChange),e._dispatcher.subscribe(Dn.queuePositionDidChange,e.onQueueChange),e._dispatcher.subscribe(Dn.nowPlayingItemDidChange,e.onQueueChange),e._dispatcher.subscribe(Hr,e.onSeamlessAudioTransition)}))()}deactivate(){var e=this,_superprop_get_deactivate=()=>super.deactivate;return _async_to_generator$B((function*(){yield _superprop_get_deactivate().call(e),e._preloader.deactivate(),e._dispatcher.unsubscribe(Dn.repeatModeDidChange,e.onRepeatModeChange),e._dispatcher.unsubscribe(Dn.queueItemsDidChange,e.onQueueChange),e._dispatcher.unsubscribe(Dn.queuePositionDidChange,e.onQueueChange),e._dispatcher.unsubscribe(Dn.nowPlayingItemDidChange,e.onQueueChange),e._dispatcher.unsubscribe(Hr,e.onSeamlessAudioTransition),yield e.stopAutoplay()}))()}hasCapabilities(e){switch(e){case yi.EDIT_QUEUE:case yi.SKIP_NEXT:case yi.SKIP_TO_ITEM:case yi.AUTOPLAY:case yi.VOLUME:case yi.SKIP_PREVIOUS:return!0;case yi.REPEAT:case yi.SHUFFLE:var t,r;return!(null===(r=this.queue)||void 0===r||null===(t=r.currentQueueItem)||void 0===t?void 0:t.isAutoplay);case yi.PAUSE:case yi.SEEK:var n;return!(null===(n=this.nowPlayingItem)||void 0===n?void 0:n.isAssetScrubbingDisabled);default:return!1}}onSeamlessAudioTransition(e,t){var r=this;return _async_to_generator$B((function*(){Mn.trace("onSeamlessAudioTransition",t),r._next({userInitiated:!1,seamlessAudioTransition:!0,endReasonType:ot.NATURAL_END_OF_TRACK,position:t.previous.playbackDuration/1e3,isPlaying:!1})}))()}onRepeatModeChange(){var e=this;return _async_to_generator$B((function*(){e.repeatMode===Gn.none?(Mn.debug("Queueing Autoplay tracks after RepeatMode change"),yield e.queueAutoplayTracks()):(Mn.debug("Removing Autoplay tracks after RepeatMode change"),e.queue.removeQueueItems((t,r)=>r>e.queue.position&&t.isAutoplay)),e.repeatMode!==Gn.one&&e.prepareToPlayNextItem()}))()}onQueueChange(){var e=this;return _async_to_generator$B((function*(){e.queue.isEmpty||(yield e.queueAutoplayTracks()),e.prepareToPlayNextItem()}))()}prepareToPlayNextItem(){var e=this;return _async_to_generator$B((function*(){const t=e.queue.nextPlayableItem;if(Mn.debug("SerialController - preparing to play next item",t),t&&e.queue.currentItem!==t)try{return e._mediaItemPlayback.prepareToPlay(t)}catch(r){Mn.debug("next item failed to prepare for playbck -",r)}}))()}appendToQueue(e){var t=this;return _async_to_generator$B((function*(){return t.queue.splice(t.queue.appendTargetIndex,0,e),t.queue}))()}insertInQueue(e,t){var r=this;return _async_to_generator$B((function*(){return r.queue.splice(t,0,e),r.queue}))()}prependToQueue(e,t){var r=this;return _async_to_generator$B((function*(){return!0===(null==t?void 0:t.clear)&&r.queue.clearAfterCurrent(),r.queue.splice(r.queue.position+1,0,e),r.queue}))()}clearQueue(){var e=this;return _async_to_generator$B((function*(){return e.queue.clear(),e.queue}))()}replaceQueue(e,t){var r=this,_superprop_get_replaceQueue=()=>super.replaceQueue;return _async_to_generator$B((function*(){const n=yield _superprop_get_replaceQueue().call(r,e,t);return yield r.stopAutoplay(),yield r.startAutoplay(),n}))()}stopAutoplay(){var e=this;return _async_to_generator$B((function*(){Mn.trace("SerialController.stopAutoplay()"),e._autoplayStation=void 0,e.queue.hasAutoplayStation=!1,Mn.debug("Removing unplayed Autoplay tracks from Queue"),e.queue.removeQueueItems((t,r)=>r>e.queue.position&&!0===t.isAutoplay)}))()}startAutoplay(){var e=this;return _async_to_generator$B((function*(){var t;if(Mn.trace("SerialController.startAutoplay()"),!e.isActive)return void Mn.debug("Not starting autoplay, not active");if(!e.autoplayEnabled)return void Mn.debug("Not starting autoplay, not enabled");if(e.repeatMode!==Gn.none)return void Mn.debug("Not starting autoplay, repeat mode is on");if(void 0!==e.autoplayStation)return void Mn.debug("Autoplay station already created");if(e.loadingAutoplayStation)return void Mn.debug("Autoplay station already loading");const r=e.queue.items.slice(-e.maxTracksForAutoplayStation);if(0===r.length)return void Mn.debug("No items in queue to start Autoplay station");e.loadingAutoplayStation=!0;const n=null===(t=e.queue.userAddedItems.slice(-1))||void 0===t?void 0:t.pop();let i,o;void 0!==(null==n?void 0:n.container)&&(i={id:n.container.id,type:n.container.type});try{Mn.info(`Creating Autoplay station with ${r.length} ${1===r.length?"item":"items"}`);o=(yield e._services.itemLoader.createAutoplayStation(e.queue.items.slice(-e.maxTracksForAutoplayStation),{container:i})).station}catch(De){Mn.warning("Unable to create Autoplay station: "+De.message)}void 0===o?Mn.info("Unable to create Autoplay station: no server data"):Mn.info("Created Autoplay Station "+(null==o?void 0:o.id)),e._autoplayStation=o,e.queue.hasAutoplayStation=void 0!==o,e.loadingAutoplayStation=!1,yield e.queueAutoplayTracks()}))()}queueAutoplayTracks(e){var t=this;return _async_to_generator$B((function*(){var r,n;if(void 0===t._autoplayStation)return void Mn.debug("Skipping loading Autoplay tracks, no autoplay station");if(0===(null==e?void 0:e.limit))return void Mn.warn("Skipping loading Autoplay tracks, track limit set to 0");if(t.queue.unplayedUserItems.length>t.autoplayQueueSizeThreshold)return void Mn.debug(`Skipping loading Autoplay tracks, more than ${t.autoplayQueueSizeThreshold} user added tracks in the queue `);if(t.loadingAutoplayTracks)return void Mn.debug("Skipping loading Autoplay tracks, already loading");const i=t.autoplayUpcomingTracksLimit-t.queue.unplayedAutoplayItems.length+((null===(r=t.queue.currentQueueItem)||void 0===r?void 0:r.isAutoplay)?1:0);if(i<=0)return void Mn.debug(`Skipping loading Autoplay tracks, ${t.autoplayUpcomingTracksLimit} autoplay items already in the queue`);t.loadingAutoplayTracks=!0,Mn.debug(`Loading next tracks from Autoplay station ${t._autoplayStation.id} (amount: ${i})`);let o=yield t._services.itemLoader.loadStationNextTracks(t._autoplayStation.id,{limit:i,container:t._autoplayStation,context:_object_spread_props$f(_object_spread$o({},t.context),{featureName:"now_playing",reco_id:(null===(n=t.context.featureName)||void 0===n?void 0:n.startsWith("listen-now"))?void 0:t.context.reco_id})});"number"==typeof(null==e?void 0:e.limit)&&e.limit>0&&(o=o.slice(0,e.limit)),Mn.debug(`Queueing ${o.length} tracks from Autoplay station ${t._autoplayStation.id}`),t.queue.appendQueueItems(o.map(e=>new QueueItem(e,{isAutoplay:!0}))),t.loadingAutoplayTracks=!1}))()}_changeToMediaAtIndex(e=0,t={userInitiated:!1}){var r=this,_superprop_get__changeToMediaAtIndex=()=>super._changeToMediaAtIndex;return _async_to_generator$B((function*(){return yield _superprop_get__changeToMediaAtIndex().call(r,e,t)}))()}get shouldTransitionSeamlessly(){return this._isSeamlessAudioTransitionsEnabled&&this.hasAuthorization&&!this.previewOnly}constructor(e){var t,r,n,i,o,a,s,c,l,d;super(e),_define_property$E(this,"type",pi.serial),_define_property$E(this,"_preloader",void 0),_define_property$E(this,"_isSeamlessAudioTransitionsEnabled",void 0),_define_property$E(this,"autoplayQueueSizeThreshold",void 0),_define_property$E(this,"autoplayUpcomingTracksLimit",void 0),_define_property$E(this,"maxTracksForAutoplayStation",void 0),_define_property$E(this,"_autoplayStation",void 0),_define_property$E(this,"loadingAutoplayStation",!1),_define_property$E(this,"loadingAutoplayTracks",!1),this._queue=new Queue(e),this._repeatable=new Repeatable(this._dispatcher),this._seekable=new Seekable(this._dispatcher,this._mediaItemPlayback),this._shuffler=new Shuffler(this,{dispatcher:this._dispatcher}),this._isSeamlessAudioTransitionsEnabled=!!(null==e||null===(t=e.bag)||void 0===t?void 0:t.features["seamless-audio-transitions"]),this.autoplayQueueSizeThreshold=null!==(c=null==e||null===(n=e.bag)||void 0===n||null===(r=n.autoplay)||void 0===r?void 0:r.maxQueueSizeForAutoplay)&&void 0!==c?c:50,this.autoplayUpcomingTracksLimit=null!==(l=null==e||null===(o=e.bag)||void 0===o||null===(i=o.autoplay)||void 0===i?void 0:i.maxUpcomingTracksToMaintain)&&void 0!==l?l:10,this.maxTracksForAutoplayStation=null!==(d=null==e||null===(s=e.bag)||void 0===s||null===(a=s.autoplay)||void 0===a?void 0:a.maxQueueSizeInRequest)&&void 0!==d?d:10;const u={controller:this,services:e.services};this._preloader=new Preloader(u)}}function _define_property$D(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}_ts_decorate$e([Bind(),_ts_metadata$e("design:type",Function),_ts_metadata$e("design:paramtypes",[void 0===yi?Object:yi]),_ts_metadata$e("design:returntype",Boolean)],SerialPlaybackController.prototype,"hasCapabilities",null),_ts_decorate$e([Bind(),_ts_metadata$e("design:type",Function),_ts_metadata$e("design:paramtypes",[String,Object]),_ts_metadata$e("design:returntype",Promise)],SerialPlaybackController.prototype,"onSeamlessAudioTransition",null),_ts_decorate$e([Bind(),_ts_metadata$e("design:type",Function),_ts_metadata$e("design:paramtypes",[]),_ts_metadata$e("design:returntype",Promise)],SerialPlaybackController.prototype,"onRepeatModeChange",null),_ts_decorate$e([Bind(),_ts_metadata$e("design:type",Function),_ts_metadata$e("design:paramtypes",[]),_ts_metadata$e("design:returntype",Promise)],SerialPlaybackController.prototype,"onQueueChange",null),_ts_decorate$e([Bind(),_ts_metadata$e("design:type",Function),_ts_metadata$e("design:paramtypes",[]),_ts_metadata$e("design:returntype",Promise)],SerialPlaybackController.prototype,"prepareToPlayNextItem",null);class MKDialog{static presentError(e){const t=e.dialog;void 0!==t?MKDialog.serverDialog(t).present():new MKDialog(e.message).present()}static serverDialog(e){const t=new this(e.message,e.explanation);return e.okButtonAction&&e.okButtonAction.url&&(t._okButtonActionURL=e.okButtonAction.url),e.okButtonString&&(t._okButtonString=e.okButtonString),e.cancelButtonString&&(t._cancelButtonString=e.cancelButtonString),t}static clientDialog(e){const t=new this(e.message,e.explanation);return e.okButtonAction&&(t._okButtonAction=e.okButtonAction),e.cancelButtonAction&&(t._cancelButtonAction=e.cancelButtonAction),e.okButtonString&&(t._okButtonString=e.okButtonString),e.cancelButtonString&&(t._cancelButtonString=e.cancelButtonString),t}get actions(){return this.cancelButton?`<div id="mk-dialog-actions">${this.cancelButton}${this.okButton}</div>`:`<div id="mk-dialog-actions">${this.okButton}</div>`}get cancelButton(){if("string"==typeof this._cancelButtonString)return`<button type="button">${this._cancelButtonString}</button>`}set cancelButton(e){this._cancelButtonString=e}get explanation(){return`<p id="mk-dialog-explanation">${this._explanation}</p>`}get hasOKButtonAction(){return!!this._okButtonActionURL||!!this._okButtonAction}get message(){return`<h5 id="mk-dialog-title">${this._message}</h5>`}get okButton(){return this.hasOKButtonAction&&this._okButtonActionURL?`<button type="button" data-ok-action-url='${this._okButtonActionURL}'>${this._okButtonString}</button>`:`<button type="button">${this._okButtonString}</button>`}present(){const e=document.createDocumentFragment(),t=document.createElement("div");t.id=this.scrimId,e.appendChild(t);const r=document.createElement("div");r.id=this.id,r.classList.add("mk-dialog"),r.setAttribute("role","alertDialog"),r.setAttribute("aria-modal","true"),r.setAttribute("aria-labeledby","mk-dialog-title"),r.setAttribute("aria-describedby","mk-dialog-explanation");let n=`\n      <div id="mk-dialog-body">\n        ${this.message}\n        ${this.explanation}\n      </div>`;n=`\n      ${n}\n      ${this.actions}\n    `,r.innerHTML=n,e.appendChild(r),document.body.appendChild(e),document.querySelector(`#${r.id} #mk-dialog-actions *:first-child`).focus(),setTimeout(()=>{document.querySelector(`#${r.id} #mk-dialog-actions *:first-child`).addEventListener("click",()=>{this._cancelButtonAction&&this._cancelButtonAction(),r.parentElement.removeChild(r),t.parentElement.removeChild(t)}),this.hasOKButtonAction&&(this._okButtonActionURL?document.querySelector(`#${r.id} #mk-dialog-actions *:last-child`).addEventListener("click",e=>{window.open(e.target.dataset.okActionUrl,"_blank"),r.parentElement.removeChild(r),t.parentElement.removeChild(t)}):this._okButtonAction&&document.querySelector(`#${r.id} #mk-dialog-actions *:last-child`).addEventListener("click",e=>{this._okButtonAction(),r.parentElement.removeChild(r),t.parentElement.removeChild(t)}))})}_appendStyle(e){const t=document.createElement("style");t.id=this.styleId,t.styleSheet?t.styleSheet.cssText=e:t.innerHTML=e,document.body.appendChild(t)}constructor(e,t=""){_define_property$D(this,"_message",void 0),_define_property$D(this,"_explanation",void 0),_define_property$D(this,"id",void 0),_define_property$D(this,"scrimId",void 0),_define_property$D(this,"styleId",void 0),_define_property$D(this,"_cancelButtonString",void 0),_define_property$D(this,"_cancelButtonAction",void 0),_define_property$D(this,"_okButtonAction",void 0),_define_property$D(this,"_okButtonActionURL",void 0),_define_property$D(this,"_okButtonString",void 0),this._message=e,this._explanation=t,this.id="musickit-dialog",this.scrimId=this.id+"-scrim",this.styleId=this.id+"-style",this._okButtonString="OK",[this.id,this.scrimId,this.styleId].forEach(e=>{try{const t=document.getElementById(e);t.parentElement.removeChild(t)}catch(t){}}),this._appendStyle("\n#musickit-dialog {\n  --mk-dialog-background: rgba(255, 255, 255, 1);\n  --mk-dialog-text: rgba(0, 0, 0, 0.95);\n  --mk-dialog-border: rgba(0, 0, 0, 0.07);\n  --mk-dialog-scrim: rgba(255, 255, 255, 0.8);\n  --mk-dialog-primary: rgba(0, 122, 255, 1);\n}\n\n@media (prefers-color-scheme: dark) {\n  #musickit-dialog {\n      --mk-dialog-background: rgba(30, 30, 30, 1);\n      --mk-dialog-text: rgba(255, 255, 255, 0.85);\n      --mk-dialog-border: rgba(255, 255, 255, 0.1);\n      --mk-dialog-scrim: rgba(38, 38, 38, 0.8);\n      --mk-dialog-primary: rgba(8, 132, 255, 1);\n  }\n}\n\n#musickit-dialog-scrim {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  width: 100%;\n  height: 100%;\n  background: rgba(0, 0, 0, 0.35);\n}\n\n#musickit-dialog * {\n  -webkit-tap-highlight-color: transparent;\n  -webkit-touch-callout: none;\n  -ms-touch-action: none;\n  -webkit-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n  font-family: -apple-system, SF UI Text, Helvetica Neue, Helvetica, sans-serif;\n  font-size: 15px;\n  line-height: 20px;\n}\n\n#musickit-dialog *:focus { outline: 0; }\n\n#musickit-dialog {\n  display: -webkit-box;\n  display: -moz-box;\n  display: -ms-flexbox;\n  display: -webkit-flex;\n  display: flex;\n  -webkit-flex-direction: column;\n  -moz-flex-direction: column;\n  flex-direction: column;\n  -webkit-justify-content: space-between;\n  -moz-justify-content: space-between;\n  justify-content: space-between;\n  min-width: 277px;\n  max-width: 290px;\n  min-height: 109px;\n  background: var(--mk-dialog-background);\n  box-shadow: 0px 0px 9px rgba(0, 0, 0, 0.18);\n  border-radius: 10px;\n  color: var(--mk-dialog-text);\n  position: fixed;\n  top: 50%;\n  left: 50%;\n  margin-left: -142px;\n  margin-top: -67px;\n  z-index: 9999999999999999999999999;\n}\n\n#musickit-dialog #mk-dialog-body {\n  display: -webkit-box;\n  display: -moz-box;\n  display: -ms-flexbox;\n  display: -webkit-flex;\n  display: flex;\n  -webkit-flex-direction: column;\n  -moz-flex-direction: column;\n  flex-direction: column;\n  flex-grow: 1;\n  -webkit-justify-content: space-evenly;\n  -moz-justify-content: space-evenly;\n  justify-content: space-evenly;\n  -webkit-align-items: stretch;\n  align-items: stretch;\n  padding: 10px 20px;\n  min-height: 74px;\n  text-align: center;\n}\n\n#musickit-dialog .mk-dialog h5 {\n  font-weight: 500;\n  line-height: 20px;\n  margin: 7px 0 0 0;\n  padding: 0;\n}\n\n#musickit-dialog .mk-dialog p {\n  margin: 0 0 7px 0;\n  padding: 0;\n  paddin-top: 3px;\n  line-height: 18px;\n  font-size: 13px;\n  font-weight: 300;\n}\n\n#musickit-dialog #mk-dialog-actions {\n  border-top: 1px solid var(--mk-dialog-border);\n  display: -webkit-box;\n  display: -moz-box;\n  display: -ms-flexbox;\n  display: -webkit-flex;\n  display: flex;\n  -webkit-flex-direction: row;\n  -moz-flex-direction: colrowumn;\n  flex-direction: row;\n  max-height: 41px;\n  min-height: 34px;\n  -webkit-justify-self: flex-end;\n  -moz-justify-self: flex-end;\n  justify-self: flex-end;\n}\n\n#musickit-dialog #mk-dialog-actions button {\n  flex-grow: 1;\n  border: 0;\n  background: none;\n  color: var(--mk-dialog-primary);\n  padding: 0;\n  margin: 0;\n  min-height: 34px;\n  height: 41px;\n  text-align: center;\n}\n\n#musickit-dialog #mk-dialog-actions *:nth-child(2) {\n  border-left: 1px solid var(--mk-dialog-border);\n  font-weight: 500;\n}\n")}}function _define_property$C(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$n(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$C(e,t,r[t])}))}return e}function transformParameters(e,t=25){if(e)return e.limit&&(e.limit=e.limit>t?t:e.limit),e}function transformStoreData(e){const t=_object_spread$n({},e),{href:r}=t;return void 0!==r&&(delete t.href,t.attributes=_object_spread$n({},t.attributes,{href:r})),t}function transformTrackParameters(e){return e.map(e=>"string"==typeof e?{id:e,type:"songs"}:{id:e.id,type:e.type||"songs"})}function _define_property$B(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const fi=["extend","include","l","platform","views"];class LocalDataStore{get hasDataStore(){return this.enableDataStore&&void 0!==this._store}delete(e,t){this.hasDataStore&&this._store.remove(e,t)}read(e,t,r,n){n||"function"!=typeof r||(n=r,r=void 0);const i={};let o=!1;if(r&&(o=Object.keys(r).some(e=>/^(fields|extend)/.test(e)),r.views&&(i.views=r.views),r.include&&(i.relationships=r.include)),this.hasDataStore&&!o){let n,o=[];if(r&&(o=Object.keys(r).reduce((e,t)=>(-1===fi.indexOf(t)&&e.push([t,r[t]]),e),o)),n=o&&1===o.length?this._store.query(o[0][0],o[0][1]):this._store.peek(e,t,i),Array.isArray(n)){if(!r&&n.length)return n}else if(n)return n}if("function"==typeof n)return n()}write(e){return this._prepareDataForDataStore(e,e=>this._store.save(e))}parse(e){return this._prepareDataForDataStore(e,e=>this._store.populateDataRecords(e,{}))}_prepareDataForDataStore(e,t){return this.hasDataStore?Array.isArray(e)?t({data:e}):Object.keys(e).reduce((r,n)=>{const i=e[n];return hasOwn(i,"data")&&(r[n]=t({data:i.data})),"meta"===n&&(r[n]=e[n]),r},{}):e}constructor(e={}){_define_property$B(this,"_store",void 0),_define_property$B(this,"enableDataStore",!1);let t=!1;e.features&&hasOwn(e.features,"api-data-store")&&(this.enableDataStore=!!e.features["api-data-store"]),e.features&&hasOwn(e.features,"disable-data-store-record-reuse")&&(t=!!e.features["disable-data-store-record-reuse"]),this.enableDataStore&&(this._store=e.store||new DataStore({shouldDisableRecordReuse:t}),this._store.mapping=transformStoreData)}}function asyncGeneratorStep$A(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$A(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$A(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$A(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}const ChunkedIdApi=(e,t=100,r=1e3)=>(n,i,o)=>{if(void 0===o||"function"!=typeof o.value)throw new TypeError(`Only methods can be decorated with @ChunkedIdApi, but ${i} is not a method.`);return{configurable:!0,get(){const n=o.value;function chunkedIdApi(){return _chunkedIdApi.apply(this,arguments)}function _chunkedIdApi(){return(_chunkedIdApi=_async_to_generator$A((function*(...i){const o=i[e];if(o&&Array.isArray(o)){const a=o[0].length||20,s=Math.min(t,Math.floor(r/a)),c=Math.ceil(o.length/s);if(c>1){const t=i.slice(0,e),r=i.slice(e+1),a=[];let l=0;for(let e=1;e<=c;e++){const i=Math.min(e*s,o.length),c=[...t,o.slice(l,i),...r];a.push(n.apply(this,c)),l+=s}const d=yield Promise.all(a);return[].concat(...d)}}return n.apply(this,i)}))).apply(this,arguments)}return Object.defineProperty(this,i,{value:chunkedIdApi,configurable:!0,writable:!0}),chunkedIdApi}}},formatTimezoneOffset=(e=new Date)=>{const t=e.getTimezoneOffset(),r=Math.floor(Math.abs(t)/60),n=Math.round(Math.abs(t)%60);let i="+";return 0!==t&&(i=t>0?"-":"+"),`${i}${leadingZeros(r,2)}:${leadingZeros(n,2)}`},leadingZeros=(e,t=2)=>{let r=""+e;for(;r.length<t;)r="0"+r;return r};function asyncGeneratorStep$z(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$z(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$z(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$z(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$A(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread_props$e(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _ts_metadata$d(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}class Books extends TokenSession{audioBook(e,t,r){return this.resource("audio-books",e,t,r)}audioBooks(e,t,r){return this.collection("audio-books",e,t,r)}collection(e,t,r,n){var i=this;return _async_to_generator$z((function*(){const o=`catalog/${i.storefrontId}/${e}`;return t&&((r=r||{}).ids=t),makeRequest(i,o,r,n)}))()}parseResultData(e,t){return e?this._store.write(t):this._store.parse(t)}resource(e,t,r,n){var i=this;return _async_to_generator$z((function*(){if(!(null==n?void 0:n.reload)){const n=i._store.read(e,t,r);if(n)return n}const[o]=yield i.collection(e,t,r,n);return o}))()}constructor(e,t,r,n,i={},o){super("https://api.books.apple.com/v1",e,_object_spread_props$e(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$A(e,t,r[t])}))}return e}({},o),{userToken:t,storage:n})),_define_property$A(this,"_store",void 0),_define_property$A(this,"defaultIncludePaginationMetadata",void 0),_define_property$A(this,"storefrontId",ce.ID),r&&(this.storefrontId=r),this._store=new LocalDataStore(i),this.defaultIncludePaginationMetadata=i.features&&hasOwn(i.features,"api-pagination-metadata")}}function asyncGeneratorStep$y(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$y(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$y(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$y(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$z(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$z(e,t,r[t])}))}return e}function _object_spread_props$d(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _ts_metadata$c(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([ChunkedIdApi(1),_ts_metadata$d("design:type",Function),_ts_metadata$d("design:paramtypes",[String,Object,"undefined"==typeof QueryParameters?Object:QueryParameters,"undefined"==typeof InternalMakeRequestOptions?Object:InternalMakeRequestOptions]),_ts_metadata$d("design:returntype",Promise)],Books.prototype,"collection",null);class Podcasts extends TokenSession{catalogResource(e,t,r,n){return this.resource(e,t,r,n)}catalogResources(e,t,r,n){return this.collection(e,t,r,n)}catalogResourceRelationship(e,t,r,n,i){return this.collection(`${e}/${t}/${r}`,void 0,n,i)}search(e,t,r){return this.collection("search",void 0,_object_spread$l({term:e,types:"podcasts"},t),r)}artist(e,t,r){return this.catalogResource("artists",e,t,r)}artists(e,t,r){return this.catalogResources("artists",e,t,r)}artistRelationship(e,t,r,n){return this.catalogResourceRelationship("artists",e,t,r,n)}charts(e,t,r){return this.catalogResources("charts",void 0,_object_spread$l({types:e},t),r)}podcast(e,t,r){return this.catalogResource("podcasts",e,_object_spread$l({include:"episodes"},t),r)}podcasts(e,t,r){var n=this;return _async_to_generator$y((function*(){return n.catalogResources("podcasts",e,_object_spread$l({include:"episodes"},t),r)}))()}podcastRelationship(e,t,r,n){var i=this;return _async_to_generator$y((function*(){return i.catalogResourceRelationship("podcasts",e,t,r,n)}))()}episode(e,t,r){var n=this;return _async_to_generator$y((function*(){return n.resource("podcast-episodes",e,t,r)}))()}episodes(e,t,r){var n=this;return _async_to_generator$y((function*(){return n.catalogResources("podcast-episodes",e,t,r)}))()}collection(e,t,r,n){var i=this;return _async_to_generator$y((function*(){let o;if(t){const n={};n["charts"===e?"types":"ids"]=t,o=Object.assign(n,r)}else o=r;const a=`catalog/${i.storefrontId}/${e}`;return makeRequest(i,a,o,n)}))()}parseResultData(e,t){return e?this._store.write(t):this._store.parse(t)}resource(e,t,r,n){var i=this;return _async_to_generator$y((function*(){if(!(null==n?void 0:n.reload)){const n=i._store.read(e,t,r);if(n)return n}const[o]=yield i.collection(e,t,r,n);return o}))()}constructor(e,t,r=ce.ID,n,i={},o){super("https://amp-api.podcasts.apple.com/v1",e,_object_spread_props$d(_object_spread$l({},o),{userToken:t,storage:n})),_define_property$z(this,"_store",void 0),_define_property$z(this,"defaultIncludePaginationMetadata",void 0),_define_property$z(this,"storefrontId",void 0),this.storefrontId=r,this._store=new LocalDataStore(i),this.defaultIncludePaginationMetadata=i.features&&hasOwn(i.features,"api-pagination-metadata")}}function asyncGeneratorStep$x(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _define_property$y(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$k(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$y(e,t,r[t])}))}return e}function _object_spread_props$c(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _ts_metadata$b(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([ChunkedIdApi(1),_ts_metadata$c("design:type",Function),_ts_metadata$c("design:paramtypes",[String,Object,"undefined"==typeof QueryParameters?Object:QueryParameters,"undefined"==typeof InternalMakeRequestOptions?Object:InternalMakeRequestOptions]),_ts_metadata$c("design:returntype",Promise)],Podcasts.prototype,"collection",null);const _i=new Set(["editorial-items"]);class Fitness extends TokenSession{workout(e,t,r){return this.resource("workouts",e,t,r)}contributor(e,t,r){return this.resource("contributors",e,t,r)}editorialItem(e,t,r){return this.resource("editorial-items",e,t,r)}modalities(e,t,r){return this.collection("modalities",e,t,r)}modality(e,t,r){return this.resource("modalities",e,t,r)}workoutProgram(e,t,r){return this.resource("workout-programs",e,t,r)}collection(e,t,r,n){let i;i=t?_object_spread$k({ids:t},r):r;let o="catalog";_i.has(e)&&(o="editorial");return makeRequest(this,`${o}/${this.storefrontId}/${e}`,i,n)}parseResultData(e,t){return e?this._store.write(t):this._store.parse(t)}resource(e,t,r,n){var i=this;return function(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$x(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$x(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}((function*(){const o=i._store.read(e,t,r);if(o)return o;const[a]=yield i.collection(e,t,r,n);return a}))()}constructor(e,t,r=ce.ID,n,i={},o){var a;super("https://amp-api.fitness.apple.com/v1",e,_object_spread_props$c(_object_spread$k({},o),{userToken:t,storage:n})),_define_property$y(this,"_store",void 0),_define_property$y(this,"defaultIncludePaginationMetadata",void 0),_define_property$y(this,"storefrontId",ce.ID),this.storefrontId=r,this._store=new LocalDataStore(i),this.defaultIncludePaginationMetadata=!!(null==i||null===(a=i.features)||void 0===a?void 0:a["api-pagination-metadata"])}}function asyncGeneratorStep$w(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$w(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$w(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$w(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$x(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$j(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$x(e,t,r[t])}))}return e}function _object_spread_props$b(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _ts_metadata$a(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([ChunkedIdApi(1),_ts_metadata$b("design:type",Function),_ts_metadata$b("design:paramtypes",[String,Object,"undefined"==typeof QueryParameters?Object:QueryParameters,"undefined"==typeof MakeRequestOptions?Object:MakeRequestOptions]),_ts_metadata$b("design:returntype","undefined"==typeof Promise?Object:Promise)],Fitness.prototype,"collection",null);class TVLibrary extends TokenSession{genres(e,t){var r=this;return _async_to_generator$w((function*(){return r.collection("genres",_object_spread$j({types:"tv-episodes,movies"},e),t)}))()}movies(e,t){var r=this;return _async_to_generator$w((function*(){return r.collection("movies",e,t)}))()}purchases(e,t){var r=this;return _async_to_generator$w((function*(){return r.collection("",_object_spread$j({types:"tv-episodes,movies"},e),t)}))()}tvEpisodes(e,t){var r=this;return _async_to_generator$w((function*(){return r.collection("tv-episodes",e,t)}))()}collection(e,t,r){var n=this;return _async_to_generator$w((function*(){try{return yield makeRequest(n,"me/purchases/"+e,t,r)}catch(De){if(MKError.isMKError(De)&&De.reason===MKError.Reason.CONTENT_UNAVAILABLE)return(null==r?void 0:r.includePagination)?{data:[],meta:{}}:[];throw De}}))()}parseResultData(e,t){return e?this._store.write(t):this._store.parse(t)}constructor(e,t,r,n={},i){super("https://amp-api.videos.apple.com/v1",e,_object_spread_props$b(_object_spread$j({},i),{userToken:t,storage:r})),_define_property$x(this,"_store",void 0),_define_property$x(this,"defaultIncludePaginationMetadata",void 0),this._store=new LocalDataStore(n),this.defaultIncludePaginationMetadata=n.features&&hasOwn(n.features,"api-pagination-metadata")}}function asyncGeneratorStep$v(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$v(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$v(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$v(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$w(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$w(e,t,r[t])}))}return e}function _object_spread_props$a(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([ChunkedIdApi(1),_ts_metadata$a("design:type",Function),_ts_metadata$a("design:paramtypes",[String,"undefined"==typeof QueryParameters?Object:QueryParameters,"undefined"==typeof InternalMakeRequestOptions?Object:InternalMakeRequestOptions]),_ts_metadata$a("design:returntype",Promise)],TVLibrary.prototype,"collection",null);const RecommendationUpdate=()=>(e,t,r)=>{if(void 0===r||"function"!=typeof r.value)throw new TypeError(`Only methods can be decorated with @RecommendationUpdate, but ${t} is not a method.`);return{configurable:!0,get(){const e=r.value;function recommendationUpdate(){return _recommendationUpdate.apply(this,arguments)}function _recommendationUpdate(){return(_recommendationUpdate=_async_to_generator$v((function*(...t){const r=yield e.apply(this,t),n=new Map,i=[],o=new Date;if(!r||!Array.isArray(r))return r;if(r.forEach((e,t)=>{var r;const a=e.id;var s;const c=null!==(s=e.nextUpdateDate)&&void 0!==s?s:null===(r=e.attributes)||void 0===r?void 0:r.nextUpdateDate;if(!a||!c)return;new Date(c)<o&&(i.push(a),n.set(a,t))}),!i.length)return r;let[a,s,c,...l]=t;c=_object_spread_props$a(_object_spread$i({},c),{reload:!0});const d=[i,s,c,...l];return(yield e.apply(this,d)).forEach(e=>{const t=n.get(e.id);void 0!==t&&(r[t]=e)}),r}))).apply(this,arguments)}return Object.defineProperty(this,t,{value:recommendationUpdate,configurable:!0,writable:!0}),recommendationUpdate}}};function rejectOnLast(){return Promise.reject("The last middleware in the stack should not call next")}function processMiddleware(e,...t){return e.length?function createNextFunction([e,...t]){return(...r)=>e(createNextFunction(t),...r)}([...e,rejectOnLast])(...t):Promise.reject("processMiddleware requires at mimimum one middleware function")}function parameterizeString(e,t){return function(e){try{return function recursiveTokenizeParameterizedString(e,t=[]){if(e.startsWith("{{")){const r=e.indexOf("}}");if(-1===r)throw new Error("UNCLOSED_PARAMETER");const n={type:1,value:e.slice(2,r)};return r+2<e.length?recursiveTokenizeParameterizedString(e.slice(r+2),[...t,n]):[...t,n]}{const r=e.indexOf("{{");return-1===r?[...t,{type:0,value:e}]:recursiveTokenizeParameterizedString(e.slice(r),[...t,{type:0,value:e.slice(0,r)}])}}(e)}catch(De){if("UNCLOSED_PARAMETER"===De.message)throw new Error(`Unclosed parameter in path: "${e}"`);throw De}}(e).map(e=>{switch(e.type){case 1:return e.value in t?encodeURIComponent(""+t[e.value]):`{{${e.value}}}`;case 0:default:return e.value}}).join("")}var vi;function _define_property$v(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread_props$9(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function constructUrlMiddleware(e,t){let r=t.url;var n;return r||(r=buildURL(t.baseUrl,t.path)),t.urlParameters&&(r=parameterizeString(r,t.urlParameters)),e(_object_spread_props$9(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$v(e,t,r[t])}))}return e}({},t),{url:buildURL(r,null!==(n=t.queryParameters)&&void 0!==n?n:{})}))}function asyncGeneratorStep$u(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$u(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$u(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$u(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function unwrapJSONFromResponse(e){return _unwrapJSONFromResponse.apply(this,arguments)}function _unwrapJSONFromResponse(){return(_unwrapJSONFromResponse=_async_to_generator$u((function*(e){try{return yield e.json()}catch(De){return}}))).apply(this,arguments)}function fetchMiddlewareFactory(e){return t=_async_to_generator$u((function*(t,r){const n=yield e(r.url,r.fetchOptions),i={request:r,response:n,data:yield unwrapJSONFromResponse(n)};if(!n.ok)throw MKError.responseError(n);return i})),function(e,r){return t.apply(this,arguments)};var t}!function(e){e[e.Static=0]="Static",e[e.Parameter=1]="Parameter"}(vi||(vi={}));const mi=fetchMiddlewareFactory("undefined"!=typeof fetch?fetch:()=>{throw new Error("window.fetch is not defined")});function _define_property$u(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$g(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$u(e,t,r[t])}))}return e}function _object_spread_props$8(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}var gi;!function(e){e.Replace="REPLACE",e.Merge="MERGE"}(gi||(gi={}));const bi=["url"];class APISession{get config(){return this._config}request(e,t={},r={}){var n;return processMiddleware(this.middlewareStack,_object_spread_props$8(_object_spread$g({},this.config.defaultOptions,r),{baseUrl:this.config.url,path:e,fetchOptions:mergeFetchOptions(null===(n=this.config.defaultOptions)||void 0===n?void 0:n.fetchOptions,r.fetchOptions),queryParameters:_object_spread$g({},this.config.defaultQueryParameters,t),urlParameters:_object_spread$g({},this.config.defaultUrlParameters,r.urlParameters)}))}reconfigure(e,t="REPLACE"){"MERGE"===t&&(e=deepmerge(this.config,e)),bi.forEach(t=>{if(void 0===e[t])throw new Error(`Session requires a valid SessionConfig, missing "${t}"`)}),this._config=e,this.middlewareStack=this.createMiddlewareStack()}createMiddlewareStack(){return Array.isArray(this.config.middleware)?[constructUrlMiddleware,...this.config.middleware,this.makeFetchMiddleware()]:[constructUrlMiddleware,this.makeFetchMiddleware()]}makeFetchMiddleware(){return"function"==typeof this.config.fetchFunction?fetchMiddlewareFactory(this.config.fetchFunction):mi}constructor(e){_define_property$u(this,"_config",void 0),_define_property$u(this,"middlewareStack",void 0),this.reconfigure(e)}}function _object_without_properties$1(e,t){if(null==e)return{};var r,n,i=function(e,t){if(null==e)return{};var r,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}const Si={music:{url:"https://api.music.apple.com"},apps:{url:"https://amp-api.apps.apple.com"},books:{url:"https://amp-api.books.apple.com"},fitness:{url:"https://amp-api.fitness.apple.com"}};Si.music={url:"https://amp-api.music.apple.com"},Si.videos={url:"https://amp-api.videos.apple.com"},Si.podcasts={url:"https://amp-api.podcasts.apple.com"};class MediaAPIV3{configure(e,t,r=gi.Merge){this.storefrontId=t.storefrontId;const n=function(e){let t={};e.url&&(t.url=e.url);e.storefrontId&&(t.defaultUrlParameters={storefrontId:e.storefrontId});e.mediaUserToken&&(t.defaultOptions={fetchOptions:{headers:{"Media-User-Token":e.mediaUserToken}}});e.developerToken&&(t=deepmerge(t,{defaultOptions:{fetchOptions:{headers:{Authorization:"Bearer "+e.developerToken}}}}));e.options&&(t=deepmerge(t,e.options));return t}(t);if(this[e])this[e].session.reconfigure(n,r);else{var i;const t=new APISession(n),r=t.request.bind(t);r.session=t;const o="undefined"!=typeof process&&"test"===(null===(i=process.env)||void 0===i?void 0:i.NODE_ENV);Object.defineProperty(this,e,{value:r,writable:o,enumerable:!0})}}constructor(e){!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"storefrontId",void 0);const{realmConfig:t}=e,r=_object_without_properties$1(e,["realmConfig"]);for(const n in Si){let e=deepmerge(Si[n],r);const i=null==t?void 0:t[n];i&&(e=deepmerge(e,i)),this.configure(n,e)}}}function dasherize(e){return e.replace(/([A-Z])/g,"-$1").replace(/[-_\s]+/g,"-").toLowerCase()}function asyncGeneratorStep$t(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _define_property$s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function makeAlbumKey(e){var t;return(null===(t=e.artwork)||void 0===t?void 0:t.url)+""+e.artistName+""+e.name}class ServerLedger{_initData(){return{lastTimestamp:0,albums:{added:Object.create(null),removed:Object.create(null)},playlists:{added:Object.create(null),removed:Object.create(null)}}}_checkTimestamp(){const e=this._data.lastTimestamp;e&&e+24e5<Date.now()&&(this._data=this._initData(),this._sessionStorage&&this._sessionStorage.removeItem(this._storageKey))}added(e){this.load();const t=null==e?void 0:e.playlists,r=null==e?void 0:e.albums;return t||r?(t&&t.forEach(e=>{const t=Date.now();this._data.playlists.added[e]=t,this._data.lastTimestamp=t}),r&&r.forEach(e=>{const t=Date.now();this._data.albums.added[e]=t,this._data.lastTimestamp=t}),this.save(),e):e}removed(e){this.load();const t=null==e?void 0:e.playlists;return t?(ensureArray(t).forEach(e=>{if(0!==e.indexOf("pl.")){const t=Date.now();this._data.playlists.removed[e]=t,this._data.lastTimestamp=t}}),this.save(),e):e}reconcile(e,t,r,n,i){var o=this;return function(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$t(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$t(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}((function*(){o._checkTimestamp();const i=t.data||t;if(!i||!Array.isArray(i)||Array.isArray(r))return t;const a=o._data.albums.added,s=o._data.playlists.removed,c=o._data.playlists.added,l=[],d=n&&!n.offset||!!r&&(void 0===r.offset||0===r.offset);let u=!1;if("all"===e||"playlists"===e){for(let e=i.length-1;e>=0;e--){var p;const t=i[e],r=null===(p=t.playParams)||void 0===p?void 0:p.globalId;"library-playlists"===t.type&&(s[t.id]?i.splice(e,1):r&&c[r]&&(delete c[r],u=!0,d||i.splice(e,1)))}if(d&&o._catalogApi){const e=Object.keys(c);if(e.length){const t=yield o._catalogApi.playlists(e);l.splice(0,0,...t)}}}if(o._catalogApi&&("all"===e||"albums"===e)){const e=Object.keys(a);if(e.length){const t=yield o._catalogApi.albums(e),r=Object.create(null);t.forEach((t,n)=>{const i=makeAlbumKey(t);r[i]={catalogId:e[n],album:t}});for(let e=i.length-1;e>=0;e--){var h;const t=i[e];if(null===(h=t.playParams)||void 0===h||h.globalId,"library-albums"===t.type){const n=makeAlbumKey(t),o=r[n];o&&(delete a[o.catalogId],u=!0,d?delete r[n]:i.splice(e,1))}}if(d){const e=Object.keys(r).map(e=>r[e].album);e.length&&l.splice(0,0,...e)}}}if(u&&o.save(),d&&l.length&&(l.sort((e,t)=>{const r=o._data.albums.added[e.id]||o._data.playlists.added[e.id]||0;return(o._data.albums.added[t.id]||o._data.playlists.added[t.id]||0)-r}),i.splice(0,0,...l)),!i.length)throw new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"The requested content is not available.");const y=t.meta;return y&&void 0===y.total&&(y.total=i.length),t}))()}load(){if(!this._sessionStorage)return;const e=this._sessionStorage.getItem(this._storageKey);if(e)try{this._data=JSON.parse(e),this._data.albums&&this._data.playlists||(this._data=this._initData())}catch(t){this._data||(this._data=this._initData())}else this._data=this._initData()}save(){if(!this._sessionStorage)return;const e=this._data,t=0===Object.keys(e.albums.added).length&&0===Object.keys(e.albums.removed).length&&0===Object.keys(e.playlists.added).length&&0===Object.keys(e.playlists.removed).length;try{if(t)this._sessionStorage.getItem(this._storageKey)&&this._sessionStorage.removeItem(this._storageKey);else{const e=JSON.stringify(this._data);this._sessionStorage.setItem(this._storageKey,e)}}catch(r){}}constructor(e,t,r){_define_property$s(this,"_storageKey",void 0),_define_property$s(this,"_data",this._initData()),_define_property$s(this,"_catalogApi",void 0),_define_property$s(this,"_sessionStorage",void 0),this._catalogApi=t,this._storageKey="mk-server-ledger:"+(e||""),this._sessionStorage=r||getSessionStorage(),this.load()}}function asyncGeneratorStep$s(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$s(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$s(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$s(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$f(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$r(e,t,r[t])}))}return e}function _object_spread_props$7(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _ts_metadata$9(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const Pi="me/library";class Library extends TokenSession{add(e){var t=this;return _async_to_generator$s((function*(){const r=transformKeys(e,dasherize),n=Date.now();if(n-t._last<1e3)return Promise.reject(new MKError(MKError.Reason.QUOTA_EXCEEDED));const i=new Headers({Authorization:"Bearer "+t.developerToken,[L]:t.userToken}),o=Object.keys(r).map(e=>`ids[${e}]=${r[e].join(",")}`).join("&");try{const e=yield fetch(`${t.url}/${Pi}?${o}`,{method:"POST",headers:i});return e.ok?(t._last=n,t._serverLedger.added(r)):Promise.reject(MKError.responseError(e))}catch(a){return Promise.reject(MKError.responseError(a))}}))()}remove(e){var t=this;return _async_to_generator$s((function*(){if(!t.developerToken||!t.userToken)return Promise.reject("Invalid tokens");const r=new Headers({Authorization:"Bearer "+t.developerToken,[L]:t.userToken}),n=transformKeys(e,dasherize),i=Object.keys(n)[0],o=Object.values(n)[0];try{const e=yield fetch(`${t.url}/${Pi}/${i}/${o}`,{method:"DELETE",headers:r});return e.ok?t._serverLedger.removed(n):Promise.reject(MKError.responseError(e))}catch(a){return Promise.reject(MKError.responseError(a))}}))()}album(e,t,r){var n=this;return _async_to_generator$s((function*(){return n.resource("albums",e,t,r)}))()}albumRelationship(e,t,r,n){var i=this;return _async_to_generator$s((function*(){return i.collection(`albums/${e}/${t}`,void 0,r,n)}))()}albums(e,t,r){var n=this;return _async_to_generator$s((function*(){let i;try{i=yield n.collection("albums",e,t,_object_spread_props$7(_object_spread$f({},r),{shouldCacheResults:!1}))}catch(o){if(!MKError.isMKError(o)||o.reason!==MKError.Reason.CONTENT_UNAVAILABLE)throw o;i={data:[],meta:{}}}return n._serverLedger.reconcile("albums",i,e,t,r)}))()}artist(e,t,r){var n=this;return _async_to_generator$s((function*(){return n.resource("artists",e,t,r)}))()}artistRelationship(e,t="albums",r,n){var i=this;return _async_to_generator$s((function*(){return i.collection(`artists/${e}/${t}`,void 0,r,n)}))()}artists(e,t,r){var n=this;return _async_to_generator$s((function*(){return n.collection("artists",e,t,r)}))()}createPlaylist(e={},t){var r=this;return _async_to_generator$s((function*(){let n;const{name:i,description:o,tracks:a=[]}=e,s={attributes:{name:i,description:o},relationships:{tracks:{data:transformTrackParameters(a)}}},c=JSON.stringify(s);try{n=yield r.request(Pi+"/playlists",t,{body:c,method:"POST"})}catch(De){return Promise.reject(MKError.responseError(De))}try{const[e]=r._store.write(n);return e}catch(De){return Promise.reject(MKError.parseError(De))}}))()}deletePlaylist(e,t){var r=this;return _async_to_generator$s((function*(){let n;const i=`${Pi}/playlists/${e}`;try{n=yield r.request(i,t,{method:"DELETE"})}catch(De){return Promise.reject(MKError.responseError(De))}r.purgePlaylistFromCaches(e)}))()}editPlaylist(e,t,r){var n=this;return _async_to_generator$s((function*(){let i;const o=JSON.stringify({attributes:t});try{i=yield n.request(`${Pi}/playlists/${e}`,r,{body:o,method:"PATCH"})}catch(De){return Promise.reject(MKError.responseError(De))}try{const r=t,i="library-playlists";return n._store.write({data:[{type:i,id:e,attributes:r}]}),t}catch(De){return Promise.reject(MKError.parseError(De))}}))()}updatePlaylistTracklist(e,t){var r=this;return _async_to_generator$s((function*(){yield r.putPlaylistTracklisting(e,t,"PUT"),r.purgePlaylistFromCaches(e)}))()}appendTracksToPlaylist(e,t){var r=this;return _async_to_generator$s((function*(){yield r.putPlaylistTracklisting(e,t,"POST"),r.purgePlaylistFromCaches(e)}))()}playlistFolder(e,t,r){return this.resource("playlist-folders",e,t,r)}playlistFolders(e,t,r){return this.collection("playlist-folders",e,t,r)}playlistFoldersRoot(e,t){return e=_object_spread_props$7(_object_spread$f({},e),{filter:_object_spread_props$7(_object_spread$f({},null==e?void 0:e.filter),{identity:"playlistsroot"})}),this.playlistFolders(void 0,e,t)}playlistFolderChildren(e,t,r){const n=`playlist-folders/${e}/children`;return this.collection(n,void 0,t,r)}musicVideo(e,t,r){var n=this;return _async_to_generator$s((function*(){return n.resource("music-videos",e,t,r)}))()}musicVideos(e,t,r){var n=this;return _async_to_generator$s((function*(){return n.collection("music-videos",e,t,r)}))()}parseResultData(e,t){return e?this._store.write(t):this._store.parse(t)}playlist(e,t,r){var n=this;return _async_to_generator$s((function*(){return t=_object_spread$f({include:"tracks"},t),n.resource("playlists",e,t,r)}))()}createCatalogPlaylist(e,t,r){var n=this;return _async_to_generator$s((function*(){return r=_object_spread$f({method:"POST"},r),n.resource(`playlists/${e}/catalog`,void 0,t,r)}))()}playlistRelationship(e,t="tracks",r,n){var i=this;return _async_to_generator$s((function*(){return i.collection(`playlists/${e}/${t}`,void 0,r,n)}))()}playlists(e,t,r){var n=this;return _async_to_generator$s((function*(){let i;try{i=e&&e.length>0?yield Promise.all(e.map(e=>n.playlist(e,t,r))):yield n.collection("playlists",e,t,_object_spread_props$7(_object_spread$f({},r),{shouldCacheResults:!1}))}catch(o){if(!MKError.isMKError(o)||o.reason!==MKError.Reason.CONTENT_UNAVAILABLE)throw o;i={data:[],meta:{}}}return n._serverLedger.reconcile("playlists",i,e,t,r)}))()}recentlyAdded(e,t){var r=this;return _async_to_generator$s((function*(){const n=null==e?void 0:e.limit;let i;try{i=yield r.collection("recently-added",void 0,transformParameters(e,n||10),_object_spread_props$7(_object_spread$f({},t),{shouldCacheResults:!1}))}catch(o){if(!MKError.isMKError(o)||o.reason!==MKError.Reason.CONTENT_UNAVAILABLE)throw o;i={data:[],meta:{}}}return r._serverLedger.reconcile("all",i,void 0,e,t)}))()}search(e,t,r){var n=this;return _async_to_generator$s((function*(){t=n._denormalizeLibraryTypes(t);const i=_object_spread$f({term:e,types:"library-albums"},t);return n.collection("search",void 0,i,_object_spread_props$7(_object_spread$f({},r),{shouldCacheResults:!1}))}))()}song(e,t,r){var n=this;return _async_to_generator$s((function*(){return n.resource("songs",e,t,r)}))()}songRelationship(e,t,r,n){var i=this;return _async_to_generator$s((function*(){return i.collection(`songs/${e}/${t}`,void 0,r,n)}))()}songs(e,t,r){var n=this;return _async_to_generator$s((function*(){return n.collection("songs",e,t,r)}))()}collection(e,t,r,n){var i=this;return _async_to_generator$s((function*(){!t||t.length||r||(r=transformParameters(t,100),t=void 0);const o=t?_object_spread$f({ids:t},r):null!=r?r:{};return makeRequest(i,`${Pi}/${e}`,o,n)}))()}resource(e,t,r,n){var i=this;return _async_to_generator$s((function*(){if(!(null==n?void 0:n.reload)){const n=i._store.read(e,t,r);if(n)return n}let o=`${Pi}/${e}`;t&&(o=`${o}/${t}`);const[a]=yield makeRequest(i,o,r,n);return a}))()}purgePlaylistFromCaches(e){this._store.delete("library-playlists",e),this.networkCache.removeItemsMatching(buildURL(`${Pi}/playlists/${e}`,{}),!1)}putPlaylistTracklisting(e,t,r="PUT"){var n=this;return _async_to_generator$s((function*(){const i=transformTrackParameters(t),o=JSON.stringify({data:i});try{yield n.request(`${Pi}/playlists/${e}/tracks`,void 0,{body:o,method:r})}catch(De){return Promise.reject(MKError.responseError(De))}}))()}_denormalizeLibraryTypes(e={},t="types"){let r=e[t];return r?("string"==typeof r&&(r=r.split(",")),e[t]=r.map(e=>e.replace(/^(albums|music-videos|playlists|songs)$/,"library-$1")),e):e}constructor(e,t,r,n={},i,o){super(e,t,_object_spread_props$7(_object_spread$f({},o),{userToken:r})),_define_property$r(this,"_last",0),_define_property$r(this,"_store",void 0),_define_property$r(this,"defaultIncludePaginationMetadata",void 0),_define_property$r(this,"_serverLedger",void 0),this._store=new LocalDataStore(n),this._serverLedger=new ServerLedger(r,i),this.defaultIncludePaginationMetadata=n.features&&hasOwn(n.features,"api-pagination-metadata")}}function asyncGeneratorStep$r(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$r(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$r(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$r(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$q(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$e(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$q(e,t,r[t])}))}return e}function _object_spread_props$6(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _ts_decorate$8(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$8(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}var Ei,Ti;!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([ChunkedIdApi(1),_ts_metadata$9("design:type",Function),_ts_metadata$9("design:paramtypes",[String,Object,"undefined"==typeof QueryParameters?Object:QueryParameters,"undefined"==typeof MakeRequestOptions?Object:MakeRequestOptions]),_ts_metadata$9("design:returntype",Promise)],Library.prototype,"collection",null),function(e){e[e.Global=0]="Global",e.Lyrics="lyrics",e.Catalog="catalog",e.Personalized="me",e.Editorial="editorial",e.Engagement="engagement",e.Social="social"}(Ei||(Ei={})),function(e){e.songs="songs",e.albums="albums",e.playlists="playlists",e.stations="stations",e["music-videos"]="music-videos",e["library-music-videos"]="library-music-videos",e["library-playlists"]="library-playlists",e["library-songs"]="library-songs"}(Ti||(Ti={}));class API extends TokenSession{activity(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.resource("catalog","activities",e,t,r)}))()}activities(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.collection("catalog","activities",e,t,r)}))()}album(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.resource("catalog","albums",e,t,r)}))()}albumRelationship(e,t,r,n){var i=this;return _async_to_generator$r((function*(){return i.collection("catalog",`albums/${e}/${t}`,void 0,r,n)}))()}albums(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.collection("catalog","albums",e,t,r)}))()}appleCurator(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.resource("catalog","apple-curators",e,t,r)}))()}appleCurators(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.collection("catalog","apple-curators",e,t,r)}))()}artist(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.resource("catalog","artists",e,t,r)}))()}artistRelationship(e,t,r,n){var i=this;return _async_to_generator$r((function*(){return i.collection("catalog",`artists/${e}/${t}`,void 0,r,n)}))()}artistView(e,t,r,n){return this.collection("catalog",`artists/${e}/view/${t}`,void 0,r,n)}artists(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.collection("catalog","artists",e,t,r)}))()}audioBook(e,t,r){return this.books.audioBook(e,t,r)}audioBooks(e,t,r){return this.books.audioBooks(e,t,r)}catalogResources(e,t={},r){const n=function(e){const t={};if(!e)return t;for(const r of e){if(!r)continue;const{type:e,id:n}=r;e in t||(t[e]=[]),t[e].push(n)}return t}(e);return t=_object_spread_props$6(_object_spread$e({},t),{ids:n}),makeRequest(this,"catalog/"+this.storefrontId,t,r)}changeStation(e,t,r={}){var n=this;return _async_to_generator$r((function*(){return yield makeRequest(n,"me/stations/change-station/"+e,t,_object_spread_props$6(_object_spread$e({},r),{reload:!0,method:"POST",shouldCacheResults:!1}))}))()}charts(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.collection("catalog","charts",e,t,_object_spread_props$6(_object_spread$e({},r),{returnRawJSONApiRecords:!0}))}))()}contents(e,t,r){return this.collection("catalog","contents",e,t,r)}curator(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.resource("catalog","contents",e,t,r)}))()}curators(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.collection("catalog","contents",e,t,r)}))()}curatorRelationship(e,t,r,n){var i=this;return _async_to_generator$r((function*(){return i.collection("catalog",`curators/${e}/${t}`,void 0,r,n)}))()}episode(e,t,r){var n=this;return _async_to_generator$r((function*(){return n._podcastsAPI.catalogResource("podcast-episodes",e,t,r)}))()}episodes(e,t,r){var n=this;return _async_to_generator$r((function*(){return n._podcastsAPI.catalogResources("podcast-episodes",e,t,r)}))()}genre(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.resource("catalog","genres",e,t,r)}))()}genres(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.collection("catalog","genres",e,t,r)}))()}grouping(e,t,r){var n=this;return _async_to_generator$r((function*(){!t&&isObject$1(e)&&(t=e,e=void 0);const i=_object_spread$e({},{platform:"desktop"},t);return n.resource("editorial","groupings",e,i,_object_spread_props$6(_object_spread$e({},r),{shouldCacheResults:!1}))}))()}groupings(e,t={},r){var n=this;return _async_to_generator$r((function*(){const i=_object_spread$e({},{platform:"desktop"},t);return n.collection("editorial","groupings",e,i,_object_spread_props$6(_object_spread$e({},r),{shouldCacheResults:!1}))}))()}lyric(e,t,r){return this.resource("catalog",`songs/${e}/lyrics`,"",t,_object_spread$e({reload:!0},r))}lyricSnippet(e,t,r){return this.collection("lyrics","snippet/songs",e,t,_object_spread_props$6(_object_spread$e({},r),{returnRawJSONApiRecords:!0}))}historyHeavyRotation(e,t){var r=this;return _async_to_generator$r((function*(){return r.collection("me","history/heavy-rotation",void 0,transformParameters(e,10),t)}))()}multiplex(e,t,r){var n=this;return _async_to_generator$r((function*(){const i=n._store.read("multiplex",e,t);return i||(r=_object_spread$e({returnRawJSONApiRecords:!0},r),makeRequest(n,`editorial/${n.storefrontId}/multiplex/${e}`,t,r))}))()}multiroom(e,t,r){var n=this;return _async_to_generator$r((function*(){const i=n._store.read("multirooms",e,t);if(i)return i;const[o]=yield n.collection("editorial","multirooms/"+e,void 0,t,r);return o}))()}musicMovie(e,t,r){return this.resource("catalog","music-movies",e,t,r)}musicMovies(e,t,r){return this.collection("catalog","music-movies",e,t,r)}musicVideo(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.resource("catalog","music-videos",e,t,r)}))()}musicVideos(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.collection("catalog","music-videos",e,t,r)}))()}nextStationTracks(e,t,r={}){var n=this;return _async_to_generator$r((function*(){var i;const o=null!==(i=r.queryParameters)&&void 0!==i?i:{};(null==t?void 0:t.clean)&&(o.clean=t.clean,delete t.clean),(null==t?void 0:t.limit)&&(o.limit=t.limit,delete t.limit);return yield makeRequest(n,"me/stations/next-tracks/"+e,t,_object_spread_props$6(_object_spread$e({},r),{reload:!0,method:"POST",queryParameters:o,shouldCacheResults:!1}))}))()}continuousStation(e,t,r={}){var n=this;return _async_to_generator$r((function*(){return yield makeRequest(n,"me/stations/continuous",e,_object_spread_props$6(_object_spread$e({},r),{reload:!0,method:"POST",queryParameters:t,returnRawJSONApiRecords:!0,shouldCacheResults:!1}))}))()}playlist(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.resource("catalog","playlists",e,t,r)}))()}playlistRelationship(e,t,r,n){var i=this;return _async_to_generator$r((function*(){return i.collection("catalog",`playlists/${e}/${t}`,void 0,r,n)}))()}playlists(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.collection("catalog","playlists",e,t,r)}))()}podcast(e,t,r){var n=this;return _async_to_generator$r((function*(){return n._podcastsAPI.catalogResource("podcasts",e,_object_spread$e({include:"episodes"},t),r)}))()}podcastRelationship(e,t,r,n){var i=this;return _async_to_generator$r((function*(){return i._podcastsAPI.catalogResourceRelationship("podcasts",e,t,r,n)}))()}podcasts(e,t,r){var n=this;return _async_to_generator$r((function*(){return n._podcastsAPI.catalogResources("podcasts",e,_object_spread$e({include:"episodes"},t),r)}))()}recentPlayed(e,t){var r=this;return _async_to_generator$r((function*(){return r.collection("me","recent/played",void 0,transformParameters(e,10),t)}))()}recentRadioStations(e,t){var r=this;return _async_to_generator$r((function*(){return r.collection("me","recent/radio-stations",void 0,transformParameters(e,10),t)}))()}recordLabel(e,t,r){return this.resource("catalog","record-labels",e,t,r)}recordLabels(e,t,r){return this.collection("catalog","record-labels",e,t,r)}recordLabelView(e,t,r,n){return this.collection("catalog",`record-labels/${e}/view/${t}`,void 0,r,n)}personalRecommendation(e,t,r,n=!0){var i=this;return _async_to_generator$r((function*(){const o=yield i.personalRecommendations(e,t,r,n),[a]=o;return a}))()}refreshPersonalRecommendation(e,t,r){return t=_object_spread$e({timezone:formatTimezoneOffset()},t),r=_object_spread_props$6(_object_spread$e({},r),{method:"POST",queryParameters:t}),this.resource("me","recommendations",e,void 0,r)}personalRecommendations(e,t,r={},n=!0){var i=this;return _async_to_generator$r((function*(){const o=formatTimezoneOffset(),a=yield i.collection("me","recommendations",e,_object_spread$e({timezone:o},t),_object_spread_props$6(_object_spread$e({},r),{shouldCacheResults:n,returnRawJSONApiRecords:!0}));i._reindexRelationships(a,"recommendations");try{return mapRequestResult(a,e=>i.parseResultData(!1,e))}catch(De){return Promise.reject(MKError.parseError(De))}}))()}personalRecommendationView(e,t,r,n={}){var i=this;return _async_to_generator$r((function*(){return i.collection("me",`recommendations/${e}/view/${t}`,void 0,r,n)}))()}recommendations(e,t,r={}){var n=this;return _async_to_generator$r((function*(){const i=formatTimezoneOffset(),o=yield n.collection(0,"recommendations/"+n.storefrontId,e,_object_spread$e({timezone:i},t),_object_spread_props$6(_object_spread$e({},r),{shouldCacheResults:!1,returnRawJSONApiRecords:!0}));n._reindexRelationships(o,"recommendations");try{return mapRequestResult(o,e=>n.parseResultData(!1,e))}catch(De){return Promise.reject(MKError.parseError(De))}}))()}recommendedFriends(e,t,r={}){return r=_object_spread_props$6(_object_spread$e({},r),{method:"POST",body:JSON.stringify(_object_spread$e({ids:{socialProfiles:e}},r.body))}),this.collection(0,"social/recommended-friends",void 0,t,_object_spread_props$6(_object_spread$e({},r),{shouldCacheResults:!1,returnRawJSONApiRecords:!0}))}room(e,t,r){var n=this;return _async_to_generator$r((function*(){const i=n._store.read("rooms",e,t);if(i&&i.hasAttributes("title"))return i;const o=yield n.collection("editorial","rooms/"+e,void 0,t,r),[a]=o;return a}))()}roomContents(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.collection("editorial",`rooms/${e}/contents`,void 0,t,r)}))()}search(e,t,r){var n=this;return _async_to_generator$r((function*(){const i=_object_spread$e({term:e},t);return r=_object_spread_props$6(_object_spread$e({},r),{useRawResponse:!0}),n.collection("catalog","search",void 0,i,_object_spread_props$6(_object_spread$e({},r),{shouldCacheResults:!1}))}))()}searchHints(e,t,r){var n=this;return _async_to_generator$r((function*(){const i=_object_spread$e({term:e},t),o=yield n.collection("catalog","search/hints",void 0,i,_object_spread_props$6(_object_spread$e({},r),{returnRawJSONApiRecords:!0}));return"topResults"===(null==i?void 0:i.with)&&"topResults"in o&&(o.topResults=n.parseResultData(!0,o.topResults)),o}))()}searchQuery(e,t){var r=this;return _async_to_generator$r((function*(){return t=_object_spread_props$6(_object_spread$e({},t),{useRawResponse:!0}),r.collection("catalog","search/query",void 0,e,_object_spread_props$6(_object_spread$e({},t),{shouldCacheResults:!1}))}))()}searchSuggestions(e,t,r){var n=this;return _async_to_generator$r((function*(){t=_object_spread$e({term:e},t);const i=yield n.collection("catalog","search/suggestions",void 0,t,_object_spread_props$6(_object_spread$e({},r),{returnRawJSONApiRecords:!0}));return Array.isArray(null==i?void 0:i.suggestions)&&i.suggestions.forEach(e=>{"topResults"===e.kind&&(e.content=n.parseResultData(!0,[e.content])[0])}),i}))()}socialBadgingMap(e,t){return this.collection(0,"social/badging-map",void 0,e,_object_spread_props$6(_object_spread$e({},t),{returnRawJSONApiRecords:!0}))}socialProfile(e,t,r){return this.resource("social","social-profiles",e,t,r)}socialProfiles(e,t,r){return this.collection("social","social-profiles",e,t,r)}personalSocialProfile(e,t){return this.resource("me","social-profile",void 0,e,t)}socialPost(e,t={},r){var n=this;return _async_to_generator$r((function*(){e.startsWith("sa.")?t.filter={post:e}:t.ids=e;const[i]=yield n.collection("catalog","contents","",t,r);return i}))()}socialSearch(e,t={},r){var n=this;return _async_to_generator$r((function*(){return t=_object_spread_props$6(_object_spread$e({},t),{term:e}),n.collection("social","search",void 0,t,r)}))()}song(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.resource("catalog","songs",e,t,r)}))()}songRelationship(e,t,r,n){var i=this;return _async_to_generator$r((function*(){return i.collection("catalog",`songs/${e}/${t}`,void 0,r,n)}))()}songs(e,t,r){var n=this;return _async_to_generator$r((function*(){return!t&&isObject$1(e)&&(t=e,e=void 0),n.collection("catalog","songs",e,t,r)}))()}tastePreferences(e,t){var r=this;return _async_to_generator$r((function*(){return r.collection("me","taste/taste-preferences",void 0,e,_object_spread_props$6(_object_spread$e({},t),{shouldCacheResults:!1}))}))()}saveTastePreferences(e){var t=this;return _async_to_generator$r((function*(){e=e.map(e=>e instanceof DataRecord?e.serialize().data:e);const r={method:"POST",body:JSON.stringify({data:e}),shouldCacheResults:!0};try{return yield makeRequest(t,"me/taste/taste-preferences",void 0,r)}catch(De){return MKError.isMKError(De)&&De.reason===MKError.Reason.CONTENT_UNAVAILABLE?[]:Promise.reject(MKError.parseError(De))}}))()}tvEpisode(e,t,r){return this.resource("catalog","tv-episodes",e,_object_spread$e({include:"seasons"},t),r)}tvEpisodes(e,t,r){return this.collection("catalog","tv-episodes",e,_object_spread$e({include:"seasons"},t),r)}tvSeason(e,t,r){return this.resource("catalog","tv-seasons",e,_object_spread$e({include:"episodes"},t),r)}tvSeasons(e,t,r){return this.collection("catalog","tv-seasons",e,_object_spread$e({include:"episodes"},t),r)}tvShow(e,t,r){return this.resource("catalog","tv-shows",e,t,r)}tvShows(e,t,r){return this.collection("catalog","tv-shows",e,t,r)}uploadedAudio(e,t,r){var n=this;return _async_to_generator$r((function*(){return t=_object_spread$e({include:"curator,artists"},t),n.resource("catalog","uploaded-audios",e,t,r)}))()}uploadedAudios(e,t,r){var n=this;return _async_to_generator$r((function*(){return t=_object_spread$e({include:"curator,artists"},t),n.collection("catalog","uploaded-audios",e,t,r)}))()}uploadedVideo(e,t,r){var n=this;return _async_to_generator$r((function*(){return t=_object_spread$e({include:"curator,artists"},t),n.resource("catalog","uploaded-videos",e,t,r)}))()}uploadedVideos(e,t,r){var n=this;return _async_to_generator$r((function*(){return t=_object_spread$e({include:"curator,artists"},t),n.collection("catalog","uploaded-videos",e,t,r)}))()}upsellMarketingItems(e,t){return this.collection("engagement","upsell/marketing-items",void 0,e,t)}station(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.resource("catalog","stations",e,t,r)}))()}stations(e,t,r){var n=this;return _async_to_generator$r((function*(){return!t&&isObject$1(e)&&(t=e,e=void 0),n.collection("catalog","stations",e,t,r)}))()}storefront(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.resource(0,"storefronts",e,t,r)}))()}storefronts(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.collection(0,"storefronts",e,t,r)}))()}musicSummary(e,t,r){var n=this;return _async_to_generator$r((function*(){return n.resource("me","music-summaries",e,t,r)}))()}musicSummarySearch(e={},t){var r=this;return _async_to_generator$r((function*(){return r.collection("me","music-summaries/search",void 0,e,t)}))()}addToLibrary(e){var t=this;return _async_to_generator$r((function*(){return t.developerToken&&t.userToken&&t.library?t.library.add(e):Promise.reject("Invalid tokens")}))()}rating(e,t,r){var n=this;return _async_to_generator$r((function*(){const[i]=yield n.ratings(e,t,r);return i}))()}ratings(e,t,r){if(!this.developerToken||!this.userToken)return Promise.reject("Invalid tokens");const[n]=Object.keys(e),i=e[n],o=Array.isArray(i);if(o&&0===i.length)return Promise.resolve([]);let a="me/ratings/"+formatRatingsContentType(n,o?i[0]:i);return o?t=_object_spread_props$6(_object_spread$e({},t),{ids:i.map(normalizeAdamId)}):a=`${a}/${normalizeAdamId(i)}`,makeRequest(this,a,t,_object_spread$e({shouldCacheResults:!1,reload:!0,includePagination:!1},r))}putRating(e,t,r){var n=this;return _async_to_generator$r((function*(){if(!n.developerToken||!n.userToken)return Promise.reject("Invalid tokens");const[i]=Object.keys(e),o=e[i],a=formatRatingsContentType(i,o),s={method:"PUT",body:JSON.stringify({type:"rating",attributes:{value:t}}),includePagination:!1},c=yield makeRequest(n,`me/ratings/${a}/${normalizeAdamId(o)}`,r,_object_spread$e({shouldCacheResults:!1},s)),[l]=c;return l}))()}deleteRating(e,t){var r=this;return _async_to_generator$r((function*(){if(!r.developerToken||!r.userToken)return Promise.reject("Invalid tokens");const[n]=Object.keys(e),i=e[n],o=formatRatingsContentType(n,i);if(Array.isArray(i))return Promise.all(i.map(e=>r.deleteRating({[n]:e},t))).then(()=>{});yield makeRequest(r,`me/ratings/${o}/${i}`,t,{method:"DELETE",shouldCacheResults:!1,returnRawJSONApiRecords:!0});try{r._store.delete(o,i)}catch(De){return Promise.reject(MKError.parseError(De))}}))()}equivalent(e,t){var r=this;return _async_to_generator$r((function*(){let n=`catalog/${r.userStorefrontId}/${e}`,i={};switch(e){case"albums":case"songs":i={"filter[equivalents]":t};break;case"artists":case"playlists":n=`${n}/${t}`;break;default:return Promise.reject(new MKError(MKError.Reason.INVALID_ARGUMENTS,"Invalid equivalent type"))}return r.resource(0,n,"",i)}))()}collection(e,t,r,n,i){var o=this;return _async_to_generator$r((function*(){let a,s,c=null==i?void 0:i.shouldCacheResults;switch(a=r?_object_spread$e({["charts"===t?"types":"ids"]:r},n):n,e){case"catalog":case"editorial":case"engagement":case"social":case"lyrics":const r=o.storefrontId;s=`${e}/${r}/${t}`;break;case 0:s=t;break;case"me":s=`${e}/${t}`,c=!1}return makeRequest(o,s,a,_object_spread_props$6(_object_spread$e({},i),{shouldCacheResults:c}))}))()}parseResultData(e,t){return e?this._store.write(t):this._store.parse(t)}resource(e,t,r,n,i){var o=this;return _async_to_generator$r((function*(){if(!(null==i?void 0:i.reload)){const e=o._store.read(t,r,n);if(e)return e}const[a]=yield o.collection(e,t,r,n,i);return a}))()}_reindexRelationships(e,t){("data"in e?e.data:e).forEach(e=>{hasOwn(e,"relationships")&&hasOwn(e.relationships,t)&&hasOwn(e.relationships[t],"data")&&Array.isArray(e.relationships[t].data)&&e.relationships[t].data.forEach((e,t)=>{e.id=`${e.id}-${t}`})})}constructor(e,t,r,n,i,o,a={},s){super(e,t,_object_spread_props$6(_object_spread$e({},s),{userToken:n,storage:o})),_define_property$q(this,"_store",void 0),_define_property$q(this,"v3",void 0),_define_property$q(this,"storefrontId",ce.ID),_define_property$q(this,"defaultIncludePaginationMetadata",void 0),_define_property$q(this,"resourceRelatives",{artists:{albums:{include:"tracks"},playlists:{include:"tracks"},songs:null}}),_define_property$q(this,"userStorefrontId",void 0),_define_property$q(this,"library",void 0),_define_property$q(this,"books",void 0),_define_property$q(this,"tvLibrary",void 0),_define_property$q(this,"_podcastsAPI",void 0),_define_property$q(this,"fitness",void 0),this.defaultIncludePaginationMetadata=a.features&&hasOwn(a.features,"api-pagination-metadata"),this._store=new LocalDataStore(a),r&&(this.storefrontId=r.toLowerCase()),n&&i&&(this.userStorefrontId=i.toLowerCase()),this._podcastsAPI=new Podcasts(t,n,r,o,a,_object_spread$e({},s)),this.fitness=new Fitness(t,n,r,o,a,_object_spread$e({},s)),this.tvLibrary=new TVLibrary(t,n,o,a,_object_spread$e({},s)),this.library=new Library(e,t,n,a,this,_object_spread$e({},s)),this.books=new Books(t,n,r,o,a,_object_spread$e({},s)),this.v3=new MediaAPIV3({developerToken:t,mediaUserToken:n,storefrontId:r,realmConfig:{music:{url:e.replace(/\/v[0-9]+(\/)?$/,"")}}})}}function asyncGeneratorStep$q(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$q(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$q(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$q(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$p(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}let ki;_ts_decorate$8([RecommendationUpdate(),_ts_metadata$8("design:type",Function),_ts_metadata$8("design:paramtypes",[Object,"undefined"==typeof QueryParameters?Object:QueryParameters,"undefined"==typeof MakeRequestOptions?Object:MakeRequestOptions,void 0]),_ts_metadata$8("design:returntype",Promise)],API.prototype,"personalRecommendations",null),_ts_decorate$8([RecommendationUpdate(),_ts_metadata$8("design:type",Function),_ts_metadata$8("design:paramtypes",[Object,"undefined"==typeof QueryParameters?Object:QueryParameters,"undefined"==typeof MakeRequestOptions?Object:MakeRequestOptions]),_ts_metadata$8("design:returntype",Promise)],API.prototype,"recommendations",null),_ts_decorate$8([ChunkedIdApi(2),_ts_metadata$8("design:type",Function),_ts_metadata$8("design:paramtypes",[void 0===Ei?Object:Ei,String,Object,"undefined"==typeof QueryParameters?Object:QueryParameters,"undefined"==typeof InternalMakeRequestOptions?Object:InternalMakeRequestOptions]),_ts_metadata$8("design:returntype",Promise)],API.prototype,"collection",null);const wi=function(){var e=_async_to_generator$q((function*(e,t=!1){if(ki&&!t){if(void 0===e.storefrontId||e.storefrontId===ki.storefrontId)return ki;ki.clear()}return ki=new MediaAPIService(e.dispatcher),yield ki.configure(e),ki}));return function(t){return e.apply(this,arguments)}}(),Oi={album:{isPlural:!1,apiMethod:"album",relationshipMethod:{method:"albumRelationship",relationship:"tracks"}},albums:{isPlural:!0,apiMethod:"albums"},audioBook:{isPlural:!1,apiMethod:"audioBook"},audioBooks:{isPlural:!0,apiMethod:"audioBooks"},episode:{isPlural:!1,apiMethod:"episode"},episodes:{isPlural:!0,apiMethod:"episodes"},musicVideo:{isPlural:!1,apiMethod:"musicVideo"},musicVideos:{isPlural:!0,apiMethod:"musicVideos"},musicMovie:{isPlural:!1,apiMethod:"musicMovie"},musicMovies:{isPlural:!0,apiMethod:"musicMovies"},podcast:{isPlural:!1,apiMethod:"podcast"},podcasts:{isPlural:!0,apiMethod:"podcasts"},playlist:{isPlural:!1,apiMethod:"playlist",relationshipMethod:{method:"playlistRelationship",relationship:"tracks"}},playlists:{isPlural:!0,apiMethod:"playlists"},song:{isPlural:!1,apiMethod:"song"},songs:{isPlural:!0,apiMethod:"songs"},tvEpisode:{isPlural:!1,apiMethod:"tvEpisode"},tvEpisodes:{isPlural:!0,apiMethod:"tvEpisodes"},uploadedAudio:{isPlural:!1,apiMethod:"uploadedAudio"},uploadedAudios:{isPlural:!0,apiMethod:"uploadedAudios"},uploadedVideo:{isPlural:!1,apiMethod:"uploadedVideo"},uploadedVideos:{isPlural:!0,apiMethod:"uploadedVideos"}};class MediaAPIService{get isConfigured(){return void 0!==this._api}get api(){if(void 0===this._api)throw new MKError(MKError.Reason.CONFIGURATION_ERROR,"The API cannot be accessed before it is configured.");return this._api}get storefrontId(){return this.store&&this.store.storefrontId}configure(e){var t=this;return _async_to_generator$q((function*(){void 0!==e.store&&(t.store=e.store,[Dn.authorizationStatusDidChange,Dn.userTokenDidChange,Dn.storefrontIdentifierDidChange,Dn.storefrontCountryCodeDidChange].forEach(e=>{t.store.storekit.addEventListener(e,()=>t.resetAPI())}),t._initializeAPI(e))}))()}clear(){this.api&&this.api.clearNetworkCache&&this.api.clearNetworkCache()}getAPIForItem(e){var t=this;return _async_to_generator$q((function*(){return isLibraryType(e)?(yield t.store.authorize(),t.api.library||t.api):t.api}))()}resetAPI(){var e=this;return _async_to_generator$q((function*(){e.clear(),e._initializeAPI()}))()}_initializeAPI(e){if(void 0!==(null==e?void 0:e.api))return void(this._api=e.api);const t=e&&e.store||this.store;if(void 0===t)return;const r=qn.features["api-session-storage"]?getSessionStorage():void 0,n=e&&e.storefrontId||t.storefrontId,i=new API(this.url,t.developerToken,n,t.storekit.userToken,t.storekit.storefrontCountryCode,r,qn,null==e?void 0:e.sessionOptions);this._api=i.v3,this._api=i}_updateStorefrontId(e){var t=this;return _async_to_generator$q((function*(){t.api&&e===t.api.storefrontId||(yield t.configure({dispatcher:t._dispatcher,store:t.store,storefrontId:e}))}))()}constructor(e){if(_define_property$p(this,"_dispatcher",void 0),_define_property$p(this,"namedQueueOptions",void 0),_define_property$p(this,"url",void 0),_define_property$p(this,"store",void 0),_define_property$p(this,"_api",void 0),this._dispatcher=e,!qn.urls.mediaApi)throw new Error("bag.urls.mediaApi is not configured");this.url=qn.urls.mediaApi,this.namedQueueOptions=Oi;var t=this;this._dispatcher.subscribe(et.apiStorefrontChanged,function(){var e=_async_to_generator$q((function*(e,{storefrontId:r}){yield t._updateStorefrontId(r)}));return function(t,r){return e.apply(this,arguments)}}())}}function asyncGeneratorStep$p(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$p(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$p(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$p(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function configure$2(e){return _configure$2.apply(this,arguments)}function _configure$2(){return(_configure$2=_async_to_generator$p((function*(e){const t=new UTSClientService;return yield t.configure(e),t}))).apply(this,arguments)}class UTSClientService{get isConfigured(){return void 0!==this.api}configure(e){var t=this;return _async_to_generator$p((function*(){t.api=e.api}))()}clear(){}getAPIForItem(e){var t=this;return _async_to_generator$p((function*(){if(void 0===t.api)throw new Error("UTS has not been configured");return t.api}))()}constructor(){_define_property$o(this,"api",void 0),_define_property$o(this,"namedQueueOptions",{}),_define_property$o(this,"url","")}}var Ii;e.SupportedAPIs=void 0,(Ii=e.SupportedAPIs||(e.SupportedAPIs={})).MEDIA_API="media-api",Ii.UTS_CLIENT="uts-client";const createMediaAPIServiceDescriptor=e=>{let t;var r;"api"in e?t={api:e.api}:t=null!==(r=e.configureOptions)&&void 0!==r?r:{};return{apiType:"media-api",options:t}},createUTSAPIServiceDescriptor=e=>{const{client:t}=e.configureOptions;return{apiType:"uts-client",options:{api:t}}};function asyncGeneratorStep$o(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _define_property$n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$n(e,t,r[t])}))}return e}class APIServiceManager{get api(){return this.getApiByType(this._defaultAPI)}get apiService(){if(void 0!==this._defaultAPI)return this._apisByType[this._defaultAPI];Mn.error("There is no API instance configured")}get mediaAPI(){return this.getApiByType(e.SupportedAPIs.MEDIA_API)}get utsClient(){return this.getApiByType(e.SupportedAPIs.UTS_CLIENT)}getApiByType(e){let t;if(void 0!==e&&(t=this._apisByType[e]),void 0===t||void 0===t.api)throw new MKError(MKError.Reason.CONFIGURATION_ERROR,"There is no API instance configured for the requested type: "+e);return t.api}set defaultApiType(e){this._defaultAPI=e}registerAPIService(t){var r=this;return function(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$o(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$o(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}((function*(){const{apiType:n,options:i}=t,o={store:r.store,dispatcher:r._dispatcher};void 0===r._defaultAPI&&(r._defaultAPI=n),n===e.SupportedAPIs.MEDIA_API?r._apisByType[n]=yield wi.call(r,_object_spread$d({},i,o)):n===e.SupportedAPIs.UTS_CLIENT&&(r._apisByType[n]=yield configure$2.call(r,_object_spread$d({},i,o)))}))()}constructor(e,t){_define_property$n(this,"store",void 0),_define_property$n(this,"_dispatcher",void 0),_define_property$n(this,"_apisByType",void 0),_define_property$n(this,"_defaultAPI",void 0),this.store=e,this._dispatcher=t,this._apisByType={}}}const Ai={};function adaptAddEventListener(e,t,r,n={}){const{once:i}=n,o=function(e,t){const r=getCallbacksForName(e),wrappedCallback=(e,r)=>{t(r)};return r.push([t,wrappedCallback]),wrappedCallback}(t,r);!0===i?e.subscribeOnce(t,o):e.subscribe(t,o)}function getCallbacksForName(e){let t=Ai[e];return t||(t=[],Ai[e]=t),t}function asyncGeneratorStep$n(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$n(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$n(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$n(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$m(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Ri=Mn.createChild("rtc");class RTCStreamingTracker{get isConfigured(){return void 0!==this.instance}configure(e){var t=this;return _async_to_generator$n((function*(){t.instance=e.instance}))()}handleEvent(e,t,r){}loadScript(){return _async_to_generator$n((function*(){if(!qn.urls.rtc)throw new Error("bag.urls.rtc is not configured");yield loadScript(qn.urls.rtc)}))()}prepareReportingAgent(e){this.clearReportingAgent();const{Sender:t,ClientName:r,ServiceName:n,ApplicationName:i,ReportingStoreBag:o,DeviceName:a}=window.rtc.RTCReportingAgentConfigKeys;e=null!=e?e:this.instance.nowPlayingItem;const s=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$m(e,t,r[t])}))}return e}({firmwareVersion:this.generateBrowserVersion(),model:this.options.browserName},this.getMediaIdentifiers(e));void 0===this._storeBag&&(this._storeBag=this.generateStoreBag());const c={[t]:"HLSJS",[r]:this.options.clientName,[n]:this.options.serviceName,[i]:this.options.applicationName,[o]:this._storeBag,[a]:this.options.osVersion,userInfoDict:s};return Ri.debug("RTC: creating reporting agent with config",c),this.reportingAgent=new window.rtc.RTCReportingAgent(c),Ri.debug("RTC: created reporting agent",this.reportingAgent),this.reportingAgent}cleanup(){var e=this;return _async_to_generator$n((function*(){e.clearReportingAgent()}))()}getMediaIdentifiers(e){const t=null==e?void 0:e.defaultPlayable;if(t){var r;const e={};return void 0!==(null===(r=t.mediaMetrics)||void 0===r?void 0:r.MediaIdentifier)&&(e.MediaIdentifier=t.mediaMetrics.MediaIdentifier),void 0!==t.channelId&&(e.ContentProvider=t.channelId),e}return"musicVideo"===(null==e?void 0:e.type)?{MediaIdentifier:"adamid="+e.id}:(null==e?void 0:e.isLiveVideoStation)?{MediaIdentifier:"raid="+e.id}:void 0}clearReportingAgent(){void 0!==this.reportingAgent&&(this.reportingAgent.destroy(),Ri.debug("RTC: called destroy on reporting agent",this.reportingAgent),this.reportingAgent=void 0)}generateBrowserVersion(){return this.options.browserMajorVersion?`${this.options.browserMajorVersion}.${this.options.browserMinorVersion||0}`:"unknown"}generateStoreBag(){var e;const{storeBagURL:t,clientName:r,applicationName:n,serviceName:i,browserName:o}=this.options,a={iTunesAppVersion:`${`${qn.app.name}-${qn.app.build}`}/${null===(e=this.instance)||void 0===e?void 0:e.version}`},s=new window.rtc.RTCStorebag.RTCReportingStoreBag(t,r,i,n,o,a);return Ri.debug("RTC: created store bag",s),s}constructor(e){_define_property$m(this,"options",void 0),_define_property$m(this,"reportingAgent",void 0),_define_property$m(this,"instance",void 0),_define_property$m(this,"currentMediaItem",void 0),_define_property$m(this,"_storeBag",void 0),_define_property$m(this,"requestedEvents",[]),this.options=e}}function asyncGeneratorStep$m(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _define_property$l(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$7(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$7(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}class PlayActivityService{cleanup(){this.trackers.forEach(e=>{var t;return null===(t=e.cleanup)||void 0===t?void 0:t.call(e)}),this.clearIntention(),this.teardownListeners(),this.registeredEvents.clear()}configure(e){var t=this;return function(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$m(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$m(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}((function*(){t.cleanup(),t.registeredEvents=function(e){const t=[];for(const r of e)t.push(...r.requestedEvents);return new Set(t)}(t.trackers),t.setupListeners();try{yield Promise.all(t.trackers.map(t=>t.configure(e)))}catch(r){Mn.error("Error configuring a play activity service",r)}}))()}getTrackerByType(e){return this.trackers.find(t=>t instanceof e)}handleEvent(e,t={}){const r=this.addIntention(e,t);e===et.playerActivate&&(r.flush="boolean"==typeof t.isPlaying?!t.isPlaying:void 0);for(const n of this.trackers)n.handleEvent(e,r,t.item)}addIntention(e,t){if(![et.playbackPause,et.playbackStop].includes(e))return t;const r=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$l(e,t,r[t])}))}return e}({},this.lastUserIntent,this.lastApplicationIntent,t);return this.clearIntention(),r}clearIntention(){this.lastUserIntent=void 0,this.lastApplicationIntent=void 0}recordApplicationIntent(e,t){this.lastApplicationIntent=t}recordUserIntent(e,t){this.lastUserIntent=t}setupListeners(){this.registeredEvents.forEach(e=>{this.dispatcher.subscribe(e,this.handleEvent)}),this.dispatcher.subscribe(et.userActivityIntent,this.recordUserIntent),this.dispatcher.subscribe(et.applicationActivityIntent,this.recordApplicationIntent)}teardownListeners(){this.registeredEvents.forEach(e=>{this.dispatcher.unsubscribe(e,this.handleEvent)}),this.dispatcher.unsubscribe(et.userActivityIntent,this.recordUserIntent),this.dispatcher.unsubscribe(et.applicationActivityIntent,this.recordApplicationIntent)}constructor(e,t){_define_property$l(this,"dispatcher",void 0),_define_property$l(this,"trackers",void 0),_define_property$l(this,"registeredEvents",void 0),_define_property$l(this,"lastUserIntent",void 0),_define_property$l(this,"lastApplicationIntent",void 0),_define_property$l(this,"isConfigured",void 0),this.dispatcher=e,this.trackers=t,this.registeredEvents=new Set,this.isConfigured=!0}}function asyncGeneratorStep$l(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$l(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$l(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$l(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}_ts_decorate$7([Bind(),_ts_metadata$7("design:type",Function),_ts_metadata$7("design:paramtypes",[String,Object]),_ts_metadata$7("design:returntype",void 0)],PlayActivityService.prototype,"handleEvent",null),_ts_decorate$7([Bind(),_ts_metadata$7("design:type",Function),_ts_metadata$7("design:paramtypes",[String,"undefined"==typeof ActivityIntention?Object:ActivityIntention]),_ts_metadata$7("design:returntype",void 0)],PlayActivityService.prototype,"recordApplicationIntent",null),_ts_decorate$7([Bind(),_ts_metadata$7("design:type",Function),_ts_metadata$7("design:paramtypes",[String,"undefined"==typeof ActivityIntention?Object:ActivityIntention]),_ts_metadata$7("design:returntype",void 0)],PlayActivityService.prototype,"recordUserIntent",null);const $i=BooleanDevFlag.register("mk-force-safari-hlsjs");function useNativeSafariPlayback(){return!$i.enabled}function requiresHlsJs(e){return _requiresHlsJs.apply(this,arguments)}function _requiresHlsJs(){return(_requiresHlsJs=_async_to_generator$l((function*(e){const t=null!=e?e:yield findKeySystemPreference(),r=!useNativeSafariPlayback();return t!==Fe.FAIRPLAY||r}))).apply(this,arguments)}function asyncGeneratorStep$k(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$k(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$k(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$k(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$k(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$a(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$k(e,t,r[t])}))}return e}function _object_spread_props$5(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function fetchRadioStationAssets(e,t,r){return _fetchRadioStationAssets.apply(this,arguments)}function _fetchRadioStationAssets(){return(_fetchRadioStationAssets=_async_to_generator$k((function*(e,t,r){const n=new Headers({Authorization:"Bearer "+t,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+r}),i=encodeQueryParameters(_object_spread_props$5(_object_spread$a({},e.playParams),{keyFormat:"web"})),o=`${qn.urls.mediaApi}/play/assets?${i}`,a=yield fetch(o,{method:"GET",headers:n});if(500===a.status){const t=new MKError(MKError.Reason.SERVER_ERROR);throw t.data=e,t}if(403===a.status){let t;try{var s;t=yield a.json(),t=null==t||null===(s=t.errors)||void 0===s?void 0:s[0]}catch(d){}const r="40303"===(null==t?void 0:t.code)?MKError.Reason.SUBSCRIPTION_ERROR:MKError.Reason.ACCESS_DENIED;var c;const n=new MKError(r,null!==(c=null==t?void 0:t.title)&&void 0!==c?c:null==t?void 0:t.detail);throw n.data=e,n}if(!a.ok){const t=new MKError(MKError.Reason.CONTENT_UNAVAILABLE);throw t.data=e,t}const l=(yield a.json()).results;return Mn.debug(`media-item: loaded data from ${o}: ${JSON.stringify(l)}`),l}))).apply(this,arguments)}function asyncGeneratorStep$j(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$j(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$j(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$j(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function fetchMZPlayItem(e,t){return _fetchMZPlayItem.apply(this,arguments)}function _fetchMZPlayItem(){return(_fetchMZPlayItem=_async_to_generator$j((function*(e,t){const r=new Headers({Authorization:"Bearer "+t.developerToken,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+t.musicUserToken}),i=String(e.playParams.id),o=e.isLibraryItem?Object.fromEntries([["purchaseAdamId",e.playParams.purchasedId],["subscriptionAdamId",n(i)?i.slice(2):e.playParams.catalogId],["universalLibraryId",isLibraryType(i)?i:void 0]].filter((e,t)=>void 0!==t)):{salableAdamId:i},a=yield fetch(t.endpoint,{method:"POST",body:JSON.stringify(o),headers:r}),s=JSON.parse(yield a.text());if(void 0===(null==s?void 0:s.songList)||0===s.songList.length)throw MKError.serverError(s,MKError.Reason.UNSUPPORTED_ERROR);return s.songList[0]}))).apply(this,arguments)}function asyncGeneratorStep$i(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$i(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$i(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$i(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function fetchPlaylistAssets(e){return _fetchPlaylistAssets.apply(this,arguments)}function _fetchPlaylistAssets(){return(_fetchPlaylistAssets=_async_to_generator$i((function*(e){let t;try{t=yield fetch(e)}catch(d){throw new MKError(MKError.Reason.CONTENT_UNAVAILABLE)}const r=yield t.text(),n=/^#EXT-X-STREAM-INF:.*\s*\n(.*$)/gim;let i;const o=[];for(;i=n.exec(r);){var a,s;let t=i[1];const r=i[0];var c;const n=null!==(c=null===(a=/CODECS=("(.*)")/.exec(r))||void 0===a?void 0:a[2])&&void 0!==c?c:"";var l;const d=null!==(l=null===(s=/(?:[^\w-])BANDWIDTH=((\d+))/.exec(r))||void 0===s?void 0:s[2])&&void 0!==l?l:0;/^http(s)?:\/\//.test(t)||(t=joinURLPath([...splitURLPath(e).slice(0,-1),t])),o.push({bandwidth:Number(d),codec:n,URL:t})}return o}))).apply(this,arguments)}function asyncGeneratorStep$h(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$h(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$h(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$h(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}const Ci=BooleanDevFlag.get("mk-hlsjs-live-radio");function prepareMediaAPIItem(e,t,r){return _prepareMediaAPIItem.apply(this,arguments)}function _prepareMediaAPIItem(){return(_prepareMediaAPIItem=_async_to_generator$h((function*(e,t,r){if(void 0===r)return Promise.reject(new MKError(MKError.Reason.AUTHORIZATION_ERROR,"Unable to prepare media item for play: missing MusicUserToken."));e.hasOffersHlsUrl?yield prepareWithHLSOffers(e):e.isLiveVideoStation?yield prepareLiveVideoStation(e,t,r):e.isLiveRadioStation?yield prepareLiveRadioStation(e,t,r):e.isRadioEpisode?yield prepareRadioStationEpisode(e,t,r):"musicVideo"===e.type||"musicMovie"===e.type?yield prepareMusicVideo(e,t,r):yield prepareMZPlayItem(e,t,r)}))).apply(this,arguments)}function prepareWithHLSOffers(e){return _prepareWithHLSOffers.apply(this,arguments)}function _prepareWithHLSOffers(){return(_prepareWithHLSOffers=_async_to_generator$h((function*(e){var t,r;const n=qn.urls.hlsOffersKeyUrls;if(!n)throw new MKError(MKError.Reason.CONTENT_UNSUPPORTED,"HLS OFFERS");var i;const o=null!==(i=null===(t=e.attributes)||void 0===t?void 0:t.assetUrl)&&void 0!==i?i:null===(r=e.attributes.offers)||void 0===r?void 0:r[0].hlsUrl;updateItemPlaybackProperties(e,{assets:yield fetchPlaylistAssets(o),playlist:o,keyURLs:n})}))).apply(this,arguments)}function prepareRadioStationEpisode(e,t,r){return _prepareRadioStationEpisode.apply(this,arguments)}function _prepareRadioStationEpisode(){return(_prepareRadioStationEpisode=_async_to_generator$h((function*(e,t,r){const n=yield fetchRadioStationAssets(e,t,r);if(void 0===n.assets||0===n.assets.length)throw new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"Missing RadioStation assets");const i=n.assets[0];n.assets.length>1&&Mn.warn("RadioStation endpoint returned multiple assets"),Object.assign(e,{assetURL:i.url,keyURLs:{"hls-key-cert-url":i.fairPlayKeyCertificateUrl,"hls-key-server-url":i.keyServerUrl,"widevine-cert-url":i.widevineKeyCertificateUrl}})}))).apply(this,arguments)}function prepareLiveVideoStation(e,t,r){return _prepareLiveVideoStation.apply(this,arguments)}function _prepareLiveVideoStation(){return(_prepareLiveVideoStation=_async_to_generator$h((function*(e,t,r){const n=yield fetchRadioStationAssets(e,t,r);if(void 0===n.assets||0===n.assets.length)throw new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"Missing RadioStation assets");const i=n.assets[0];n.assets.length>1&&Mn.warn("RadioStation endpoint returned multiple assets"),Object.assign(e,{assetURL:i.url,keyURLs:{"hls-key-cert-url":i.fairPlayKeyCertificateUrl,"hls-key-server-url":i.keyServerUrl,"widevine-cert-url":i.widevineKeyCertificateUrl}})}))).apply(this,arguments)}function prepareLiveRadioStation(e,t,r){return _prepareLiveRadioStation.apply(this,arguments)}function _prepareLiveRadioStation(){return(_prepareLiveRadioStation=_async_to_generator$h((function*(e,t,r){const n=yield fetchRadioStationAssets(e,t,r);if(void 0===n.assets||0===n.assets.length)throw new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"Missing Live Radio Station assets");const i=n.assets[0];n.assets.length>1&&Mn.warn("RadioStation endpoint returned multiple assets"),updateItemPlaybackProperties(e,Ci?{playlist:i.url,keyURLs:{"hls-key-cert-url":i.fairPlayKeyCertificateUrl,"hls-key-server-url":i.keyServerUrl,"widevine-cert-url":i.widevineKeyCertificateUrl}}:{assets:yield fetchPlaylistAssets(i.url),keyURLs:{"hls-key-cert-url":i.fairPlayKeyCertificateUrl,"hls-key-server-url":i.keyServerUrl,"widevine-cert-url":i.widevineKeyCertificateUrl}})}))).apply(this,arguments)}function prepareMusicVideo(e,t,r){return _prepareMusicVideo.apply(this,arguments)}function _prepareMusicVideo(){return(_prepareMusicVideo=_async_to_generator$h((function*(e,t,r){if(Mn.trace("prepareMusicVideo",e.playParams.id),!(yield hasMusicSubscription()))return;if(!qn.urls.webPlayback)throw new MKError(MKError.Reason.CONFIGURATION_ERROR,"bag.urls.webPlayback is not configured");const n=yield fetchMZPlayItem(e,{endpoint:qn.urls.webPlayback,developerToken:t,musicUserToken:r});updateItemPlaybackProperties(e,{songId:n.songId,playlist:n["hls-playlist-url"],keyURLs:{"hls-key-cert-url":n["hls-key-cert-url"],"hls-key-server-url":n["hls-key-server-url"],"widevine-cert-url":n["widevine-cert-url"]}})}))).apply(this,arguments)}function prepareMZPlayItem(e,t,r){return _prepareMZPlayItem.apply(this,arguments)}function _prepareMZPlayItem(){return(_prepareMZPlayItem=_async_to_generator$h((function*(e,t,r){if(Mn.trace("prepareItemWithMZPlay",e),!(yield hasMusicSubscription()))return;if(!qn.urls.webPlayback)throw new Error("bag.urls.webPlayback is not configured");const n=yield fetchMZPlayItem(e,{endpoint:qn.urls.webPlayback,developerToken:t,musicUserToken:r});updateItemPlaybackProperties(e,{songId:n.songId,keyURLs:{"hls-key-cert-url":n["hls-key-cert-url"],"hls-key-server-url":n["hls-key-server-url"],"widevine-cert-url":n["widevine-cert-url"]},assets:n.assets})}))).apply(this,arguments)}function updateItemPlaybackProperties(e,t){return void 0!==t.songId&&(e.songId=String(t.songId)),void 0!==t.keyURLs&&(e.keyURLs=t.keyURLs),void 0!==t.playlist&&(e.assetURL=String(t.playlist)),void 0!==t.assets&&(e.assets=t.assets),e}function asyncGeneratorStep$g(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$g(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$g(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$g(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function prepareToPlayMediaItem(e,t){return _prepareToPlayMediaItem.apply(this,arguments)}function _prepareToPlayMediaItem(){return(_prepareToPlayMediaItem=_async_to_generator$g((function*(e,t){if(t.isPreparedToPlay)Mn.warn("media-item: item is prepared to play");else{if(Mn.debug("media-item: item.prepareToPlay playParams",t.playParams),t.state=y.loading,t.isUTS)return Promise.reject(new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Item was not prepared to play"));{const{developerToken:r,userToken:n}=e.store;yield prepareMediaAPIItem(t,r,n)}}}))).apply(this,arguments)}function shouldPlayPreview(e,t){return _shouldPlayPreview.apply(this,arguments)}function _shouldPlayPreview(){return(_shouldPlayPreview=_async_to_generator$g((function*(e,t){return!!e.previewURL&&(!!t||!e.playRawAssetURL&&(!(yield hasMusicSubscription())||(!hasAuthorization()||!e.isPlayable||!supportsDrm())))}))).apply(this,arguments)}function _prepareForEncryptedPlayback(){return(_prepareForEncryptedPlayback=_async_to_generator$g((function*(e,t,r){if(Mn.debug("prepareForEncryptedPlayback"),!t.isUTS&&!hasAuthorization())return Promise.reject(new MKError(MKError.Reason.AUTHORIZATION_ERROR,"Unable to prepare for playback."));try{yield prepareToPlayMediaItem(e,t)}catch(De){if(De.reason===MKError.Reason.AUTHORIZATION_ERROR)yield e.store.storekit.revokeUserToken();else if(De.reason===MKError.Reason.TOKEN_EXPIRED)try{return yield e.store.storekit.renewUserToken(),yield prepareToPlayMediaItem(e,t),t.playbackData=_playbackDataForItem(t,r),t}catch(n){}if(De)return Promise.reject(De)}return t.playbackData=_playbackDataForItem(t,r),t}))).apply(this,arguments)}function _playbackDataForItem(t,r){if(Mn.debug("mk: _playbackDataForItem",t),t.isCloudUpload)return t.assets[0];if("musicVideo"!==t.type&&!t.isLiveVideoStation){if(!t.isLiveRadioStation){const[e]=t.assets.filter(e=>{if(!("flavor"in e))return!1;const t=new RegExp(`\\d{1,2}\\:(c${(null===(n=window.WebKitMediaKeys)||void 0===n?void 0:n.isTypeSupported(ze+".1_0",He.AVC1))?"bc":"tr"}p)(\\d{2,3})`,"i");var n;const i=t.test(e.flavor);var o;const a=null!==(o=e.flavor.match(t))&&void 0!==o?o:[];return i&&parseInt(a[2],10)<=r.bitrate});return e}{var n;const i=t.assets.reduce((e,t)=>{const r=t.bandwidth;return e[r]||(e[r]=[]),e[r].push(t),e},{}),o=Object.keys(i).sort((e,t)=>parseInt(e,10)-parseInt(t,10)),a=r.bitrate===e.PlaybackBitrate.STANDARD?o[0]:o[o.length-1];(null==i||null===(n=i[a])||void 0===n?void 0:n[0].URL)&&(t.assetURL=i[a][0].URL)}}}function _define_property$j(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$6(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$6(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}class ID3MetadataTrackManager{get activeMetadata(){return this._activeMetadata}get activeCues(){var e;const t=null===(e=this.metadataTrack)||void 0===e?void 0:e.activeCues;return null!=t?Array.from(t):[]}get isDestroyed(){return this._isDestroyed}get tracks(){return void 0!==this.metadataTrack?[this.metadataTrack]:[]}get currentTrack(){return this.metadataTrack}attach(e){if(void 0!==this.mediaElement&&this.mediaElement!==e)throw new Error("MetadaTrackManager is already attached to a different HTMLMediaElement.");this.mediaElement!==e&&(this.mediaElement=e,this.mediaElement.addEventListener("loadedmetadata",this.registerMetadataTrack),this.mediaElement.addEventListener("loadeddata",this.registerMetadataTrack))}detach(){void 0!==this.mediaElement&&(this.mediaElement.removeEventListener("loadedmetadata",this.registerMetadataTrack),this.mediaElement.removeEventListener("loadeddata",this.registerMetadataTrack),this.mediaElement=void 0),void 0!==this.metadataTrack&&(this.metadataTrack.removeEventListener("cuechange",this.onCueChange),this.metadataTrack=void 0)}registerMetadataTrack(e){if(void 0!==this.mediaElement)for(let r=0;r<this.mediaElement.textTracks.length;r++){const e=this.mediaElement.textTracks[r];if("metadata"===e.kind){var t;if(void 0===this.metadataTrack)this.metadataTrack=e,this.metadataTrack.addEventListener("cuechange",this.onCueChange);else yn.warning(`Skipping registering metadata TextTrack with id "${null!==(t=e.id)&&void 0!==t?t:"unknown"}"`);break}}}onCueChange(e){if(yn.debug("Processing metadata cues"),void 0===this.activeCues||this.activeCues.length<=0){var t;if(void 0!==this.activeMetadata)null===(t=this.onchange)||void 0===t||t.call(this);this._activeMetadata=void 0}else{const e=function(e){const t={};for(const i of e){if(!isTextTrackID3FrameCue(i)||void 0===(null==i?void 0:i.value))continue;const e=i.value;switch(e.key){case"TALB":t.album=e.data;break;case"TIT2":t.title=e.data;break;case"TPE1":t.performer=e.data;break;case"WXXX":var r,n;if(t.links=null!==(r=t.links)&&void 0!==r?r:[],!t.links.some(({url:t})=>t===e.data))t.links.push({description:null!==(n=e.description)&&void 0!==n?n:"",url:e.data});break;case"PRIV":{const r=e.owner||e.info;"com.apple.radio.ping.jingle"===r&&(t.blob=parsePingBlob(e.data)),"com.apple.radio.adamid"===r&&(t.storefrontAdamIds=parseStorefrontAdamIds(e.data));break}}}return new TimedMetadata(t)}(this.activeCues);var r;if(void 0===this.activeMetadata||!e.equals(this.activeMetadata))yn.debug("Track TimedMetadata changed",e),this._activeMetadata=e,null===(r=this.onchange)||void 0===r||r.call(this,e)}}saveTrack(){}restoreSelectedTrack(){}destroy(){this._isDestroyed=!0,this.onchange=void 0,this.detach()}constructor(e){_define_property$j(this,"_isDestroyed",!1),_define_property$j(this,"mediaElement",void 0),_define_property$j(this,"metadataTrack",void 0),_define_property$j(this,"_activeMetadata",void 0),_define_property$j(this,"onchange",void 0),this.onchange=null==e?void 0:e.onchange,void 0!==(null==e?void 0:e.element)&&this.attach(e.element)}}function asyncGeneratorStep$f(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$f(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$f(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$f(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$5(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$5(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}_ts_decorate$6([Bind(),_ts_metadata$6("design:type",Function),_ts_metadata$6("design:paramtypes",[Object]),_ts_metadata$6("design:returntype",void 0)],ID3MetadataTrackManager.prototype,"registerMetadataTrack",null),_ts_decorate$6([Bind(),_ts_metadata$6("design:type",Function),_ts_metadata$6("design:paramtypes",[Object]),_ts_metadata$6("design:returntype",void 0)],ID3MetadataTrackManager.prototype,"onCueChange",null);const Di=BooleanDevFlag.get("mk-hlsjs-item-preloading"),Mi={keySystemGenericError:"keySystemGenericError"},Ni=new Set([MKError.Reason.DEVICE_LIMIT,MKError.Reason.GEO_BLOCK]),Li={};Li[Fe.FAIRPLAY]="fairplaystreaming",Li[Fe.PLAYREADY]="playready",Li[Fe.WIDEVINE]="widevine";const xi=Ue.createChild("hlsjs-audio"),ji=JsonDevFlag.register("mk-hlsjs-config-overrides");class HlsJsAudioPlayer extends BasePlayer{loadPreviewImage(){return _async_to_generator$f((function*(){}))()}get _targetElement(){return this.mediaElement}preloadItem(e,t){var r=this;return _async_to_generator$f((function*(){if(xi.trace("preloadItem",e,t),!0===Di){const n=generateAssetUrl(e,t);xi.debug(`Prefetching HLS source for item "${e.id}" with license URL "${n}"`),r.hls.prefetchSource(n,{itemId:e.id})}}))()}setPresentationMode(e){return _async_to_generator$f((function*(){return Promise.resolve()}))()}get shouldDispatchErrors(){return!this.userInitiated||this._playbackDidStart}get currentPlayingDate(){var e;return null===(e=this.hls)||void 0===e?void 0:e.playingDate}get isPlayingAtLiveEdge(){var e;const t=this.hls;return!(!t||!(null===(e=this.nowPlayingItem)||void 0===e?void 0:e.isLinearStream))&&!!t.isPlayingAtLive}playItemFromEncryptedSource(t,r=!1,n={}){var i=this;return _async_to_generator$f((function*(){i.playbackState!==e.PlaybackStates.stopped?(t.playbackType=e.PlaybackType.encryptedFull,i.nowPlayingItem=t,t.state=y.loading,i.userInitiated=r,yield i.playHlsStream(t.assetURL,t,n)):xi.debug("hlsjsAudioPlayer.playItemFromEncryptedSource aborting playback because player is stopped")}))()}initializeMediaElement(){var e=this;return _async_to_generator$f((function*(){const t=nextAvailableAudioElement();t.autoplay=!1,t.id="apple-music-player",t.controls=!1,t.muted=!1,t.playbackRate=1,t.preload="metadata",t.volume=1,e.mediaElement=t,document.body.appendChild(t),e.id3MetadataManager.attach(t),xi.debug("initializedMediaElement",t)}))()}get seekableTimeRanges(){const e=this.hls;return e?e.seekableTimeRanges:this.currentPlaybackDuration?[{start:0,end:this.currentPlaybackDuration}]:void 0}initializeExtension(){var e=this;return _async_to_generator$f((function*(){e._keySystem=yield findKeySystemPreference();try{var t;if(!Ke.urls.hls)throw new Error("bag.urls.hls is not configured");yield Promise.all([loadScript(Ke.urls.hls),null===(t=e._rtcTracker)||void 0===t?void 0:t.loadScript()])}catch(r){throw xi.error("hlsjs-audio-player failed to load script "+Ke.urls.hls,r),r}}))()}stopMediaElement(){var e=this,_superprop_get_stopMediaElement=()=>super.stopMediaElement;return _async_to_generator$f((function*(){xi.trace("HlsJsAudioPlayer.stopMediaElement()"),yield _superprop_get_stopMediaElement().call(e),e.destroy()}))()}destroy(){if(xi.debug("HlsJsAudioPlayer.destroy()"),this.hls){const e=this.hls;e.stopLoad();const t=e.Events;e.off(t.ERROR,this.handleHlsError),e.off(t.INTERNAL_ERROR,this.handleHlsError),e.off(t.MANIFEST_PARSED,this.handleManifestParsed),e.off(t.KEY_REQUEST_STARTED,this.handleKeyRequestStarted),e.off(t.LICENSE_CHALLENGE_CREATED,this.handleLicenseChallengeCreated),e.off(t.LEVEL_SWITCHED,this.handleLevelSwitched),e.destroy()}this.id3MetadataManager.destroy(),super.destroy(),asAsync(this._license.stop())}playHlsStream(e,t,r={}){var n=this;return _async_to_generator$f((function*(){const{_keySystem:i}=n;if(!i)return;let o,a;n._unrecoverableError=void 0,n.createHlsPlayer(),i===Fe.WIDEVINE&&(o="WIDEVINE_SOFTWARE",a={initDataTypes:["cenc","keyids"],distinctiveIdentifier:"optional",persistentState:"required"});const s={subs:"accepts-css",platformInfo:{requiresCDMAttachOnStart:i!==Fe.NONE,maxSecurityLevel:o,keySystemConfig:a},appData:{serviceName:Ke.app.name}},{_rtcTracker:c,hls:l}=n;if(c){const e=c.prepareReportingAgent(t);void 0!==e&&(s.appData.reportingAgent=e)}xi.debug("RTC: loadSource with load options",s);const d=n.startPlaybackSequence();return xi.info("Manifest already loaded, passing url to HLSJS",e),l.loadSource(e,s,r.startTime),l.attachMedia(n.mediaElement),t&&(n._licenseServerUrl=t.keyURLs["hls-key-server-url"],i===Fe.FAIRPLAY?l.setProtectionData({fairplaystreaming:{serverCertUrl:t.keyURLs["hls-key-cert-url"]}}):l.setProtectionData({widevine:{serverCertUrl:t.keyURLs["widevine-cert-url"]}})),d}))()}createHlsPlayer(){const{_keySystem:e}=this,{os:t}=this.services.runtime,{Hls:r}=window,n=un.get(),i={clearMediaKeysOnPromise:!1,debug:!!n,debugLevel:n,enableItemPreloading:!0===Di,enablePerformanceLogging:!!n,enablePlayReadyKeySystem:!0,enableRtcReporting:void 0!==this._rtcTracker,keySystemPreference:Li[e],useMediaKeySystemAccessFilter:!0,nativeControlsEnabled:t.isAndroid,enableID3Cues:!0};(e=>{const t=ji.value;t&&"object"==typeof t&&Object.assign(e,t)})(i);const o=new r(i),{ERROR:a,INTERNAL_ERROR:s,MANIFEST_PARSED:c,KEY_REQUEST_STARTED:l,LICENSE_CHALLENGE_CREATED:d,LEVEL_SWITCHED:u}=r.Events;o.on(a,this.handleHlsError),o.on(s,this.handleHlsError),o.on(c,this.handleManifestParsed),o.on(l,this.handleKeyRequestStarted),o.on(d,this.handleLicenseChallengeCreated),o.on(u,this.handleLevelSwitched),this.hls=o}handleLevelSwitched(e,t){var r,n;const{level:i}=t;if(!i)return;const o=null===(r=this._levels)||void 0===r?void 0:r.find(e=>e.persistentId===i);if(!o||(null===(n=this._currentLevel)||void 0===n?void 0:n.persistentId)===(null==o?void 0:o.persistentId))return;this._currentLevel=o;const a=void 0!==o.audioGroupId?this._channelsByGroup[o.audioGroupId]:void 0;this._dispatcher.publish(et.hlsLevelUpdated,{level:o,channels:a})}handleHlsError(e,t){if(xi.warn("HLS.js error",JSON.stringify(t)),this._unrecoverableError)return;let r=new MKError(MKError.Reason.UNSUPPORTED_ERROR,t.reason);r.data=t;const{keySystemGenericError:n}=Mi;if(t.details!==n){if("output-restricted"===t.reason&&(r=new MKError(MKError.Reason.OUTPUT_RESTRICTED,t.reason)),t.fatal){if(this.hls.destroy(),!this.shouldDispatchErrors)throw r;this._dispatcher.publish(rt.mediaPlaybackError,r)}}else this._dispatcher.publish(n,r)}handleManifestParsed(e,t){var r=this;return _async_to_generator$f((function*(){var e,n;let i;xi.debug("handleManifestParsed",t),r._levels=null!==(e=t.levels)&&void 0!==e?e:[],r.nowPlayingItem.state=y.ready,r._channelsByGroup=(null!==(n=t.audioTracks)&&void 0!==n?n:[]).reduce((e,t)=>(e[t.groupId]=t.channels,e),{});try{yield r._playMedia()}catch(o){throw xi.warn("error from media element, possibly non-fatal",o),o}finally{i=yield r.finishPlaybackSequence()}return i}))()}handleKeyRequestStarted(e,t){xi.debug("hlsjs-video.handleKeyRequestStarted"),this.hls.generateKeyRequest(t.keyuri,{})}handleLicenseChallengeCreated(e,t){var r=this;return _async_to_generator$f((function*(){xi.trace("handleLicenseChallengeCreated",t);const{_licenseServerUrl:e,nowPlayingItem:n,_keySystem:i,userInitiated:a}=r;try{var s;const c=yield null===(s=r._license)||void 0===s?void 0:s.start(e,n,t,i,a),l={statusCode:c.status};(null==c?void 0:c.license)&&(i===Fe.FAIRPLAY?l.ckc=o(c.license):l.license=o(c.license));const d=c["renew-after"];d&&(l.renewalDate=new Date(Date.now()+1e3*d)),r.hls.setLicenseResponse(t.keyuri,l)}catch(c){if(r._unrecoverableError)return;const e=c.data,n={};void 0!==(null==e?void 0:e.status)&&(n.statusCode=+e.status),xi.warn("Passing license response error to Hls.js",n),r.hls.setLicenseResponse(t.keyuri,n),Ni.has(c.name)&&(r._unrecoverableError=c,r.resetDeferredPlay(),yield r.stop({endReasonType:ot.FAILED_TO_LOAD,userInitiated:a})),r.onPlaybackLicenseError(c)}}))()}onPlaybackLicenseError(e){this.resetDeferredPlay(),this._dispatcher.publish(Ge.playbackLicenseError,e)}seekToTime(e){var t=this;return _async_to_generator$f((function*(){t.hls?(xi.debug("hlsjs-video: hls seekTo",e),t.hls.seekTo=e):(xi.debug("hlsjs-video: media element seek to",e),t._targetElement.currentTime=e)}))()}constructor(e){var t;super(e),_define_property$i(this,"currentAudioTrack",void 0),_define_property$i(this,"currentTextTrack",void 0),_define_property$i(this,"textTracks",[]),_define_property$i(this,"audioTracks",[]),_define_property$i(this,"userInitiated",!1),_define_property$i(this,"mediaElement",void 0),_define_property$i(this,"mediaPlayerType","hlsjs-audio"),_define_property$i(this,"hls",void 0),_define_property$i(this,"supportsPreviewImages",!1),_define_property$i(this,"extension",void 0),_define_property$i(this,"_keySystem",void 0),_define_property$i(this,"_license",void 0),_define_property$i(this,"_rtcTracker",void 0),_define_property$i(this,"_levels",void 0),_define_property$i(this,"_channelsByGroup",{}),_define_property$i(this,"_currentLevel",void 0),_define_property$i(this,"_licenseServerUrl",void 0),_define_property$i(this,"_unrecoverableError",void 0),_define_property$i(this,"id3MetadataManager",void 0),this._rtcTracker=null==e||null===(t=e.playbackServices)||void 0===t?void 0:t.getRTCStreamingTracker(),this._license=new License,this.id3MetadataManager=new ID3MetadataTrackManager({onchange:e=>{var t;const r={item:this.nowPlayingItem,metadata:e,position:this.currentPlaybackTime,playingDate:this.currentPlayingDate};xi.debug("Dispatching bufferTimedMetadataDidChange",r),null===(t=this._dispatcher)||void 0===t||t.publish(qr,r)}})}}function asyncGeneratorStep$e(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$e(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$e(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$e(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$h(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}_ts_decorate$5([Bind(),_ts_metadata$5("design:type",Function),_ts_metadata$5("design:paramtypes",[void 0,void 0]),_ts_metadata$5("design:returntype",void 0)],HlsJsAudioPlayer.prototype,"handleLevelSwitched",null),_ts_decorate$5([Bind(),_ts_metadata$5("design:type",Function),_ts_metadata$5("design:paramtypes",[void 0,void 0]),_ts_metadata$5("design:returntype",void 0)],HlsJsAudioPlayer.prototype,"handleHlsError",null),_ts_decorate$5([Bind(),_ts_metadata$5("design:type",Function),_ts_metadata$5("design:paramtypes",[void 0,void 0]),_ts_metadata$5("design:returntype",Promise)],HlsJsAudioPlayer.prototype,"handleManifestParsed",null),_ts_decorate$5([Bind(),_ts_metadata$5("design:type",Function),_ts_metadata$5("design:paramtypes",[void 0,void 0]),_ts_metadata$5("design:returntype",void 0)],HlsJsAudioPlayer.prototype,"handleKeyRequestStarted",null),_ts_decorate$5([Bind(),_ts_metadata$5("design:type",Function),_ts_metadata$5("design:paramtypes",[void 0,void 0]),_ts_metadata$5("design:returntype",Promise)],HlsJsAudioPlayer.prototype,"handleLicenseChallengeCreated",null),_ts_decorate$5([Bind(),_ts_metadata$5("design:type",Function),_ts_metadata$5("design:paramtypes",["undefined"==typeof Error?Object:Error]),_ts_metadata$5("design:returntype",void 0)],HlsJsAudioPlayer.prototype,"onPlaybackLicenseError",null),_ts_decorate$5([AsyncDebounce(250),_ts_metadata$5("design:type",Function),_ts_metadata$5("design:paramtypes",[Number]),_ts_metadata$5("design:returntype",Promise)],HlsJsAudioPlayer.prototype,"seekToTime",null);const Ui=BooleanDevFlag.register("mk-force-native-safari-video-player"),Fi=BooleanDevFlag.register("mk-force-hlsjs-video-player"),Ki=BooleanDevFlag.get("mk-hlsjs-live-radio"),Bi=Ue.createChild("factory");function contentRequiresHLSjs(e){return _contentRequiresHLSjs.apply(this,arguments)}function _contentRequiresHLSjs(){return(_contentRequiresHLSjs=_async_to_generator$e((function*(e){var t,r,n;return!!(e.isLiveVideoStation||e.isLinearStream||(null===(n=e.defaultPlayable)||void 0===n||null===(r=n.assets)||void 0===r||null===(t=r.fpsKeyServerUrl)||void 0===t?void 0:t.startsWith("https://linear.tv.apple.com")))||!(!e.hasOffersHlsUrl&&!e.isRadioEpisode)}))).apply(this,arguments)}class Factory{get isDestroyed(){return this._isDestroyed}getPlayerForMediaItem(e){var t=this;return _async_to_generator$e((function*(){if(Bi.trace("Factory.getPlayerForMediaItem",e),function(e){return null!=e&&!isVideo(e)}(e)){if(yield contentRequiresHLSjs(e)){const r=yield t.createAudioPlayer(e,t.playerOptions);return yield r.initialize(),r}{const r=t.playersByType.get("audio");if(void 0!==r&&!r.isDestroyed)return Bi.debug("Using cached AudioPlayer"),r;const n=yield t.createAudioPlayer(e,t.playerOptions);return yield n.initialize(),Bi.debug("Caching AudioPlayer"),t.playersByType.set("audio",n),n}}if(isVideo(e)){const r=yield t.createVideoPlayer(e,t.playerOptions);return yield r.initialize(),r}throw new Error("Unable to create player for MediaItem: "+(null==e?void 0:e.id))}))()}createAudioPlayer(e,t){var r=this;return _async_to_generator$e((function*(){if(Ki)return Bi.info("Creating HLSAudioPlayer with DevFlag enabled"),new HlsJsAudioPlayer(t);if(yield contentRequiresHLSjs(e))return Bi.info("Creating HlsJsAudioPlayer required for content item"),new HlsJsAudioPlayer(t);const{os:n}=r.runtime;return n.isIOS||n.isIPadOS?(Bi.info("Creating native AudioPlayer for iOS platform"),new AudioPlayer(t)):(Bi.info("Creating AudioPlayer as a fall through"),new AudioPlayer(t))}))()}createVideoPlayer(e,t){var r=this;return _async_to_generator$e((function*(){if(Bi.debug("Creating VideoPlayer"),Ui.enabled)return Bi.info("Creating NativeSafariVideoPlayer with mkForceSafariNativeVideoPlayer enabled"),new NativeSafariVideoPlayer(t);if(Fi.enabled)return Bi.info("Creating HlsJsVideoPlayer with mkForceHlsjsVideoPlayer enabled"),new HlsJsVideoPlayer(t);if(yield contentRequiresHLSjs(e))return Bi.info("Creating HlsJsVideoPlayer required for content item"),new HlsJsVideoPlayer(t);const{os:n}=r.runtime;return n.isIOS||n.isIPadOS?(Bi.info("Creating NativeSafariVideoPlayer for iOS platform"),new NativeSafariVideoPlayer(t)):(Bi.info("Creating HLSjsVideoPlayer as a fall through"),new HlsJsVideoPlayer(t))}))()}destroy(){this._isDestroyed=!0;for(const e of this.playersByType.values())e.destroy();this.playersByType.clear()}constructor(e){_define_property$h(this,"runtime",void 0),_define_property$h(this,"playerOptions",void 0),_define_property$h(this,"playersByType",void 0),_define_property$h(this,"_isDestroyed",!1),this.playersByType=new Map,this.playerOptions=e,this.runtime=e.services.runtime}}function asyncGeneratorStep$d(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$d(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$d(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$d(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$g(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$4(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$4(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const{playbackLicenseError:Vi}=Ge,{keySystemGenericError:Gi}=bn,Hi=function(){var e=_async_to_generator$d((function*(e,t){var r,n;if(null===(n=e.container)||void 0===n||null===(r=n.attributes)||void 0===r?void 0:r.requiresSubscription){if(!(yield t())){const t=new MKError(MKError.Reason.SUBSCRIPTION_ERROR);throw t.data=e,t}}}));return function(t,r){return e.apply(this,arguments)}}();let qi=!1;class MediaItemPlayback{get isDestroyed(){return this._isDestroyed}get currentPlaybackTime(){return this._currentPlayer.currentPlaybackTime}get currentPlaybackTimeRemaining(){return this._currentPlayer.currentPlaybackTimeRemaining}get currentPlayingDate(){return this._currentPlayer.currentPlayingDate}get isPlayingAtLiveEdge(){return this._currentPlayer.isPlayingAtLiveEdge}get seekableTimeRanges(){return this._currentPlayer.seekableTimeRanges}get audioTracks(){return this._currentPlayer.audioTracks}get currentAudioTrack(){return this._currentPlayer.currentAudioTrack}set currentAudioTrack(e){this._currentPlayer.currentAudioTrack=e}get currentPlaybackDuration(){return this._currentPlayer.currentPlaybackDuration}get currentBufferedProgress(){return this._currentPlayer.currentBufferedProgress}get currentPlaybackProgress(){return this._currentPlayer.currentPlaybackProgress}get currentTextTrack(){return this._currentPlayer.currentTextTrack}set currentTextTrack(e){this._currentPlayer.currentTextTrack=e}get previewOnly(){return this._previewOnly}set previewOnly(e){this._previewOnly=e}get isPlaying(){return this._currentPlayer.isPlaying}get isPrimaryPlayer(){return this._currentPlayer.isPrimaryPlayer}set isPrimaryPlayer(e){this._currentPlayer.isPrimaryPlayer=e}get isReady(){return this._currentPlayer.isReady}get nowPlayingItem(){return this._currentPlayer.nowPlayingItem}get playbackRate(){return this._currentPlayer.playbackRate}set playbackRate(e){this._updatePlayerState("playbackRate",e)}get playbackState(){return this._currentPlayer.playbackState}set playbackState(e){this._currentPlayer.setPlaybackState(e,this.nowPlayingItem)}get playbackTargetAvailable(){return this._currentPlayer.playbackTargetAvailable}get playbackTargetIsWireless(){return this._currentPlayer.playbackTargetIsWireless}get supportsPreviewImages(){return this._currentPlayer.supportsPreviewImages}get textTracks(){return this._currentPlayer.textTracks}get volume(){return this._currentPlayer.volume}set volume(e){var t;this._currentPlayer.isDestroyed&&(null===(t=this._dispatcher)||void 0===t||t.publish(rt.playbackVolumeDidChange,{}));this._updatePlayerState("volume",e)}clearNextManifest(){this._currentPlayer.clearNextManifest()}destroy(){var e,t;this._isDestroyed=!0,this._playerFactory.destroy(),null===(e=this._dispatcher)||void 0===e||e.unsubscribe(Vi,this.onPlaybackLicenseError),null===(t=this._dispatcher)||void 0===t||t.unsubscribe(Gi,this.onKeySystemGenericError)}exitFullscreen(){return this._currentPlayer.exitFullscreen()}loadPreviewImage(e){var t=this;return _async_to_generator$d((function*(){return t._currentPlayer.loadPreviewImage(e)}))()}getNewSeeker(){return this._currentPlayer.newSeeker()}mute(){this._volumeAtMute=this.volume,this.volume=0}pause(e){var t=this;return _async_to_generator$d((function*(){return t._currentPlayer.pause(e)}))()}play(){var e=this;return _async_to_generator$d((function*(){return e._currentPlayer.play()}))()}preload(){var e=this;return _async_to_generator$d((function*(){return e._currentPlayer.preload()}))()}prepareToPlay(e){var t=this;return _async_to_generator$d((function*(){if(Bn.trace("MediaItemPlayback.prepareToPlay",e),function(e){return"podcast-episodes"===e.type&&!e.keyURLs}(e))return void Bn.info(`Not preparing MediaItem ${e.id} (${e.info}): free podcast episode`,e);if(yield shouldPlayPreview(e,t.previewOnly))return void Bn.info(`Not preparing MediaItem ${e.id} (${e.info}): preview playback only`,e);Bn.info(`Preparing MediaItem ${e.id} (${e.info})`,e);const r=yield t.prepareForEncryptedPlayback(e,{bitrate:t._bitrateCalculator.bitrate});return Bn.info(`Preloading MediaItem ${e.id} (${e.info})`,e),yield t._currentPlayer.preloadItem(e,t.playOptions.get(e.id)),r}))()}requestFullscreen(e){return this._currentPlayer.requestFullscreen(e)}showPlaybackTargetPicker(){this._currentPlayer.showPlaybackTargetPicker()}seekToTime(t,r=e.SeekReasonType.Manual){var n=this;return _async_to_generator$d((function*(){yield n._currentPlayer.seekToTime(t,r)}))()}setPresentationMode(e){var t=this;return _async_to_generator$d((function*(){return t._currentPlayer.setPresentationMode(e)}))()}startMediaItemPlayback(e,t=!1){var r=this;return _async_to_generator$d((function*(){var n;Bn.debug("MediaItemPlayback: startMediaItemPlayback",e),e.resetState(),((e,t)=>{const{os:r}=t;if(e.isLinearStream&&("ios"===r.name||"ipados"===r.name)){Bn.warn("Cannot play linear stream on iOS or iPad");const t=new MKError(MKError.Reason.CONTENT_UNSUPPORTED,"IOS LINEAR");throw t.data={item:e},t}})(e,r.services.runtime),((e,t)=>{const{isMSESupported:r,isMMSSupported:n}=t;if(e.hasOffersHlsUrl&&!r&&!n){Bn.warn("HLSjs is not supported");const t=new MKError(MKError.Reason.CONTENT_UNSUPPORTED,"HLSjs Unsupported on Device");throw t.data={item:e},t}})(e,r.services.runtime),yield Hi(e,r.hasMusicSubscription);const i=yield r._getPlayerForMediaItem(e);if(yield r.setCurrentPlayer(i),!(null===(n=r._currentPlayer)||void 0===n?void 0:n.hasMediaElement))return Bn.warn(`MediaItemPlayback: Could not play media of type ${e.type}, marking item as unsupported and skipping.`),void e.notSupported();try{const{dispatcher:n}=r.services;e.beginMonitoringStateDidChange(e=>n.publish(Se.mediaItemStateDidChange,e)),e.beginMonitoringStateWillChange(e=>n.publish(Se.mediaItemStateWillChange,e));const i=r.playOptions.get(e.id);i&&r.playOptions.delete(e.id);const o=yield r._playAccordingToPlaybackType(e,t,i);return r._currentPlayback={item:e,userInitiated:t},o}catch(De){throw e.updateFromLoadError(De),Bn.error(De.message,De),De}}))()}_playAccordingToPlaybackType(e,t,r){var n=this;return _async_to_generator$d((function*(){return(yield shouldPlayPreview(e,n._previewOnly))?n._playPreview(e,t):function(e){return!!e.rawAssetUrl}(e)?n._playRawAsset(e,t,r):function(e){return isLive(e)&&isStream(e)&&void 0!==e.attributes.stationProviderName&&"Shoutcast"===e.attributes.streamingRadioSubType}(e)?n._playBroadcastRadio(e,t):((e=>{if(!supportsDrm()){const t=new MKError(MKError.Reason.CONTENT_UNSUPPORTED,"NO DRM");throw t.data={item:e},Bn.warn("No DRM detected"),t}})(e),n._playEncryptedFull(e,t,r))}))()}_playEncryptedFull(e,t,r){var n=this;return _async_to_generator$d((function*(){if(Bn.debug("MediaItemPlayback: play encrypted full",e),!e||!e.isPlayable)return Promise.reject(new MKError(MKError.Reason.MEDIA_PLAYBACK,"Not Playable"));const i=n._currentPlayer;try{yield n.prepareForEncryptedPlayback(e,{bitrate:n._bitrateCalculator.bitrate})}catch(De){return Bn.error("prepareForEncryptedPlayback Error: userInitiated "+t),i.destroy(),t?Promise.reject(De):void i.dispatch(rt.mediaPlaybackError,De)}return yield Nn(e,r),Bn.debug("About to play item as encrypted",e),yield i.playItemFromEncryptedSource(e,t,r),e}))()}_playBroadcastRadio(t,r){var n=this;return _async_to_generator$d((function*(){if(Bn.debug("MediaItemPlayback: play broadcast radio",t),!Ke.features["broadcast-radio"]){const e=new MKError(MKError.Reason.CONTENT_UNAVAILABLE);throw e.data=t,e}const i=n._currentPlayer,o=i.isPaused()&&!r,a=yield fetchRadioStationAssets(t,Or.developerToken,Or.musicUserToken),s=a.assets[0];return t.playbackType=e.PlaybackType.unencryptedFull,t.trackInfo=a["track-info"],i.nowPlayingItem=t,yield i.playItemFromUnencryptedSource(s.url,o),t}))()}_playRawAsset(t,r,n){var i=this;return _async_to_generator$d((function*(){Bn.debug("MediaItemPlayback: play raw asset",t);const o=i._currentPlayer,a=o.isPaused()&&!r;return t.playbackType=e.PlaybackType.unencryptedFull,o.nowPlayingItem=t,yield o.playItemFromUnencryptedSource(t.rawAssetUrl,a,n),t}))()}_playPreview(t,r){var n=this;return _async_to_generator$d((function*(){Bn.debug("MediaItemPlayback: play preview",t);const i=n._currentPlayer,o=i.isPaused()&&!r;return supportsDrm()||i.dispatch(rt.drmUnsupported,{item:t}),t.playbackType=e.PlaybackType.preview,i.nowPlayingItem=t,yield i.playItemFromUnencryptedSource(t.previewURL,o),t}))()}stop(e){var t=this;return _async_to_generator$d((function*(){yield t._currentPlayer.stop(e)}))()}unmute(){this.volume>0||(this.volume=this._volumeAtMute||1,this._volumeAtMute=void 0)}_getPlayerForMediaItem(e){var t=this;return _async_to_generator$d((function*(){Bn.trace("MediaItemPlayback._getPlayerForMediaItem",e);const r=yield t._playerFactory.getPlayerForMediaItem(e);return Bn.trace("Applying default player state",r,t.playerState),Object.assign(r,t.playerState),r}))()}setCurrentPlayer(e){var t=this;return _async_to_generator$d((function*(){var r;t._currentPlayer!==e&&(Bn.debug("MediaItemPlayback: setting currentPlayer",e),yield t._currentPlayer.stop(),t._currentPlayer=e,null===(r=t._dispatcher)||void 0===r||r.publish(rt.playerTypeDidChange,{player:e}))}))()}getCurrentPlayer(){return this._currentPlayer}onKeySystemGenericError(e,t){var r=this;return _async_to_generator$d((function*(){var e;qi?null===(e=r._dispatcher)||void 0===e||e.publish(rt.mediaPlaybackError,t):(qi=!0,Bn.warn("Retrying playback after keysystemGenericError"),yield r.restartPlayback())}))()}onPlaybackLicenseError(e,t){var r=this;return _async_to_generator$d((function*(){var e;t.reason===MKError.Reason.PLAYREADY_CBC_ENCRYPTION_ERROR?(Bn.warn("MediaItemPlayback: PLAYREADY_CBC_ENCRYPTION_ERROR...retrying with different key system"),yield r.restartPlayback()):null===(e=r._dispatcher)||void 0===e||e.publish(rt.mediaPlaybackError,t)}))()}restartPlayback(){var e=this;return _async_to_generator$d((function*(){yield e.stop();const{_currentPlayback:t}=e;if(t){const{item:r,userInitiated:n}=t;r.resetState(),yield e.startMediaItemPlayback(r,n)}}))()}_updatePlayerState(e,t){this.playerState[e]=t,this._currentPlayer[e]=t}constructor(e){_define_property$g(this,"playerState",{playbackRate:1,volume:1}),_define_property$g(this,"playOptions",new Map),_define_property$g(this,"hasMusicSubscription",void 0),_define_property$g(this,"prepareForEncryptedPlayback",void 0),_define_property$g(this,"_currentPlayer",void 0),_define_property$g(this,"services",void 0),_define_property$g(this,"_dispatcher",void 0),_define_property$g(this,"_playerFactory",void 0),_define_property$g(this,"_previewOnly",!1),_define_property$g(this,"_volumeAtMute",void 0),_define_property$g(this,"_currentPlayback",void 0),_define_property$g(this,"_bitrateCalculator",void 0),_define_property$g(this,"_isDestroyed",!1);const{playbackServices:t}=e;var r;this.hasMusicSubscription=t.hasMusicSubscription,this.prepareForEncryptedPlayback=t.prepareForEncryptedPlayback,function(e){Or=e}(e.tokens),e.bag&&(r=e.bag,Object.assign(Ke,r)),this.services=e.services,this._dispatcher=e.services.dispatcher,this._bitrateCalculator=e.services.bitrateCalculator,this._playerFactory=new Factory(e),this._currentPlayer=new PlayerStub(e),this._dispatcher.subscribe(Vi,this.onPlaybackLicenseError),this._dispatcher.subscribe(Gi,this.onKeySystemGenericError)}}_ts_decorate$4([Bind(),_ts_metadata$4("design:type",Function),_ts_metadata$4("design:paramtypes",[void 0,void 0]),_ts_metadata$4("design:returntype",Promise)],MediaItemPlayback.prototype,"onKeySystemGenericError",null),_ts_decorate$4([Bind(),_ts_metadata$4("design:type",Function),_ts_metadata$4("design:paramtypes",[void 0,void 0]),_ts_metadata$4("design:returntype",Promise)],MediaItemPlayback.prototype,"onPlaybackLicenseError",null);const Wi=["artist","album","audioBook","episode","librarySong","movie","musicMovie","musicVideo","playlist","podcast","podcastEpisode","radioStation","song","station","trailer","tvEpisode","uploadedAudio","uploadedVideo"],Yi=["artists","albums","audioBooks","episodes","librarySongs","movies","musicVideos","musicMovies","playlists","podcasts","podcastEpisodes","radioStations","songs","stations","trailers","tvEpisodes","uploadedVideos","uploadedAudios"],zi=Mn.createChild("item-loader");function isMediaAPIResource(e){return void 0!==e&&"string"==typeof e.id&&"string"==typeof e.type&&void 0!==e.attributes}function convertToItemDescriptors(e){if(Object.keys(e).reduce((function(e,t){return"item"===t||"items"===t||"url"===t||"urls"===t||Wi.includes(t)||Yi.includes(t)?e+1:e}),0)>1)throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Using multiple media kinds is not supported");return function(e){return null!=e&&void 0!==e.item}(e)?convertItemList([e.item]):function(e){return null!=e&&Array.isArray(e.items)}(e)?convertItemList(e.items):function(e){return null!=e&&"string"==typeof e.url}(e)?[convertURL(e.url)]:function(e){return null!=e&&Array.isArray(e.urls)}(e)?e.urls.map(e=>convertURL(e)):function(e){let t;const r=[];for(const a of Object.keys(e)){const n=translateMediaAPIResource(a);isNamedOptionKey(a)&&(void 0===t?t=[n,e[a]]:r.push(a))}const[n,i]=null!=t?t:[];if(void 0===n||void 0===i)return[];r.length>0&&zi.warn(`Found redundant named options besides ${n}: ${r.join(", ")}`);const o=singularizeMediaType(n);return Array.isArray(i)?i.map(e=>({id:e,kind:o})):[{id:i,kind:o}]}(e)}function convertItemList(e){const t=[];for(const r of e)"string"==typeof r?t.push(convertURL(r)):r instanceof MediaItem?t.push({id:r.id,kind:singularizeMediaType(r.type),item:r}):isMediaAPIResource(r)?t.push({id:r.id,kind:singularizeMediaType(r.type),data:r}):t.push(r);return t}function convertURL(e){if(!function(e){return l.test(String(e))}(e))throw new MKError(MKError.Reason.INVALID_ARGUMENTS,"Invalid media URL: "+e);const{contentId:t,kind:r}=parseMediaURL(e);if(void 0===t)throw new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"Unable to resolve URL: "+e);const n=translateMediaAPIResource(r);if(void 0===n||!Wi.includes(n)&&!Yi.includes(n))throw new MKError(MKError.Reason.CONTENT_UNSUPPORTED,"Unsupported Media Kind: "+n);return{id:t,kind:singularizeMediaType(n)}}function translateMediaAPIResource(e){return"episode"===singularizeMediaType(e)?"podcastEpisode":e}function isNamedOptionKey(e){return Wi.includes(e)||Yi.includes(e)}function asyncGeneratorStep$c(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$c(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$c(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$c(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$f(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$9(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$f(e,t,r[t])}))}return e}function _object_spread_props$4(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}class MusicItemLoader{get isConfigured(){return void 0!==this.developerToken}static create(e){const t=new this(e);return t.configure(e),t}configure(e){void 0!==e.storefrontId&&(this.storefrontId=e.storefrontId),void 0!==e.developerToken&&(this.developerToken=e.developerToken),void 0!==e.musicUserToken&&(this.musicUserToken=e.musicUserToken),void 0!==e.fetchContainerPages&&(this.fetchContainerPages=e.fetchContainerPages)}convertOptionsToItemDescriptors(e){return convertToItemDescriptors(e)}buildRequest(e,t){const r=new Headers(_object_spread_props$4(_object_spread$9({},null==t?void 0:t.headers),{Authorization:"Bearer "+this.developerToken}));var n;void 0!==this.musicUserToken&&r.set("Music-User-Token",this.musicUserToken);const i=encodeQueryParameters(null!==(n=null==t?void 0:t.queryParams)&&void 0!==n?n:"",{arrayFormat:"repeat",prefix:"?"});var o;const a={method:null!==(o=null==t?void 0:t.method)&&void 0!==o?o:"GET",headers:r};return void 0!==(null==t?void 0:t.body)&&(a.method="POST","string"==typeof t.body?a.body=t.body:(a.body=JSON.stringify(t.body),r.has("Content-Type")||r.set("Content-Type","application/json"))),new Request(buildURL("https://"+this.apiHost,e,i),a)}loadItems(e){var t=this;return _async_to_generator$c((function*(){zi.debug("Loading Items",e);const r=yield t.loadResources(_object_spread$9({fetchContainerPages:t.fetchContainerPages},e));return zi.debug(`Transforming ${r.length} resources into MediaItems`),t.createItems(r,{container:null==e?void 0:e.container,context:null==e?void 0:e.context})}))()}loadStation(e){var t=this;return _async_to_generator$c((function*(){zi.debug("Loading Radio Station",e);const r=t.convertOptionsToItemDescriptors(e).find(e=>"station"===e.kind);if(void 0===r)return void zi.debug("No station descriptor found in options, returning undefined");return(yield t.loadItems({restricted:e.restricted,items:[r],container:null==e?void 0:e.container,context:null==e?void 0:e.context,fetchContainerPages:!1}))[0]}))()}loadStationNextTracks(e,t){var r=this;return _async_to_generator$c((function*(){var n,i,o;const a="string"==typeof e?e:e.id,s=r.buildRequest("/v1/me/stations/next-tracks/"+a,{queryParams:void 0!==(null==t?void 0:t.limit)?{limit:t.limit}:void 0,method:"POST"}),c=yield r.fetchResources(s);var l,d,u;const p={id:null!==(l=null==t||null===(n=t.container)||void 0===n?void 0:n.id)&&void 0!==l?l:a,type:"stations",href:null!==(d=null==t||null===(i=t.container)||void 0===i?void 0:i.href)&&void 0!==d?d:`/v1/catalog/${r.storefrontId}/stations/${a}`,attributes:null!==(u=null==t||null===(o=t.container)||void 0===o?void 0:o.attributes)&&void 0!==u?u:{}};var h;const y=null!==(h=null==t?void 0:t.context)&&void 0!==h?h:{};return flattenAll(c.map(e=>transform(e,p,y)))}))()}createAutoplayStation(e,t){var r=this;return _async_to_generator$c((function*(){const n=[];for(let r=0;r<e.length;r++){const i=e[r],o=pluralizeMediaType(i instanceof MediaItem?i.type:i.kind);/(-?songs|artists?)$/.test(o)&&n.push({id:i.id,type:isLibraryType(i.id)?"library-songs":"songs",meta:void 0!==(null==t?void 0:t.container)?{container:t.container}:void 0})}if(0===n.length)throw zi.error("Unable to create AutoplayStation: No items to seed"),new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"Unable to create AutoplayStation: No items to seed");const i=r.buildRequest("/v1/me/stations/continuous",{queryParams:{"limit[results:tracks]":void 0!==(null==t?void 0:t.limit)&&t.limit>1?t.limit:void 0,with:!0===(null==t?void 0:t.withTracks)?["tracks"]:void 0},method:"POST",body:{data:n}}),{errors:o,results:a}=yield r.services.request.fetchJSON(i);if(void 0!==o&&o.length>0){zi.error("Unable to create AutoplayStation: Server Error");const e=new MKError(MKError.Reason.CONTENT_UNSUPPORTED,"Unable to create AutoplayStation: Server Error");throw e.data={errors:o},e}if(void 0===(null==a?void 0:a.station))throw zi.error("Unable to create AutoplayStation: No station returned from server"),new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"Unable to create AutoplayStation: No station returned from server");const s=r.createItems(a.station,{container:null==t?void 0:t.container,context:null==t?void 0:t.context})[0];let c=[];return Array.isArray(a.tracks)&&(c=r.createItems(a.tracks,{container:s,context:null==t?void 0:t.context})),{station:s,tracks:c}}))()}loadResources(e){var t=this;return _async_to_generator$c((function*(){const r=convertToItemDescriptors(e),n=function(e){const t=_object_spread$9({},e);if(void 0===e)return t;for(const r of["extend","include","relate","fields"])if(void 0!==t[r]){const n=e[r];"string"==typeof n&&(t[r]=n.split(/(?:,{1}?\s*|\s+)/))}return t}(e.parameters),i=new Map(r.map((e,t)=>[e.id,{position:t,descriptor:e}])),o=function(e,t){const r={};for(const n of e){const e=t(n);void 0===r[e]&&(r[e]=[]),r[e].push(n)}return r}(r,e=>e.kind),a=Object.entries(o),s=[],c=[];for(const[p,h]of a){const r=[],i=[],o=[];for(const e of h)void 0!==e.item||void 0!==e.data?r.push(e):(isLibraryType(e.id)?o:i).push(e);const a=[];/^(?:playlists?|albums?)$/i.test(p)&&a.push("tracks"),/^podcasts?$/i.test(p)&&a.push("episodes");const l=/^(?:playlists?|library-playlists?)$/i.test(p),d=e.restricted?"explicit":void 0;r.length>0&&s.push(...r.map(e=>{var t;return null!==(t=e.item)&&void 0!==t?t:e.data}));const u=deepmerge(deepClone(n),{include:a,extend:l?["hasCollaboration"]:[],restrict:d});if(i.length>0){const e=i.reduce((function(e,t,r){const n=Math.floor(r/16);return void 0===e[n]&&(e[n]=[]),e[n].push(t.id),e}),[]);for(const r of e)c.push(t.buildRequest(`/v1/catalog/${t.storefrontId}/${dasherize$1(p)}s`,{queryParams:_object_spread_props$4(_object_spread$9({},u),{ids:r})}))}if(o.length>0)for(const e of o)c.push(t.buildRequest(`/v1/me/library/${dasherize$1(p)}s/${e.id}`,{queryParams:u}))}const l=yield Promise.all(c.map(r=>t.fetchResources(r,{fetchContainerPages:e.fetchContainerPages,containerItemLimit:e.containerItemLimit,restricted:e.restricted}))),d=Array(i.size);for(const e of[...s,...flattenAll(l)]){const t=i.get(e.id);void 0!==(null==t?void 0:t.position)&&(d[t.position]=e)}const u=[];for(const{position:e,descriptor:t}of i.values())void 0===d[e]&&u.push(t);if(u.length>0){const e=new MKError(MKError.Reason.NOT_FOUND,"One or more items could not be resolved: "+u.map(({id:e})=>e).join(", "));throw e.data=u,e}return d}))()}loadPivots(e){var t=this;return _async_to_generator$c((function*(){var r,n,i;const o={sessionId:e.sessionId,seed:{},offeredRounds:e.offeredRounds||[]};var a;/-?songs$/.test(null===(r=e.seed)||void 0===r?void 0:r.type)&&(o.seed={id:e.seed.id,type:isLibraryType(e.seed.id)?"library-songs":"songs"});const s=t.buildRequest("/v1/me/recommendations/pivots",{queryParams:{limit:null!==(a=e.limit)&&void 0!==a?a:"20",types:"albums,stations,playlists",with:"pivot-meta","format[resources]":"map","associate[albums]":"recommended-entry-tracks","associate[playlists]":"recommended-entry-tracks"},method:"POST",body:o}),{meta:c,results:l,resources:d}=yield t.services.request.fetchJSON(s);if(0===(null===(n=l.data)||void 0===n?void 0:n.length)){const e=new MKError(MKError.Reason.NOT_FOUND,"No Pivots returned");throw e.data=l,e}const u=[],p=[];return null===(i=l.data)||void 0===i||i.forEach(e=>{var r,n,i,o;const a=null==d||null===(r=d[e.type])||void 0===r?void 0:r[e.id];if(null==a||null===(n=a.meta)||void 0===n?void 0:n.associations){var s,c,l;const e=null==a||null===(l=a.meta)||void 0===l||null===(c=l.associations)||void 0===c||null===(s=c["recommended-entry-tracks"])||void 0===s?void 0:s.data[0];var h,y;if(e)p.push(...t.createItems(null!==(y=null==d||null===(h=d[null==e?void 0:e.type])||void 0===h?void 0:h[null==e?void 0:e.id])&&void 0!==y?y:[],{container:a,context:d}))}u.push(...t.createItems(_object_spread_props$4(_object_spread$9({},e,a),{meta:_object_spread$9({},e.meta,null==d||null===(o=d[e.type])||void 0===o||null===(i=o[e.id])||void 0===i?void 0:i.meta)})))}),{sessionId:null==c?void 0:c.sessionId,pivots:u,pivotQueueItems:p}}))()}fetchResources(e,t){var r=this;return _async_to_generator$c((function*(){const{request:n}=r.services,i=(null==t?void 0:t.restricted)?"explicit":void 0;var o;const a=null!==(o=null==t?void 0:t.fetchContainerPages)&&void 0!==o&&o;var s;const c=Math.max(0,null!==(s=null==t?void 0:t.containerItemLimit)&&void 0!==s?s:1/0),l=yield n.fetchJSON(e),d=Array.isArray(l.data)?l.data:[l.data];return Promise.all(d.map(function(){var e=_async_to_generator$c((function*(e){var t,o,s;const l=null!==(s=null===(t=e.relationships)||void 0===t?void 0:t.tracks)&&void 0!==s?s:null===(o=e.relationships)||void 0===o?void 0:o.episodes;if(void 0===l)return e;const d=[...l.data];let u=void 0;for(a&&d.length<c&&(u=l.next);void 0!==u;){const e=Math.min(100,c-d.length),{data:t,next:o}=yield n.fetchJSON(r.buildRequest(u,{queryParams:{restrict:i,limit:e}}));d.push(...t),u=d.length<c?o:void 0}return null==l||delete l.next,null==l||delete l.href,l.data=d.slice(0,c),e}));return function(t){return e.apply(this,arguments)}}()))}))()}createItems(e,t){return flattenAll((e=Array.isArray(e)?e:[e]).map(e=>transform(e,null==t?void 0:t.container,null==t?void 0:t.context)))}constructor(e){if(_define_property$f(this,"services",void 0),_define_property$f(this,"apiHost",void 0),_define_property$f(this,"fetchContainerPages",void 0),_define_property$f(this,"storefrontId","us"),_define_property$f(this,"developerToken",void 0),_define_property$f(this,"musicUserToken",void 0),this.services=e.services,this.apiHost=e.apiHost.replace(/^https?:[/]{0,2}/i,""),isEmptyString$1(this.apiHost))throw new MKError(MKError.Reason.CONFIGURATION_ERROR,"Invalid API Host for Item Loader");var t;this.fetchContainerPages=null!==(t=e.fetchContainerPages)&&void 0!==t&&t}}function asyncGeneratorStep$b(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$b(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$b(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$b(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$e(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$8(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$e(e,t,r[t])}))}return e}function _ts_decorate$3(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$3(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const Qi=[MKError.Reason.CONTENT_EQUIVALENT,MKError.Reason.CONTENT_RESTRICTED,MKError.Reason.CONTENT_UNAVAILABLE,MKError.Reason.CONTENT_UNSUPPORTED,MKError.Reason.SERVER_ERROR,MKError.Reason.SUBSCRIPTION_ERROR,MKError.Reason.UNSUPPORTED_ERROR,MKError.Reason.USER_INTERACTION_REQUIRED],Ji=JsonDevFlag.register("mk-bag-features-overrides");class MKInstance{get playbackController(){return this._playbackController}get developerToken(){return Yn.developerToken}get api(){return this._services.apiManager.api}get audioTracks(){return this._mediaItemPlayback.audioTracks}get authorizationStatus(){return Yn.authorizationStatus}get bitrate(){return this._services.bitrateCalculator.bitrate}set bitrate(e){this._services.bitrateCalculator.bitrate=e}get browserSupportsPictureInPicture(){return detectPictureInPictureSupport()}get browserSupportsVideoDrm(){return supportsDrm()}get cid(){return(this.realm===e.SKRealm.TV||this.sourceType!==St.MUSICKIT)&&Yn.cid}get continuous(){var e,t;return null!==(t=null===(e=this._playbackController)||void 0===e?void 0:e.continuous)&&void 0!==t&&t}set continuous(e){this.getPlaybackController().continuous=e}get autoplayEnabled(){return this._autoplayEnabled}set autoplayEnabled(t){this.realm!==e.SKRealm.MUSIC&&(t=!1),t!==this.autoplayEnabled&&(this._autoplayEnabled=t,this._services.dispatcher.publish(Dn.autoplayEnabledDidChange,this.autoplayEnabled))}get currentAudioTrack(){return this._mediaItemPlayback.currentAudioTrack}set currentAudioTrack(e){this._mediaItemPlayback.currentAudioTrack=e}get currentPlaybackDuration(){return this._mediaItemPlayback.currentPlaybackDuration}get currentPlaybackProgress(){return this._mediaItemPlayback.currentPlaybackProgress}get currentPlaybackTime(){return this._mediaItemPlayback.currentPlaybackTime}get currentPlayingDate(){return this._mediaItemPlayback.currentPlayingDate}get isPlayingAtLiveEdge(){return this._mediaItemPlayback.isPlayingAtLiveEdge}get seekableTimeRanges(){return this._mediaItemPlayback.seekableTimeRanges}get currentPlaybackTimeRemaining(){return this._mediaItemPlayback.currentPlaybackTimeRemaining}get currentTextTrack(){return this._mediaItemPlayback.currentTextTrack}set currentTextTrack(e){this._mediaItemPlayback.currentTextTrack=e}get isAuthorized(){return Yn.isAuthorized}get isPlaying(){var e,t;return null!==(t=null===(e=this._playbackController)||void 0===e?void 0:e.isPlaying)&&void 0!==t&&t}get isRestricted(){return Yn.isRestricted}get isU13(){return Yn.isU13}get metricsClientId(){return Yn.metricsClientId}set metricsClientId(e){Yn.metricsClientId=e}get musicUserToken(){return Yn.musicUserToken}set musicUserToken(e){e&&Yn.musicUserToken===e||(Yn.musicUserToken=e)}updateUserTokenFromStorage(){return Yn.updateUserTokenFromStorage()}get needsGDPR(){return Yn.needsGDPR}get nowPlayingItem(){return this._mediaItemPlayback.nowPlayingItem}get nowPlayingItemIndex(){var e,t;return null!==(t=null===(e=this._playbackController)||void 0===e?void 0:e.nowPlayingItemIndex)&&void 0!==t?t:-1}get playbackMode(){return this._playbackMode}set playbackMode(t){if(-1===Object.values(e.PlaybackMode).indexOf(t))return;const r=t===e.PlaybackMode.PREVIEW_ONLY,n=this._services.mediaItemPlayback;n&&(n.previewOnly=r),this._playbackMode!==t&&(this._playbackMode=t,void 0!==this._playbackController&&(this._playbackController.playbackMode=t))}get playbackRate(){return this._mediaItemPlayback.playbackRate}set playbackRate(e){this._mediaItemPlayback.playbackRate=e}get playbackState(){return this._mediaItemPlayback.playbackState}get playbackTargetAvailable(){return this._mediaItemPlayback.playbackTargetAvailable}get playbackTargetIsWireless(){return this._mediaItemPlayback.playbackTargetIsWireless}get previewOnly(){return this.playbackMode===e.PlaybackMode.PREVIEW_ONLY}set previewOnly(t){this.playbackMode=t?e.PlaybackMode.PREVIEW_ONLY:e.PlaybackMode.MIXED_CONTENT}get queue(){var e;return null===(e=this._playbackController)||void 0===e?void 0:e.queue}get queueIsEmpty(){var e,t,r;return null===(r=null===(t=this._playbackController)||void 0===t||null===(e=t.queue)||void 0===e?void 0:e.isEmpty)||void 0===r||r}get realm(){return Yn.realm}get repeatMode(){var e,t;return null!==(t=null===(e=this._playbackController)||void 0===e?void 0:e.repeatMode)&&void 0!==t?t:Gn.none}set repeatMode(e){this.getPlaybackController().repeatMode=e}set requestUserToken(e){Yn.requestUserToken=e}get restrictedEnabled(){return Yn.restrictedEnabled}set restrictedEnabled(e){Yn.restrictedEnabled=e}get supportsPreviewImages(){return this._mediaItemPlayback.supportsPreviewImages}get seekSeconds(){var e;return null===(e=this._playbackController)||void 0===e?void 0:e.seekSeconds}get services(){return this._services}set shuffle(e){this.getPlaybackController().shuffle=e}get shuffleMode(){var e,t;return null!==(t=null===(e=this._playbackController)||void 0===e?void 0:e.shuffleMode)&&void 0!==t?t:di.off}set shuffleMode(e){this.getPlaybackController().shuffleMode=e}get storefrontCountryCode(){return Yn.storefrontCountryCode}get subscribeURL(){return Yn.subscribeURL}get subscribeFamilyURL(){return Yn.subscribeFamilyURL}get subscribeIndividualURL(){return Yn.subscribeIndividualURL}get subscribeStudentURL(){return Yn.subscribeStudentURL}get textTracks(){return this._mediaItemPlayback.textTracks}get videoContainerElement(){return this.context.videoContainerElement}set videoContainerElement(e){this.context.videoContainerElement=e}get volume(){return this._mediaItemPlayback.volume}set volume(e){this._mediaItemPlayback.volume=e}get storefrontId(){return Yn.storefrontId}set storefrontId(e){Yn.storefrontId=e}get _mediaItemPlayback(){return this._services.mediaItemPlayback}getPlaybackController(){if(Bn.trace("MKInstance.getPlaybackController()",this._playbackController),void 0===this._playbackController)throw new MKError(MKError.Reason.INTERNAL_ERROR,"No PlaybackController active");return this._playbackController}setPlaybackController(e){var t=this;return _async_to_generator$b((function*(){return Bn.trace("MKInstance.setPlaybackController()",e),t._playbackController===e||(void 0!==t._playbackController&&(yield t._playbackController.deactivate()),e.autoplayEnabled=t._autoplayEnabled,yield e.activate(),t.capabilities.controller=e,t.capabilities.updateChecker(e.hasCapabilities),t._playbackController=e),e}))()}addEventListener(e,t,r={}){adaptAddEventListener(this._services.dispatcher,e,t,r)}authorize(){var e=this;return _async_to_generator$b((function*(){return e.deferPlayback(),Yn.authorize()}))()}canAuthorize(){return supportsDrm()&&!this.isAuthorized}canUnauthorize(){return supportsDrm()&&this.isAuthorized}changeToMediaAtIndex(e){var t=this;return _async_to_generator$b((function*(){t._isPlaybackSupported()&&(yield t.validateAuthorization(),t.signalChangeItemIntent(),yield t.getPlaybackController().changeToMediaAtIndex(e))}))()}changeToMediaItem(e){var t=this;return _async_to_generator$b((function*(){Bn.debug("instance.changeToMediaItem",e),t._isPlaybackSupported()&&(yield t.validateAuthorization(),t.signalChangeItemIntent(),yield t.getPlaybackController().changeToMediaItem(e))}))()}changeUserStorefront(e){var t=this;return _async_to_generator$b((function*(){t.storefrontId=e}))()}cleanup(){var e=this;return _async_to_generator$b((function*(){var t;null===(t=e._services.mediaItemPlayback)||void 0===t||t.destroy(),e.signalIntent({endReasonType:ot.EXITED_APPLICATION});const r=Object.keys(e.playbackControllers).map(t=>e.playbackControllers[t].destroy());try{yield Promise.all(r)}catch(n){Bn.error("Error cleaning up controller",n)}e._services.dispatcher.clear()}))()}configure(e){var t=this;return _async_to_generator$b((function*(){return yield t.setPlaybackController(t.getPlaybackControllerByType(pi.serial)),t._whenConfigured=t._configure(e),t._whenConfigured}))()}_configure(e){var t=this;return _async_to_generator$b((function*(){yield Yn.storekit.whenAuthCompleted;const r=e.map(t._services.apiManager.registerAPIService,t._services.apiManager);yield Promise.all(r),yield t._configurePlayActivity(),t._initializeExternalEventPublishing()}))()}deferPlayback(){Bn.debug("deferPlayback",this._playbackController),deferPlayback()}getApiByType(e){var t;return null===(t=this._services.apiManager)||void 0===t?void 0:t.getApiByType(e)}me(){return _async_to_generator$b((function*(){try{return yield Yn.storekit.me()}catch(e){return Promise.reject(new MKError(MKError.Reason.AUTHORIZATION_ERROR,"Unauthorized"))}}))()}musicSubscriptionOffers(){return Yn.storekit.musicSubscriptionOffers(this.storefrontId)}musicSubcriptionOffers(){return deprecationWarning("musicSubcriptionOffers",{message:"musicSubcriptionOffers has been deprecated, use musicSubscriptionOffers instead"}),this.musicSubscriptionOffers()}hasMusicSubscription(){return hasMusicSubscription(Yn.storekit)}mute(){return this._mediaItemPlayback.mute()}pause(e){var t=this;return _async_to_generator$b((function*(){if(t._isPlaybackSupported()){try{t.signalIntent({endReasonType:ot.PLAYBACK_MANUALLY_PAUSED}),yield t.getPlaybackController().pause(e)}catch(De){t._handlePlaybackError(De)}return Promise.resolve()}}))()}play(){var e=this;return _async_to_generator$b((function*(){if(Bn.debug("instance.play()"),e._isPlaybackSupported()){yield e.validateAuthorization();try{yield e.getPlaybackController().play()}catch(De){e._handlePlaybackError(De)}return Promise.resolve()}}))()}playMediaItem(e,t){var r=this;return _async_to_generator$b((function*(){var n,i;if(Bn.trace("MKInstance.playMediaItem()",e,t),(null==t?void 0:t.bingeWatching)||r.deferPlayback(),t=_object_spread$8({},t),(null==e?void 0:e.playEvent)&&!hasOwn(t,"startTime")){const{playEvent:r}=e;r.isDone||void 0===r.playCursorInSeconds||(t.startTime=r.playCursorInSeconds)}r.services.dispatcher.publish(Dn.playInitiated,{item:e,timestamp:null!==(i=null===(n=t.meta)||void 0===n?void 0:n.initiatedTimestamp)&&void 0!==i?i:Date.now()});try{t&&r._mediaItemPlayback.playOptions.set(e.id,t);const n=yield r.getPlaybackController().playSingleMediaItem(e,t);return r.services.dispatcher.publish(Dn.capabilitiesChanged),n}catch(De){Bn.error("mk:playMediaItem error",De),r._handlePlaybackError(De)}}))()}removeEventListener(e,t){!function(e,t,r){const n=getCallbacksForName(t);let i;for(let o=n.length-1;o>=0;o--){const[e,t]=n[o];if(e===r){i=t,n.splice(o,1);break}}i&&e.unsubscribe(t,i)}(this._services.dispatcher,e,t)}shouldDisplayPrivacyLink(e){return _async_to_generator$b((function*(){return Yn.shouldDisplayPrivacyLink(e)}))()}exitFullscreen(){return this._mediaItemPlayback.exitFullscreen()}requestFullscreen(e){return this._mediaItemPlayback.requestFullscreen(e)}loadPreviewImage(e){var t=this;return _async_to_generator$b((function*(){return t._mediaItemPlayback.loadPreviewImage(e)}))()}getNewSeeker(){return this.getPlaybackController().getNewSeeker()}seekToTime(t,r=e.SeekReasonType.Manual){var n=this;return _async_to_generator$b((function*(){if(n._isPlaybackSupported()){yield n.validateAuthorization();try{yield n.getPlaybackController().seekToTime(t,r)}catch(De){n._handlePlaybackError(De)}return Promise.resolve()}}))()}setPresentationMode(e){var t=this;return _async_to_generator$b((function*(){return t._mediaItemPlayback.setPresentationMode(e)}))()}skipToNextItem(){var e=this;return _async_to_generator$b((function*(){if(e._isPlaybackSupported()){yield e.validateAuthorization(),e.signalIntent({endReasonType:ot.TRACK_SKIPPED_FORWARDS,direction:ot.TRACK_SKIPPED_FORWARDS});try{yield e.getPlaybackController().skipToNextItem()}catch(De){e._handlePlaybackError(De)}}}))()}skipToPreviousItem(){var e=this;return _async_to_generator$b((function*(){if(e._isPlaybackSupported()){yield e.validateAuthorization(),e.signalIntent({endReasonType:ot.TRACK_SKIPPED_BACKWARDS,direction:ot.TRACK_SKIPPED_BACKWARDS});try{yield e.getPlaybackController().skipToPreviousItem()}catch(De){e._handlePlaybackError(De)}}}))()}seekForward(){var e=this;return _async_to_generator$b((function*(){if(e._isPlaybackSupported()){yield e.validateAuthorization();try{e.signalIntent({endReasonType:ot.TRACK_SKIPPED_FORWARDS,direction:ot.TRACK_SKIPPED_FORWARDS}),yield e.getPlaybackController().seekForward()}catch(De){e._handlePlaybackError(De)}}}))()}seekBackward(){var e=this;return _async_to_generator$b((function*(){if(e._isPlaybackSupported()){yield e.validateAuthorization();try{yield e.getPlaybackController().seekBackward()}catch(De){e._handlePlaybackError(De)}}}))()}showPlaybackTargetPicker(){this.getPlaybackController().showPlaybackTargetPicker()}stop(e){var t=this;return _async_to_generator$b((function*(){if(t._isPlaybackSupported()){var r;t.signalIntent({endReasonType:null==e?void 0:e.endReasonType,userInitiated:null===(r=null==e?void 0:e.userInitiated)||void 0===r||r});try{yield t.getPlaybackController().stop(e)}catch(De){t._handlePlaybackError(De)}}}))()}resetSubscribeViewEligibility(){Yn.storekit.resetSubscribeViewEligibility()}unauthorize(){return _async_to_generator$b((function*(){return Yn.unauthorize()}))()}unmute(){return this._mediaItemPlayback.unmute()}_createPlayerControllerOptions(){return{tokens:Yn,bag:qn,playbackServices:{getRTCStreamingTracker:()=>{var e;return null===(e=this._services.playActivity)||void 0===e?void 0:e.getTrackerByType(RTCStreamingTracker)},hasMusicSubscription:hasMusicSubscription,prepareForEncryptedPlayback:(e,t)=>function(e,t,r){return _prepareForEncryptedPlayback.apply(this,arguments)}(this._services.apiManager,e,t),requiresHlsJs:requiresHlsJs},services:this._services,context:this.context,autoplayEnabled:this.autoplayEnabled,privateEnabled:this.privateEnabled,siriInitiated:this.siriInitiated,storekit:null==Yn?void 0:Yn.storekit,playbackMode:this.playbackMode}}getPlaybackControllerByType(e){let t=this.playbackControllers[e];if(void 0!==t)return t;switch(e){case pi.serial:t=new SerialPlaybackController(this._createPlayerControllerOptions());break;case pi.continuous:t=new ContinuousPlaybackController(this._createPlayerControllerOptions());break;default:throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Unsupported controller requested: "+e)}return this.playbackControllers[e]=t,t}playbackControllerForItems(e){const t=e[0];return(null==t?void 0:t.isRadioStation)&&!(null==t?void 0:t.isRadioEpisode)?this.getPlaybackControllerByType(pi.continuous):this.getPlaybackControllerByType(pi.serial)}_handlePlaybackError(e){if(Bn.error("mediaPlaybackError",e),MKError.isMKError(e)&&Qi.includes(e.reason))throw e;this._playbackErrorDialog&&!this._services.runtime.isNodeEnvironment&&MKDialog.presentError(e)}_initializeInternalEventHandling(){const{dispatcher:t,itemLoader:r}=this._services;Yn.storekit.addEventListener(Dn.userTokenDidChange,({userToken:e})=>{this._whenConfigured&&this._whenConfigured.then(()=>this._configurePlayActivity().catch()).catch(),Bn.debug("Setting musicUserToken for MusicItemLoader: "+this.musicUserToken),null==r||r.configure({musicUserToken:e})}),Yn.storekit.addEventListener(Dn.storefrontCountryCodeDidChange,(function({storefrontCountryCode:e}){Bn.debug("Setting storefrontId for MusicItemLoader: "+e),null==r||r.configure({storefrontId:e})})),t.subscribe(Dn.mediaPlaybackError,(e,t)=>this._handlePlaybackError(t)),t.subscribe(Dn.playbackStateDidChange,(t,r)=>{r.state===e.PlaybackStates.paused&&(Bn.debug("mk: playbackStateDidChange callback - calling storekit.presentSubscribeViewForEligibleUsers"),Yn.storekit.presentSubscribeViewForEligibleUsers({state:r.state,item:this.nowPlayingItem},!1))}),t.subscribe(qr,(e,{metadata:r,item:n,position:i,playingDate:o})=>{if(r.blob){const e={item:null!=n?n:this.nowPlayingItem,position:null!=i?i:this.currentPlaybackTime,playingDate:null!=o?o:this.currentPlayingDate,storefrontId:this.storefrontId.toUpperCase(),metadata:r};Bn.debug('Dispatching TimedMetadata "ping"',e),t.publish(et.timedMetadata,e)}})}_initializeExternalEventPublishing(){[Dn.authorizationStatusDidChange,Dn.needsGDPRDidChange,Dn.storefrontCountryCodeDidChange,Dn.storefrontIdentifierDidChange,Dn.userTokenDidChange,Dn.eligibleForSubscribeView].forEach(e=>{Yn.storekit.addEventListener(e,t=>this._services.dispatcher.publish(e,t))}),this._services.dispatcher.subscribe(qr,(e,{metadata:t})=>{Bn.debug("Dispatching TimedMetadata change",t),this._services.dispatcher.publish(Dn.timedMetadataDidChange,t)})}configureLogger(e){var t;Bn.level===Fn&&(!0===e.debug?setRootLoggingLevel(W.DEBUG):void 0!==e.logLevel&&setRootLoggingLevel(e.logLevel)),jn.enabled&&setConsoleOutput(jn.enabled),void 0!==Un.value&&applyLoggingLevels(Un.value),void 0!==e.logHandler&&(t=e.logHandler,Bn.handlers.external=new CallbackHandler(t))}_configurePlayActivity(){var e=this;return _async_to_generator$b((function*(){void 0!==e._services.playActivity&&(yield e._services.playActivity.configure({instance:e,services:e._services}))}))()}_isPlaybackSupported(){return!this._services.runtime.isNodeEnvironment||(Bn.warn("Media playback is not supported in Node environments."),!1)}signalChangeItemIntent(){this.signalIntent({endReasonType:ot.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM})}signalIntent(e){this.services.dispatcher.publish(et.userActivityIntent,_object_spread$8({userInitiated:!0},e))}validateAuthorization(t=!1){var r=this;return _async_to_generator$b((function*(){(t||r.playbackMode===e.PlaybackMode.FULL_PLAYBACK_ONLY)&&(void 0!==r._playbackController&&r._playbackController.isReady&&r._playbackController.isPlaying||(yield r.authorize()))}))()}constructor(t){_define_property$e(this,"app",void 0),_define_property$e(this,"capabilities",void 0),_define_property$e(this,"context",void 0),_define_property$e(this,"_autoplayEnabled",!1),_define_property$e(this,"id",void 0),_define_property$e(this,"prefix",void 0),_define_property$e(this,"privateEnabled",!1),_define_property$e(this,"siriInitiated",!1),_define_property$e(this,"sourceType",St.MUSICKIT),_define_property$e(this,"version",e.version),_define_property$e(this,"playbackActions",void 0),_define_property$e(this,"guid",void 0),_define_property$e(this,"_bag",qn),_define_property$e(this,"playbackControllers",{}),_define_property$e(this,"_playbackController",void 0),_define_property$e(this,"_queue",void 0),_define_property$e(this,"_services",void 0),_define_property$e(this,"_playbackErrorDialog",!0),_define_property$e(this,"_playbackMode",e.PlaybackMode.MIXED_CONTENT),_define_property$e(this,"_whenConfigured",void 0);const{developerToken:r}=t;if("string"!=typeof r||""===r.trim())throw new MKError(MKError.Reason.CONFIGURATION_ERROR,"Missing or empty developer token");Object.assign(qn.features,function(e=[]){const t={};return e.forEach(e=>{"-"===e.charAt(0)?(e=e.substr(1),t[e]=!1):t[e]=!0}),t}(t.features));const n=Ji.get();n&&(Bn.warn("Overriding bag.features with",n),qn.features=_object_spread$8({},qn.features,n)),Object.assign(qn.autoplay,t.autoplay),Object.assign(qn.app,t.app),Object.assign(qn.urls,t.urls),this.context={};const i=t.services;this.capabilities=new Capabilities(i.dispatcher),"playbackActions"in t&&(this.playbackActions=t.playbackActions),"guid"in t&&(this.guid=t.guid);const o=new TimingAccuracy(!!qn.features["player-accurate-timing"]),a=new BitrateCalculator(i.dispatcher,t.bitrate),s=function(e,t){return Yn=new Store(e,t),Yn}(r,t);let c=!0===qn.features["fetch-container-pages"],l="api.music.apple.com";c=this.realm===e.SKRealm.MUSIC,l="amp-api.music.apple.com",this.realm===e.SKRealm.PODCAST&&(l="amp-api.podcasts.apple.com"),this._services={runtime:i.runtime,request:i.request,dispatcher:i.dispatcher,itemLoader:MusicItemLoader.create({apiHost:l,services:{runtime:i.runtime,request:i.request},storefrontId:null==s?void 0:s.storefrontId,developerToken:r,musicUserToken:s.musicUserToken,fetchContainerPages:c}),timing:o,bitrateCalculator:a},void 0!==t.playActivityAPI&&(this._services.playActivity=new PlayActivityService(i.dispatcher,t.playActivityAPI)),t.services=this._services,this.configureLogger(t),this._services.apiManager=new APIServiceManager(s,i.dispatcher);const d=new MediaItemPlayback(this._createPlayerControllerOptions());if(this._services.mediaItemPlayback=d,t.sourceType&&(this.sourceType=t.sourceType),this._initializeInternalEventHandling(),t.bitrate&&(this.bitrate=t.bitrate),"prefix"in t&&/^(?:web|preview)$/.test(t.prefix||"")&&(this.prefix=qn.prefix=t.prefix),t.suppressErrorDialog&&(this._playbackErrorDialog=!t.suppressErrorDialog),void 0!==t.playbackMode&&(this.playbackMode=t.playbackMode),"privateEnabled"in t&&(this.privateEnabled=t.privateEnabled||!1),"siriInitiated"in t&&(this.siriInitiated=t.siriInitiated||!1),this.id=generateUUID(),Bn.info("MusicKit JS Version: "+this.version),Bn.info("InstanceId",this.id),Bn.debug("Link Parameters",t.linkParameters),qn.app&&Bn.debug("App",qn.app),t.userToken){const{userToken:e}=t;"function"==typeof e?Yn.dynamicMusicUserToken=e:this.musicUserToken=e}}}function asyncGeneratorStep$a(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$a(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$a(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$a(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function dispatchDocumentEvent(e){if(detectNodeEnvironment())return;const t=new Event(e,{bubbles:!0,cancelable:!0});setTimeout(()=>document.dispatchEvent(t))}function _loadWebComponents(){return(_loadWebComponents=_async_to_generator$a((function*(){var e;if(detectNodeEnvironment())return;const t=findScript("musickit.js");if(""!==(null==t||null===(e=t.dataset)||void 0===e?void 0:e.webComponents))return;const r="noModule"in t,n=`components/musickit-components/musickit-components${r?".esm":""}.js`,i="https:"+cdnBaseURL(n)+n,o={};r&&(o.type="module"),t.hasAttribute("async")&&(o.async=""),t.hasAttribute("defer")&&(o.defer=""),yield loadScript(i,o),dispatchDocumentEvent(Dn.webComponentsLoaded)}))).apply(this,arguments)}function asyncGeneratorStep$9(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$9(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$9(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$9(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$d(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$7(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$d(e,t,r[t])}))}return e}function _object_spread_props$3(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}_ts_decorate$3([AsyncDebounce(250,{isImmediate:!0}),_ts_metadata$3("design:type",Function),_ts_metadata$3("design:paramtypes",["undefined"==typeof ActivityNotificationOptions?Object:ActivityNotificationOptions]),_ts_metadata$3("design:returntype",Promise)],MKInstance.prototype,"pause",null),_ts_decorate$3([AsyncDebounce(250,{isImmediate:!0}),_ts_metadata$3("design:type",Function),_ts_metadata$3("design:paramtypes",[]),_ts_metadata$3("design:returntype",Promise)],MKInstance.prototype,"play",null),_ts_decorate$3([SerialAsync("skip"),_ts_metadata$3("design:type",Function),_ts_metadata$3("design:paramtypes",[]),_ts_metadata$3("design:returntype",Promise)],MKInstance.prototype,"skipToNextItem",null),_ts_decorate$3([SerialAsync("skip"),_ts_metadata$3("design:type",Function),_ts_metadata$3("design:paramtypes",[]),_ts_metadata$3("design:returntype",Promise)],MKInstance.prototype,"skipToPreviousItem",null),_ts_decorate$3([SerialAsync("seek"),_ts_metadata$3("design:type",Function),_ts_metadata$3("design:paramtypes",[]),_ts_metadata$3("design:returntype",Promise)],MKInstance.prototype,"seekForward",null),_ts_decorate$3([SerialAsync("seek"),_ts_metadata$3("design:type",Function),_ts_metadata$3("design:paramtypes",[]),_ts_metadata$3("design:returntype",Promise)],MKInstance.prototype,"seekBackward",null);const Xi="undefined"!=typeof window&&"undefined"!=typeof document;let Zi=!1;const eo=[];function cleanupInstances(){return _cleanupInstances.apply(this,arguments)}function _cleanupInstances(){return(_cleanupInstances=_async_to_generator$9((function*(){const e=eo.map(e=>e.cleanup());yield Promise.all(e),eo.splice(0,eo.length)}))).apply(this,arguments)}function configure$1(e){return _configure$1.apply(this,arguments)}function _configure$1(){return(_configure$1=_async_to_generator$9((function*(e,t=MKInstance,r){if(!e)throw new MKError(MKError.Reason.INVALID_ARGUMENTS,"configuration required");const n={};e.mergeQueryParams&&Xi&&window.location&&(n.linkParameters=_object_spread$7({},e.linkParameters||{},parseQueryParams(window.location.href)));const i=_object_spread$7({runtime:yield RuntimeEnvironment.detect(),dispatcher:new PubSub,request:new RequestManager},null==e?void 0:e.services);yield findKeySystemPreference(i.runtime);const o=new t(_object_spread_props$3(_object_spread$7({},e,n),{services:i}));return Zi||(yield cleanupInstances()),r&&(yield r(o)),eo.push(o),dispatchDocumentEvent(Dn.configured),o}))).apply(this,arguments)}function getInstance(e){if(0!==eo.length)return void 0===e?eo[eo.length-1]:eo.find(t=>t.id===e)}Xi&&(asAsync(function(){return _loadWebComponents.apply(this,arguments)}()),dispatchDocumentEvent(Dn.loaded));function asyncGeneratorStep$8(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _define_property$c(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class NpPlay{getNpPayloadContent(e,t,r,n="com.apple.tv"){var i,o,a,s;const c={context:{user:{id:r,keyspace:"cid"},userAgent:navigator.userAgent,appleStoreFront:null===(s=this.utsClient)||void 0===s||null===(a=s.configuration)||void 0===a||null===(o=a.applicationProps)||void 0===o||null===(i=o.storefront)||void 0===i?void 0:i.storefrontId,source:"Client_Device",cadence:"Contract",bundleId:n,millisecondsSinceEvent:0},event:{}};return"vod"===e?c.event.vodEvent=t:"live"===e&&(c.event.liveEvent=t),c}send(e,t,r,n="com.apple.tv"){var i=this;return function(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$8(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$8(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}((function*(){var o;return i.request.fetch("/api/np/play/json",{headers:{Authorization:"Bearer "+i.tokens.developerToken,"Media-User-Token":null!==(o=i.tokens.musicUserToken)&&void 0!==o?o:""},method:"POST",body:JSON.stringify(i.getNpPayloadContent(e,t,r,n))})}))()}constructor(e){_define_property$c(this,"tokens",void 0),_define_property$c(this,"utsClient",void 0),_define_property$c(this,"request",void 0),this.tokens=e.tokens,this.utsClient=e.services.utsClient,this.request=e.services.request}}function asyncGeneratorStep$7(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _define_property$b(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class PlayMetadata{get isDestroyed(){return this._isDestroyed}destroy(){var e;this._isDestroyed=!0,null===(e=this.watcher)||void 0===e||e.stopMonitor(),this.watcher=void 0}trackActivity(e,t){return function(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$7(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$7(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}((function*(){return Promise.resolve()}))()}getAppBundleIds(e,t){var r;const n=null==t?void 0:t.channels;if(!Array.isArray(n)||void 0===(null==e?void 0:e.channelId))return;const i=n.find(t=>t.id===e.channelId);var o;return null!==(o=null==i||null===(r=i.appBundleIds)||void 0===r?void 0:r[0])&&void 0!==o?o:void 0}determineRelativePosition(e,t){return e<=t.mainContentStarts?0:e>=t.mainContentEnds?t.mainContentEnds:e-t.mainContentStarts}constructor(e,t,r,n,i,o,a){_define_property$b(this,"appBundleIds",void 0),_define_property$b(this,"dispatcher",void 0),_define_property$b(this,"item",void 0),_define_property$b(this,"itemTiming",void 0),_define_property$b(this,"mediaItemPlayback",void 0),_define_property$b(this,"npPlay",void 0),_define_property$b(this,"playable",void 0),_define_property$b(this,"pldfltcid",void 0),_define_property$b(this,"utsClient",void 0),_define_property$b(this,"watcher",void 0),_define_property$b(this,"_isDestroyed",!1),this.dispatcher=e,this.item=r,this.mediaItemPlayback=t,this.npPlay=a,this.playable=n,this.pldfltcid=i,this.utsClient=o,this.appBundleIds=this.getAppBundleIds(n,r),this.itemTiming=function(e){const t=parseRollItems(e,["pre-roll"]),r=parseRollItems(e,["post-roll"]),n=t.reduce(addRollItemDuration,0),i=r.reduce(addRollItemDuration,0);var o,a;const s=null!==(a=null!==(o=e.hlsMetadata["up-next.start"])&&void 0!==o?o:e.hlsMetadata["watched.time"])&&void 0!==a?a:e.hlsMetadata["feature.duration"],c=parseFloat(s);return{mainContentStarts:n,mainContentEnds:c,mainContentLength:c-n,totalContentLength:c+i}}(r)}}function asyncGeneratorStep$6(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$6(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$6(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$6(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _ts_decorate$2(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata$2(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}class Live extends PlayMetadata{init(){var e=this;return _async_to_generator$6((function*(){var t;const{playable:r}=e,n=yield null===(t=e.utsClient)||void 0===t?void 0:t.request("getContentsPlayMetadataLive",{brandId:r.channelId,externalServiceId:r.externalServiceId});var i;e.playMetadataLive=null!==(i=null==n?void 0:n.data)&&void 0!==i?i:n,e.resetListening()}))()}destroy(){this.unsubscribe()}trackActivity(e,t){var r=this;return _async_to_generator$6((function*(){"scrub"!==e&&"seek"!==e||r.resetListening()}))()}handleTimeChange(){var e,t;const{scheduleItems:r}=this;var n;const i=null!==(n=null===(t=this.mediaItemPlayback)||void 0===t||null===(e=t.currentPlayingDate)||void 0===e?void 0:e.getTime())&&void 0!==n?n:0;if(0!==i&&r){for(let e=0;e<r.length;e++){const t=r[e],n=t.eventTime.liveBadgeTime.startTime,o=t.eventTime.liveBadgeTime.endTime;if(i>=n&&i<=o)r.splice(e,1),e-=1,this.onLiveEvent(t);else if(i>n)r.splice(e,1),e-=1;else if(i<n)return}0===r.length&&this.unsubscribe()}}onLiveEvent(e){var t=this;return _async_to_generator$6((function*(){var r;const n=t.pldfltcid,{appBundleIds:i,playable:o,utsClient:a}=t;if(!n||!a||!o)return;const s=t.generateEventStartEvent(e);yield null===(r=t.npPlay)||void 0===r?void 0:r.send("live",s,n,null!=i?i:"com.apple.tv")}))()}generateEventStartEvent(e){return{bundleId:"com.apple.tv",millisecondsSinceEvent:0,cause:"Event_Start",passThrough:null==e?void 0:e.nowPlayingPassThrough}}resetListening(){var e;const t=null===(e=this.playMetadataLive)||void 0===e?void 0:e.schedule;t&&t.length&&(this.scheduleItems=[...t],this.unsubscribe(),this.subscribe())}subscribe(){this.dispatcher.subscribe(Dn.playbackTimeDidChange,this.handleTimeChange)}unsubscribe(){this.dispatcher.unsubscribe(Dn.playbackTimeDidChange,this.handleTimeChange)}constructor(...e){super(...e),_define_property$a(this,"playMetadataLive",void 0),_define_property$a(this,"scheduleItems",[])}}function asyncGeneratorStep$5(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$5(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$5(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$5(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$9(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread_props$2(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _ts_metadata$1(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}_ts_decorate$2([Bind(),_ts_metadata$2("design:type",Function),_ts_metadata$2("design:paramtypes",[]),_ts_metadata$2("design:returntype",void 0)],Live.prototype,"handleTimeChange",null),_ts_decorate$2([Bind(),_ts_metadata$2("design:type",Function),_ts_metadata$2("design:paramtypes",["undefined"==typeof PlayMetadataLiveSchedule?Object:PlayMetadataLiveSchedule]),_ts_metadata$2("design:returntype",Promise)],Live.prototype,"onLiveEvent",null);const to=new Set(["exit","pause","play","scrub","seek","skip","stop"]);class Vod extends PlayMetadata{init(){var e=this;return _async_to_generator$5((function*(){var t;const{item:r,playable:n}=e;if(hasContentCompletionThresholdData(r)){const t=(e=>Math.min(Math.round(getUpNextStart(e)),Math.round(getWatchedTime(e))))(r);e.setupVodWatcher(t,Number.POSITIVE_INFINITY)}const i=yield null===(t=e.utsClient)||void 0===t?void 0:t.request("getContentsPlayMetadataVOD",{externalId:n.externalId,brandId:n.channelId,hlsAssetDuration:e.mediaItemPlayback.currentPlaybackDuration});var o;e.metadata=null!==(o=null==i?void 0:i.data)&&void 0!==o?o:i}))()}setupVodWatcher(e,t){this.watcher=new SpanWatcher(this.dispatcher,this.onContentCompletionThreshhold,e,t,!0),this.watcher.startMonitor()}onContentCompletionThreshhold(e){var t=this;return _async_to_generator$5((function*(){yield t.trackActivity("exit",e),t.dispatcher.publish(et.mediaContentComplete,t.item)}))()}trackActivity(e,t){var r=this;return _async_to_generator$5((function*(){var n,i;const{appBundleIds:o,metadata:a,playable:s,pldfltcid:c}=r;let{itemTiming:l}=r;if(!(a&&s&&l&&to.has(e)))return;if("stop"===e){var d;const e=r.itemTiming.totalContentLength;if(!(null===(d=r.item)||void 0===d?void 0:d.isLinearStream)&&void 0!==e&&void 0!==t){const r=e-t;r>=0&&r<5&&(t=e+.5)}}const u=null===(n=r.mediaItemPlayback)||void 0===n?void 0:n.currentPlaybackDuration;if(isNaN(l.totalContentLength)||u&&u<l.totalContentLength){const e=null!=u?u:NaN;isNaN(e)||(r.itemTiming=l=_object_spread_props$2(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$9(e,t,r[t])}))}return e}({},l),{mainContentEnds:e,mainContentLength:e,totalContentLength:e}))}const p=r.generateVodEvent(s,a,l,t);yield null===(i=r.npPlay)||void 0===i?void 0:i.send("vod",p,c,null!=o?o:"com.apple.tv")}))()}generateVodEvent(e,t,r,n){var i,o;return{playHeadInMilliseconds:Math.floor(1e3*n),mediaLengthInMilliseconds:Math.floor(1e3*r.totalContentLength),mainContentInfo:{isDone:n>=r.mainContentEnds?"Done":"Not_Done",playHeadInMilliseconds:Math.floor(1e3*this.determineRelativePosition(n,r)),lengthInMilliseconds:Math.floor(1e3*r.mainContentLength),passThrough:null!==(o=null===(i=this.metadata)||void 0===i?void 0:i.nowPlayingPassThrough)&&void 0!==o?o:""}}}constructor(...e){super(...e),_define_property$9(this,"metadata",void 0)}}function asyncGeneratorStep$4(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$4(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$4(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$4(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$8(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}!function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);o>3&&a&&Object.defineProperty(t,r,a)}([Bind(),_ts_metadata$1("design:type",Function),_ts_metadata$1("design:paramtypes",[Number]),_ts_metadata$1("design:returntype",Promise)],Vod.prototype,"onContentCompletionThreshhold",null);class Ebs extends PlayMetadata{init(){var e=this;return _async_to_generator$4((function*(){var t;const{playable:r}=e,n=yield null===(t=e.utsClient)||void 0===t?void 0:t.request("getContentsPlayMetadataEBS",{brandId:r.channelId,externalId:r.externalId});var i;const o=null!==(i=null==n?void 0:n.data)&&void 0!==i?i:n;e.playMetadataEbs=o}))()}trackActivity(e,t){var r=this;return _async_to_generator$4((function*(){if("exit"!==e&&"stop"!==e){if("play"===e&&!r.sentEventStart){var t;const e=r.pldfltcid,{appBundleIds:n,playable:i,utsClient:o}=r;if(!e||!o||!i)return;const a=r.generateEventStartEvent();yield null===(t=r.npPlay)||void 0===t?void 0:t.send("live",a,e,null!=n?n:"com.apple.tv"),r.sentEventStart=!0}}else r.sentEventStart=!1}))()}generateEventStartEvent(){var e,t;return{bundleId:"com.apple.tv",millisecondsSinceEvent:0,cause:"Event_Start",passThrough:null!==(t=null===(e=this.playMetadataEbs)||void 0===e?void 0:e.nowPlayingPassThrough)&&void 0!==t?t:""}}constructor(...e){super(...e),_define_property$8(this,"playMetadataEbs",void 0),_define_property$8(this,"sentEventStart",!1)}}function asyncGeneratorStep$3(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$3(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$3(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$3(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$7(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class BookmarkTracker{get requestedEvents(){return Array.from(this.dispatchTable.keys())}get isConfigured(){return void 0!==this.npPlay}configure(e){var t=this;return _async_to_generator$3((function*(){var r;if(!t.shouldConfigure(e.instance))return;const n=e.instance;t.dispatcher=e.services.dispatcher,t.request=e.services.request,t.mediaItemPlayback=e.services.mediaItemPlayback,t.utsClient=null===(r=e.services.apiManager)||void 0===r?void 0:r.utsClient,t.npPlay=new NpPlay({tokens:{get developerToken(){return n.developerToken},get musicUserToken(){var e;return null!==(e=n.musicUserToken)&&void 0!==e?e:""}},services:{utsClient:t.utsClient,request:t.request}})}))()}cleanup(){var e=this;return _async_to_generator$3((function*(){e.clearItem()}))()}shouldConfigure(e){return _async_to_generator$3((function*(){return!!qn.features.bookmarking&&e.isAuthorized}))()}shouldTrackPlayActivity(e,t){if(!t||!this.utsClient)return!1;const{type:r,contentType:n}=t,i="Bonus"!==r&&!!n&&"Extra"!==n;return Mn.debug("Bookmark shouldTrackPlayActivity",i,e),i}handleEvent(e,t,r){if(!this.shouldTrackPlayActivity(e,r))return;const n=this.dispatchTable.get(e);void 0!==n&&"function"==typeof this[n]&&this[n](r,t)}exit(e,t={}){var r=this;return _async_to_generator$3((function*(){yield r.trackActivity("exit",void 0,t.position),r.clearItem()}))()}pause(e,t={}){var r=this;return _async_to_generator$3((function*(){yield r.trackActivity("pause",e,t.position)}))()}play(e,t={}){var r=this;return _async_to_generator$3((function*(){const n=void 0===t.position?0:t.position;yield r.trackActivity("play",e,n)}))()}scrub(e,t={}){var r=this;return _async_to_generator$3((function*(){yield r.trackActivity("scrub",e,t.position)}))()}seek(e,t={}){var r=this;return _async_to_generator$3((function*(){yield r.trackActivity("seek",e,t.position)}))()}skip(e,t={}){var r=this;return _async_to_generator$3((function*(){yield r.trackActivity("skip",e,t.position)}))()}stop(e,t={}){var r=this;return _async_to_generator$3((function*(){yield r.trackActivity("stop",e,t.position),r.clearItem()}))()}clearItem(){var e;this.currentItem=void 0,null===(e=this.playMetadata)||void 0===e||e.destroy(),this.playMetadata=void 0}trackActivity(e,t,r){var n=this;return _async_to_generator$3((function*(){var i,o;if(void 0!==r&&void 0!==n.utsClient&&(void 0!==t&&t.id!==(null===(i=n.currentItem)||void 0===i?void 0:i.id)&&(yield n.updateItem(t)),void 0!==n.currentItem))return null===(o=n.playMetadata)||void 0===o?void 0:o.trackActivity(e,r)}))()}updateItem(e){var t=this;return _async_to_generator$3((function*(){var r,n;const i=yield Yn.storekit.pldfltcid();if(void 0===t.utsClient||!t.dispatcher||!i)return;if(t.currentItem&&t.currentItem.id!==e.id&&t.clearItem(),void 0!==t.currentItem)return;t.currentItem=e;const o=e.defaultPlayable;if(void 0===o)return;let a;null===(r=t.playMetadata)||void 0===r||r.destroy(),a=e.isLinearStream?"EbsEvent"===o.type?Ebs:Live:Vod,t.playMetadata=new a(t.dispatcher,t.mediaItemPlayback,e,o,i,t.utsClient,t.npPlay),yield null===(n=t.playMetadata)||void 0===n?void 0:n.init()}))()}constructor(){_define_property$7(this,"currentItem",void 0),_define_property$7(this,"playMetadata",void 0),_define_property$7(this,"dispatcher",void 0),_define_property$7(this,"request",void 0),_define_property$7(this,"mediaItemPlayback",void 0),_define_property$7(this,"utsClient",void 0),_define_property$7(this,"npPlay",void 0),_define_property$7(this,"dispatchTable",new Map([[et.playbackPlay,"play"],[et.playbackPause,"pause"],[et.playbackScrub,"scrub"],[et.playbackSeek,"seek"],[et.playbackSkip,"skip"],[et.playbackStop,"stop"],[et.playerExit,"exit"]]))}}var ro={setDelegate:!0};function isDefined(e){return void 0!==e}function isDefinedNonNull(e){return isDefined(e)&&null!==e}function isEmptyString(e){return isString(e)&&0===e.length}function isEmptyArray(e){return isArray(e)&&0===e.length}function isEmptyObject(e){return isObject(e)&&0===Object.keys(e).length}function isFunction$1(e){return"function"==typeof e}function isNumber$1(e){return"number"==typeof e}function isInteger$1(e){return isNumber$1(e)&&e%1==0}function isString(e){return"string"==typeof e||e instanceof String}function isArray(e){return!!e&&e.constructor===Array}function isObject(e){return!!e&&e.constructor===Object}function hasGetterAndSetterMethods(e){return isObject(e)&&isFunction$1(e.__lookupGetter__)&&isFunction$1(e.__lookupSetter__)&&isFunction$1(e.__defineGetter__)&&isFunction$1(e.__defineSetter__)}function extend$2(e){var t=[!0,!0,!0].concat(Array.prototype.slice.call(arguments));return copyKeysAndValues.apply(null,t)}function copyKeysAndValues(e,t,r,n){for(var i,o=r&&n||{},a=3;a<arguments.length;a++)for(var s in i=arguments[a])if(Object.prototype.hasOwnProperty.call(i,s)){var c=i[s];(e||null!=c)&&(t||"function"!=typeof c)&&(o[s]=c)}return o}function attachMethods(e,t,r,n){var i=!1;if(e&&t){n=n||{},r=r||t;var captureFunction=function(e,t,r,n,i){var returnValue=function(){return r[i].apply(e,arguments)};return t&&(returnValue.origFunction=t),returnValue.attachedMethod=!0,returnValue};for(var o in t)if(!(o in n)&&t[o]&&isFunction$1(t[o])){var a=e[o],s=null;a&&isFunction$1(a)&&(s=!0===a.attachedMethod?a:a.bind(e)),e[o]=captureFunction(r,s,t,0,o),i=!0}}return i}function detachMethods(e){var t=!1;for(var r in e){if(isFunction$1(e[r])&&!0===e[r].attachedMethod)if(e[r].origFunction)for(;e[r].origFunction;)e[r]=e[r].origFunction,t=!0;else delete e[r]}return t}function globalScope(){return"undefined"!=typeof globalThis?globalThis:void 0!==t?t:"undefined"!=typeof window?window:{}}var no=Object.freeze({__proto__:null,_utResetNonOverridableFunctions:function(){ro={setDelegate:!0}},shallowClone:function(e){var t,r,n={},i=hasGetterAndSetterMethods(e);for(var o in e)t=null,r=null,i&&(t=e.__lookupGetter__(o),r=e.__lookupSetter__(o)),t||r?(t&&n.__defineGetter__(o,t),r&&n.__defineSetter__(o,r)):n[o]=e[o];return n},isDefined:isDefined,isDefinedNonNull:isDefinedNonNull,isDefinedNonNullNonEmpty:function(e){return isDefinedNonNull(e)&&!isEmptyString(e)&&!isEmptyArray(e)&&!isEmptyObject(e)},isEmptyString:isEmptyString,isEmptyArray:isEmptyArray,isEmptyObject:isEmptyObject,isFunction:isFunction$1,isNumber:isNumber$1,isInteger:isInteger$1,isString:isString,isElement:function(e){return!!e&&1==e.nodeType},isArray:isArray,isObject:isObject,values:function(e){var t=[];for(var r in e){var n=e[r];e.hasOwnProperty(r)&&!isFunction$1(n)&&t.push(n)}return t},keys:function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&!isFunction$1(e[r])&&t.push(r);return t},hasAnyKeys:function(e){for(var t in e)if(e.hasOwnProperty(t))return!0},hasAnyNonNullKeys:function(e){for(var t in e)if(e.hasOwnProperty(t)&&e[t])return!0},hasGetterAndSetterMethods:hasGetterAndSetterMethods,methods:function(e){var t=[];for(var r in e){var n=e[r];e.hasOwnProperty(r)&&isFunction$1(n)&&t.push(n)}return t},invert:function(e){var t={};for(var r in e)e.hasOwnProperty(r)&&!isFunction$1(e[r])&&(t[e[r]]=r);return t},extend:extend$2,copyKeysAndValues:copyKeysAndValues,addNonOverrideableFunctions:function(e){for(var t=0;t<e.length;t++){var r=e[t];ro[r]=!0}},attachMethods:attachMethods,detachMethods:detachMethods,attachDelegate:function(e,t,r){var n=!1;if(r=r||!1,e&&t&&e!==t){var i={};Object.keys(t).forEach((function(t){e[t]||(i[t]=!0)})),extend$2(i,ro),n=attachMethods(e,t,r?e:null,i)}return n},setDelegates:function(e,t){var r={};for(var n in e)t[n]&&isFunction$1(e[n].setDelegate)&&(r[n]=e[n].setDelegate.apply(e[n],[t[n]].concat(Array.prototype.slice.call(arguments,2))));return r},resetDelegates:function(e){var t=!1;for(var r in e){var n=e[r];n&&"object"==typeof n&&isFunction$1(n.setDelegate)&&(t|=detachMethods(n))}return!!t},copyDelegatedFunctions:function(e,t){var r=null;if(e&&t&&t.setDelegate){var n,i={};for(n in e)isFunction$1(e[n])&&e[n].origFunction&&(i[n]=e[n]);r=t.setDelegate(i)}return r},dedupedArray:function(e,t){var r={};if(e)for(var n=0;n<e.length;n++)r[e[n]]=0;if(t)for(var i=0;i<t.length;i++)r[t[i]]=0;return Object.keys(r)},globalScope:globalScope}),io={maxWait:1500,initialDelay:100,factor:2},ExponentialStrategy=function(e,t,r){this.delay=e||io.initialDelay,this.maxWait=isNumber$1(t)?t:io.maxWait,this.factor=r||io.factor,this.timeWaited=0};ExponentialStrategy.prototype.nextDelay=function(){var e=null,t=this.maxWait-this.timeWaited;return t>0&&(this.delay=Math.min(this.delay,t),this.timeWaited+=this.delay),(0===this.maxWait||t>0)&&(e=this.delay,this.delay=this.delay*this.factor),e};var oo=Object.freeze({__proto__:null,exponentialBackoff:function(e,t,r,n,i,o){!function _backoff(e,t,r,n){t.call(t,r,(function(){var i=e.nextDelay();i?setTimeout(_backoff.bind(null,e,t,r,n),i):n.apply(n,arguments)}))}(new ExponentialStrategy(n,i,o),e,t,r)}});var ao=Object.freeze({__proto__:null,deResNumber:function(e,t,r){var n=void 0;if(isDefined(e))if(isDefined(t)||(t=1048576),isDefined(r)||(r=2),isNumber$1(e)&&isNumber$1(t)&&t>0&&isInteger$1(r)&&r>=0){var i=Math.pow(10,r);n=Math[e>0?"floor":"ceil"](e/t/i)*i}else n=NaN;return n}}),so="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxy",co=so+"z";function snakeCaseToCamelCase(e,t){var r="";if(e)for(var n,i=e.toLowerCase().split("_"),o=0;o<i.length;o++)n=i[o][0],(0!==o||t)&&(n=n.toUpperCase()),r+=n+i[o].slice(1);return r}function randomHexCharacter(e,t,r){var n,i=globalScope(),o=i.crypto||i.msCrypto;return n=e?(16*e()|0).toString(16):o&&o.getRandomValues?(15&o.getRandomValues(new Uint8Array(1))[0]).toString(16):o&&o.randomBytes?o.randomBytes(1).toString("hex")[0]:(16*Math.random()|0).toString(16),t&&r&&(n<t||n>r)&&(n=randomHexCharacter(e,t,r)),n}var lo=Object.freeze({__proto__:null,base10Alphabet:"0123456789",base16Alphabet:"0123456789ABCDEF",base36Alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",base61Alphabet:so,base62Alphabet:co,startsWith:function(e,t,r){var n=!1;return e&&t&&(e=e.substr(0,t.length),r&&(e=e.toLowerCase(),t=t.toLowerCase()),n=0===e.indexOf(t)),n},endsWith:function(e,t,r){var n=!1;if(e&&t){r&&(e=e.toLowerCase(),t=t.toLowerCase());var i=e.length-t.length;n=i>=0&&e.lastIndexOf(t)===i}return n},trim:function(e,t,r){var n=null,i=new RegExp("^[\t\n\v\f\r             　\u2028\u2029​]+"),o=new RegExp("[\t\n\v\f\r             　\u2028\u2029​]+$");if(e)if(r||t&&"\t\n\v\f\r             　\u2028\u2029​"!=t||!e.trim){var a=null,s=null,c=null;t&&void 0!==t?(a="["+(t=t.replace(/([.?*+^$[\]\\(){}-])/g,"\\$1"))+"]",s=new RegExp("^"+a+"+"),c=new RegExp(a+"+$")):(a="\t\n\v\f\r             　\u2028\u2029​",s=i,c=o),n=e.replace(s,"").replace(c,"")}else n=e.trim();return n},snakeCaseToCamelCase:snakeCaseToCamelCase,snakeCaseToUpperCamelCase:function(e){return snakeCaseToCamelCase(e,!0)},exceptionString:function(e,t){return"The function "+e+"."+t+"() must be overridden with a platform-specific delegate function.If you have no data for this function, have your delegate return null or undefined (no 'return')"},paramString:function(e){var t="",r="",n=!0;for(var i in e){var o=e[i];(o||0===o||!1===o)&&(t+=r+i+"="+encodeURIComponent(o),n&&(r="&",n=!1))}return t},versionStringFromUserAgent:function(e,t){var r=null;t=t||"\\S+";var n=new RegExp("\\b"+t+"/(\\S+)\\b","i").exec(e);return n&&n[1]&&(r=n[1]),r},requestId:function(e){var t=Date.now(),r=Math.floor(1e5*Math.random());return e+"z"+(t=t.toString(36).toUpperCase())+"z"+(r=r.toString(36).toUpperCase())},uuid:function(e){for(var t,r="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",n="",i=0,o=r.length;i<o;i++)n+="x"===(t=r.charAt(i))?randomHexCharacter(e):"y"===t?randomHexCharacter(e,"8","b"):t;return n},randomHexCharacter:randomHexCharacter,convertNumberToBaseAlphabet:function(e,t){var r="",n=t.length;if(n<=36)r=e.toString(n).toUpperCase();else{for(var i,o,a=[];e>0;)i=e%n,o=t.charAt(i),a.push(o),e=(e-i)/n;r=a.reverse().join("")}return""===r&&(r="0"),r},cryptoRandomBase62String:function(e){var t;if(16777215==Math.floor(4294967295/256)){var r,n,i,o,a,s=globalScope(),c=s.crypto||s.msCrypto;if(c&&c.getRandomValues)r=c.getRandomValues(new Uint32Array(16/Uint32Array.BYTES_PER_ELEMENT)),a=!0;else if(c&&c.randomBytes){var l=c.randomBytes(16);r=new Uint32Array(l.buffer,l.byteOffset,l.byteLength/Uint32Array.BYTES_PER_ELEMENT),a=!0}else for(r=new Uint32Array(16/Uint32Array.BYTES_PER_ELEMENT),n=0;n<r.length;n++)r[n]=Math.floor(Math.random()*Math.floor(4294967295));if(r){for(t="",n=0;n<r.length;n++)for(o=r[n],i=0;i<6;i++)t+=co[o%62],o=Math.floor(o/62);e&&(t="1_"+(a?"1":"2")+"_"+t)}}return t}});function _valueForKeyPath(e,t,r){var n=t;if(e&&t)for(var i=e.split("."),o=0;n&&o<i.length;o++){var a=i[o];!(a in n)&&r&&(n[a]={}),n=a in n?n[a]:null}return n}function valueForKeyPath(e){var t=null;if(e&&arguments.length>1)for(var r=sourcesArray(Array.prototype.slice.call(arguments,1)),n=r.length-1;n>=0;n--){var i=r[n];if(isDefinedNonNull(t=_valueForKeyPath(e,i)))break}return t}function sourcesArray(e){var t=[],r=[];r=r.concat(e),arguments&&arguments.length>1&&(r=r.concat(Array.prototype.slice.call(arguments,1)));for(var n=0;n<r.length;n++){var i=r[n];t=t.concat(i)}return t}var uo=Object.freeze({__proto__:null,valueForKeyPath:valueForKeyPath,createObjectAtKeyPath:function(e,t){return _valueForKeyPath(e,t,!0)},sourcesArray:sourcesArray});function mergeAndCleanEventFields(e){for(var t=[!1,!1,!1].concat(Array.prototype.slice.call(arguments)),r=[],n=0;n<t.length;n++){var i=t[n];if(i&&i.constructor===Array)for(var o=0;o<i.length;o++)r.push(i[o]);else r.push(i)}return copyKeysAndValues.apply(null,r)}var po=Object.freeze({__proto__:null,mergeAndCleanEventFields:mergeAndCleanEventFields,processMetricsData:function(e,t,r,n){var i=mergeAndCleanEventFields(n),o=i;if(e&&t){var a={};if(r||(t=t.filter((function(e){return e in i}))),t.length)for(var s=0;s<t.length;s++){var c=t[s],l=e[c];isFunction$1(l)&&(a[c]=l.call(e,i))}o=mergeAndCleanEventFields(o,a)}return o},applyFieldsMap:function(e,t,r,n){var i,o,a;if(e&&t&&r){var s,c;if(o={},i=valueForKeyPath(t,r,r.custom))if(isArray(i))for(s=0;s<i.length;++s)isDefinedNonNull(c=e[i[s]])&&(o[i[s]]=c);else if(isObject(i)){for(var l in i)for(s=0;s<i[l].length;++s)if(isDefinedNonNull(c=valueForKeyPath(i[l][s],e))){o[l]=c;break}}else a="metrics: incorrect data type provided to applyFieldsMap (only accepts objects and Arrays)";else a="metrics: unable to get "+t+" section from fieldsMap"}else{var d=[];e||d.push("data"),t||d.push("sectionName"),r||d.push("fieldsMap"),a="metrics: missing argument(s): "+d.join(",")+" not provided to applyFieldsMap"}return a&&isFunction$1(n)&&n(a),o}});function makeAjaxRequest(e,t,r,n,i,o){var a=new XMLHttpRequest;r=r||void 0,o=o||{},n=isFunction$1(n)?n:function(){},i=isFunction$1(i)?i:function(){};var s=!1!==o.async;o.timeout&&s&&(a.timeout=o.timeout),a.onload=function(){a.status>=200&&a.status<300?n(a.response):i(new Error("XHR error: server responded with status "+a.status+" "+a.statusText),a.status)},a.onerror=function(){i(new Error("XHR error"))},a.open(t,e,s),a.withCredentials="boolean"!=typeof o.withCredentials||o.withCredentials,a.setRequestHeader("Content-type","application/json"),a.send(r)}var ho=Object.freeze({__proto__:null,makeAjaxGetRequest:function(e,t,r){makeAjaxRequest(e,"GET",null,t,r)},makeAjaxRequest:makeAjaxRequest}),yo={LOCAL_STORAGE:"localStorage",SESSION_STORAGE:"sessionStorage"},_storageObject=function(e){var t=null,r=!1;return function(){return e?t=e:(r||(console.error("storageObject: storage object not found. Override this function if there is a platform-specific implementation"),r=!0),t||(t={storage:{},getItem:function(e){return this.storage[e]},setItem:function(e,t){this.storage[e]=t},removeItem:function(e){delete this.storage[e]}})),t}};function _defaultStorageObject(e){var t=null,r=e===yo.LOCAL_STORAGE;try{t="undefined"!==(r?typeof localStorage:typeof sessionStorage)?r?localStorage:sessionStorage:null}catch(n){t=null,console.error("_utils.storage._defaultStorageObject: Unable to retrieve storage object: "+n)}return t}var fo=_storageObject(_defaultStorageObject(yo.LOCAL_STORAGE)),_o=_storageObject(_defaultStorageObject(yo.SESSION_STORAGE));var vo=Object.freeze({__proto__:null,_utDefaultStorageObject:function(e){return _defaultStorageObject(e)},localStorageObject:fo,sessionStorageObject:_o,saveObjectToStorage:function(e,t,r){var n=null;if(r)try{e.setItem(t,JSON.stringify(r)),n=r}catch(i){}else n=e.removeItem(t);return n},objectFromStorage:function(e,t){var r=null,n=e.getItem(t);if(n)try{r=JSON.parse(n)}catch(i){r=void 0}return r}});function FlagSymbol(e){this.key=e}FlagSymbol.prototype.toString=function(){return this.key};var mo={flagArguments:{INCLUDE_CALL_STACK:new FlagSymbol("INCLUDE_CALL_STACK"),MIRROR_TO_SERVER:new FlagSymbol("MIRROR_TO_SERVER"),SUPPRESS_CLIENT_OUTPUT:new FlagSymbol("SUPPRESS_CLIENT_OUTPUT")},setDelegate:function(e){return no.attachDelegate(this,e)},execute:function(e,t,r){var n=e.levelStringToIntMap[t];if(e.level()!==e.NONE&&e.level()<=n){var i=Array.prototype.slice.call(r),o=mo.nonFlagLogArguments(i),a=mo.logOptions(e,n,i),s=a.includeCallStack?(new Error).stack:null,c=s?o.concat("\n"+s):o;if(e[t]._lastLog=c,a.mirrorToServer,a.throwInsteadOfPrint)throw new Error(o.toString());a.suppressClientOutput||(console[t]?console[t].apply(console,c):console.log.apply(console,c))}},isFlagObject:function(e){return e&&e===mo.flagArguments[e.toString()]},nonFlagLogArguments:function(e){return e.filter((function(e){return!mo.isFlagObject(e)}))},logOptions:function(e,t,r){var n,i={};return r.forEach((function(e){mo.isFlagObject(e)&&(n=lo.snakeCaseToCamelCase(e.toString()),i[n]=!0)})),no.isFunction(e.mirrorToServerLevel)&&e.mirrorToServerLevel()!==e.NONE&&e.mirrorToServerLevel()<=t&&(i.mirrorToServer=!0),e.throwLevel()!==e.NONE&&e.throwLevel()<=t&&(i.throwInsteadOfPrint=!0),i},sendToServer:function(e,t,r,n){}},go={NONE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4},bo={MIN_LEVEL:go.NONE,MAX_LEVEL:go.ERROR,levelIntToStringMap:{0:"none",1:"debug",2:"info",3:"warn",4:"error"},levelStringToIntMap:{none:0,debug:1,info:2,warn:3,error:4}};no.extend(bo,go);var So={loggerName:"defaultLogger",level:bo.INFO,throwLevel:bo.NONE},Po=!1,Eo={};function Logger(e){this._loggerName=e,this._level,this._throwLevel,Po||(Po=!0,no.extend(Logger.prototype,bo),no.extend(Logger.prototype,mo.flagArguments))}function loggerNamed(e){var t=Eo[e=e||So.loggerName];return t||(t=new Logger(e),Eo[e]=t),t}Logger.level=function(){return So.level},Logger.throwLevel=function(){return So.throwLevel},Logger.prototype.setDelegate=function(e){return no.attachDelegate(this,e)},Logger.prototype.loggerName=function(){return this._loggerName},Logger.prototype.levelParameterAsInt=function(e){var t,r=null;return no.isString(e)?t=this.levelStringToIntMap[e.toLowerCase()]:no.isNumber(e)&&(t=e),t>=this.MIN_LEVEL&&t<=this.MAX_LEVEL&&(r=t),r},Logger.prototype.setLevel=function(e){var t=this.levelParameterAsInt(e);null!==t&&(this._level=t)},Logger.prototype.setThrowLevel=function(e){var t=this.levelParameterAsInt(e);null!==t&&(this._throwLevel=t)},Logger.prototype.level=function(){var e=this._level;return no.isNumber(e)?e:Logger.level()},Logger.prototype.levelString=function(){return this.levelIntToStringMap[this.level()]},Logger.prototype.throwLevel=function(){var e=this._throwLevel;return no.isNumber(e)?e:Logger.throwLevel()},Logger.prototype.debug=function(){mo.execute(this,"debug",arguments)},Logger.prototype.info=function(){mo.execute(this,"info",arguments)},Logger.prototype.warn=function(){mo.execute(this,"warn",arguments)},Logger.prototype.error=function(){mo.execute(this,"error",arguments)},Logger.prototype.lastLog=function(e){return this[e]?this[e]._lastLog:null},Logger.level,Logger.throwLevel;var Environment$4=function(){};Environment$4.prototype.setDelegate=function(e){return no.attachDelegate(this,e)},Environment$4.prototype.localStorageObject=vo.localStorageObject,Environment$4.prototype.sessionStorageObject=vo.sessionStorageObject;var Network=function(){};Network.prototype.setDelegate=function(e){return no.attachDelegate(this,e)},Network.prototype.makeAjaxRequest=ho.makeAjaxRequest;var To,ko={configBaseUrl:"https://xp.apple.com/config/1/report",disabled:!0},_appendSectionAndSubsectionToConfigSources=function(e,t,r){if(r){e.push(r);var n=r[t];n&&no.hasAnyKeys(n)&&e.push(n)}},Config=function(e){this.environment=new Environment$4,this.network=new Network,this.logger=new Logger("mt-client-config"),this._topic=e||"noTopicConfig",this._debugSource=null,this._cachedSource=null,this._serviceSource=null,this._initCalled=!1,this._initialized=!1,this._showedDebugWarning=!1,this._showedNoProvidedSourceWarning=!1,this._keyPathsThatSuppressWarning={configBaseUrl:!0},this._configFetchPromise=null,this.DEBUG_SOURCE_KEY="mtClientConfig_debugSource_"+this._topic,this.CACHED_SOURCE_KEY="mtClientConfig_cachedSource_"+this._topic};Config.defaultConfig=function(){return To||(To=new Config("noTopicConfig")),To},Config.prototype._defaults=function(){return ko},Config.prototype._setInitialized=function(e){this._initialized=e},Config.prototype._setInitCalled=function(e){this._initCalled=e},Config.prototype._setShowedDebugWarning=function(e){this._showedDebugWarning=e},Config.prototype._setShowedNoProvidedSourceWarning=function(e){this._showedNoProvidedSourceWarning=e},Config.prototype.setDelegate=function(e){return no.attachDelegate(this,e)},Config.prototype.resetDelegate=function(){no.detachMethods(this),no.resetDelegates(this)},Config.prototype.topic=function(){return this._topic},Config.prototype.configHostname=function(){},Config.prototype.configUrl=function(){var e=this.configHostname();return(e?Promise.resolve("https://"+e+"/config/1/report"):this.value("configBaseUrl")).then(function(e){return"noTopicConfig"!==this._topic?e+="/"+this.topic():this.logger.error("config.configUrl(): Topic must be provided"),e}.bind(this))},Config.prototype.sources=function(){},Config.prototype.value=function(e,t){var r=function(){var r,n=this.cachedSource(),i=this.serviceSource(),o=this.sources(),a=this.debugSource(),s=n||i||o||a;return o||i||e in this._keyPathsThatSuppressWarning||this._showedNoProvidedSourceWarning||(this._showedNoProvidedSourceWarning=!0,this.logger.warn("Metrics config: No config provided via delegate or fetched via init(), using cached config values.")),a&&(this._showedDebugWarning||(this._showedDebugWarning=!0,this.logger.warn('"debugSource" found.\nThis will override any same-named client-supplied configSource fields.\nThis setting "sticks" across session, use "setDebugSource(null)" to clear'))),no.isArray(o)||(o=[o]),r="disabled"===e?s?[n,i,o,a]:[ko]:[ko,n,i,o,a],r=this.configSourcesWithOverrides(r,t||this.topic()),uo.valueForKeyPath.apply(null,[e].concat(r))}.bind(this);if(this._configFetchPromise)return this._configFetchPromise.then(r);var n=r();return Promise.resolve(n)},Config.prototype.configSourcesWithOverrides=function(e,t){var r=e;if(e&&e.length&&t){r=[];for(var n=0;n<e.length;n++){var i=e[n];if(i)if(no.isArray(i)&&i.length){for(var o=[],a=0;a<i.length;a++)_appendSectionAndSubsectionToConfigSources(o,t,i[a]);r.push(o)}else _appendSectionAndSubsectionToConfigSources(r,t,i)}}return r},Config.prototype.setDebugSource=function(e){return this._debugSource=e||null,vo.saveObjectToStorage(this.environment.localStorageObject(),this.DEBUG_SOURCE_KEY,this._debugSource)},Config.prototype.debugSource=function(){return this._debugSource||(this._debugSource=vo.objectFromStorage(this.environment.localStorageObject(),this.DEBUG_SOURCE_KEY)),this._debugSource},Config.prototype.setCachedSource=function(e){return this._cachedSource=e||null,vo.saveObjectToStorage(this.environment.localStorageObject(),this.CACHED_SOURCE_KEY,this._cachedSource)},Config.prototype.cachedSource=function(){return this._cachedSource||(this._cachedSource=vo.objectFromStorage(this.environment.localStorageObject(),this.CACHED_SOURCE_KEY)),this._cachedSource},Config.prototype.setServiceSource=function(e){return this._serviceSource=e,this._serviceSource},Config.prototype.serviceSource=function(){return this._serviceSource},Config.prototype.init=function(e){var t="noTopicConfig"===this._topic||!no.isFunction(e);if(t&&this.logger.warn("config.init(): Falling back to default config because configSourcesFn or a valid topic was not provided"),this._initCalled||t)return Promise.resolve(this);this._initCalled=!0;var r=this;return this._configFetchPromise=Promise.resolve(e()).then((function(e){return r.setDelegate({sources:function(){return e}}),r._initialized=!0,r})).catch((function(e){throw r._initCalled=!1,r._initialized=!1,e})),this._configFetchPromise},Config.prototype.cleanup=function(){this._initCalled=this._initialized=!1,this.setCachedSource(),this.setDebugSource(),this.resetDelegate(),this.environment=null,this.network=null,this.logger=null,this._topic=null,this._debugSource=null,this._cachedSource=null,this._serviceSource=null,this._initCalled=!1,this._initialized=!1,this._showedDebugWarning=!1,this._showedNoProvidedSourceWarning=!1,this._configFetchPromise=null},Config.prototype.initialized=function(){return this._initialized};var MetricsConfig=function(e){Config.call(this,e)};function dedupedArray(e,t){var r={};if(e)for(var n=0;n<e.length;n++)r[e[n]]=0;if(t)for(var i=0;i<t.length;i++)r[t[i]]=0;return Object.keys(r)}(MetricsConfig.prototype=Object.create(Config.prototype)).constructor=MetricsConfig,MetricsConfig.prototype.disabled=function(e){return this.value("disabled",e).then((function(e){return!!e}))},MetricsConfig.prototype.blacklistedEvents=function(e){return this.denylistedEvents(e)},MetricsConfig.prototype.denylistedEvents=function(e){var t=this.value("blacklistedEvents",e).then((function(e){return e||[]})).catch((function(){return[]})),r=this.value("denylistedEvents",e).then((function(e){return e||[]})).catch((function(){return[]}));return Promise.all([t,r]).then((function(e){return dedupedArray(e[0],e[1])}))},MetricsConfig.prototype.blacklistedFields=function(e){return this.denylistedFields(e)},MetricsConfig.prototype.denylistedFields=function(e){var t=this.value("blacklistedFields",e).then((function(e){return e||[]})).catch((function(){return[]})),r=this.value("denylistedFields",e).then((function(e){return e||[]})).catch((function(){return[]}));return Promise.all([t,r]).then((function(e){return dedupedArray(e[0],e[1])}))},MetricsConfig.prototype.removeBlacklistedFields=function(e,t){return this.removeDenylistedFields(e,t)},MetricsConfig.prototype.removeDenylistedFields=function(e,t){return e?this.denylistedFields(t).then((function(t){for(var r=0;r<t.length;r++){var n=t[r];n&&n in e&&delete e[n]}return e})):Promise.resolve(e)},MetricsConfig.prototype.metricsDisabledOrBlacklistedEvent=function(e,t){return this.metricsDisabledOrDenylistedEvent(e,t)},MetricsConfig.prototype.metricsDisabledOrDenylistedEvent=function(e,t){return this.disabled(t).then(function(r){return r||!!e&&this.denylistedEvents(t).then((function(t){return t.indexOf(e)>-1}))}.bind(this))},MetricsConfig.prototype.deResFields=function(e){return this.value("deResFields",e).then((function(e){return e||[]}))},MetricsConfig.prototype.applyDeRes=function(e,t){return e?this.deResFields(t).then((function(t){var r;return t.forEach((function(t){(r=t.fieldName)in e&&(e[r]=ao.deResNumber(e[r],t.magnitude,t.significantDigits))})),e})):Promise.resolve(e)};var Delegates=function(e,t){if(!no.isDefinedNonNullNonEmpty(e)||!no.isString(e))throw new Error("No valid topic was provided to Delegates.");this.config=this.getOrCreateConfig(e),no.isDefinedNonNull(t)&&(this.environment=t.environment,this.eventRecorder=t.eventRecorder),this._useOrginalContextForDelegateFunc=!1};function AbstractEventRecorder(){this._operationPromiseChain=Promise.resolve()}Delegates.prototype.init=function(){if(!no.isDefinedNonNull(this.environment))throw new Error("No environment was provided to Delegate options.");if(!no.isDefinedNonNull(this.eventRecorder))throw new Error("No eventRecorder was provided to Delegate options.");this.config.environment.setDelegate(this.environment),this.config.logger.setDelegate(this.logger),this.config.network.setDelegate(this.network);var e=no.isFunction(this.configSources)?this.configSources.bind(this):null;return this.config.init(e)},Delegates.prototype.mergeDelegates=function(e){for(var t in e)this[t]||(this[t]=e[t]);this.config.setDelegate(e.config)},Delegates.prototype.cleanup=function(){no.isFunction(this.eventRecorder.cleanup)&&this.eventRecorder.cleanup(),this.config=null,this.eventRecorder=null,this.environment=null},Delegates.prototype.setEventRecorder=function(e){return no.isDefinedNonNull(e)&&(no.isDefinedNonNull(this.eventRecorder)?(no.setDelegates(this.eventRecorder,e),this.eventRecorder.setDelegate(e)):this.eventRecorder=e),this},Delegates.prototype.setEnvironment=function(e){if(no.isDefinedNonNull(this.environment)){var t=Object.create(this.environment);no.extend(t,e),this.environment=t}else this.environment=e;return this},Delegates.prototype.setConfig=function(e){return this.config.setDelegate(e),this},Delegates.prototype.getOrCreateConfig=function(e){return no.isDefinedNonNull(this.config)||(this.config=new MetricsConfig(e)),this.config},Delegates.prototype.configSources=function(){throw new Error("This method should be implemented by subdelegates.")},AbstractEventRecorder.prototype.setDelegate=function(e){return no.attachDelegate(this,e)},AbstractEventRecorder.prototype.recordEvent=function(e,t){var r=Array.prototype.slice.call(arguments,2),n=this;return this._operationPromiseChain=this._operationPromiseChain.then((function(){return Promise.resolve(t).then((function(t){return n._recordEvent.apply(n,[e,t].concat(r))}))})),this._operationPromiseChain},AbstractEventRecorder.prototype.flushUnreportedEvents=function(){var e=Array.prototype.slice.call(arguments),t=this;return this._operationPromiseChain.then((function(){return t._operationPromiseChain=Promise.resolve(),t._flushUnreportedEvents.apply(t,e)}))},AbstractEventRecorder.prototype._recordEvent=function(e,t){},AbstractEventRecorder.prototype._flushUnreportedEvents=function(e){};var wo={setDelegate:function(e){return no.attachDelegate(this,e)},globalScope:function(){return no.globalScope()}},Oo={AJAX:"ajax",AJAX_SYNCHRONOUS:"ajaxSynchronous",IMAGE:"image",BEACON:"beacon",BEACON_SYNCHRONOUS:"beaconSynchronous"},Io=["dsId","consumerId"];function cloneTopicConfigWithTopic(e,t){var r={_topic:t};return Object.setPrototypeOf(r,e),r}var Base$3=function(e){this._validateConfig(e),this._config=e,this._topicConfigCache={},this._topicPropsCache={},this.logger=loggerNamed("mt-event-queue")};Base$3.prototype._validateConfig=function(e){var t="please call constructor with a valid Config instance first.";if(!e)throw new TypeError("Unable to find config, "+t);if(!e.topic||!no.isFunction(e.topic))throw new TypeError("Unable to find config.topic function, "+t);if(!e.metricsDisabledOrDenylistedEvent||!no.isFunction(e.metricsDisabledOrDenylistedEvent))throw new TypeError("Unable to find config.metricsDisabledOrDenylistedEvent function, "+t);if(!e.removeDenylistedFields||!no.isFunction(e.removeDenylistedFields))throw new TypeError("Unable to find config.removeDenylistedFields function, "+t)},Base$3.prototype._removeIdentifiableFieldsForTopic=function(e,t){this._topicPropsCache[e]=this._topicPropsCache[e]||{},this._topicPropsCache[e].anonymous&&Io.forEach((function(e){delete t[e]}))},Base$3.prototype._record=function(e){},Base$3.prototype.cleanup=function(){this._config=null,this._topicConfigCache=null,this._topicPropsCache={}},Base$3.prototype.recordEvent=function(e,t){if(!this._config||!t)return Promise.resolve(null);var r=this._config,n=this,i=arguments;return no.isDefinedNonNullNonEmpty(e)&&e!==r.topic()&&((r=this._topicConfigCache[e])||(r=this._topicConfigCache[e]=cloneTopicConfigWithTopic(this._config,e))),r.metricsDisabledOrDenylistedEvent(t.eventType).then((function(o){return o?null:r.removeDenylistedFields(t).then((function(){return n._removeIdentifiableFieldsForTopic(e,t),n._record.apply(n,[r].concat(Array.prototype.slice.call(i,1)))})).then((function(){return t}))})).catch((function(e){return n.logger.error(e),null}))},Base$3.prototype.sendMethod=function(){return"javascript"},Base$3.prototype.setProperties=function(e,t){this._topicPropsCache[e]=this._topicPropsCache[e]||{},this._topicPropsCache[e]=t};var Ao={setDelegate:function(e){return no.attachDelegate(this,e)},makeAjaxRequest:ho.makeAjaxRequest};function _isIOS(){var e=navigator.userAgent;return/iPad|iPhone|iPod/.test(e)&&-1==e.indexOf("IEMobile")}function _logger(){return loggerNamed("mt-event-queue")}var Ro=1e4,$o="events",Co="1.0",Do=100,Mo=2,No=Oo,Lo=2,xo="properties",jo={eventQueues:{},postIntervalEnabled:!0,enqueueEvent:function(e,t){if(e&&t&&e.topic()){var r=e.topic();return jo.eventQueues=jo.eventQueues||{},jo.eventQueues[r]=jo.eventQueues[r]||{},jo.eventQueues[r].topicConfig=e,jo.eventQueues[r].flushConfig=jo.eventQueues[r].flushConfig||{},jo.eventQueues[r][$o]=jo.eventQueues[r][$o]||[],jo.eventQueues[r][$o].push(t),0===Object.keys(jo.eventQueues[r].flushConfig).length&&Promise.all([e.value("metricsUrl"),e.value("requestTimeout"),e.value("postFrequency")]).then((function(e){var t=jo.eventQueues[r].flushConfig;t.metricsUrl=e[0],t.requestTimeout=e[1],t.postFrequency=e[2]})),e.value("maxPersistentQueueSize").then((function(e){return e=e||Do,jo.trimEventQueues(jo.eventQueues,e),t}))}return Promise.resolve(null)},trimEventQueues:function(e,t){var r=Object.keys(e);r.length&&r.forEach((function(r){var n=e[r][$o];n&&n.length&&n.length>t&&(_logger().warn("eventQueue overflow, deleting LRU events: size is: "+n.length+" which is over max size: "+t),e[r][$o]=n.slice(-t))}))},resetTopicQueue:function(e){jo.eventQueues[e]&&(jo.eventQueues[e][$o]=null)},resetTopicRetryAttempts:function(e){jo.eventQueues[e]&&(jo.eventQueues[e].retryAttempts=0)},scheduleNextTopicRetryAttempt:function(e){var t=e.topic();return jo.eventQueues[t]&&this.postIntervalEnabled?e.value("postFrequency").then((function(r){var n=jo.eventQueues[t];n.retryAttempts=n.retryAttempts||0,n.retryAttempts++;var i=Math.pow(Mo,n.retryAttempts)*r;jo.resetTopicPostInterval(t),jo.setTopicPostInterval(e,i)})):Promise.resolve()},sendEvents:function(e,t){var r=[];for(var n in jo.eventQueues){var i=jo.eventQueues[n].topicConfig,o=jo.sendEventsForTopicConfig(i,e,t);r.push(o)}return Promise.all(r)},sendEventsForTopicConfig:function(e,t,r){var n=e.topic(),i=jo.eventQueues[n];return Promise.all([e.value("testExponentialBackoff"),e.value("metricsUrl"),e.disabled(),e.value("postFrequency")]).then((function(o){var a=o[0],s=o[1],c=o[2],l=o[3];if(i&&s&&!c&&!a){if(!i.retryAttempts||!r){var d;switch(jo.resetTopicPostInterval(n),jo.setTopicPostInterval(e,l),t){case No.IMAGE:d=jo.sendEventsViaImage(e);break;case No.BEACON:d=jo.sendEventsViaBeacon(e);break;case No.AJAX_SYNCHRONOUS:d=jo.sendEventsViaAjax(e,!1);break;case No.AJAX:default:d=jo.sendEventsViaAjax(e,!0)}return d}}else if(a)return jo.scheduleNextTopicRetryAttempt(e)}))},sendEventsViaImage:function(e){var t=e.topic(),r=Promise.resolve();return jo.eventQueues[t]&&(r=resolveTopicConfigWithCallback(e,(function(e){var r=e.metricsUrl,n=-1==r.indexOf("?")?"?":"&",i=r+n+"responseType=image",o=jo.eventQueues[t][$o];o&&o.length&&o.forEach((function(e){var r=jo.createQueryParams(e);if(r){var n=i+"&"+r,o=new Image,a=jo.eventQueues[t][xo];a&&a.anonymous&&o.setAttribute("crossOrigin","anonymous"),o.src=n}})),jo.resetTopicQueue(t)}))),r},createQueryParams:function(e){var t,r,n="";return Object.keys(e).forEach((function(i,o,a){t=e[i],r=no.isString(t)?t:JSON.stringify(t),n+=i+"="+encodeURIComponent(r),o<a.length-1&&(n+="&")})),n.length?n:null},sendEventsViaAjax:function(e,t){var r=Promise.resolve(),n=e.topic();if(jo.eventQueues[n]&&jo.eventQueues[n][$o]){var i=enrichAndSerializeEvents(jo.eventQueues[n][$o]);i&&(r=resolveTopicConfigWithCallback(e,(function(r){var o=r.metricsUrl,a=r.requestTimeout,resetQueue=function(){jo.resetTopicQueue(n),jo.resetTopicRetryAttempts(n)},s=jo.eventQueues[n][xo]||{},c={async:t,timeout:a};s.anonymous&&(c.withCredentials=!1),Ao.makeAjaxRequest(o,"POST",i,resetQueue,(function(t,r){r>=400&&r<500?resetQueue():jo.scheduleNextTopicRetryAttempt(e)}),c)})))}return r},sendEventsViaBeacon:function(e){var t=Promise.resolve();if(!no.isFunction(navigator.sendBeacon))return _logger().error("navigator.sendBeacon() is not available in the environment"),t;var r=e.topic(),n=jo.eventQueues[r];if(n){var i=n[xo];if(i&&i.anonymous)t=no.isFunction(wo.globalScope().fetch)&&!/Firefox/.test(navigator.userAgent)?jo.sendEventsViaFetch(e,{keepalive:!0}):_isIOS()?jo.sendEventsViaAjax(e,!1):jo.sendEventsViaImage(e);else{var o=enrichAndSerializeEvents(n[$o]);o&&(t=resolveTopicConfigWithCallback(e,(function(e){var t=e.metricsUrl,n=new(0,wo.globalScope().Blob)([o],{type:"application/json"});navigator.sendBeacon(t,n)||_logger().error("navigator.sendBeacon() was unable to queue the data for transfer"),jo.resetTopicQueue(r)})))}}return t},sendEventsViaFetch:function(e,t){var r=Promise.resolve(),n=e.topic(),i=jo.eventQueues[n],o=no.isDefinedNonNull(t)?t.keepalive:null;if(no.isDefinedNonNull(i)){var a=enrichAndSerializeEvents(i[$o]);if(a){var s=i[xo]||{};r=resolveTopicConfigWithCallback(e,(function(e){var t=e.metricsUrl;no.globalScope().fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:a,credentials:!0===s.anonymous?"omit":"same-origin",keepalive:!no.isDefinedNonNull(o)||o}),jo.resetTopicQueue(n)}))}}return r},setTopicPostInterval:function(e,t){var r=e.topic();jo.eventQueues[r]&&t&&this.postIntervalEnabled&&(this.resetTopicPostInterval(r),jo.eventQueues[r].postIntervalToken=wo.globalScope().setInterval((function(){_logger().debug("MetricsKit: triggering postIntervalTimer for "+r+" at "+(new Date).toString()),jo.sendEventsForTopicConfig(e)}),t))},resetTopicPostInterval:function(e){jo.eventQueues[e]&&(wo.globalScope().clearInterval(jo.eventQueues[e].postIntervalToken),jo.eventQueues[e].postIntervalToken=null)},resetQueuePostIntervals:function(){for(var e in jo.eventQueues)jo.resetTopicPostInterval(e)},setQueuePostIntervals:function(){var e=[],setTopicPostIntervalFn=function(e){return function(t){jo.setTopicPostInterval(e,t)}};for(var t in jo.eventQueues){var r=jo.eventQueues[t][$o],n=jo.eventQueues[t].topicConfig;if(r&&r.length){var i=n.value("postFrequency").then(setTopicPostIntervalFn(n));e.push(i)}}return Promise.all(e)},objectContainsValue:function(e,t){var r=!1;for(var n in e){var i=e[n];if(e.hasOwnProperty(n)&&!no.isFunction(i)&&i===t){r=!0;break}}return r},setProperties:function(e,t){jo.eventQueues=jo.eventQueues||{},jo.eventQueues[e]=jo.eventQueues[e]||{},jo.eventQueues[e][xo]=t}};function _utQueue(){return jo}function enrichAndSerializeEvents(e){var t=null;if(e&&e.length){var r={};r.deliveryVersion=Co,r.postTime=Date.now(),r[$o]=e;try{t=JSON.stringify(r)}catch(n){_logger().error("Error stringifying events as JSON: "+n)}}return t}function metricsUrlForConfig(e){return e.value("metricsUrl").then((function(t){return t+"/"+Lo+"/"+e.topic()}))}function resolveTopicConfigWithCallback(e,t){if(no.isFunction(t)){if(no.isString(e.metricsUrl)&&!no.isFunction(e.value)){var r=no.isFunction(e.topic)?e.topic():e.topic,n=e.metricsUrl+"/"+Lo+"/"+r,i=e.requestTimeout||Ro,o=e.postFrequency;return t({requestTimeout:Math.min(i,o),metricsUrl:n})}return Promise.all([e.value("requestTimeout"),e.value("postFrequency"),metricsUrlForConfig(e)]).then((function(e){var r=e[0]||Ro,n=e[1],i=e[2];return t({requestTimeout:Math.min(r,n),metricsUrl:i})}))}_logger().warn("No callback function is provided for resolveTopicConfigWithCallback()")}function requestTimeoutForConfig(e){return Promise.all([e.value("requestTimeout"),e.value("postFrequency")]).then((function(e){var t=e[0]||Ro,r=e[1];return Math.min(t,r)}))}function flushUnreportedEvents(e,t){return e?t===Oo.BEACON_SYNCHRONOUS?function(){for(var e in jo.eventQueues){var t=jo.eventQueues[e].flushConfig,r=no.extend({},t,{_topic:e,topic:function(){return this._topic}});jo.sendEventsViaBeacon(r)}}():no.isString(t)&&jo.objectContainsValue(Oo,t)?jo.sendEvents(t,!0):no.isFunction(navigator.sendBeacon)?jo.sendEvents(No.BEACON,!0):_isIOS()?jo.sendEvents(No.AJAX_SYNCHRONOUS,!0):jo.sendEvents(No.IMAGE,!0):jo.sendEvents(No.AJAX,!0)}var QueuedEventRecorder=function(e){Base$3.apply(this,arguments)};(QueuedEventRecorder.prototype=Object.create(Base$3.prototype)).constructor=QueuedEventRecorder,QueuedEventRecorder.prototype._utResetQueue=function(){for(var e in _utQueue().eventQueues)_utQueue().resetTopicPostInterval(e);_utQueue().eventQueues={}},QueuedEventRecorder.prototype._record=function(e,t,r){return function(e,t,r){var n=e.topic();return e.disabled().then((function(i){if(!i)return e.value("postFrequency").then((function(n){return 0===n&&(r=!0),jo.enqueueEvent(e,t).then((function(){return n}))})).then((function(t){if(r)return jo.sendEvents(No.AJAX,!0);!jo.eventQueues[n].postIntervalToken&&jo.postIntervalEnabled&&jo.setTopicPostInterval(e,t)}))}))}(e,t,r)},QueuedEventRecorder.prototype.SEND_METHOD=Oo,QueuedEventRecorder.prototype.setDelegate=function(e){return no.attachDelegate(this,e)},QueuedEventRecorder.prototype.flushUnreportedEvents=function(e,t){return flushUnreportedEvents.apply(null,arguments)},QueuedEventRecorder.prototype.setProperties=function(e,t){Object.getPrototypeOf(QueuedEventRecorder.prototype).setProperties.call(this,e,t),_utQueue().setProperties(e,t)},QueuedEventRecorder.prototype.cleanup=function(){Object.getPrototypeOf(QueuedEventRecorder.prototype).cleanup.call(this),this._utResetQueue()};var ImmediateEventRecorder=function(e){Base$3.apply(this,arguments)};(ImmediateEventRecorder.prototype=Object.create(Base$3.prototype)).constructor=ImmediateEventRecorder,ImmediateEventRecorder.prototype._record=function(e,t){var r=enrichAndSerializeEvents([t]);if(r)return Promise.all([metricsUrlForConfig(e),requestTimeoutForConfig(e)]).then(function(t){var n=t[0],i={timeout:t[1]};this._topicPropsCache[e.topic()]&&this._topicPropsCache[e.topic()].anonymous&&(i.withCredentials=!1),Ao.makeAjaxRequest(n,"POST",r,null,null,i)}.bind(this))};var Uo=loggerNamed("mt-event-queue");function Environment$3(e){this._config=e}function EventRecorder$1(e){AbstractEventRecorder.call(this),this._proxyEventRecorder=e,this.SEND_METHOD=e.SEND_METHOD}Environment$3.prototype._document=function(){if("undefined"!=typeof document)return document;throw"metricskit-delegates-html.environment HTML delegate 'document' object not found"},Environment$3.prototype._window=function(){if("undefined"!=typeof window)return window;throw"metricskit-delegates-html.environment HTML delegate 'window' object not found"},Environment$3.prototype.browser=function(){var e=this._window().navigator.userAgent;return no.isDefinedNonNull(this._config)&&no.isDefinedNonNullNonEmpty(e)?this._config.value("browserMaps").then((function(t){if(!no.isDefinedNonNull(t))return null;for(var r=t.specifiedBrowsers||[],n=t.browserMap||{},i=null,o=0;o<r.length;o++){var a=r[o];if(e.indexOf(a)>-1){i=a;break}}if(!no.isDefinedNonNull(i)){var s=e.match(/Mozilla\/5.0 \((.*?)\)(\s|$)((.*?)\/(.*?)(\s)\(.*\))?(.*?)\/(.*?)(\s|$)/);no.isDefinedNonNullNonEmpty(s)&&s.length>=8&&(i=s[7])}return n[i=no.isDefinedNonNull(i)?i.trim():"unknown"]||i})):null},Environment$3.prototype.cookie=function(){return this._window().document.cookie},Environment$3.prototype.pageUrl=function(){return this._window().location.href},Environment$3.prototype.parentPageUrl=function(){var e,t=this._window(),r=t.parent;if(r!==t)try{e=r.location.href}catch(n){e=this._document().referrer}return e},Environment$3.prototype.pixelRatio=function(){return this._window().devicePixelRatio},Environment$3.prototype.screenHeight=function(){return this._window().screen.height},Environment$3.prototype.screenWidth=function(){return this._window().screen.width},Environment$3.prototype.userAgent=function(){return this._window().navigator.userAgent},Environment$3.prototype.windowInnerHeight=function(){return this._window().innerHeight},Environment$3.prototype.windowInnerWidth=function(){return this._window().innerWidth},Environment$3.prototype.windowOuterHeight=function(){return this._window().outerHeight},Environment$3.prototype.windowOuterWidth=function(){return this._window().outerWidth},Environment$3.prototype.timeOriginOffset=function(){var e=null,t=this._window().performance;return t&&t.timing&&(e=t.timing.navigationStart),e},Environment$3.prototype.app=function(){},Environment$3.prototype.appVersion=function(){},Environment$3.prototype.capacityData=function(){},Environment$3.prototype.capacityDataAvailable=function(){},Environment$3.prototype.capacityDisk=function(){},Environment$3.prototype.capacitySystem=function(){},Environment$3.prototype.capacitySystemAvailable=function(){},Environment$3.prototype.connectionType=function(){},Environment$3.prototype.dsId=function(){},Environment$3.prototype.hardwareBrand=function(){},Environment$3.prototype.hardwareFamily=function(){},Environment$3.prototype.hardwareModel=function(){},Environment$3.prototype.hostApp=function(){},Environment$3.prototype.hostAppVersion=function(){},Environment$3.prototype.os=function(){},Environment$3.prototype.osBuildNumber=function(){},Environment$3.prototype.osLanguages=function(){},Environment$3.prototype.osVersion=function(){},Environment$3.prototype.resourceRevNum=function(){},Environment$3.prototype.storeFrontCountryCode=function(){},Environment$3.prototype.storeFrontHeader=function(){},Environment$3.prototype.storeFrontLanguage=function(){},Environment$3.prototype.userType=function(){},EventRecorder$1.prototype=Object.create(AbstractEventRecorder.prototype),EventRecorder$1.prototype.constructor=EventRecorder$1,EventRecorder$1.prototype._recordEvent=function(e,t){return this._proxyEventRecorder.recordEvent.apply(this._proxyEventRecorder,arguments)},EventRecorder$1.prototype.flushUnreportedEvents=function(e,t){var r=this,n=Array.prototype.slice.call(arguments);return no.isDefinedNonNull(this._proxyEventRecorder.SEND_METHOD)&&t===this._proxyEventRecorder.SEND_METHOD.BEACON_SYNCHRONOUS?this._proxyEventRecorder.flushUnreportedEvents.apply(this._proxyEventRecorder,arguments):this._operationPromiseChain.then((function(){return r._operationPromiseChain=Promise.resolve(),r._proxyEventRecorder.flushUnreportedEvents.apply(r._proxyEventRecorder,n)}))},EventRecorder$1.prototype._flushUnreportedEvents=function(){return this._proxyEventRecorder.flushUnreportedEvents.apply(this._proxyEventRecorder,arguments)},EventRecorder$1.prototype.sendMethod=function(){return this._proxyEventRecorder.sendMethod.apply(this._proxyEventRecorder,arguments)},EventRecorder$1.prototype.setProperties=function(e,t){return this._proxyEventRecorder.setProperties.apply(this._proxyEventRecorder,arguments)},EventRecorder$1.prototype.cleanup=function(){return this._proxyEventRecorder.cleanup.apply(this._proxyEventRecorder,arguments)};var WebDelegates=function(e,t){var r=this.getOrCreateConfig(e);Delegates.call(this,e,{environment:new Environment$3(r),eventRecorder:new EventRecorder$1(new QueuedEventRecorder(r))}),this.immediateEventRecorder=new EventRecorder$1(new ImmediateEventRecorder(r)),this.network=null,this.logger=null,t&&(this.mergeDelegates(t),t.environment&&this.setEnvironment(t.environment),t.eventRecorder&&this.setEventRecorder(t.eventRecorder),t.network&&this.setNetwork(t.network),t.logger&&this.setLogger(t.logger),t.config&&(t.config.url&&this.config.setDelegate({configUrl:t.config.url}),this.setConfig(t.config)))};(WebDelegates.prototype=Object.create(Delegates.prototype)).constructor=WebDelegates,WebDelegates.prototype.setEnvironment=function(e){return wo.setDelegate(e),Delegates.prototype.setEnvironment.call(this,e)},WebDelegates.prototype.setNetwork=function(e){return e&&(this.network=e,Ao.setDelegate(e)),this},WebDelegates.prototype.setLogger=function(e){return e&&(this.logger=e,Uo.setDelegate(e)),this},WebDelegates.prototype.setImmediateEventRecorder=function(e){if(e){var t=Object.create(this.immediateEventRecorder);Object.assign(t,e),this.immediateEventRecorder=t}return this},WebDelegates.prototype.configSources=function(){var e=this;return new Promise((function(t,r){var onFetchSuccess=function(r){try{var n=JSON.parse(r);e.config.setCachedSource(n),e.config.setServiceSource(n),t(n)}catch(De){onFetchFailure(De)}},onFetchFailure=function(t){e.config.setCachedSource(e.config.cachedSource()),r(t)};Promise.resolve(e.config.configUrl()).then((function(t){oo.exponentialBackoff(e.config.network.makeAjaxRequest.bind(e.config.network,t,"GET",null),onFetchSuccess,onFetchFailure)})).catch(onFetchFailure)}))};var Environment$2=function(){};Environment$2.prototype.setDelegate=function(e){return no.attachDelegate(this,e)},Environment$2.prototype.localStorageObject=vo.localStorageObject,Environment$2.prototype.sessionStorageObject=vo.sessionStorageObject,Environment$2.prototype.platformIdentifier=function(e,t,r){};var System$1=function(){this.environment=new Environment$2,this.logger=loggerNamed("mt-client-constraints")};function lookForKeyPath(e,t,r,n){return no.isDefined(e)&&no.isDefinedNonNullNonEmpty(t)&&no.isFunction(n)?function _lookForKeyPath(e,t,r,n,i,o,a){if(no.isFunction(e))return i||e;if(n.push(r),0===t.length)return a(e,r,n.slice(1).join("."),i),i||e;if(!no.isDefined(e))return i||e;var s=o?e:{},c=t.shift();if(c.length>2&&c.indexOf("[]")===c.length-2){c=c.slice(0,-2),n.push(c),no.extend(s,e);var l=s[c];if(no.isDefinedNonNull(l)){var d=l.map((function(e,r){var i=o?l:l.slice();return _lookForKeyPath(e,t.slice(),r,n,i,o,a),n.pop(),i[r]}));s[c]=d}}else{var u=e[c];no.extend(s,e),s=_lookForKeyPath(u,t,c,n,s,o,a)}return n.pop(),i?(i[r]=s,i):s}(e,t.split("."),null,[],null,r,n):e}var Fo={all:{initMatchValue:!0,accumulateMatchResult:function(e,t){return e&&t}},any:{initMatchValue:!1,accumulateMatchResult:function(e,t){return e||t}}};var Ko={nonEmpty:function(e,t){return!!no.isObject(t)&&t.hasOwnProperty(e)&&no.isDefinedNonNullNonEmpty(t[e])},valueMatches:function(e,t,r){if(!no.isObject(t))return!1;var n=t[e];return t.hasOwnProperty(e)&&r.indexOf(n)>-1},nonValueMatches:function(e,t,r){if(!no.isObject(t)||!no.isArray(r))return!1;var n=t[e];return t.hasOwnProperty(e)&&-1===r.indexOf(n)},nestedFieldMatches:function(e,t,r){if(!no.isObject(t)||!no.isObject(r))return!1;var n=r.matchType,i=r.matches;if(!no.isDefinedNonNullNonEmpty(i))return!1;var o=function(e){var t=Fo[e];return no.isDefinedNonNull(t)||(t=Fo.all),t}(n),a=o.initMatchValue;return lookForKeyPath(t,e,!1,(function(e,t,r,n){var s=Object.keys(i).every((function(e){var r=i[e];return!!no.isDefinedNonNull(Ko[e])&&Ko[e](t,n,r)}));a=o.accumulateMatchResult(a,s)})),!!a}},Bo="overrideFieldValue",Base$2=function(){};Base$2.prototype.constrainedValue=function(e,t,r){var n=e&&e.hasOwnProperty(r)?e[r]:null;return this.applyConstraintRules(n,t)},Base$2.prototype.applyConstraintRules=function(e,t){var r=e;t&&(t.denylisted||t.blacklisted?r=null:t.hasOwnProperty(Bo)&&(r=t.overrideFieldValue));return r};var Vo=lo.exceptionString,Base$1$1=function(e){this._constraintsInstance=e};function hostname(e){var t,r=withoutParams(e=e||"").split("/");return(t=-1===e.indexOf("//")?r[0]:r[2]).substring(t.indexOf("@")+1).split(":")[0]}function withoutParams(e,t){var r=(e||"").split("?"),n=r[0],i=function(e){return(e||"").split("#")[0]}(r[1]).split("&").filter((function(e){var r=e.split("="),n=r[0],i=r[1];return no.isArray(t)?-1!==t.indexOf(n):!!no.isObject(t)&&(no.isObject(t[n])&&no.isArray(t[n].allowedValues)&&-1!==t[n].allowedValues.indexOf(i))})).join("&");return i.length>0?n+"?"+i:n}Base$1$1.prototype.setDelegate=function(e){return no.attachDelegate(this,e)},Base$1$1.prototype.constrainedValue=function(e,t,r,n){throw Vo("field_actions.Base","constrainedValue")},Base$1$1.prototype.performAction=function(e,t,r,n){return no.isDefinedNonNull(n)&&!no.isEmptyObject(n)&&(e=this.constrainedValue(e,n,r,t)),e};function generateId(e){if(!no.isDefinedNonNull(e)||!no.isInteger(e.idVersion))return"0";var t=lo.uuid(),r=e.generatedIdSeparator||"z";return(function(e){var t=[e.idVersion];e.time&&t.push(e.time);return t.map((function(e){return e.toString(16)})).join("-")}(e)+"-"+t||"").split("-").map((function(e){var t=parseInt(e,16);return lo.convertNumberToBaseAlphabet(t,lo.base61Alphabet)})).join(r)}function constrainedValue(e,t,r,n){var i=this.storageKey(n,r,t),o=this._constraintsInstance.system.environment,a=vo.objectFromStorage(o.localStorageObject(),i)||{};return a.value=this.idString(a,t),!this.rulesHaveLifespan(t)||no.isNumber(a.expirationTime)&&!this.timeExpired(a.expirationTime)||(a.expirationTime=this.expirationTime(t.lifespan)),vo.saveObjectToStorage(o.localStorageObject(),i,a),a.value}var Go={};function constrainedValue$1(e,t,r,n){var i=this.storageKey(n,r,t),o=Go[i];return o||(o=constrainedValue.apply(this,arguments),Go[i]=o),o}var IdAction=function(){Base$1$1.apply(this,arguments)};(IdAction.prototype=Object.create(Base$1$1.prototype)).constructor=IdAction,IdAction.prototype.SCOPE_STRATEGIES={ALL:"all",MAIN_DOMAIN:"mainDomain"},IdAction.prototype.rulesHaveLifespan=function(e){return e=e||{},no.isNumber(e.lifespan)},IdAction.prototype.expirationTime=function(e){return e?Date.now()+e:null},IdAction.prototype.storageKey=function(e,t,r){var n=this.scope(t,r);return this.storageKeyPrefix(r,e)+(n?"_"+n:"")},IdAction.prototype.storageKeyPrefix=function(e,t){return e&&no.isString(e.storageKeyPrefix)&&e.storageKeyPrefix.length>0?e.storageKeyPrefix:"mtId_"+t},IdAction.prototype.scope=function(e,t){var r,n,i,o,a,s="";if(t&&(t.namespace&&(s+=t.namespace),t.scopeStrategy)){var c;switch(t.scopeStrategy){case this.SCOPE_STRATEGIES.MAIN_DOMAIN:var l=t.scopeFieldName;r=e[l],n=hostname(r).split("."),i=n[n.length-1],o=n[n.length-2],a=2,i&&2===i.length&&o&&(2===o.length||o in{com:!0,org:!0,net:!0,edu:!0,gov:!0})&&(a=3),c=n.slice(-1*a).join(".")||"unknownDomain";break;case this.SCOPE_STRATEGIES.ALL:default:c=this.SCOPE_STRATEGIES.ALL}s.length&&(s+="_"),s+=c}return s},IdAction.prototype.idString=function(e,t){var r=e?e.value:null,n=r;return(!r||no.isNumber(e.expirationTime)&&this.timeExpired(e.expirationTime))&&(n=this.generateId(t)),n},IdAction.prototype.generateId=function(e){return e=e||{},generateId({idVersion:this.generatedIdVersion(),time:this.expirationTime(e.lifespan),generatedIdSeparator:this.generatedIdSeparator(e.tokenSeparator)})},IdAction.prototype.generatedIdVersion=function(){return 4},IdAction.prototype.idTokenSeparator=function(){return"-"},IdAction.prototype.generatedIdSeparator=function(e){return e||"z"},IdAction.prototype.timeExpired=function(e){return e<=Date.now()},IdAction.prototype.constrainedValue=function(e,t,r,n){return r&&t&&!no.isEmptyObject(t)&&(e=!0===t.persistIdForSession?constrainedValue$1.apply(this,arguments):constrainedValue.apply(this,arguments)),e};var ClientId=function(e,t){this._base=e,this._idAction=new IdAction(t),this._idAction.setDelegate({storageKey:function(e,t,r){return this.storageKeyPrefix()+"_"+this.scope(t,r)}.bind(this._idAction),storageKeyPrefix:function(){return"mtClientId"}})};ClientId.prototype.constrainedValue=function(e,t){var r=t;t&&no.isNumber(t.expirationPeriod)&&((r=no.extend({},t)).lifespan=r.expirationPeriod,delete r.expirationPeriod);var n=e?e.clientId:null,i=this._idAction.performAction(n,"clientId",e,r);return this._base.applyConstraintRules(i,t)};var UrlAction=function(){Base$1$1.apply(this,arguments)};(UrlAction.prototype=Object.create(Base$1$1.prototype)).constructor=UrlAction,UrlAction.prototype.SCOPES={HOSTNAME:"hostname",FULL:"full",FULL_WITHOUT_PARAMS:"fullWithoutParams",FULL_WITH_REPLACEMENTS:"fullWithReplacements"},UrlAction.prototype.constrainedValue=function(e,t){if(e&&t&&t.scope)switch(t.scope){case this.SCOPES.HOSTNAME:e=hostname(e);break;case this.SCOPES.FULL_WITHOUT_PARAMS:e=withoutParams(e,t.allowedParams);break;case this.SCOPES.FULL_WITH_REPLACEMENTS:e=function(e,t){var r=e||"";return(t||[]).reduce((function(e,t){var r=new RegExp(t.searchPattern,t.flags),n=t.replaceVal;return e.replace(r,n)}),r)}(e,t.replacements);break;case this.SCOPES.FULL:}return e};var ParentPageUrl=function(e){this._base=e,this._urlAction=new UrlAction};ParentPageUrl.prototype.constrainedValue=function(e,t){var r=e?e.parentPageUrl:null,n=this._urlAction.performAction(r,"parentPageUrl",e,t);return this._base.applyConstraintRules(n,t)};var FieldHandlers=function(e){this.base=new Base$2,this.clientId=new ClientId(this.base,e),this.parentPageUrl=new ParentPageUrl(this.base)},LegacyTreatment=function(e){this._fieldHandlers=new FieldHandlers(e)};function updateFieldRulesets(e,t,r,n){var i=e||{};if(n=n||function(e,t,r){return e[r]||{}},t&&t[r]){var o,a,s=i[r]||{};for(o in i[r]=s,t[r]){var c=n(s,t[r],o);for(a in s[o]=c,t[r][o])c[a]=t[r][o][a]}}return i}LegacyTreatment.prototype.applyConstraints=function(e,t){return t&&t.fieldConstraints&&(e=this.applyFieldConstraints(e,t.fieldConstraints)),e},LegacyTreatment.prototype.applyFieldConstraints=function(e,t){if(t){var r,n,i,o={};for(i in t)n=t[i],(e.hasOwnProperty(i)||!0===n.generateValue||n.hasOwnProperty(Bo))&&(r=i in this._fieldHandlers?this._fieldHandlers[i].constrainedValue(e,n):this._fieldHandlers.base.constrainedValue(e,n,i),o[i]=r);for(i in o)e[i]=o[i];e=po.mergeAndCleanEventFields(e)}return e};var LegacyConstraintGenerator=function(e){this.treatment=new LegacyTreatment(e)};LegacyConstraintGenerator.prototype.constraintsForEvent=function(e,t,r){if(!t)return Promise.resolve(null);var n=this;return Promise.resolve(t.constraintProfile(r)).then((function(e){if(!e)return null;var n="constraints.profiles."+e;return t.value(n,r)})).then((function(t){var r=null;return t&&t.precedenceOrderedRules&&(r=t.precedenceOrderedRules.reduce((function(t,r){return n.eventMatchesRule(e,r)&&(t=n.updateRules(t,r)),t}),{})),r}))},LegacyConstraintGenerator.prototype.eventMatchesRule=function(e,t){var r=!1;return e&&t.filters&&("any"===t.filters?r=!0:no.isObject(t.filters)&&(r=this.eventMatchesNonEmptyFields(e,t.filters.nonEmptyFields)&&this.eventMatchesFieldValues(e,t.filters.valueMatches))),r},LegacyConstraintGenerator.prototype.eventMatchesNonEmptyFields=function(e,t){var r=!1;return e&&(r=!t||!no.isArray(t)||t.every((function(t){return Ko.nonEmpty(t,e)}))),r},LegacyConstraintGenerator.prototype.eventMatchesFieldValues=function(e,t){var r=!1;return e&&(r=!(t&&no.isObject(t)&&!no.isEmptyObject(t))||Object.keys(t).every((function(r){var n=t[r];return Ko.valueMatches(r,e,n)}))),r},LegacyConstraintGenerator.prototype.updateRules=function(e,t){return updateFieldRulesets(e,t,"fieldConstraints")};var DenylistedEventAction=function(){};DenylistedEventAction.prototype.performAction=function(e,t,r){return!0!==r?e:null};var DenylistedFieldsAction=function(){};DenylistedFieldsAction.prototype.performAction=function(e,t,r){return e&&no.isArray(r)&&!no.isEmptyArray(r)?(e=no.extend({},e),r.forEach((function(t){delete e[t]})),no.isEmptyObject(e)?null:e):e};var AllowlistedFieldsAction=function(){};AllowlistedFieldsAction.prototype.performAction=function(e,t,r){if(!e||!no.isArray(r)||no.isEmptyArray(r))return e;var n={};return r.forEach((function(t){no.isDefinedNonNull(e[t])&&(n[t]=e[t])})),no.isEmptyObject(n)?null:n};var SessionizationFieldsAction=function(e){this._constraintsInstance=e};SessionizationFieldsAction.prototype.performAction=function(e,t,r){if(!no.isDefinedNonNull(e)||!no.isDefined(r))return e;if(no.isDefinedNonNull(r.sessionResetOptions)){if(!no.isDefinedNonNull(r.sessionResetOptions.filters))throw new SyntaxError('sessionizationFields Action: unable to find the required config "filters"');if(!0!==this._resetSession(e,t,r))return e}e=no.extend({},e);var n=this._storageKey(e,r),i=this._constraintsInstance.system.environment,o=vo.objectFromStorage(i.localStorageObject(),n)||{};this._shouldCreateNewSession(t,o,r)&&(o.sessionId=this._generateSessionId(r),o.rawFirstEventTimeInSession=t.eventTime,o.firstEventTimeInSession=e.eventTime,o.eventCount=0),o.rawLastEventTimeInSession=t.eventTime,o.lastEventTimeInSession=e.eventTime,o.eventCount+=1,vo.saveObjectToStorage(i.localStorageObject(),n,o);var a=this._getSessionFieldNames(r);return e[a.sessionId]=o.sessionId,r.sessionStartTime&&(e[a.sessionStartTime]=o.firstEventTimeInSession),e},SessionizationFieldsAction.prototype._storageKey=function(e,t){var r=this._scope(e,t);return this._storageKeyPrefix(t)+(no.isEmptyString(r)?"":"_"+r)},SessionizationFieldsAction.prototype._storageKeyPrefix=function(e){return e&&no.isString(e.storageKeyPrefix)&&e.storageKeyPrefix.length>0?e.storageKeyPrefix:"mtSessionization"},SessionizationFieldsAction.prototype._scope=function(e,t){var r="";return no.isDefined(t)&&(no.isString(t.namespace)&&(r+=t.namespace),no.isString(t.scopeFieldName)&&no.isDefinedNonNull(e[t.scopeFieldName])&&(r+="_",r+=e[t.scopeFieldName].toString())),r},SessionizationFieldsAction.prototype._generateSessionId=function(e){return generateId({idVersion:1,time:Date.now(),idTokenSeparator:"-",generatedIdSeparator:e.tokenSeparator})},SessionizationFieldsAction.prototype._shouldCreateNewSession=function(e,t,r){var n=!1;return n|=!no.isDefinedNonNull(t.sessionId),no.isDefinedNonNull(r.endSessionConditions)&&(no.isDefinedNonNull(r.endSessionConditions.lifespan)&&(n|=e.eventTime>=t.rawFirstEventTimeInSession+r.endSessionConditions.lifespan),no.isDefinedNonNull(r.endSessionConditions.idleSpan)&&(n|=e.eventTime>=t.rawLastEventTimeInSession+r.endSessionConditions.idleSpan),no.isDefinedNonNull(r.endSessionConditions.eventCount)&&(n|=t.eventCount>=r.endSessionConditions.eventCount)),n},SessionizationFieldsAction.prototype._resetSession=function(e,t,r){var n=r.sessionResetOptions,i=this._constraintsInstance._constraintGenerator;if(no.isDefinedNonNull(i)&&no.isDefinedNonNull(i.eventMatchesTreatment)&&i.eventMatchesTreatment(t,n)){var o=this._storageKey(e,r),a=this._constraintsInstance.system.environment;return vo.saveObjectToStorage(a.localStorageObject(),o,void 0),n.newSessionAfterReset}return!0},SessionizationFieldsAction.prototype._getSessionFieldNames=function(e){var t={sessionId:"sessionId",sessionStartTime:"sessionStartTime"};return no.isDefinedNonNull(e.sessionFields)&&(no.isDefinedNonNullNonEmpty(e.sessionFields.sessionId)&&(t.sessionId=e.sessionFields.sessionId),no.isDefinedNonNullNonEmpty(e.sessionFields.sessionStartTime)&&(t.sessionStartTime=e.sessionFields.sessionStartTime)),t};var Ho="blacklisted",qo="denylisted",Wo="blacklistedFields",Yo="denylistedFields",zo="whitelistedFields",Qo="allowlistedFields",Jo="sessionizationFields",EventActions=function(e){var t=new DenylistedEventAction,r=new DenylistedFieldsAction,n=new AllowlistedFieldsAction,i=new SessionizationFieldsAction(e);this._actions={},this._actions[Ho]=t,this._actions[qo]=t,this._actions[Wo]=r,this._actions[Yo]=r,this._actions[zo]=n,this._actions[Qo]=n,this._actions[Jo]=i};EventActions.prototype.getAction=function(e){return this._actions[e]};var NumberAction=function(){Base$1$1.apply(this,arguments)};(NumberAction.prototype=Object.create(Base$1$1.prototype)).constructor=NumberAction,NumberAction.prototype.constrainedValue=function(e,t){var r=t?t.precision:0,n=t?t.buckets:null;if(no.isDefinedNonNullNonEmpty(n)){var i=(n=n.slice().sort((function(e,t){return e.start-t.start})))[function(e,t){var r=-1;if(!no.isDefinedNonNull(t)||0===e.length||no.isDefinedNonNull(e[0])&&t<e[0].start)return-1;if(e[e.length-1].start<t)r=e.length-1;else for(var n=0;n<e.length;n++){var i=e[n].start;if(i===t){r=n;break}if(i>t){r=n-1;break}}return r}(n,e)];no.isDefinedNonNull(i)&&(e=i.value)}else no.isNumber(e)&&no.isNumber(r)&&r>0&&(e=Math.floor(e/r)*r);return e};var SerialNumberGenerator=function(e){e=e||{},this._nextRotationTime=e.nextRotationTime||Number.POSITIVE_INFINITY,this._storageKey=e.namespace||"mt_serial_number",this._initialSerialNumber=e.initialSerialNumber||0,this._rotationPeriod=e.rotationPeriod||Number.POSITIVE_INFINITY};SerialNumberGenerator.prototype.setDelegate=function(e){no.attachDelegate(this,e)},SerialNumberGenerator.prototype.localStorageObject=function(){return vo.localStorageObject()},SerialNumberGenerator.prototype.getNextSerialNumber=function(e){var t=this._storageKey,r=this._getCurrentSerialNumberData(t),n=r.sn;return e=no.isNumber(e)?e:1,n=parseInt(n,10),isNaN(n)&&(n=this._initialSerialNumber),n=this._increaseSerialNumber(n,e),r.sn=n,vo.saveObjectToStorage(this.localStorageObject(),this._storageKey,r),n},SerialNumberGenerator.prototype.resetSerialNumber=function(){var e=vo.objectFromStorage(this.localStorageObject(),this._storageKey);no.isDefinedNonNull(e)&&this._resetSerialNumber(e.exp)},SerialNumberGenerator.prototype.getTime=function(){return Date.now()},SerialNumberGenerator.prototype._increaseSerialNumber=function(e,t){return e+t},SerialNumberGenerator.prototype._getCurrentSerialNumberData=function(e){var t,r,n=vo.objectFromStorage(this.localStorageObject(),e);for(n?(t=n.exp,t=parseInt(t,10),n.exp=t=isNaN(t)?this._nextRotationTime:t):t=this._nextRotationTime-this._rotationPeriod;!n||this.getTime()>=t;)t=r=t+this._rotationPeriod,n=this._resetSerialNumber(r);return n},SerialNumberGenerator.prototype._resetSerialNumber=function(e){var t={};return t.exp=e,t.sn=this._initialSerialNumber,vo.saveObjectToStorage(this.localStorageObject(),this._storageKey,t),t};var TimeAction=function(){Base$1$1.apply(this,arguments),this._storage=this._constraintsInstance.system.environment.localStorageObject(),this._precisionEndTimeCache={},this._serialNumberGenerator=null};(TimeAction.prototype=Object.create(Base$1$1.prototype)).constructor=TimeAction,TimeAction.prototype.constrainedValue=function(e,t,r,n){var i=e;if(no.isNumber(e)&&no.isObject(t)&&no.isNumber(t.precision)&&t.precision>0){var o=this._computePrecisionStartTime(e,t);this._serialNumberGenerator=new SerialNumberGenerator({namespace:this._persistentStorageKey(t,n),nextRotationTime:o+t.precision,rotationPeriod:t.precision}),this._serialNumberGenerator.setDelegate(this._constraintsInstance.system.environment),this._serialNumberGenerator.setDelegate({getTime:function(){return e}});var a=this._serialNumberGenerator.getNextSerialNumber();i=this._computeTimestamp(o,a),this._serialNumberGenerator=null}return i},TimeAction.prototype._computeTimestamp=function(e,t){return e+t},TimeAction.prototype._persistentStorageKey=function(e,t){var r=e.namespace?"_"+e.namespace:"";return(e.storageKeyPrefix||"mtTimestamp")+r+"_"+t},TimeAction.prototype._computePrecisionStartTime=function(e,t){var r=t.precision;return Math.floor(e/r)*r};var HashAction=function(){Base$1$1.apply(this,arguments)};function buildSaltStorageKey(e,t){var r=e.namespace?"_"+e.namespace:"";return(e.storageKeyPrefix||"mtHash")+r+"_salt_"+t}(HashAction.prototype=Object.create(Base$1$1.prototype)).constructor=HashAction,HashAction.prototype.constrainedValue=function(e,t,r,n){return no.isDefinedNonNullNonEmpty(e)?this._loadPlatformBasedSalt(t,n).then((function(t){return function(e,t){return[e,t].map((function(e){var t=0;if(no.isDefinedNonNullNonEmpty(e))for(var r=0;r<e.length;r++){t=(t<<5)-t+e.charCodeAt(r)}var n=Math.abs(t);return n=parseInt(n,16),lo.convertNumberToBaseAlphabet(n,lo.base62Alphabet)})).join("")}(e,t)})):e},HashAction.prototype.timeExpired=function(e){return!!e&&e<=Date.now()},HashAction.prototype.expirationTime=function(e){return e?Date.now()+e:null},HashAction.prototype._loadPlatformBasedSalt=function(e,t){var r=null,n=this,i=e.platformBasedSalt;return no.isDefinedNonNull(i)?(r=this._constraintsInstance.system.environment.platformIdentifier(i.saltNamespace,"userid",i.crossDeviceSync||!0),r=no.isDefinedNonNull(r)?r.then((function(r){return no.isDefinedNonNull(r)||(n._constraintsInstance.system.logger.warn("Hash: platform returned an empty salt. Will use default salt generator to generate the salt."),r=n._getSalt(e,t)),r})):Promise.resolve(this._getSalt(e,t))):r=Promise.resolve(this._getSalt(e,t)),r},HashAction.prototype._getSalt=function(e,t){var r=this._retrieveSaltFromStorage(e,t),n=e.saltLifespan;if(!no.isDefinedNonNull(r)||this.timeExpired(r.expirationTime)){var i=this._constraintsInstance.system.environment.localStorageObject();r={salt:function(){for(var e="";e.length<10;)e+=lo.randomHexCharacter();return e}(),expirationTime:this.expirationTime(n)},vo.saveObjectToStorage(i,buildSaltStorageKey(e,t),r)}return r.salt},HashAction.prototype._retrieveSaltFromStorage=function(e,t){var r=this._constraintsInstance.system.environment.localStorageObject();return vo.objectFromStorage(r,buildSaltStorageKey(e,t))};var Xo="idGenerator",Zo="numberDeres",ea="timeDeres",ta="urlDeres",ra="hash",FieldActions=function(e){this.actions={},this.actions[Xo]=new IdAction(e),this.actions[Zo]=new NumberAction(e),this.actions[ea]=new TimeAction(e),this.actions[ta]=new UrlAction(e),this.actions[ra]=new HashAction(e)};FieldActions.prototype.getAction=function(e){return this.actions[e]};var ActionTreatment=function(e){this._eventActions=new EventActions(e),this._fieldActions=new FieldActions(e)};ActionTreatment.prototype.applyConstraints=function(e,t){var r=e;if(t&&!no.isEmptyObject(t)){var n=[],i=this;if(t.fieldActions&&!no.isEmptyObject(t.fieldActions)){var o=!1,a=r;a=Object.keys(t.fieldActions).reduce((function(e,s){var c=t.fieldActions[s];if(c){var l=c.denylisted||c.blacklisted,d=c.treatmentType,u=i._fieldActions.getAction(d);e=lookForKeyPath(e,s,!1,(function(e,t,i,d){if(l)delete d[t],o=!0;else if(c.hasOwnProperty(Bo))d[t]=c[Bo],o=!0;else if(u){var p=u.performAction(e,s,r,c);d[t]=p,p instanceof Promise&&n.push(p.then((function(e){lookForKeyPath(a,s,!0,(function(t,r,n,o){n===i&&(o[r]=e)}))}))),o=!0}}))}return e}),a),o&&(r=n.length>0?Promise.all(n).then((function(){return a})):a)}if(t.eventActions&&!no.isEmptyObject(t.eventActions)){var s=Object.keys(t.eventActions),processEventActions=function(r){return s.forEach((function(n){var o=i._eventActions.getAction(n);if(o){var a=t.eventActions[n];r=o.performAction(r,e,a)}})),r};r=r instanceof Promise?Promise.resolve(r).then((function(e){return processEventActions(e)})):processEventActions(r)}}return r};function _updateTreatment(e,t){var r=e||{};return function(e,t){e.eventActions||(e.eventActions={});var r=e.eventActions,n=t.eventActions;n&&Object.keys(n).reduce((function(e,t){var r=e[t],i=n[t];return no.isArray(r)?no.isArray(i)&&i.forEach((function(e){-1===r.indexOf(e)&&r.push(e)})):no.isArray(i)?e[t]=i.slice():(no.isObject(i)||!no.isObject(i)&&!no.isFunction(i))&&(e[t]=i),e}),r)}(r,t),function(e,t){e.fieldActions||(e.fieldActions={});updateFieldRulesets(e,t,"fieldActions",(function(e,t,r){return e[r]&&e[r].treatmentType===t[r].treatmentType?e[r]:{}}))}(r,t),r}var TreatmentGenerator=function(e){this._constraintsInstance=e,this.treatment=new ActionTreatment(e)};TreatmentGenerator.prototype._combineTreatments=function(e,t,r){var n,i=[];return no.isArray(e)?(e.forEach((function(e){if(e){var n="treatmentProfiles."+e,o=t.value(n,r).then((function(e){return e&&e.treatments?e.treatments:[]}));i.push(o)}})),n=Promise.all(i).then((function(e){var t=[];return e.forEach((function(e){t=t.concat(e)})),t}))):n=Promise.resolve([]),n},TreatmentGenerator.prototype.constraintsForEvent=function(e,t,r){if(!t)return Promise.resolve(null);var n=this;return Promise.resolve(t.constraintProfiles(r)).then((function(e){return no.isDefinedNonNull(e)?e:Promise.resolve(t.constraintProfile(r)).then((function(e){return no.isDefinedNonNull(e)?[e]:null}))})).then((function(e){if(no.isDefinedNonNull(e)){if(!no.isArray(e))throw new TypeError('"constraintProfiles" should be an Array, but got: '+(e?e.constructor:e));return n._combineTreatments(e,t,r).then((function(t){if(0===t.length)throw new SyntaxError("The constraintProfiles: "+e.join(", ")+" are not found in the topic config");return t}))}return Promise.resolve([])})).then((function(t){return t.reduce((function(t,r){return n.eventMatchesTreatment(e,r)&&(t=_updateTreatment(t,r)),t}),null)}))},TreatmentGenerator.prototype.eventMatchesTreatment=function(e,t){var r=t.filters;if(r&&no.isString(r))return"any"===r;if(!no.isDefinedNonNull(r)||0===r.length)throw new SyntaxError("Unable to find the filter in \n"+JSON.stringify(t));return Object.keys(r).every((function(n){var i=r[n];if(i&&no.isString(i))return!1;if(!i||!no.isObject(i)||no.isEmptyObject(i))throw new SyntaxError("Invalid filter object for field ("+n+") in \n"+JSON.stringify(t));return Object.keys(i).every((function(r){var o=i[r];if(Ko[r])return Ko[r](n,e,o);throw new SyntaxError("Unable to find the filter ("+r+") for field ("+n+")in \n"+JSON.stringify(t))}))}))};var na={constraintProfile:function(e){return this.value("constraints.defaultProfile",e)},constraintProfiles:function(e){return this.value("defaultTreatmentProfiles",e)}};var Constraints=function(e,t){if(r=e,n=!0,(n&=no.isDefinedNonNull(r))&&(n&=!no.isEmptyObject(r),n&=no.isFunction(r.initialized),n&=no.isFunction(r.value),n&=no.isFunction(r.constraintProfile)),!n)throw new Error('The topic config is not a valid instance of "mt-client-config".');var r,n;this._isInitialized=!1,this._topicConfig=e,this._constraintGenerator=null,this.system=new System$1,no.setDelegates(this.system,t||{})};Constraints.prototype._getConstraintGenerator=function(){var e=this;return this._constraintGenerator?Promise.resolve(this._constraintGenerator):this._topicConfig.value("treatmentProfiles").then((function(t){return no.isDefinedNonNull(t)?e._constraintGenerator=new TreatmentGenerator(e):e._constraintGenerator=new LegacyConstraintGenerator(e),e._constraintGenerator}))},Constraints.prototype.constraintsForEvent=function(e,t){var r=this;return this._getConstraintGenerator().then((function(n){return n.constraintsForEvent(e,r._topicConfig,t)}))},Constraints.prototype.applyConstraintTreatments=function(e,t){var r=t?Promise.resolve(t):this.constraintsForEvent(e),n=this;return Promise.all([r,this._getConstraintGenerator()]).then((function(t){var r=t[0];return t[1].treatment.applyConstraints(e,r)})).catch((function(e){return n.system.logger.warn("An error occurred while applying constraints: "+e.message||e),null}))};var ia,oa,aa=Constraints;function environmentBaseFieldNames(){return oa||(oa=["app","appVersion","hardwareFamily","hardwareModel","os","osBuildNumber","osLanguages","osVersion","resourceRevNum","screenHeight","screenWidth","userAgent"].concat(["delegateApp","hardwareBrand","storeFrontCountryCode","storeFrontHeader","storeFrontLanguage"])),oa}var sa,ca=no.attachDelegate,la=lo.cryptoRandomBase62String,da=lo.exceptionString;function Base$1(e){if(!no.isDefinedNonNull(e))throw new Error("A processor instance is required for creating BaseEventHandler.");this._processor=e,sa||(sa=!0,environmentBaseFieldNames().forEach((function(e){Base$1.prototype[e]=function(t){return t&&t.hasOwnProperty(e)?t[e]:this.environment()[e]()}})))}Base$1._className="eventHandlers.base",Base$1.prototype.setDelegate=function(e){return ca(this,e)},Base$1.prototype.environment=function(){throw da(Base$1._className,"environment")},Base$1.prototype.eventRecorder=function(){throw da(Base$1._className,"eventRecorder")},Base$1.prototype.metricsData=function(){throw da(Base$1._className,"metricsData")},Base$1.prototype.processMetricsData=function(){throw da(Base$1._className,"processMetricsData")},Base$1.prototype.knownFields=function(){return ia||(ia=environmentBaseFieldNames().concat(["baseVersion","clientEventId","connection","eventTime","eventType","eventVersion","timezoneOffset","xpPostFrequency","xpSendMethod"])),ia},Base$1.prototype.baseVersion=function(){return 1},Base$1.prototype.clientEventId=function(e){return e&&e.clientEventId||la(!0)},Base$1.prototype.connection=function(e){return e&&e.connection||this.environment().connectionType()},Base$1.prototype.dsId=function(e){return e&&e.dsId||this.environment().dsId()},Base$1.prototype.eventTime=function(e){return e&&e.eventTime||Date.now()},Base$1.prototype.eventVersion=function(e){return e&&e.eventVersion||null},Base$1.prototype.timezoneOffset=function(e){return e&&e.timezoneOffset||(new Date).getTimezoneOffset()},Base$1.prototype.xpPostFrequency=function(e){return e&&e.xpPostFrequency||this._processor.config.value("postFrequency")},Base$1.prototype.xpSendMethod=function(e){return e&&e.xpSendMethod||this.eventRecorder().sendMethod()};var ua,pa=Base$1,ha=no.attachDelegate,ya=lo.exceptionString,fa=vo.localStorageObject,_a=vo.sessionStorageObject;function Environment$1(){ua||(ua=!0,["app","appVersion","hardwareFamily","hardwareModel","os","osBuildNumber","osLanguages","osVersion","resourceRevNum","screenHeight","screenWidth","userAgent"].forEach((function(e){Environment$1.prototype[e]=function(){throw ya(Environment$1._className,e)}})),["delegateApp","hardwareBrand","storeFrontCountryCode","storeFrontHeader","storeFrontLanguage"].forEach((function(e){Environment$1.prototype[e]=function(){}})))}Environment$1._className="system.environment",Environment$1.prototype.setDelegate=function(e){return ha(this,e)},Environment$1.prototype.connectionType=function(){throw ya(Environment$1._className,"connectionType")},Environment$1.prototype.dsId=function(){},Environment$1.prototype.localStorageObject=fa,Environment$1.prototype.sessionStorageObject=_a,Environment$1.prototype.platformIdentifier=function(){};var va=Environment$1;function MetricsData$2(){this._eventData={}}MetricsData$2.prototype.updateData=function(){no.extend.apply(null,[this._eventData].concat(Array.prototype.slice.call(arguments)))};var ma=MetricsData$2,ga=va;function PlayActivityEnvironment(){ga.apply(this,arguments)}PlayActivityEnvironment.prototype=Object.create(ga.prototype),PlayActivityEnvironment.prototype.constructor=PlayActivityEnvironment,PlayActivityEnvironment.prototype.consumerId=function(){},PlayActivityEnvironment.prototype.consumerNs=function(){},PlayActivityEnvironment.prototype.isOffline=function(){},PlayActivityEnvironment.prototype.videoViewportHeight=function(){},PlayActivityEnvironment.prototype.videoViewportWidth=function(){};var ba=no.attachDelegate,Sa=lo.exceptionString,Pa="PlayActivityProcessor.system.eventRecorder",EventRecorder=function(){};EventRecorder.prototype.setDelegate=function(e){return ba(this,e)},EventRecorder.prototype.recordEvent=function(e,t){throw Sa(Pa,"recordEvent")},EventRecorder.prototype.sendMethod=function(){throw Sa(Pa,"sendMethod")},EventRecorder.prototype.flushUnreportedEvents=function(e){};var Ea=loggerNamed("mt-metricskit-processor-play-activity"),System=function(){this.environment=new PlayActivityEnvironment,this.eventRecorder=new EventRecorder,this.logger=Ea},EventFields=function(e){this._processor=e};EventFields.prototype.applyFieldsMap=function(e,t){return this._processor.config.value("fieldsMap").then((function(r){return po.applyFieldsMap(e,t,r)}))};var Utils=function(e){this.eventFields=new EventFields(e)},Ta="unknown",ka="next",wa="previous",Oa="location",Ia="interval",Aa="playhead",Ra="scrub",$a="transition",Ca="interruption",Da="buffering",Ma="play",Na="seek",La="playOther",xa="skipIntro",ja="skipToLive",Ua="actionType",Fa="consumerId",Ka="consumerNs",Ba="dsId",Va="eventType",Ga="eventVersion",Ha="isOffline",qa="videoViewportHeight",Wa="videoViewportWidth",Ya={TYPE:{MANUAL:"manual",AUTOMATIC:"automatic",UNKNOWN:Ta},ASSET_PLACEMENT:{PRE_ROLL:"preroll",POST_ROLL:"postroll",MID_ROLL:"midroll",FEATURE:"feature",CATCH_UP_TO_LIVE:"catchUpToLive"},PLAY_START_REASON:{PLAY:Ma,PLAY_OTHER:La,UNPAUSE:"unpause",NEXT:ka,PREVIOUS:wa,SEEK:Na,TRANSITION:$a,INTERRUPTION:Ca,FOREGROUND:"foreground",FOCUS:"focus",BUFFERING:Da,UNKNOWN:Ta,SKIP_TO_LIVE:ja},PLAY_START_REASON_TYPE:{SKIP_INTRO:xa,SKIP_TO_LIVE:ja},PLAY_STOP_REASON:{COMPLETE:"complete",TRANSITION:$a,PLAY_OTHER:La,PAUSE:"pause",SEEK:Na,NEXT:ka,INTERRUPTION:Ca,BACKGROUND:"background",EXIT:"exit",INACTIVITY:"inactivity",BUFFERING:Da,ERROR:"error",FAILURE:"failure",UNKNOWN:Ta,CLOSE_PLAYER:"closePlayer",SKIP_TO_LIVE:ja},PLAY_STOP_REASON_TYPE:{SKIP_INTRO:xa,SKIP_TO_LIVE:ja},SEEK_START_REASON:{NEXT:ka,PREVIOUS:wa,LOCATION:Oa,INTERVAL:Ia,PLAYHEAD:Aa,SCRUB:Ra,UNKNOWN:Ta,SKIP_INTRO:xa},SEEK_STOP_REASON:{NEXT:ka,PREVIOUS:wa,LOCATION:Oa,INTERVAL:Ia,PLAYHEAD:Aa,SCRUB:Ra,UNKNOWN:Ta,SEEK:Na,SKIP_INTRO:xa},SEEK_STOP_REASON_TYPE:{SKIP_INTRO:xa}},za={ACTIVITY_TYPE:{PLAY:Ma,SEEK:Na},ACTION_TYPE:{START:"start",STOP:"stop"},EVENT_TYPE:{PLAY_ACTIVITY:"playActivity",SEEK_ACTIVITY:"seekActivity"}},Qa={INCLUDES_START_POSITIONS:"includesStartPositions",INCLUDES_END_POSITIONS:"includesEndPositions"},MediaActivity=function(e,t){this._processor=e,this._activityType=t,this._startMetricsDataPromise=Promise.resolve(null),this._isStopped=!1};MediaActivity.ACTIVITY_TYPE=za.ACTIVITY_TYPE,Object.defineProperties(MediaActivity.prototype,{isStopped:{get:function(){return this._isStopped}},type:{get:function(){return this._activityType}},startOverallPosition:{get:function(){return this._startMetricsDataPromise?this._startMetricsDataPromise.then((function(e){return e.overallPosition})):Promise.resolve(null)}}}),no.extend(MediaActivity.prototype,Ya),MediaActivity.prototype.started=function(e,t,r,n){var i=this._startEventHandler(),o=this;if(i){if(this._startMetricsDataPromise=i.metricsData.apply(i,arguments),this.type!=MediaActivity.ACTIVITY_TYPE.SEEK)return this._processor.system.eventRecorder.recordEvent(this._processor.config.topic(),this._startMetricsDataPromise)}else o._processor.system.logger.error('Failed to record the start event with activityType: "'+r+'" due to unexpected current type "'+this.type+'", expected "'+MediaActivity.ACTIVITY_TYPE.PLAY+'" or "'+MediaActivity.ACTIVITY_TYPE.SEEK+'"');return Promise.resolve(null)},MediaActivity.prototype.stopped=function(e,t,r,n){var i=Array.prototype.slice.call(arguments),o=this._stopEventHandler(),a=this;if(o){this._isStopped=!0;var s=this._startMetricsDataPromise.then((function(a){var s=[e,t,r,n,a].concat(Array.prototype.slice.call(i,4));return o.metricsData.apply(o,s)}));return a._processor.system.eventRecorder.recordEvent(a._processor.config.topic(),s)}return a._processor.system.logger.error('Failed to record the stop event with activityType: "'+r+'" due to unexpected current type "'+this.type+'", expected "'+MediaActivity.ACTIVITY_TYPE.PLAY+'" or "'+MediaActivity.ACTIVITY_TYPE.SEEK+'"'),Promise.resolve(null)},MediaActivity.prototype._startEventHandler=function(){var e;switch(this.type){case MediaActivity.ACTIVITY_TYPE.PLAY:e=this._processor.eventHandlers.playStart;break;case MediaActivity.ACTIVITY_TYPE.SEEK:e=this._processor.eventHandlers.seekStart}return e},MediaActivity.prototype._stopEventHandler=function(){var e;switch(this.type){case MediaActivity.ACTIVITY_TYPE.PLAY:e=this._processor.eventHandlers.playStop;break;case MediaActivity.ACTIVITY_TYPE.SEEK:e=this._processor.eventHandlers.seekStop}return e};var Ja=no.isInteger,TimeTracker=function(e,t,r){this._date=new Date,this._position=t,this._validatePlaybackRate(e),this._playbackRate=e,this._logger=r};Object.defineProperties(TimeTracker.prototype,{playbackRate:{get:function(){return this._playbackRate}}}),TimeTracker.prototype.update=function(e,t){this._date=new Date,this._position=t,this._validatePlaybackRate(e),this._playbackRate=e},TimeTracker.prototype.estimatedTime=function(e){var t;Ja(e)?t=e:(this._logger.error("VPAFKit error: position should be an integer"),t=Math.round(e));var r=(t-this._position)/(0==this.playbackRate?1:this.playbackRate);return this._date.getTime()+Math.round(r)},TimeTracker.prototype._validatePlaybackRate=function(e){0==e&&this._logger.error("VPAFKit error: playbackRate should not be zero.")};var Xa=no.attachDelegate,Za=no.extend,es=no.isFunction,ts=no.isNumber,rs=ma,ns=Qa.INCLUDES_START_POSITIONS,is=Qa.INCLUDES_END_POSITIONS,MediaActivityTracker=function(e,t){rs.apply(this,arguments),this._processor=e,this._playlist=t,this._playActivity=null,this._playStartPlaylistItem=null,this._seekActivity=null,this._timeTracker=null,this._shouldGenerateTransitions=!0};(MediaActivityTracker.prototype=Object.create(rs.prototype)).constructor=MediaActivityTracker,Za(MediaActivityTracker.prototype,Ya),Object.defineProperties(MediaActivityTracker.prototype,{shouldGenerateTransitions:{get:function(){return this._shouldGenerateTransitions},set:function(e){this._shouldGenerateTransitions=e}}}),MediaActivityTracker.prototype.setDelegate=function(e){return Xa(this,e)},MediaActivityTracker.prototype.playStarted=function(e,t,r){return this.playStartedWithPlaybackRate.apply(this,[1].concat(Array.prototype.slice.call(arguments)))},MediaActivityTracker.prototype.playStartedWithPlaybackRate=function(e,t,r,n){var i=Promise.resolve(),o=this;if(this._hasUnstoppedActivity(this._playActivity))this._error("inconsistent state: did you forget to call playStopped?");else{var a=this._playlistItem(t,ns);a?i=this._playStarted.apply(this,[a].concat(Array.prototype.slice.call(arguments,1))).then((function(){o.shouldGenerateTransitions&&(o._timeTracker=new TimeTracker(e,t,o._processor.system.logger))})).catch((function(e){o._error(e)})):this._error('Failed to record play start event due to no active playlist item for the overall position "'+t+'".')}return i},MediaActivityTracker.prototype.playStopped=function(e,t,r){var n=this._generatePlaylistTransitionsIfNecessary(e),i=this,o=Array.prototype.slice.call(arguments);return this._hasUnstoppedActivity(this._playActivity)?n=n.then((function(){var e=i._playStopped.apply(i,Array.prototype.slice.call(o));return i._playStartPlaylistItem=null,i._timeTracker=null,e})).catch((function(e){i._error(e)})):this._error("inconsistent state: did you forget to call playStarted?"),n},MediaActivityTracker.prototype.playTransitioned=function(e){var t=this,r=Array.prototype.slice.call(arguments,1);return this.playStopped.apply(this,[e,this.TYPE.AUTOMATIC,this.PLAY_STOP_REASON.TRANSITION].concat(r)).then((function(){return t.playStarted.apply(t,[e,t.TYPE.AUTOMATIC,t.PLAY_START_REASON.TRANSITION].concat(r))})).catch((function(e){t._error(e)}))},MediaActivityTracker.prototype.seekStarted=function(e,t,r){var n=Promise.resolve();if(this._hasUnstoppedActivity(this._seekActivity))this._error("inconsistent state: did you forget to call seekStopped?");else{var i=this._playlistItem(e,ns);if(i){var o=this._activityArguments.apply(this,[i].concat(Array.prototype.slice.call(arguments)));this._seekActivity=new MediaActivity(this._processor,MediaActivity.ACTIVITY_TYPE.SEEK);var a=this;n=this._seekActivity.started.apply(this._seekActivity,o).catch((function(e){a._error(e)}))}else this._error('Failed to record seek start event due to no active playlist item for the overall position "'+e+'".')}return n},MediaActivityTracker.prototype.seekStopped=function(e,t,r){var n=Promise.resolve(),i=this._playlistItem(e,is);if(i&&this._hasUnstoppedActivity(this._seekActivity)){var o=this._activityArguments.apply(this,[i].concat(Array.prototype.slice.call(arguments))),a=this;n=this._seekActivity.stopped.apply(this._seekActivity,o).catch((function(e){a._error(e)}))}else this._error("inconsistent state: did you forget to call seekStarted?");return n},MediaActivityTracker.prototype.synchronize=function(e,t){if(this.shouldGenerateTransitions){var r=e>0,n=this._hasUnstoppedActivity(this._playActivity),i=Promise.resolve(),o=this;return n&&r?i=this._generatePlaylistTransitionsIfNecessary(t).then((function(){o._timeTracker.update(e,t)})).catch((function(e){o._error(e)})):n&&!r?this._error("inconsistent state: did you forget to call playStopped?"):!n&&r&&this._error("inconsistent state: did you forget to call playStarted?"),i}},MediaActivityTracker.prototype._playStarted=function(e,t,r,n){var i=this._activityArguments.apply(this,[e].concat(Array.prototype.slice.call(arguments,1)));return this._playStartPlaylistItem=e,this._playActivity=new MediaActivity(this._processor,MediaActivity.ACTIVITY_TYPE.PLAY),this._playActivity.started.apply(this._playActivity,i)},MediaActivityTracker.prototype._playStopped=function(e,t,r){var n=this._playStartPlaylistItem,i=this._activityArguments.apply(this,[n].concat(Array.prototype.slice.call(arguments)));return this._playActivity.stopped.apply(this._playActivity,i)},MediaActivityTracker.prototype._playlistItem=function(e,t){var r;return this._playlist&&es(this._playlist.getItem)&&(r=this._playlist.getItem(e,t)),r||this._error("unable to get item from playlist"),r},MediaActivityTracker.prototype._playlistItems=function(e,t){var r=[];return this._playlist&&es(this._playlist.getItems)?r=this._playlist.getItems(e,t):this._error("unable to get items from playlist"),r},MediaActivityTracker.prototype._relativePosition=function(e,t){var r;return(t=t||this._playlistItem(e))&&ts(t.startOverallPosition)&&(r=e-t.startOverallPosition+(t.startPosition||0)),r},MediaActivityTracker.prototype._combineEventData=function(e,t){var r=this._playlist?this._playlist.eventData:null,n=e?e.eventData:null,i=[];return r&&i.push(r),n&&i.push(n),this._eventData&&i.push(this._eventData),t&&(i=i.concat(t)),i},MediaActivityTracker.prototype._activityArguments=function(e,t,r,n){var i=this._relativePosition(t,e),o=this._combineEventData(e,Array.prototype.slice.call(arguments,4)),a=[i,t,r,n].concat(o);return a},MediaActivityTracker.prototype._generatePlaylistTransitionsIfNecessary=function(e){var t=this,r=Promise.resolve();return this.shouldGenerateTransitions&&this._hasUnstoppedActivity(this._playActivity)&&(r=this._playActivity.startOverallPosition.then((function(e){return e||0})).then((function(r){var n,i,o=t._playlistItems(r,e),a=Promise.resolve();t._playlist._returnsOrderedItems||o.sort(t._playlistItemComparator);for(var s=0;s+1<o.length;s++)if(!((n=(i=o[s+1]).startOverallPosition)<=r)){if(n>=e)break;a=a.then(function(){var e=this,r=e.startOverallPosition,n={eventTime:t._timeTracker?t._timeTracker.estimatedTime(r):null};return t._playStopped(r,t.TYPE.AUTOMATIC,t.PLAY_STOP_REASON.TRANSITION,n).then((function(){return t._playStarted(e,r,t.TYPE.AUTOMATIC,t.PLAY_START_REASON.TRANSITION,n)}))}.bind(i))}return a}))),r},MediaActivityTracker.prototype._hasUnstoppedActivity=function(e){return e&&!e.isStopped},MediaActivityTracker.prototype._error=function(e){this._processor.system.logger.error(this.constructor.name+" error: "+e)},MediaActivityTracker.prototype._playlistItemComparator=function(e,t){return e.startOverallPosition==t.startOverallPosition?0:e.startOverallPosition<t.startOverallPosition?-1:1};var HLSRollItemsMediaActivityTracker=function(e,t){MediaActivityTracker.apply(this,arguments)};(HLSRollItemsMediaActivityTracker.prototype=Object.create(MediaActivityTracker.prototype)).constructor=HLSRollItemsMediaActivityTracker,Object.defineProperty(HLSRollItemsMediaActivityTracker.prototype,"shouldGenerateTransitions",{get:function(){return!1},set:function(){this._error('Changing "shouldGenerateTransitions" is not allowed in HLSRollItemsMediaActivityTracker. Please use correct play activity tracker if you need to automatically generate transition play activity events ')}}),HLSRollItemsMediaActivityTracker.prototype.playStarted=function(e,t,r,n){return this.playStartedWithPlaybackRate.apply(this,[1].concat(Array.prototype.slice.call(arguments)))},HLSRollItemsMediaActivityTracker.prototype.playStartedWithPlaybackRate=function(e,t,r,n,i){var o=Promise.resolve(),a=this;if(t<1e3*i.start||t>1e3*(i.start+i.duration))return this._error("The giving overallPosition("+t+") is not in the given roll item's timeframe."),o;if(this._hasUnstoppedActivity(this._playActivity))this._error("inconsistent state: did you forget to call playStopped?");else{var s=this._playlistItem(i);s?o=this._playStarted.apply(this,[s,t,r,n].concat(Array.prototype.slice.call(arguments,5))).catch((function(e){a._error(e)})):this._error('Failed to record play start event due to no active playlist item for the roll item info startOverallPos("'+i.start+'"), duration("'+i.duration+'").')}return o},HLSRollItemsMediaActivityTracker.prototype.jumpFromOverallPosition=function(e,t,r){var n=Promise.resolve(),i=Array.prototype.slice.call(arguments,3),o=this;return e<1e3*t.start||e>1e3*(t.start+t.duration)?(this._error("The giving overallPosition("+e+") is not in the given roll item's timeframe."),n):(this._hasUnstoppedActivity(this._playActivity)&&(n=this.playStopped.apply(this,[e,this.TYPE.AUTOMATIC,this.PLAY_STOP_REASON.NEXT].concat(i))),n=n.then((function(){return o.seekStarted.apply(o,[e,o.TYPE.AUTOMATIC,o.SEEK_START_REASON.NEXT,t].concat(i))})).then((function(){return o.seekStopped.apply(o,[1e3*r.start,o.TYPE.AUTOMATIC,o.SEEK_STOP_REASON.NEXT,r].concat(i))})).then((function(){return o.playStarted.apply(o,[1e3*r.start,o.TYPE.AUTOMATIC,o.PLAY_START_REASON.NEXT,r].concat(i))})))},HLSRollItemsMediaActivityTracker.prototype.playStopped=function(e,t,r){var n=this,i=Promise.resolve();if(this._hasUnstoppedActivity(this._playActivity)){if(e<this._playStartPlaylistItem.startOverallPosition||e>this._playStartPlaylistItem.endOverallPosition)return this._error("inconsistent state: the stop-overall-position("+e+") is out of the active rollItem("+this._playStartPlaylistItem.startOverallPosition+","+this._playStartPlaylistItem.endOverallPosition+")."),i;var o=Array.prototype.slice.call(arguments);i=i.then((function(){var e=n._playStopped.apply(n,Array.prototype.slice.call(o));return n._playStartPlaylistItem=null,n._timeTracker=null,e})).catch((function(e){n._error(e)}))}else this._error("inconsistent state: did you forget to call playStarted?");return i},HLSRollItemsMediaActivityTracker.prototype.seekStarted=function(e,t,r,n){var i=Promise.resolve();if(e<1e3*n.start||e>1e3*(n.start+n.duration))return this._error("The giving overallPosition("+e+") is not in the given roll item's timeframe."),i;if(this._hasUnstoppedActivity(this._seekActivity))this._error("inconsistent state: did you forget to call seekStopped?");else{var o=this._playlistItem(n);if(o){var a=this._activityArguments.apply(this,[o,e,t,r].concat(Array.prototype.slice.call(arguments,4)));this._seekActivity=new MediaActivity(this._processor,MediaActivity.ACTIVITY_TYPE.SEEK);var s=this;i=this._seekActivity.started.apply(this._seekActivity,a).catch((function(e){s._error(e)}))}else this._error('Failed to record seek start event due to no active playlist item for the roll item info startOverallPos("'+n.start+'"), duration("'+n.duration+'").')}return i},HLSRollItemsMediaActivityTracker.prototype.seekStopped=function(e,t,r,n){var i=Promise.resolve(),o=this._playlistItem(n);if(o&&this._hasUnstoppedActivity(this._seekActivity)){var a=this._activityArguments.apply(this,[o,e,t,r].concat(Array.prototype.slice.call(arguments,4))),s=this;i=this._seekActivity.stopped.apply(this._seekActivity,a).catch((function(e){s._error(e)}))}else this._error("inconsistent state: did you forget to call seekStarted?");return i},HLSRollItemsMediaActivityTracker.prototype._playlistItem=function(e){var t;return this._playlist&&no.isFunction(this._playlist.getItemForRollItem)&&(t=this._playlist.getItemForRollItem(1e3*e.start,1e3*e.duration)),t||this._error("unable to get item from playlist"),t},HLSRollItemsMediaActivityTracker.prototype._relativePosition=function(e,t){var r;return no.isDefinedNonNull(t)?(t&&no.isNumber(t.startOverallPosition)&&(r=e-t.startOverallPosition+(t.startPosition||0)),r):(this._error("please provide the active playlist item for calculating the relative position."),r)};var os=ma,MediaPlaylistItem=function(e){os.apply(this,arguments),this._startOverallPosition=e,this._startPosition=0};(MediaPlaylistItem.prototype=new os).constructor=MediaPlaylistItem,Object.defineProperties(MediaPlaylistItem.prototype,{startOverallPosition:{get:function(){return this._startOverallPosition}},startPosition:{get:function(){return this._startPosition},set:function(e){this._startPosition=e}},eventData:{get:function(){return this._eventData}}});var HLSRollItem=function(e,t){MediaPlaylistItem.apply(this,arguments),this._duration=t};(HLSRollItem.prototype=new MediaPlaylistItem).constructor=HLSRollItem,Object.defineProperties(HLSRollItem.prototype,{duration:{get:function(){return this._duration}},endOverallPosition:{get:function(){return this.startOverallPosition+this.duration}}}),HLSRollItem.prototype.containsOverallPosition=function(e){return this.startOverallPosition<=e&&this.endOverallPosition>e};var MediaPlaylist=function(){};MediaPlaylist.prototype.RANGE_OPTIONS=Qa,Object.defineProperties(MediaPlaylist.prototype,{eventData:{get:function(){}}}),MediaPlaylist.prototype.getItem=function(e,t){},MediaPlaylist.prototype.getItems=function(e,t){};var HLSVideoPlaylist=function(e){MediaPlaylist.apply(this,arguments),this._startPosition=e,this._mainFeatureMetricsData=no.copyKeysAndValues.apply(null,[!1,!1,!1,null].concat(Array.prototype.slice.call(arguments,1))),this._rollItems=[]};(HLSVideoPlaylist.prototype=new MediaPlaylist).constructor=HLSVideoPlaylist,HLSVideoPlaylist.prototype.setDelegate=function(e){return no.attachDelegate(this,e)},HLSVideoPlaylist.prototype.addRollInfoItems=function(e){e&&e.length&&e.forEach((function(e){this.addRollInfoItem(e)}),this)},HLSVideoPlaylist.prototype.addRollInfoItem=function(e){e&&this.addRollItem(1e3*e.start,1e3*e.duration,e.metricsData)},HLSVideoPlaylist.prototype.addRollItem=function(e,t){var r=new HLSRollItem(e,t);r.updateData.apply(r,Array.prototype.slice.call(arguments,2)),this._addRollItem(r)},HLSVideoPlaylist.prototype.updateMainFeatureMetricsData=function(){no.extend.apply(null,[this._mainFeatureMetricsData].concat(Array.prototype.slice.call(arguments)))},HLSVideoPlaylist.prototype.getItemForRollItem=function(e,t){var r=this._indexOfLastRollItemWithStartBeforePosition(e),n=this._rollItems[r];return no.isDefinedNonNull(n)&&n.duration===t?n:null},HLSVideoPlaylist.prototype.getItem=function(e,t){var r,n=this._indexOfLastRollItemWithStartBeforePosition(e);if(no.isInteger(n)){for(;t!=this.RANGE_OPTIONS.INCLUDES_START_POSITIONS&&this._rollItems[n].startOverallPosition==e&&n>0;)n--;(r=this._rollItems[n]).containsOverallPosition(e)||t==this.RANGE_OPTIONS.INCLUDES_END_POSITIONS&&r.endOverallPosition==e||(r=this._mainFeatureItemWithStartOverallPosition(r.endOverallPosition))}else r=this._mainFeatureItemWithStartOverallPosition(this._startPosition);return r},HLSVideoPlaylist.prototype.getItems=function(e,t){var r=[];if(this._rollItems.length){var n=this._indexOfLastRollItemWithStartBeforePosition(e);for(no.isInteger(n)||(r.push(this._mainFeatureItemWithStartOverallPosition(this._startPosition)),n=0);n<this._rollItems.length;){var i=this._rollItems[n];if(i.startOverallPosition>t)break;if(i.endOverallPosition>=e&&r.push(i),n++,i.endOverallPosition<t)if(n<this._rollItems.length){var o=this._rollItems[n];o.startOverallPosition&&o.startOverallPosition>i.endOverallPosition&&r.push(this._mainFeatureItemWithStartOverallPosition(i.endOverallPosition))}else r.push(this._mainFeatureItemWithStartOverallPosition(i.endOverallPosition))}}else r.push(this._mainFeatureItemWithStartOverallPosition(this._startPosition));return r},HLSVideoPlaylist.prototype._addRollItem=function(e){if(e){var t=this._insertionIndexForItemWithPosition(e.startOverallPosition);this._rollItems.splice(t,0,e)}},HLSVideoPlaylist.prototype._indexOfLastRollItemWithStartBeforePosition=function(e){var t,r=this._rollItems[0];return r&&no.isInteger(e)&&r.startOverallPosition<=e&&(t=this._insertionIndexForItemWithPosition(e)-1),t},HLSVideoPlaylist.prototype._insertionIndexForItemWithPosition=function(e){for(var t=0,r=this._rollItems.length;t<r;){var n=Math.floor((t+r)/2);this._rollItems[n].startOverallPosition>e?r=n:t=n+1}return t},HLSVideoPlaylist.prototype._mainFeatureItemWithStartOverallPosition=function(e){var t=new MediaPlaylistItem(e);return t.startPosition=this._featurePlayheadProgress(e),t.updateData(this._mainFeatureMetricsData),t},HLSVideoPlaylist.prototype._featurePlayheadProgress=function(e){e=e||0;var t,r,n=this._indexOfLastRollItemWithStartBeforePosition(e),i=this._startPosition||0;no.isInteger(n)||(n=-1);for(var o=n;o>=0;o--)t=this._rollItems[o],0===o?i+=t.startOverallPosition:(r=this._rollItems[o-1],i+=t.startOverallPosition-r.endOverallPosition);return i};var MediaActivityTrackerGenerator=function(e){this._processor=e};MediaActivityTrackerGenerator.prototype.createTracker=function(e){var t=new MediaActivityTracker(this._processor,e);return t.updateData.apply(t,Array.prototype.slice.call(arguments,1)),t},MediaActivityTrackerGenerator.prototype.createHLSRollItemsMediaActivityTracker=function(e){var t=new HLSRollItemsMediaActivityTracker(this._processor,e);return t.updateData.apply(t,Array.prototype.slice.call(arguments,1)),t},MediaActivityTrackerGenerator.prototype.createHLSVideoPlaylist=function(e){var t=new HLSVideoPlaylist(e);return t.updateMainFeatureMetricsData.apply(t,Array.prototype.slice.call(arguments,1)),t},MediaActivityTrackerGenerator.prototype.createMediaPlaylist=function(e){return this.createHLSVideoPlaylist.apply(this,arguments)};var as=lo.exceptionString,PlayActivityEventHandler=function(e){this._processor=e};PlayActivityEventHandler.prototype.knownFields=function(){throw as("PlayActivityEventHandler","knownFields")},PlayActivityEventHandler.prototype.eventType=function(e){throw as("PlayActivityEventHandler","eventType")},PlayActivityEventHandler.prototype.processMetricsData=function(){var e=Array.prototype.slice.call(arguments),t=this.eventType(e),r=this._processor.config,n=this._processor._constraints,i=this;return r.metricsDisabledOrBlacklistedEvent(t).then((function(e){if(e)throw"event was disabled"})).then((function(){var t=i._processor.eventHandlers.base;return t.metricsData.apply(t,e)})).then((function(t){var r=[];e=[t].concat(e);var n=po.processMetricsData(i,i.knownFields(),!0,e),o={};return Object.keys(n).forEach((function(e){var t=n[e],i=Promise.resolve(t).then((function(t){o[e]=t}));r.push(i)})),Promise.all(r).then((function(){return o}))})).then((function(e){return n.applyConstraintTreatments(e)})).then((function(e){return r.removeBlacklistedFields(e)})).catch((function(t){return i._processor.system.logger.error("PlayActivity Processor: Unable to generate the event ("+i.eventType(e)+") for the topic "+r.topic()+", due to "+t),null}))};var ss=no.attachDelegate,cs=no.extend,MediaActivity$1=function(e,t,r){PlayActivityEventHandler.call(this,e),this._defaultEventType=t,this._reasonConstants=r,this._defaultActionType};(MediaActivity$1.prototype=Object.create(PlayActivityEventHandler.prototype)).constructor=MediaActivity$1,cs(MediaActivity$1,za),Object.defineProperties(MediaActivity$1.prototype,{TYPE:{get:function(){return Ya.TYPE}},REASON:{get:function(){return this._reasonConstants}}}),MediaActivity$1.prototype.setDelegate=function(e){return ss(this,e)},MediaActivity$1.prototype.knownFields=function(){var e=[Ua,Va,Ga];return e},MediaActivity$1.prototype.eventType=function(e){return this._defaultEventType},MediaActivity$1.prototype.eventVersion=function(e){var t=this._processor.eventHandlers.base.eventVersion(e);return null!==t?t:1},MediaActivity$1.prototype.actionType=function(e){return this._defaultActionType};var StartMediaActivity=function(e,t,r){MediaActivity$1.apply(this,arguments),this._defaultActionType=MediaActivity$1.ACTION_TYPE.START};(StartMediaActivity.prototype=Object.create(MediaActivity$1.prototype)).constructor=StartMediaActivity,StartMediaActivity.prototype.metricsData=function(e,t,r,n){var i={position:e,overallPosition:t,startType:r,startReason:n},o=Array.prototype.slice.call(arguments,4);return this.processMetricsData.apply(this,[i].concat(o))};var StopMediaActivity=function(e,t,r){MediaActivity$1.apply(this,arguments),this._defaultActionType=MediaActivity$1.ACTION_TYPE.STOP};(StopMediaActivity.prototype=Object.create(MediaActivity$1.prototype)).constructor=StopMediaActivity,StopMediaActivity.prototype.metricsData=function(e,t,r,n,i){var o=this.eventType(),a={position:e,overallPosition:t,stopType:r,stopReason:n,startPosition:(i=i||{}).position,startOverallPosition:i.overallPosition,startTime:i.eventTime,startType:i.startType,startReason:i.startReason,startReasonType:i.startReasonType};o===MediaActivity$1.EVENT_TYPE.SEEK_ACTIVITY&&(a.startAssetId=i.assetId);var s=Array.prototype.slice.call(arguments,5);return this.processMetricsData.apply(this,[a].concat(s))};var ls=pa,PlayActivityProcessorBase=function(e){ls.apply(this,arguments)};(PlayActivityProcessorBase.prototype=Object.create(ls.prototype)).constructor=PlayActivityProcessorBase,PlayActivityProcessorBase.prototype.environment=function(){return this._processor.system.environment},PlayActivityProcessorBase.prototype.eventRecorder=function(){return this._processor.system.eventRecorder},PlayActivityProcessorBase.prototype.knownFields=function(){var e=ls.prototype.knownFields().concat([Ua,Fa,Ka,Ba,Ha,qa,Wa]);return e},PlayActivityProcessorBase.prototype.consumerId=function(e){var t=Fa;return e&&t in e?e[t]:this.environment().consumerId()},PlayActivityProcessorBase.prototype.consumerNs=function(e){var t=Ka;return e&&t in e?e[t]:this.environment().consumerNs()},PlayActivityProcessorBase.prototype.isOffline=function(e){var t=Ha;return e&&t in e?e[t]:this.environment().isOffline()},PlayActivityProcessorBase.prototype.videoViewportHeight=function(e){var t=qa;return e&&t in e?e[t]:this.environment().videoViewportHeight()},PlayActivityProcessorBase.prototype.videoViewportWidth=function(e){var t=Wa;return e&&t in e?e[t]:this.environment().videoViewportWidth()},PlayActivityProcessorBase.prototype.metricsData=function(){var e=Array.prototype.slice.call(arguments),t=po.processMetricsData(this,this.knownFields(),!0,e);return t};var EventHandlers=function(e){this.base=new PlayActivityProcessorBase(e),this.playStart=new StartMediaActivity(e,MediaActivity$1.EVENT_TYPE.PLAY_ACTIVITY,Ya.PLAY_START_REASON),this.playStop=new StopMediaActivity(e,MediaActivity$1.EVENT_TYPE.PLAY_ACTIVITY,Ya.PLAY_STOP_REASON),this.seekStart=new StartMediaActivity(e,MediaActivity$1.EVENT_TYPE.SEEK_ACTIVITY,Ya.SEEK_START_REASON),this.seekStop=new StopMediaActivity(e,MediaActivity$1.EVENT_TYPE.SEEK_ACTIVITY,Ya.SEEK_STOP_REASON)},PlayActivityProcessor=function(e){if(!no.isDefinedNonNull(e))throw new Error("No delegate is provided to PlayActivityProcessor");this._initCalled=!1,this._delegatePackage=e,this.system=new System,this.config=this._delegatePackage.config,this.eventHandlers=new EventHandlers(this),this.utils=new Utils(this),this.mediaActivityTracker=new MediaActivityTrackerGenerator(this)};PlayActivityProcessor.prototype.init=function(){var e,t=Promise.resolve();return this._initCalled||(this._initCalled=!0,this._delegatePackage&&(no.setDelegates(this.eventHandlers,this._delegatePackage),no.setDelegates(this.system,this._delegatePackage)),e=this.config,no.isFunction(e.constraintProfile)&&no.isFunction(e.constraintProfiles)||no.attachMethods(e,na,e),t=this._delegatePackage.init(),this._constraints=new aa(this.config,{environment:this.system.environment})),t},PlayActivityProcessor.prototype.cleanup=function(){this._delegatePackage&&no.isFunction(this._delegatePackage.cleanup)&&this._delegatePackage.cleanup(),this.config.cleanup(),no.resetDelegates(this.eventHandlers),no.resetDelegates(this.system),no.resetDelegates(this.utils),this.config=null,this.system=null,this.eventHandlers=null,this.utils=null,this._delegatePackage=null,this._constraints=null,this._initCalled=!1};const ds={"ac-3":"AC3","mp4a.a5":"AC3",alac:"Apple Lossless","ec-3":"EC3","mp4a.a6":"EC3",flac:"Free Lossless","mp4a.40.2":"AAC","mp4a.40.5":"AAC","mp4a.40.29":"AAC","mp4a.40.34":"MP3","mp4a.40.42":"AAC"},us=/^[0-9]+\/JOC$/,isAtmos=(e,t)=>"EC3"===ds[e]&&(e=>us.test(e))(t),ps=["dvh1.05.01","dvhe.05.06"],hs={PQ:"HDR",HLG:"HDR",SDH:"SDH"},convertToVideoColorRange=(e,t)=>(e=>-1!==ps.indexOf(e))(e)?"DolbyVision":(e=>{var t;return null!==(t=hs[e])&&void 0!==t?t:e})(t);function _define_property$6(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var ys,fs,_s;!function(e){e.MANUAL="MANUAL",e.AUTOMATIC="AUTOMATIC",e.UNKNOWN="UNKNOWN"}(ys||(ys={})),function(e){e.buffering="buffering",e.idle="idle",e.paused="paused",e.playing="playing"}(fs||(fs={})),function(e){e.bufferStart="BUFFER_START",e.bufferStop="BUFFER_STOP",e.exit="EXIT",e.play="PLAY",e.pause="PAUSE",e.stop="STOP",e.next="NEXT",e.newItem="NEW"}(_s||(_s={}));const vs={initial:"idle",states:{idle:{on:{PLAY:{target:"playing",context:{reason:"PLAY",manual:"MANUAL",fromInitialPlay:!0}}}},playing:{on:{BUFFER_START:{target:"buffering",context:{reason:"BUFFERING",manual:"AUTOMATIC",fromInitialPlay:"~~previous~~"}},EXIT:{target:"idle",context:{reason:"EXIT"}},PAUSE:{target:"paused",context:{reason:"PAUSE"}},STOP:{target:"idle",context:{}},NEXT:{target:"idle",context:{reason:"NEXT"}},NEW:{target:"idle",context:{}}}},paused:{on:{PLAY:{target:"playing",context:{reason:"UNPAUSE"}},NEW:{target:"idle",context:{}},EXIT:{target:"idle",context:{reason:"EXIT"}}}},buffering:{on:{BUFFER_STOP:{target:"playing",context:{reason:"BUFFERING",manual:"AUTOMATIC"}},EXIT:{target:"idle",context:{reason:"EXIT"}}}}}},ms={manual:"UNKNOWN",reason:"UNKNOWN",fromInitialPlay:!1};class VPAFStateMachine{isAllowedTransition(e){return void 0!==this.getNextState(e)}transition(e,t={}){const r=this.getNextState(e);if(!r)return;Mn.debug(`[mk/activity/vpaf] Transitioning from ${this.currentState} to ${r.target} because ${e}`);const n={};return hasOwn(t,"manual")&&(void 0!==t.manual?n.manual=t.manual?"MANUAL":"AUTOMATIC":n.manual="UNKNOWN"),void 0!==t.reason&&(n.reason=t.reason),this.currentContext=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$6(e,t,r[t])}))}return e}({},ms,r.context,n,this.preservePreviousContext(r.context)),this.currentState=r.target,this.currentContext}reset(){this.currentState=vs.initial,this.currentContext=ms}getNextState(e){return vs.states[this.currentState].on[e]}preservePreviousContext(e){const t={};return["manual","reason","reasonType","fromInitialPlay"].forEach(r=>{"~~previous~~"===e[r]&&(t[r]=this.currentContext[r])}),t}constructor(){_define_property$6(this,"currentState",vs.initial),_define_property$6(this,"currentContext",ms)}}const gs=new Map([[et.playbackPlay,"play"],[et.playbackPause,"pause"],[et.playbackScrub,"scrub"],[et.playbackSeek,"seek"],[et.playbackSkip,"skip"],[et.playbackStop,"stop"],[et.playerExit,"exit"]]),bs={[ot.EXITED_APPLICATION]:"EXIT",[ot.FAILED_TO_LOAD]:"FAILURE",[ot.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM]:"PLAY_OTHER",[ot.NATURAL_END_OF_TRACK]:"COMPLETE",[ot.PLAYBACK_PAUSED_DUE_TO_INACTIVITY]:"INACTIVITY",[ot.SCRUB_BEGIN]:"SEEK",[ot.TRACK_SKIPPED_BACKWARDS]:"SEEK",[ot.TRACK_SKIPPED_FORWARDS]:"SEEK",[ot.PLAYBACK_SUSPENDED]:"CLOSE_PLAYER",[si.NEXT_ITEM]:"NEXT"};var Ss;!function(e){e.SEEK_STARTED="seekStarted",e.SEEK_STOPPED="seekStopped",e.PLAY_STARTED="playStarted",e.PLAY_STOPPED="playStopped"}(Ss||(Ss={}));const Ps="xp_amp_tv_vpaf",Es={[et.playbackPause]:_s.pause,[et.playbackPlay]:_s.play,[et.playbackStop]:_s.stop,[et.playerExit]:_s.exit},Ts={[e.PresentationMode.pictureinpicture]:"pictureInPicture",[e.PresentationMode.inline]:"foreground",_default:"foreground"};function asMilliseconds(e){return Math.round(1e3*e)}function determineDelegatedPlayback(e){return{delegatedPlayback:e.playbackTargetIsWireless?"Airplay":"None"}}function isSeekingInterval(t){return t.seekReasonType===e.SeekReasonType.Interval}function assertIsDefined(e,t){if(null==e)throw new Error(t)}function assertTracker(e,t){assertIsDefined(e,(null!=t?t:"PAF")+" Tracker: Attempted to track event without first calling createTracker()")}function assertProcessor(e,t){assertIsDefined(e,(null!=t?t:"PAF")+" Tracker: Attempted to create tracker without first calling configure()")}function _define_property$5(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function calculateOverallLength(e,t){const r=e.defaultPlayable;if("EbsEvent"===r.type)return;var n;let i=parseFloat(null!==(n=e.hlsMetadata["feature.duration"])&&void 0!==n?n:r.duration);for(const o of t)i+=o.duration;return asMilliseconds(i)}function getMainFeatureData(e){var t;const r={url:e.attributes.url,assetId:null==e||null===(t=e.hlsMetadata)||void 0===t?void 0:t["feature.adam-id"]};return e.isLinearStream||(r.assetPlacement="feature"),!0===e.attributes.isAdultContent&&(r.sensitiveContentType="adult"),r}function currentAudioData(e){const{currentAudioTrack:t,nowPlayingItem:r}=e;let n,i;var o,a,s;"description"===(null==t?void 0:t.kind)?(i=null==t?void 0:t.language,n=void 0):(i=void 0,n=null!==(s=null==t?void 0:t.language)&&void 0!==s?s:null==r||null===(a=r.defaultPlayable)||void 0===a||null===(o=a.primaryLocale)||void 0===o?void 0:o.locale);let c;if((null==r?void 0:r.isLinearStream)&&t){const e=null===(l=t.characteristics)||void 0===l?void 0:l.find(e=>e.startsWith("com.apple.amp.appletv.identifier"));isHomeRadioTrack(t)?c=or.Home:isAwayRadioTrack(t)?c=or.Away:e&&(c=e)}var l;return{audioLocale:n,audioDescriptionLocale:i,audioVariantId:c}}function additionalTrackingData(e,t){return function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$5(e,t,r[t])}))}return e}({},{downloadState:"streaming",playbackFocus:"foreground",topic:Ps},function(e){return{programmingType:e.isLinearStream?"live":"videoOnDemand"}}(t),function(e){return e.defaultPlayable.vpafMetrics}(t),function(e){var t;const r=null===(t=e.videoContainerElement)||void 0===t?void 0:t.querySelector("video");return{videoViewportHeight:null==r?void 0:r.clientHeight,videoViewportWidth:null==r?void 0:r.clientWidth}}(e),currentAudioData(e),function(e){var t;const{language:r,kind:n}=null!==(t=e.currentTextTrack)&&void 0!==t?t:{};return"captions"===n?{subtitleLocale:void 0,closedCaptionLocale:r}:"subtitles"===n?{subtitleLocale:r,closedCaptionLocale:void 0}:{subtitleLocale:void 0,closedCaptionLocale:void 0}}(e),determineDelegatedPlayback(e))}function ensurePositionData(e,t){if(null==t?void 0:t.isLinearStream){if(void 0===e.playingDate)throw new Error('VPAFTracker: The property `playingDate` is required on data for "linear" content');return e}if(void 0===e.position)throw new Error('VPAFTracker: The property `position` is required on data "vod" content');return e}function calculatePlaybackPosition(e,t){if(null==e?void 0:e.isLinearStream){if(void 0===t.playingDate)throw new Error("VPAF: Can't report playback position for linear stream without playingDate value");return t.playingDate.getTime()}var r;return asMilliseconds(null!==(r=t.position)&&void 0!==r?r:0)}function isSkippingIntro(t){return t.seekReasonType===e.SeekReasonType.SkipIntro}function getMappedStopReason(e){if(void 0!==e.endReasonType)return bs[e.endReasonType]}function getExplicitStateContext(e){return{manual:e.userInitiated,reason:getMappedStopReason(e)}}function formatKeyPlayRollItem(e){return{start:e.startTime,duration:e.endTime-e.startTime,metricsData:{assetId:e.id,assetPlacement:"catchUpToLive",isSkippable:!0}}}function formatKeyPlayRollItemInSeconds(e){const t=formatKeyPlayRollItem(e);return t.start=t.start/1e3,t.duration=t.duration/1e3,t}function asyncGeneratorStep$2(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator$2(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$2(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$2(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$4(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$3(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$4(e,t,r[t])}))}return e}function _object_spread_props$1(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function _ts_decorate(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a}function _ts_metadata(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}const ks=Mn.createChild("vpaf");class VPAFTracker{get requestedEvents(){return Array.from(gs.keys())}get isConfigured(){return void 0!==this.instance}get currentItem(){return this._currentItem}set currentItem(e){this._currentItem=e,this.currentSkipItems=e?parseSkipItems(e):void 0}configure(e){var t=this;return _async_to_generator$2((function*(){var r;if(t.instance=e.instance,t.dispatcher=e.services.dispatcher,!Yn.storekit.cid)try{yield Yn.storekit.infoRefresh()}catch(a){}const n=null===(r=e.services.apiManager)||void 0===r?void 0:r.utsClient,i=Array.isArray(navigator.languages)?navigator.languages:"string"==typeof navigator.language?[navigator.language]:[],o=new WebDelegates(Ps,{config:{configHostname:()=>"daf.xp.apple.com"},environment:{app:()=>"com.apple.tv",appVersion:()=>"1.0",consumerId:()=>Yn.storekit.cid,consumerNs:()=>"TV",isOffline:()=>!1,delegateApp:()=>"web-tv-player",osLanguages:()=>i,resourceRevNum:()=>qn.app.build,storeFrontCountryCode(){var e,t,r;return null!==(r=null==n||null===(t=n.configuration)||void 0===t||null===(e=t.userProps)||void 0===e?void 0:e.country)&&void 0!==r?r:""}}});o.eventRecorder.setProperties(Ps,{anonymous:!Yn.isAuthorized}),t.playActivityProcessor=new PlayActivityProcessor(o),yield t.playActivityProcessor.init(),t.setupListeners()}))()}cleanup(){var e=this;return _async_to_generator$2((function*(){e.tracker=void 0,e.isScrubbing=!1,e.scrubStopPosition=void 0,e.teardownListeners(),e.stopSynchronizing()}))()}shouldTrackPlayActivity(e,t){if(!t)return!1;const r=t.defaultPlayable;if(!r||!r.vpafMetrics)return!1;const n=Es[e];return void 0===n||this.state.isAllowedTransition(n)}handleEvent(e,t,r){if(!this.shouldTrackPlayActivity(e,r))return;const n=gs.get(e);void 0!==n&&"function"==typeof this[n]&&this[n](r,t)}bufferStart(e,t){var r=this;return _async_to_generator$2((function*(){var n;if(ks.debug("VPAFTracker: handling bufferStart()"),!(yield r.canTrackItem(e)))return void ks.debug("VPAFTracker: aborting bufferStart, no tracker");if(r.state.currentState!==fs.playing)return void ks.debug("VPAFTracker: aborting bufferStart, not playing");if("seek"===(null===(n=r.lastTrackedEvent)||void 0===n?void 0:n.reason))return void ks.debug("VPAFTracker: aborting bufferStart, after a seek");const i=r.state.currentContext.fromInitialPlay,o=calculatePlaybackPosition(e,ensurePositionData(t,e));r.state.transition(_s.bufferStart),i?ks.debug("VPAFTracker: bufferStart() not tracking PLAY_STOPPED, it is from initial play"):yield r.trackEvent(Ss.PLAY_STOPPED,o)}))()}bufferEnd(e,t){var r=this;return _async_to_generator$2((function*(){var n;if(ks.debug("VPAFTracker: handling bufferEnd()"),!(yield r.canTrackItem(e)))return;if(r.state.currentState!==fs.buffering)return void ks.debug("VPAFTracker: aborting bufferEnd, not buffering");if("seek"===(null===(n=r.lastTrackedEvent)||void 0===n?void 0:n.reason))return void ks.debug("VPAFTracker: aborting bufferEnd, after a seek");const i=r.state.currentContext.fromInitialPlay,o=calculatePlaybackPosition(e,ensurePositionData(t,e));r.state.transition(_s.bufferStop),i?ks.debug("VPAFTracker: bufferEnd() not tracking PLAY_STARTED, it is from initial play"):yield r.trackEvent(Ss.PLAY_STARTED,o)}))()}exit(e,t={}){var r=this;return _async_to_generator$2((function*(){(yield r.canTrackItem(r.currentItem))&&(ks.debug("VPAFTracker.exit()"),r.state.transition(_s.exit),yield r.trackEvent(Ss.PLAY_STOPPED,calculatePlaybackPosition(void 0,ensurePositionData(t,t.item))),r.stopSynchronizing(),r.currentItem=void 0)}))()}pause(e,t={}){var r=this;return _async_to_generator$2((function*(){if(!(yield r.canTrackItem(e)))return;ks.debug("VPAFTracker.pause()");const n=calculatePlaybackPosition(e,ensurePositionData(t,e)),i=t.endReasonType===si.NEXT_ITEM?_s.next:_s.pause;r.state.transition(i,getExplicitStateContext(t)),yield r.trackEvent(Ss.PLAY_STOPPED,n)}))()}play(e,t={}){var r=this;return _async_to_generator$2((function*(){if(!(yield r.canTrackItem(e)))return;ks.debug("VPAFTracker.play()");const n=calculatePlaybackPosition(e,_object_spread$3({position:0},t));r.state.transition(_s.play,getExplicitStateContext(t)),yield r.trackEvent(Ss.PLAY_STARTED,n)}))()}scrub(e,t={}){var r=this;return _async_to_generator$2((function*(){if(void 0===e||void 0===t.position)return;const n=calculatePlaybackPosition(e,ensurePositionData(t,e));r.isScrubbing&&void 0===t.endReasonType?r.scrubStopPosition=n:r.isScrubbing&&r.scrubEnd(e,n)}))()}seek(t,r={}){var n=this;return _async_to_generator$2((function*(){if(void 0!==t&&(!t.isLinearStream||void 0!==r.playingDate&&void 0!==r.startPlayingDate)&&(t.isLinearStream||void 0!==r.position&&void 0!==r.startPosition))return function(t){return t.seekReasonType===e.SeekReasonType.SkipToLiveManual||t.seekReasonType===e.SeekReasonType.SkipToLiveAutomatic}(r)?n.trackJumpToLive(t,r):t.currentKeyPlay?n.currentKeyPlay?n.trackJumpToKeyPlay(t,r):n.trackEnterKeyPlay(t):n.currentKeyPlay?n.trackExitKeyPlay(t,r):void(isSkippingIntro(r)||isSeekingInterval(r)?yield n.trackSeek(t,r):yield n.trackScrub(t,r))}))()}skip(e,t={}){return _async_to_generator$2((function*(){}))()}stop(e,t={}){var r=this;return _async_to_generator$2((function*(){if(!(yield r.canTrackItem(e)))return;ks.debug("VPAFTracker.stop()");const n=calculatePlaybackPosition(e,ensurePositionData(t,e));r.state.transition(_s.stop,getExplicitStateContext(t)),yield r.trackEvent(Ss.PLAY_STOPPED,n),r.stopSynchronizing(),r.currentItem=void 0}))()}lyricsPlay(e,t){return _async_to_generator$2((function*(){}))()}lyricsStop(){return _async_to_generator$2((function*(){}))()}trackSeek(e,t){var r=this;return _async_to_generator$2((function*(){const n={},i=r.getSkipActionName(t.position);isSkippingIntro(t)&&"string"==typeof i&&(n.actionName=i);const o=_object_spread_props$1(_object_spread$3({},t),{position:t.startPosition,playingDate:t.startPlayingDate});yield r.trackSeekStart(e,o,n),yield r.trackSeekStop(e,t,n)}))()}trackEnterKeyPlay(e){var t=this;return _async_to_generator$2((function*(){if(ks.debug("VPAFTracker.trackEnterKeyPlay"),!(yield t.canTrackItem(e)))return;yield t.createRollItemsTracker(e),t.assertRollItemsTracker(t.rollItemsTracker),t.currentKeyPlay=formatKeyPlayRollItemInSeconds(e.currentKeyPlay);const r=1e3*t.currentKeyPlay.start;yield t.rollItemsTracker.playStarted(r,t.rollItemsTracker.TYPE.MANUAL,t.rollItemsTracker.PLAY_START_REASON.PLAY,_object_spread$3({},t.currentKeyPlay))}))()}trackExitKeyPlay(e,t){var r=this;return _async_to_generator$2((function*(){ks.debug("VPAFTracker.trackExitKeyPlay"),r.assertRollItemsTracker(r.rollItemsTracker),assertTracker(r.tracker,"VPAF");const n=calculatePlaybackPosition(e,ensurePositionData(t,e));yield r.rollItemsTracker.playStopped(n,r.rollItemsTracker.TYPE.MANUAL,r.rollItemsTracker.PLAY_STOP_REASON.PLAY_OTHER,r.currentKeyPlay),yield r.tracker.playStarted(n,r.rollItemsTracker.TYPE.MANUAL,r.rollItemsTracker.PLAY_STOP_REASON.PLAY_OTHER),r.currentKeyPlay=void 0}))()}trackJumpToLive(t,r){var n=this;return _async_to_generator$2((function*(){ks.debug("VPAFTracker.trackJumpToLive"),n.assertRollItemsTracker(n.rollItemsTracker);const i=calculatePlaybackPosition(t,ensurePositionData(r,t)),o=r.startPlayingDate.getTime(),a=r.seekReasonType===e.SeekReasonType.SkipToLiveManual?n.rollItemsTracker.TYPE.MANUAL:n.rollItemsTracker.TYPE.AUTOMATIC;yield n.rollItemsTracker.playStopped(o,a,n.rollItemsTracker.PLAY_STOP_REASON.SEEK,_object_spread_props$1(_object_spread$3({},n.currentKeyPlay),{stopReasonType:n.rollItemsTracker.PLAY_STOP_REASON_TYPE.SKIP_TO_LIVE})),n.currentKeyPlay=void 0,yield n.trackEvent(Ss.SEEK_STARTED,o,a,n.rollItemsTracker.PLAY_START_REASON.SKIP_TO_LIVE),yield n.trackEvent(Ss.SEEK_STOPPED,i,a,n.rollItemsTracker.PLAY_START_REASON.SKIP_TO_LIVE),yield n.trackEvent(Ss.PLAY_STARTED,i,a,n.rollItemsTracker.PLAY_START_REASON.SEEK,{startReasonType:n.rollItemsTracker.PLAY_START_REASON_TYPE.SKIP_TO_LIVE})}))()}trackJumpToKeyPlay(t,r){var n=this;return _async_to_generator$2((function*(){ks.debug("VPAFTracker.trackJumpToKeyPlay"),n.assertRollItemsTracker(n.rollItemsTracker);const i=r.seekReasonType===e.SeekReasonType.Automatic?n.rollItemsTracker.TYPE.AUTOMATIC:n.rollItemsTracker.TYPE.MANUAL,o=1e3*(n.currentKeyPlay.start+n.currentKeyPlay.duration),a=Math.min(r.startPlayingDate.getTime(),o),s=formatKeyPlayRollItemInSeconds(t.currentKeyPlay),c=1e3*s.start,l=n.rollItemsTracker.PLAY_STOP_REASON.NEXT;yield n.rollItemsTracker.playStopped(a,i,l,n.currentKeyPlay),yield n.rollItemsTracker.playStarted(c,i,l,s),n.currentKeyPlay=s}))()}trackSeekStart(t,r,n={}){var i=this;return _async_to_generator$2((function*(){assertTracker(i.tracker,"VPAF");const o=r.seekReasonType===e.SeekReasonType.SkipIntro?i.tracker.SEEK_START_REASON.SKIP_INTRO:i.tracker.SEEK_START_REASON.INTERVAL,a=calculatePlaybackPosition(t,ensurePositionData(r,t)),s=i.tracker.TYPE.MANUAL;if(i.state.currentState===fs.playing){const e=isSkippingIntro(r)?_object_spread_props$1(_object_spread$3({},n),{stopReasonType:i.tracker.PLAY_STOP_REASON_TYPE.SKIP_INTRO}):n;yield i.trackEvent(Ss.PLAY_STOPPED,a,s,i.tracker.PLAY_STOP_REASON.SEEK,e)}yield i.trackEvent(Ss.SEEK_STARTED,a,s,o,n)}))()}trackSeekStop(e,t,r={}){var n=this;return _async_to_generator$2((function*(){assertTracker(n.tracker,"VPAF");const i=isSeekingInterval(t)?n.tracker.SEEK_STOP_REASON.INTERVAL:n.tracker.SEEK_STOP_REASON.SKIP_INTRO,o=calculatePlaybackPosition(e,ensurePositionData(t,e)),a=n.tracker.TYPE.AUTOMATIC;if(yield n.trackEvent(Ss.SEEK_STOPPED,o,a,i,r),n.state.currentState===fs.playing){const e=isSkippingIntro(t)?_object_spread_props$1(_object_spread$3({},r),{startReasonType:n.tracker.PLAY_START_REASON_TYPE.SKIP_INTRO}):r;yield n.trackEvent(Ss.PLAY_STARTED,o,a,n.tracker.PLAY_START_REASON.SEEK,e)}}))()}trackScrub(e,t){var r=this;return _async_to_generator$2((function*(){const n=e.isLinearStream?t.playingDate.getTime():asMilliseconds(t.position),i=e.isLinearStream?t.startPlayingDate.getTime():asMilliseconds(t.startPosition);yield r.scrubStart(e,i),yield r.scrubEnd(e,n)}))()}scrubStart(e,t){var r=this;return _async_to_generator$2((function*(){(yield r.canTrackItem(e))&&(assertTracker(r.tracker,"VPAF"),r.isScrubbing=!0,r.scrubStopPosition=t,r.state.currentState===fs.playing&&(yield r.trackEvent(Ss.PLAY_STOPPED,r.scrubStopPosition,r.tracker.TYPE.AUTOMATIC,r.tracker.PLAY_STOP_REASON.SEEK)),yield r.trackEvent(Ss.SEEK_STARTED,t,r.tracker.TYPE.MANUAL,r.tracker.SEEK_START_REASON.SCRUB))}))()}scrubEnd(e,t){var r=this;return _async_to_generator$2((function*(){assertTracker(r.tracker,"VPAF"),yield r.trackEvent(Ss.SEEK_STOPPED,t,r.tracker.TYPE.MANUAL,r.tracker.SEEK_STOP_REASON.SCRUB),r.state.currentState===fs.playing&&(yield r.trackEvent(Ss.PLAY_STARTED,t,r.tracker.TYPE.AUTOMATIC,r.tracker.PLAY_START_REASON.SEEK)),r.isScrubbing=!1,r.scrubStopPosition=void 0}))()}trackEvent(e,t,r,n,i){var o=this;return _async_to_generator$2((function*(){assertTracker(o.tracker,"VPAF"),void 0===r&&(r=o.tracker.TYPE[o.state.currentContext.manual]),void 0===n&&(n=e===Ss.PLAY_STARTED?o.tracker.PLAY_START_REASON[o.state.currentContext.reason]:o.tracker.PLAY_STOP_REASON[o.state.currentContext.reason]),ks.debug(`VPAFTracker.trackEvent(${e}, ${t}, ${r}, ${n})`,i),yield o.tracker[e].call(o.tracker,Math.round(t),r,n,i),o.lastTrackedEvent={eventType:e,position:t,type:r,reason:n,namedArgs:i}}))()}createTracker(e){var t=this;return _async_to_generator$2((function*(){assertProcessor(t.playActivityProcessor,"VPAF");const{mediaActivityTracker:r}=t.playActivityProcessor,n=getMainFeatureData(e),i=parseRollItems(e).map(e=>{const t={start:e.start,duration:e.duration,metricsData:{assetPlacement:e.type.replace("-",""),assetId:e["adam-id"],isSkippable:e.skippable}};return void 0!==e["dynamic-id"]&&(t.metricsData["data.dynamicSlot.dataSetId"]=e["dynamic-id"]),t});ks.debug("VPAF: Creating HLS Playlist",n);const o=r.createHLSVideoPlaylist(0,n);return ks.debug("VPAF: adding roll items",i),o.addRollInfoItems(i),ks.debug("VPAFTracker.createTracker: creating new tracker for "+(null==e?void 0:e.id)),t.tracker=r.createTracker(o,...yield t.getMappedPlaybackFields(e),additionalTrackingData(t.instance,e),{overallLength:calculateOverallLength(e,i),featureAssetId:n.assetId}),t.startSynchronizing(),t.tracker}))()}createRollItemsTracker(e){var t=this;return _async_to_generator$2((function*(){var r,n;assertProcessor(t.playActivityProcessor,"VPAF");const i=getMainFeatureData(e),o=t.playActivityProcessor.mediaActivityTracker.createHLSVideoPlaylist(0,i);return e.keyPlayShelf.forEach(e=>{const t=formatKeyPlayRollItem(e);o.addRollItem(t.start,t.duration,t.metricsData);o.getItemForRollItem(t.start,t.duration).startPosition=t.start}),t.rollItemsTracker=null===(n=t.playActivityProcessor)||void 0===n?void 0:n.mediaActivityTracker.createHLSRollItemsMediaActivityTracker(o,...yield t.getMappedPlaybackFields(e),additionalTrackingData(t.instance,e),{extraType:"CatchUpToLive",featureAssetId:i.assetId,featureCanonicalId:null===(r=e.defaultPlayable)||void 0===r?void 0:r.canonicalId}),t.rollItemsTracker}))()}onPlaybackStateChange(t,r){var n=this;return _async_to_generator$2((function*(){const{state:t}=r,i=n.currentItem;var o;const a={position:n.instance.currentPlaybackTime,playingDate:n.instance.currentPlayingDate,userInitiated:null!==(o=r.userInitiated)&&void 0!==o&&o},s="PlaybackStates."+e.PlaybackStates[r.oldState],c="PlaybackStates."+e.PlaybackStates[r.state];ks.debug(`onPlaybackStateChange: ${s} -> ${c}`,a),t===e.PlaybackStates.waiting?(n.isBuffering=!0,ks.debug("VPAFTracker.onPlaybackStateChange: triggering bufferStart()",a),yield n.bufferStart(i,a)):t===e.PlaybackStates.playing?n.isBuffering&&(n.isBuffering=!1,ks.debug("VPAFTracker.onPlaybackStateChange: triggering bufferEnd()",a),yield n.bufferEnd(i,a)):t!==e.PlaybackStates.stalled&&(ks.debug("VPAFTracker.onPlaybackStateChange: resetting isBuffering=false"),n.isBuffering=!1)}))()}handleLevelUpdated(e,t){var r,n;const{level:i,channels:o}=t;if(!i)return;const{audioCodec:a,videoRange:s,videoCodec:c}=i;if(!(a&&o||s&&c))return;const l={};a&&o&&(l.audioFormat=((e,t)=>{var r;const n=null!==(r=null==e?void 0:e.toLowerCase())&&void 0!==r?r:"";var i;return isAtmos(n,t)?"Atmos":null!==(i=ds[n])&&void 0!==i?i:e})(a,o)),s&&c&&(l.videoColorRange=convertToVideoColorRange(c,s)),null===(r=this.tracker)||void 0===r||r.updateData(l),null===(n=this.rollItemsTracker)||void 0===n||n.updateData(l)}handleAudioTrackChange(){if(void 0===this.tracker||void 0===this.instance)return;const e=currentAudioData(this.instance);var t;e&&(ks.debug("Updating AudioData",e),this.tracker.updateData(e),null===(t=this.rollItemsTracker)||void 0===t||t.updateData(e))}handleForcedTextTrackChange(e,t){var r,n;const i={forcedSubtitleLocale:null==t?void 0:t.language};null===(r=this.tracker)||void 0===r||r.updateData(i),null===(n=this.rollItemsTracker)||void 0===n||n.updateData(i)}handlePresentationModeChange(e,{mode:t}){var r,n,i;const o={playbackFocus:null!==(i=Ts[t])&&void 0!==i?i:Ts._default};null===(r=this.tracker)||void 0===r||r.updateData(o),null===(n=this.rollItemsTracker)||void 0===n||n.updateData(o)}handleTargetWirelessChange(){if(void 0!==this.instance){var e,t;const r=determineDelegatedPlayback(this.instance);null===(e=this.tracker)||void 0===e||e.updateData(r),null===(t=this.rollItemsTracker)||void 0===t||t.updateData(r)}}handleTextTrackChange(){var e,t;const{tracker:r}=this;if(void 0===r)return;const n=null===(e=this.instance)||void 0===e?void 0:e.currentTextTrack;if(!n||"captions"!==n.kind&&"subtitles"!==(null==n?void 0:n.kind))return;const i=""===n.language?void 0:n.language,o={closedCaptionLocale:"captions"===n.kind?i:void 0,subtitleLocale:"subtitles"===n.kind?i:void 0};r.updateData(o),null===(t=this.rollItemsTracker)||void 0===t||t.updateData(o)}handleNowPlayingItemDidChange(e,t){const{item:r}=t;r||(ks.debug("handleNowPlayingItemDidChange: calling exit and clearing currentItem"),this.state.transition(_s.exit),this.stopSynchronizing(),this.currentItem=void 0)}canTrackItem(e){var t=this;return _async_to_generator$2((function*(){var r;return void 0!==e&&void 0!==e.defaultPlayable&&((null===(r=t.currentItem)||void 0===r?void 0:r.id)!==e.id&&(t.state.transition(_s.newItem),t.currentItem=e,yield t.createTracker(e)),void 0!==t.tracker)}))()}getSkipActionName(e){var t;const r=(null!==(t=this.currentSkipItems)&&void 0!==t?t:[]).find(t=>t.target===e);return null==r?void 0:r.label}setupListeners(){void 0!==this.dispatcher&&(this.dispatcher.subscribe(Dn.audioTrackChanged,this.handleAudioTrackChange),this.dispatcher.subscribe(Dn.textTrackChanged,this.handleTextTrackChange),this.dispatcher.subscribe(Dn.forcedTextTrackChanged,this.handleForcedTextTrackChange),this.dispatcher.subscribe(Dn.nowPlayingItemDidChange,this.handleNowPlayingItemDidChange),this.dispatcher.subscribe(Dn.playbackStateDidChange,this.onPlaybackStateChange),this.dispatcher.subscribe(et.hlsLevelUpdated,this.handleLevelUpdated),this.dispatcher.subscribe(Dn.playbackTargetIsWirelessDidChange,this.handleTargetWirelessChange),this.dispatcher.subscribe(Dn.presentationModeDidChange,this.handlePresentationModeChange))}teardownListeners(){void 0!==this.dispatcher&&(this.dispatcher.unsubscribe(Dn.audioTrackChanged,this.handleAudioTrackChange),this.dispatcher.unsubscribe(Dn.textTrackChanged,this.handleTextTrackChange),this.dispatcher.unsubscribe(Dn.forcedTextTrackChanged,this.handleForcedTextTrackChange),this.dispatcher.unsubscribe(Dn.nowPlayingItemDidChange,this.handleNowPlayingItemDidChange),this.dispatcher.unsubscribe(Dn.playbackStateDidChange,this.onPlaybackStateChange),this.dispatcher.unsubscribe(et.hlsLevelUpdated,this.handleLevelUpdated),this.dispatcher.unsubscribe(Dn.playbackTargetIsWirelessDidChange,this.handleTargetWirelessChange),this.dispatcher.unsubscribe(Dn.presentationModeDidChange,this.handlePresentationModeChange))}startSynchronizing(){void 0===this.synchronizeTimeout&&(this.synchronizeTimeout=setInterval(this.synchronize,6e4))}stopSynchronizing(){void 0!==this.synchronizeTimeout&&(clearInterval(this.synchronizeTimeout),this.synchronizeTimeout=void 0)}synchronize(){if(void 0===this.tracker||void 0===this.instance||void 0===this.currentItem)return void this.stopSynchronizing();const e=this.state.currentState===fs.paused,{playbackRate:t,currentPlaybackTime:r}=this.instance,n=e?0:t,i=Math.round(1e3*r);ks.debug(`VPAF: synchronize rate: ${n} and current time: ${i}`),this.tracker.synchronize(n,i)}assertRollItemsTracker(e){assertIsDefined(e,"VPAFTracker: Attempted to track roll item event before `trackerEnterKeyPlay` was called")}getMappedPlaybackFields(e){var t=this;return _async_to_generator$2((function*(){assertProcessor(t.playActivityProcessor,"VPAF");const{utils:r}=t.playActivityProcessor,n=e.defaultPlayable;return[yield r.eventFields.applyFieldsMap(n,"utsVpafPlayable"),yield r.eventFields.applyFieldsMap(e.attributes,"utsVpafContent")]}))()}constructor(){_define_property$4(this,"_currentItem",void 0),_define_property$4(this,"playActivityProcessor",void 0),_define_property$4(this,"currentKeyPlay",void 0),_define_property$4(this,"currentSkipItems",void 0),_define_property$4(this,"dispatcher",void 0),_define_property$4(this,"instance",void 0),_define_property$4(this,"isScrubbing",!1),_define_property$4(this,"isBuffering",!1),_define_property$4(this,"rollItemsTracker",void 0),_define_property$4(this,"scrubStopPosition",void 0),_define_property$4(this,"tracker",void 0),_define_property$4(this,"synchronizeTimeout",void 0),_define_property$4(this,"state",void 0),_define_property$4(this,"lastTrackedEvent",void 0),this.state=new VPAFStateMachine}}function _define_property$3(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function extractAssetsFromPlayable(e,t){var r;if(!t.assets||"Preview"===e.type)return void(e.attributes.assetUrl=t.hlsUrl||(null===(r=t.assets)||void 0===r?void 0:r.hlsUrl));const{assets:n}=t;n.fpsKeyServerUrl&&(e.keyServerQueryParameters=n.fpsKeyServerQueryParameters,e.keyURLs={"hls-key-cert-url":n.fpsCertificateUrl,"hls-key-server-url":n.fpsKeyServerUrl,"widevine-cert-url":n.wideVineCertificateUrl}),e.assetURL=buildURL(n.hlsUrl,{webbrowser:!0})}function addPlayableToItem(e,t,r){var n,i,o,a,s,c;e.type=null!==(i=null!==(n=e.type)&&void 0!==n?n:t.type)&&void 0!==i?i:r,e.contentType=null!==(o=e.contentType)&&void 0!==o?o:t.contentType,e.attributes=null!==(a=e.attributes)&&void 0!==a?a:{},e.attributes.title=null!==(c=null!==(s=e.attributes.title)&&void 0!==s?s:e.title)&&void 0!==c?c:t.title,delete e.title,extractAssetsFromPlayable(e,t),e.id||(e.id=generateUUID()),e.playables=[t]}_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[String,Object]),_ts_metadata("design:returntype",Promise)],VPAFTracker.prototype,"onPlaybackStateChange",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[Object,Object]),_ts_metadata("design:returntype",void 0)],VPAFTracker.prototype,"handleLevelUpdated",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[]),_ts_metadata("design:returntype",void 0)],VPAFTracker.prototype,"handleAudioTrackChange",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[Object,Object]),_ts_metadata("design:returntype",void 0)],VPAFTracker.prototype,"handleForcedTextTrackChange",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[Object,void 0]),_ts_metadata("design:returntype",void 0)],VPAFTracker.prototype,"handlePresentationModeChange",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[]),_ts_metadata("design:returntype",void 0)],VPAFTracker.prototype,"handleTargetWirelessChange",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[]),_ts_metadata("design:returntype",void 0)],VPAFTracker.prototype,"handleTextTrackChange",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[String,Object]),_ts_metadata("design:returntype",void 0)],VPAFTracker.prototype,"handleNowPlayingItemDidChange",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[]),_ts_metadata("design:returntype",void 0)],VPAFTracker.prototype,"synchronize",null);const createMediaItem=e=>{var t;const r=JSON.stringify(e),n=JSON.parse(r),i=null===(t=n.playables)||void 0===t?void 0:t[0];var o;n.attributes=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$3(e,t,r[t])}))}return e}({},null!==(o=n.attributes)&&void 0!==o?o:{},n),addPlayableToItem(n,i);return new MediaItem(n)},ws=["contributors","modalities","movie","musicVideo","musicMovie","trailer","tvEpisode","uploadedVideo","uploaded-videos","music-videos","music-movies","tv-episodes","workouts"];function asyncGeneratorStep$1(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _define_property$2(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Os=Mn.createChild("ctp");class ClickToPlayTracker{get active(){return void 0!==this.rtcTracker}get isConfigured(){return this._isConfigured}configure(e){var t=this;return function(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep$1(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}((function*(){var r;t.instance=e.instance,t.rtcTracker=null===(r=e.services.playActivity)||void 0===r?void 0:r.getTrackerByType(RTCStreamingTracker),t._isConfigured=!0}))()}handleEvent(e,t,r){e===Dn.playInitiated?(Os.debug("ClickToPlayTracker.handleEvent",e,t),this.registerPlay(t.item,t.timestamp)):e===Dn.mediaCanPlay&&(Os.debug("ClickToPlayTracker.handleEvent",e,t),this.trackPlay(this.instance.nowPlayingItem,t.timestamp))}registerPlay(e,t){if(this.active&&void 0!==e){if(void 0!==t)return void 0!==this.tracking&&Os.warn(`Replacing item ${this.tracking.item.id} with item ${e.id}`),Os.debug(`Registering ${e.id} initiated at ${t}`),this.tracking={item:e,initiatedTimestamp:t},this.tracking;Os.warn(`registerPlay timestamp value for item ${e.id} is missing, discarding`)}else Os.debug("Not registring play: inactive")}trackPlay(e,t){if(!this.active||void 0===e)return void Os.debug("Not tracking play: inactive");if(void 0===this.tracking)return void Os.warn("ClickToPlayTracker.trackPlay called without a registered tracking item");const r=null!=t?t:Date.now(),n=this.tracking.initiatedTimestamp,i=r-n;if(Os.debug(`trackPlay: item=${e.id}, initiated=${n}, started=${r}, timestampDiff=${i}`),n>r)return void Os.warn("Initiated timestamp is not before started timestamp, ignoring");const o=this.getReportingAgent(e);if(void 0!==o)return Os.info(`Reporting playback success after ${i}ms`),o.issueReportingEvent(ClickToPlayTracker.EVENT_ID,{event:"playbackStartup",playbackStartupResult:"success",tapToFirstFrame:i,PlayType:e.isLinearStream?"LIVE":"VOD"}),this.tracking=void 0,{item:e,initiatedTimestamp:n,playbackTimestamp:r};Os.warn(`No reporting agent for ${e.id}, discarding`)}getReportingAgent(e){var t;if(void 0===this.rtcTracker)return void Os.warn("Could not get RTCReportingAgent from RTCStreamingTracker service");const r=this.rtcTracker.getMediaIdentifiers(e),n=null===(t=this.rtcTracker.reportingAgent)||void 0===t?void 0:t.SessionInfo;if(void 0===r||void 0===n)return;if(Object.entries(r).every((function([e,t]){return n[e]===t})))return this.rtcTracker.reportingAgent;Os.warn("RTCReportingAgent is not associated with item "+e.id)}constructor(){_define_property$2(this,"_isConfigured",!1),_define_property$2(this,"tracking",void 0),_define_property$2(this,"instance",void 0),_define_property$2(this,"rtcTracker",void 0),_define_property$2(this,"requestedEvents",[Dn.playInitiated,Dn.mediaCanPlay])}}function _define_property$1(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread$1(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property$1(e,t,r[t])}))}return e}function _object_spread_props(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}_define_property$2(ClickToPlayTracker,"EVENT_ID",4101);const Is=_object_spread$1({get info(){return function(){var t,r,n,i,o,a,s,c,l,d,u,p;const h={};h.version=e.version;const y=getHlsJsCdnConfig();var f;h.hlsJSVersion=null!==(f=null===(t=/\/hls\.js\/([^/]+)\/hls\.js\//i.exec(y.hls))||void 0===t?void 0:t[1])&&void 0!==f?f:"missing",h.hlsJSURL=y.hls,h.rtcJSURL=y.rtc;const _=getInstance();h.instanceId=null==_?void 0:_.id;const v=null==_?void 0:_.services.runtime;var m,g,b,S,P,E,T,k,w;return h.runtime=void 0===v?void 0:{browser:`${v.browser.name} ${v.browser.version}`,engine:`${v.engine.name} ${v.engine.version}`,os:`${v.os.name} ${v.os.version}`,mobile:v.isMobile,keysystems:v.availableKeySystems},h.controller=null!==(m=null==_||null===(r=_._playbackController)||void 0===r?void 0:r.constructor.name)&&void 0!==m?m:"none",h.player=null!==(g=null==_||null===(i=_._mediaItemPlayback)||void 0===i||null===(n=i.getCurrentPlayer())||void 0===n?void 0:n.constructor.name)&&void 0!==g?g:"none",h.queue={size:null!==(b=null==_||null===(o=_.queue)||void 0===o?void 0:o.length)&&void 0!==b?b:0,position:null!==(S=null==_||null===(a=_.queue)||void 0===a?void 0:a.position)&&void 0!==S?S:-1,currentItem:void 0===(null==_||null===(s=_.queue)||void 0===s?void 0:s.currentItem)?void 0:{id:null==_||null===(c=_.queue)||void 0===c?void 0:c.currentItem.id,type:null==_||null===(l=_.queue)||void 0===l?void 0:l.currentItem.type,title:null==_||null===(d=_.queue)||void 0===d?void 0:d.currentItem.title,attributes:null!==(P=null==_||null===(u=_.queue)||void 0===u?void 0:u.currentItem.attributes)&&void 0!==P?P:{}}},h.nowPlayingItem=void 0===(null==_?void 0:_.nowPlayingItem)?void 0:{id:_.nowPlayingItem.id,type:_.nowPlayingItem.type,title:_.nowPlayingItem.title,attributes:null!==(E=null==_||null===(p=_.queue)||void 0===p?void 0:p.currentItem.attributes)&&void 0!==E?E:{}},h.isPlaying=null!==(T=null==_?void 0:_.isPlaying)&&void 0!==T&&T,h.playbackModes={shuffle:["off","on"][null!==(k=null==_?void 0:_.shuffleMode)&&void 0!==k?k:0],repeat:["off","one","all"][null!==(w=null==_?void 0:_.repeatMode)&&void 0!==w?w:0],autoplay:!0===(null==_?void 0:_.autoplayEnabled)?"on":"off"},h.devFlags=Object.entries(ge).reduce((function(e,[t,r]){return _object_spread_props(_object_spread$1({},e),{[t]:r.value})}),{}),h}()}},ge);function asyncGeneratorStep(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(De){return void r(De)}s.done?t(c):Promise.resolve(c).then(n,i)}function _async_to_generator(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function _next(e){asyncGeneratorStep(o,n,i,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep(o,n,i,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _object_spread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){_define_property(e,t,r[t])}))}return e}function _object_without_properties(e,t){if(null==e)return{};var r,n,i=function(e,t){if(null==e)return{};var r,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}class MediaKitInstance extends MKInstance{playUtsItem(e,t,r){var n=this;return _async_to_generator((function*(){e=JSON.parse(JSON.stringify(e)),t?t=JSON.parse(JSON.stringify(t)):"EditorialVideoClip"===(t=JSON.parse(JSON.stringify(e))).type&&(t.type="Vod");const{id:i,type:o}=e,a={id:i,type:o,attributes:_object_spread({},e),playables:[t]};"Show"===o?(a.attributes.showId=e.id,a.attributes.showTitle=a.attributes.title,a.attributes.title=t.title):"Season"===o&&(a.attributes.title=t.title),extractAssetsFromPlayable(a,t);const s=new MediaItem(a);return n.playMediaItem(s,r)}))()}enqueuePlayables(e,t){var r=this;return _async_to_generator((function*(){const n=ensureArray(e).map(e=>{var t;const{id:n,type:i,contentType:o}=e,a={id:n,type:i,contentType:o,attributes:_object_without_properties(e,["id","type","contentType"]),playables:[e]};extractAssetsFromPlayable(a,e);const s=null===(t=e.playEvent)||void 0===t?void 0:t.playCursorInSeconds;return void 0!==s&&r._mediaItemPlayback.playOptions.set(n,{startTime:s}),new MediaItem(a)});(null==t?void 0:t.bingeWatching)||r.deferPlayback();const i=(yield r.setPlaybackController(r.getPlaybackControllerByType(pi.serial))).setQueue(new Queue({descriptor:{loaded:n},playbackMode:r.playbackMode,services:{runtime:r._services.runtime,request:r._services.request,dispatcher:r._services.dispatcher,mediaItemPlayback:r._services.mediaItemPlayback}}));if(t){var o;const e=null!==(o=r._mediaItemPlayback.playOptions.get(r.queue.nextPlayableItem.id))&&void 0!==o?o:{};r._mediaItemPlayback.playOptions.set(r.queue.nextPlayableItem.id,_object_spread({},e,t))}return i}))()}}function _configure(){return(_configure=_async_to_generator((function*(t){Bn.linkChild(Mn),Bn.linkChild(Ue),Bn.linkChild(te),t.playActivityAPI=[new VPAFTracker,new BookmarkTracker],t.realm=e.SKRealm.TV,t.rtcOptions&&(t.playActivityAPI=[...t.playActivityAPI,new RTCStreamingTracker(t.rtcOptions),new ClickToPlayTracker]);const r=yield configure$1(t,MediaKitInstance,function(){var e=_async_to_generator((function*(e){var r,n,i;const o=[];if(!(null===(i=t.apiOptions)||void 0===i||null===(n=i.utsClient)||void 0===n||null===(r=n.configureOptions)||void 0===r?void 0:r.client))throw new MKError(MKError.Reason.CONFIGURATION_ERROR,"Missing UTS Client");t.apiOptions.utsClient&&o.push(createUTSAPIServiceDescriptor(t.apiOptions.utsClient)),t.apiOptions.mediaApi&&o.push(createMediaAPIServiceDescriptor(t.apiOptions.mediaApi)),yield e.configure(o)}));return function(t){return e.apply(this,arguments)}}());return r.continuous=!0,r}))).apply(this,arguments)}e.Events=Dn,e.MKError=MKError,e.MediaKitInstance=MediaKitInstance,e.PlayActivityEndReasonType=si,e.VideoTypes={movie:!0,musicVideo:!0,musicMovie:!0,trailer:!0,tvEpisode:!0,uploadedVideo:!0,"uploaded-videos":!0,"music-videos":!0,"music-movies":!0,"tv-episodes":!0,Bonus:!0,Extra:!0,Episode:!0,Movie:!0,Preview:!0,Promotional:!0,Season:!0,Show:!0,Vod:!0,EditorialVideoClip:!0,RealityVideo:!0,SportingEvent:!0,LiveService:!0},e.__dev=Is,e.__log=Vn,e.configure=function(e){return _configure.apply(this,arguments)},e.createMediaItem=createMediaItem,e.createMediaItemFromPlayable=(e,t="Show")=>{if(Array.isArray(e.playables))return createMediaItem(e);const r=JSON.stringify(e),n=JSON.parse(r),i={id:n.id};addPlayableToItem(i,n,t);return new MediaItem(i)},e.enableMultipleInstances=function(){Zi=!0},e.formatArtworkURL=formatArtworkURL,e.formatMediaTime=function(e,t=":"){const{hours:r,minutes:n}=formattedSeconds(e);e=Math.floor(e%3600%60);const i=[];return r?(i.push(""+r),i.push(n<10?"0"+n:""+n)):i.push(""+n),i.push(e<10?"0"+e:""+e),i.join(t)},e.formattedMediaURL=formattedMediaURL,e.formattedMilliseconds=function(e){return formattedSeconds(e/1e3)},e.formattedSeconds=formattedSeconds,e.generateEmbedCode=function(e,t={height:"450",width:"660"}){if(!d.test(e))throw new Error("Invalid content url");var r;let n=null!==(r=t.height)&&void 0!==r?r:"450";var i;let o=null!==(i=t.width)&&void 0!==i?i:"660";const{kind:a,isUTS:s}=formattedMediaURL(e),c="post"===a||"musicVideo"===a||s;"song"===a||"episode"===a?n="175":c&&(n=""+Math.round(.5625*parseInt(o,10))),n=(""+n).replace(/(\d+)px/i,"$1"),o=(""+o).replace(/^(\d+)(?!px)%?$/i,"$1px");const l=(c?"width:"+o:"width:100%;"+(o?"max-width:"+o:""))+";overflow:hidden;border-radius:10px;";let h="https://embed.music.apple.com";return["podcast","episode"].includes(null!=a?a:"")&&!s&&(h="https://embed.podcasts.apple.com"),["movie","episode","season","show"].includes(null!=a?a:"")&&s&&(h="https://embed.tv.apple.com"),`<iframe ${[`allow="${p.join("; ")}"`,'frameborder="0"',n?`height="${n}"`:"",`style="${l}"`,`sandbox="${u.join(" ")}"`,`src="${e.replace(d,h)}"`].join(" ")}></iframe>`},e.getHlsJsCdnConfig=getHlsJsCdnConfig,e.getInstance=getInstance,e.getInstances=function(){return eo},e.getPlayerType=function(e){var t,r;return(null==e?void 0:e.isUTS)||ws.includes(null==e?void 0:e.type)?"video":null!==(r=null==e||null===(t=e.attributes)||void 0===t?void 0:t.mediaKind)&&void 0!==r?r:"audio"},Object.defineProperty(e,"__esModule",{value:!0})}));
